<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>

<style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color: #ffffff; --text-color: #333333; --select-text-bg-color: #B5D6FC; --select-text-font-color: auto; --monospace: "Lucida Console",Consolas,"Courier",monospace; --title-bar-height: 20px; }
.mac-os-11 { --title-bar-height: 28px; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
h1, h2, h3, h4, h5 { white-space: pre-wrap; }
body { margin: 0px; padding: 0px; height: auto; inset: 0px; font-size: 1rem; line-height: 1.42857; overflow-x: hidden; background: inherit; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; overflow-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 36px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
.typora-export .task-list-item input { pointer-events: none; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; image-orientation: from-image; }
button, input, select, textarea { color: inherit; font: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 4; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px; }
thead, tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right: 0px; background-color: inherit; }
.CodeMirror-linenumber { user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }
.md-fences-adv-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
svg { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: 0px 0px; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; -webkit-tap-highlight-color: transparent; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li blockquote { margin: 1rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; font-variant-ligatures: no-common-ligatures; }
  #write { margin-top: 0px; border-color: transparent !important; padding-top: 0px !important; padding-bottom: 0px !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  .typora-export #write { break-after: avoid; }
  .typora-export #write::after { height: 0px; }
  .is-mac table { break-inside: avoid; }
  #write > p:nth-child(1) { margin-top: 0px; }
  .typora-export-show-outline .typora-export-sidebar { display: none; }
  figure { overflow-x: visible; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
#write.first-line-indent p > .md-image:only-child:not(.md-img-error) img { left: -2em; position: relative; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
.MathJax_ref { fill: currentcolor; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.reversefootnote { font-family: ui-monospace, sans-serif; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.6; font-family: var(--monospace); }
code { text-align: left; vertical-align: initial; }
a.md-print-anchor { white-space: pre !important; border-width: initial !important; border-style: none !important; border-color: initial !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; background: 0px 0px !important; text-decoration: initial !important; text-shadow: initial !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
mark { background: rgb(255, 255, 0); color: rgb(0, 0, 0); }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
.md-expand mark .md-meta { opacity: 0.3 !important; }
mark .md-meta { color: rgb(0, 0, 0); }
@media print {
  .typora-export h1, .typora-export h2, .typora-export h3, .typora-export h4, .typora-export h5, .typora-export h6 { break-inside: avoid; }
}
.md-diagram-panel .messageText { stroke: none !important; }
.md-diagram-panel .start-state { fill: var(--node-fill); }
.md-diagram-panel .edgeLabel rect { opacity: 1 !important; }
.md-fences.md-fences-math { font-size: 1em; }
.md-fences-advanced:not(.md-focus) { padding: 0px; white-space: nowrap; border: 0px; }
.md-fences-advanced:not(.md-focus) { background: inherit; }
.typora-export-show-outline .typora-export-content { max-width: 1440px; margin: auto; display: flex; flex-direction: row; }
.typora-export-sidebar { width: 300px; font-size: 0.8rem; margin-top: 80px; margin-right: 18px; }
.typora-export-show-outline #write { --webkit-flex: 2; flex: 2 1 0%; }
.typora-export-sidebar .outline-content { position: fixed; top: 0px; max-height: 100%; overflow: hidden auto; padding-bottom: 30px; padding-top: 60px; width: 300px; }
@media screen and (max-width: 1024px) {
  .typora-export-sidebar, .typora-export-sidebar .outline-content { width: 240px; }
}
@media screen and (max-width: 800px) {
  .typora-export-sidebar { display: none; }
}
.outline-content li, .outline-content ul { margin-left: 0px; margin-right: 0px; padding-left: 0px; padding-right: 0px; list-style: none; overflow-wrap: anywhere; }
.outline-content ul { margin-top: 0px; margin-bottom: 0px; }
.outline-content strong { font-weight: 400; }
.outline-expander { width: 1rem; height: 1.42857rem; position: relative; display: table-cell; vertical-align: middle; cursor: pointer; padding-left: 4px; }
.outline-expander::before { content: ""; position: relative; font-family: Ionicons; display: inline-block; font-size: 8px; vertical-align: middle; }
.outline-item { padding-top: 3px; padding-bottom: 3px; cursor: pointer; }
.outline-expander:hover::before { content: ""; }
.outline-h1 > .outline-item { padding-left: 0px; }
.outline-h2 > .outline-item { padding-left: 1em; }
.outline-h3 > .outline-item { padding-left: 2em; }
.outline-h4 > .outline-item { padding-left: 3em; }
.outline-h5 > .outline-item { padding-left: 4em; }
.outline-h6 > .outline-item { padding-left: 5em; }
.outline-label { cursor: pointer; display: table-cell; vertical-align: middle; text-decoration: none; color: inherit; }
.outline-label:hover { text-decoration: underline; }
.outline-item:hover { border-color: rgb(245, 245, 245); background-color: var(--item-hover-bg-color); }
.outline-item:hover { margin-left: -28px; margin-right: -28px; border-left: 28px solid transparent; border-right: 28px solid transparent; }
.outline-item-single .outline-expander::before, .outline-item-single .outline-expander:hover::before { display: none; }
.outline-item-open > .outline-item > .outline-expander::before { content: ""; }
.outline-children { display: none; }
.info-panel-tab-wrapper { display: none; }
.outline-item-open > .outline-children { display: block; }
.typora-export .outline-item { padding-top: 1px; padding-bottom: 1px; }
.typora-export .outline-item:hover { margin-right: -8px; border-right: 8px solid transparent; }
.typora-export .outline-expander::before { content: "+"; font-family: inherit; top: -1px; }
.typora-export .outline-expander:hover::before, .typora-export .outline-item-open > .outline-item > .outline-expander::before { content: "−"; }
.typora-export-collapse-outline .outline-children { display: none; }
.typora-export-collapse-outline .outline-item-open > .outline-children, .typora-export-no-collapse-outline .outline-children { display: block; }
.typora-export-no-collapse-outline .outline-expander::before { content: "" !important; }
.typora-export-show-outline .outline-item-active > .outline-item .outline-label { font-weight: 700; }
.md-inline-math-container mjx-container { zoom: 0.95; }
mjx-container { break-inside: avoid; }
.md-alert.md-alert-note { border-left-color: rgb(9, 105, 218); }
.md-alert.md-alert-important { border-left-color: rgb(130, 80, 223); }
.md-alert.md-alert-warning { border-left-color: rgb(154, 103, 0); }
.md-alert.md-alert-tip { border-left-color: rgb(31, 136, 61); }
.md-alert.md-alert-caution { border-left-color: rgb(207, 34, 46); }
.md-alert { padding: 0px 1em; margin-bottom: 16px; color: inherit; border-left: 0.25em solid rgb(0, 0, 0); }
.md-alert-text-note { color: rgb(9, 105, 218); }
.md-alert-text-important { color: rgb(130, 80, 223); }
.md-alert-text-warning { color: rgb(154, 103, 0); }
.md-alert-text-tip { color: rgb(31, 136, 61); }
.md-alert-text-caution { color: rgb(207, 34, 46); }
.md-alert-text { font-size: 0.9rem; font-weight: 700; }
.md-alert-text svg { fill: currentcolor; position: relative; top: 0.125em; margin-right: 1ch; overflow: visible; }
.md-alert-text-container::after { content: attr(data-text); text-transform: capitalize; pointer-events: none; margin-right: 1ch; }


.CodeMirror { height: auto; }
.CodeMirror.cm-s-inner { background: inherit; }
.CodeMirror-scroll { overflow: auto hidden; z-index: 3; }
.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }
.CodeMirror-gutters { border-right: 1px solid rgb(221, 221, 221); background: inherit; white-space: nowrap; }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-property { color: rgb(0, 0, 0); }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: 700; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: red; }
.cm-invalidchar { color: red; }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background: inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background: inherit; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; outline: 0px; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: auto hidden; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 10px; z-index: 3; overflow-y: hidden; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; background: 0px 0px !important; border: none !important; }
.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-radius: 0px; border-width: 0px; background: 0px 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; overflow-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; }
.CodeMirror-wrap pre { overflow-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right: 30px solid transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right: none; width: auto; }
.CodeMirror-linebackground { position: absolute; inset: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right: none; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.cm-searching { background: rgba(255, 255, 0, 0.4); }
span.cm-underlined { text-decoration: underline; }
span.cm-strikethrough { text-decoration: line-through; }
.cm-tw-syntaxerror { color: rgb(255, 255, 255); background-color: rgb(153, 0, 0); }
.cm-tw-deleted { text-decoration: line-through; }
.cm-tw-header5 { font-weight: 700; }
.cm-tw-listitem:first-child { padding-left: 10px; }
.cm-tw-box { border-style: solid; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-color: inherit; border-top-width: 0px !important; }
.cm-tw-underline { text-decoration: underline; }
@media print {
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}


/* Theme adapted from https://codemirror.net/theme/dracula.css */
/*
    Name:       dracula
    Author:     Michael Kaminsky (http://github.com/mkaminsky11)

    Original dracula color scheme by Zeno Rocha (https://github.com/zenorocha/dracula-theme)
*/

.cm-s-inner {
  padding: 0.5rem 0.2rem;
  border: 1px solid var(--accent-color) !important;
  border-radius: 0.25rem;
}

.cm-s-inner.CodeMirror, .cm-s-inner .CodeMirror-gutters {
  background-color: #282a36 !important;
  color: #f8f8f2 !important;
  border: none;
}

.cm-s-inner .CodeMirror-gutters {
  width: 5ch;
  color: #282a36;
}
.cm-s-inner .CodeMirror-cursor { border-left: solid thin #f8f8f2 !important; }
.cm-s-inner .CodeMirror-linenumber {
  width: 4ch !important;
  color: #6D8A88;
}

.cm-s-inner .CodeMirror-line::selection,
.cm-s-inner .CodeMirror-line > span::selection,
.cm-s-inner .CodeMirror-line > span > span::selection { background: rgba(255, 255, 255, 0.10); }
.cm-s-inner .CodeMirror-line::-moz-selection,
.cm-s-inner .CodeMirror-line > span::-moz-selection,
.cm-s-inner .CodeMirror-line > span > span::-moz-selection { background: rgba(255, 255, 255, 0.10); }
.cm-s-inner span.cm-comment { color: #6272a4; }
.cm-s-inner span.cm-string, .cm-s-inner span.cm-string-2 { color: #f1fa8c; }
.cm-s-inner span.cm-number { color: #bd93f9; }
.cm-s-inner span.cm-variable, .cm-s-inner span.cm-variable-2 { color: #50fa7b; }
.cm-s-inner span.cm-def { color: white; }
.cm-s-inner span.cm-operator { color: #ff79c6; }
.cm-s-inner span.cm-keyword { color: #ff79c6; }
.cm-s-inner span.cm-atom { color: #bd93f9; }
.cm-s-inner span.cm-meta { color: #f8f8f2; }
.cm-s-inner span.cm-tag { color: #ff79c6; }
.cm-s-inner span.cm-attribute { color: #50fa7b; }
.cm-s-inner span.cm-qualifier { color: #50fa7b; }
.cm-s-inner span.cm-property { color: #66d9ef; }
.cm-s-inner span.cm-builtin { color: #50fa7b; }
.cm-s-inner span.cm-variable-3, .cm-s-inner span.cm-type { color: #ffb86c; }

.cm-s-inner .CodeMirror-activeline-background { background: rgba(255,255,255,0.1); }
.cm-s-inner .CodeMirror-matchingbracket {
  text-decoration: underline;
  color: white !important;
}
.CodeMirror-selectedtext, .CodeMirror-selected {
  background: #313746 !important;
  text-shadow: none;
}
/* 
  Middle East - Night
  Typora RTL theme
  design: isapanah.com
  date: 2019
  version: 1.1
*/

@import url("file:////home/Taha/.config/Typora/themes/");

/*
  Vazir provided by Rastikerdar
  Downloaded from `https://github.com/rastikerdar/vazir-font`
*/
/*
	Cousine provided by Steve Matteson from Google Fonts
	Downloaded from `https://fonts.google.com/specimen/Cousine`
*/
/** ROOT VARIABLES **/

:root {
  --bg-color: #1e2022; /* change background */
  --text-color: #dddddd; /* change text color */
  --md-char-color: #5b5b5b; /* change color of mbeta characetrs like `*` in markdown */
  --meta-content-color: #757575; /* change color of meta contents like image text or link address in markdown */
  --link-color: #6bcafb; /* change color of hyperlinks */

  --primary-color: #428bca; /* primary color */
  --primary-btn-border-color: #285e8e; /* primary color for buttons */
  --primary-btn-text-color: #fff; /* primary text color for buttons */
  --accent-color: #3c3c3c; /* background accent color */

  --window-border: 1px solid #16161a; /* border for sidebar, etc*/

  --active-file-bg-color: #16161a; /* background color if list item in file tree or file list*/
  --active-file-text-color: inherit; /* text color for selected file */
  --active-file-border-color: #777; /* border color for selected file */
  --active-search-item-bg-color: #212121; /* background color for active search item */

  --side-bar-bg-color: #2b2b2b; /* change background of sidebar*/
  --item-hover-bg-color: var(--bg-color); /* background of control items when hover, like menu in sidebar*/
  --item-hover-text-color: white; /* text color upon hovering over menu items */
  --search-hit-bg-color: #428bca40;
  --search-select-text-color: var(--text-color); /* Text color for selected searched text */
  --search-select-bg-color: #428bca90; /* Background color for selected searched text */
  --rawblock-edit-panel-bd: var(--accent-color); /* Background color for inline HTML "edit panel" blocks */
  --monospace: "Cousine"; /* monospace font for codes, fences */

  --megamenu-bg-color: var(--side-bar-bg-color); /* background color for unibody megamenu */
  --megamenu-sidebar-bg-color: var(--bg-color); /* background color for megamenu sidebar */
  --megamenu-sidebar-hover-bg-color: #161819; /* background color for hovering megamenu sidebar items */
  --megamenu-sidebar-active-bg-color: #101010; /* background color for active megamenu sidebar items */
  --megamenu-button-border-color: #9292928f; /* background color for megamenu buttons */
  --megamenu-item-hover-bg-color: var(--bg-color); /* background color for hovering megamenu items */
  --megamenu-item-hover-text-color: white; /* text color for hovering megamenu items */
}

/** TAGS **/

html,
body {
  font-family: "Vazir", "Lato", sans-serif;
}

body {
  font-size: 14px;
}

h1,
h2,
h3,
h4,
h5,
h6, p, a, del, mark, #write p, #write a, #write del, #write mark, #write ul, #write li, #write ol,
#write table, #write tr, #write td, table, tr, td {
  direction: rtl;
}

.outline-item{
  direction: rtl;
}
.outline-h2, .outline-h3, .outline-h4,
 .outline-h5, .outline-h6 {
  margin-right: 10px !important;
}

#md-notification, #md-notification *{
  direction: ltr;
}

h1,
h2,
h3,
h4,
h5,
h6 {
  font-family: "Vazir-Bold";
}

h1 {
  font-size: 1.8rem;
  margin: 1rem 0;
}

h2 {
  font-size: 1.4rem;
  margin: 0.7rem 0;
}

h3 {
  font-size: 1.2rem;
  margin: 0.5rem 0;
}

h4 {
  font-size: 1.1rem;
  margin: 0.2rem 0;
}

h5 {
  font-size: 1rem;
  margin: 0;
}

h6 {
  font-size: 1rem;
  margin: 0;
}

p {
  margin: 0.5rem 0;
}

a {
  color: var(--link-color);
}

del {
  color: var(--md-char-color);
}

mark {
  padding: 2px 1px;
  background: #fee405;
}

/* Writing area -> line height */
#write {
	line-height: 1.6;
}

/* Custom list-style */
#write ol,
#write ul {
  padding-left: 2rem;
  margin: 0.5rem 0;
  margin-left: 0 !important;
  padding-left: 0 !important;
}

#write ul {
  list-style-type: disc;
}

#write ol > li,
#write ul > li {
  color: var(--primary-color);
  padding-left: 0.25em;
}

#write ol li > *,
#write ul li > * {
  color: var(--text-color);
}

#write .md-task-list-item {
  transition: all 0.3s;
}

#write .md-task-list-item > input {
  -webkit-appearance: initial;
  display: block;
  position: absolute;
  border: 1px solid var(--md-char-color);
  border-radius: 0.25rem;
  margin-top: 0.1rem;
  margin-right: -1.8rem;
  height: 1.2rem;
  width: 1.2rem;
  transition: background 0.4s;
  right: 0;
}

#write .md-task-list-item > input:focus {
  outline: none;
  box-shadow: none;
}

#write .md-task-list-item > input:hover {
  background: var(--accent-color);
}

#write .md-task-list-item.task-list-done > p {
  color: var(--md-char-color);
  text-decoration: line-through;
}

#write .md-task-list-item > input[checked]::before {
  content: "";
  position: absolute;
  top: 20%;
  left: 50%;
  height: 60%;
  width: 2px;
  transform: rotate(40deg);
  background: var(--text-color);
}

#write .md-task-list-item > input[checked]::after {
  content: "";
  position: absolute;
  top: 46%;
  left: 25%;
  height: 30%;
  width: 2px;
  transform: rotate(-40deg);
  background: var(--text-color);
}

blockquote {
  margin: 1rem 0rem 1rem 0;
  font-family: "Vazir-Bold";
}

blockquote p::before {
  content: "";
  position: absolute;
  right: -2rem;
  height: 100%;
  width: 0.25rem;
  background: var(--primary-color);
}

blockquote p:not(:last-child):before {
  height: calc(100% + 1rem);
}

code,
.md-fences,
tt {
  font-family: "Cousine", monospace;
  font-size: 1rem;
}

code {
  border: 1px solid var(--accent-color);
  border-radius: 0.25rem;
  padding: 0 0.125rem;
}

/* Code auto-suggest list menu */
#fences-auto-suggest .active {
  background: var(--accent-color);
}

hr {
  border-color: var(--md-char-color);
}

/* YAML */
pre.md-meta-block {
  background-color: transparent;
  border-bottom: 1px solid var(--md-char-color);
  padding-bottom: 1rem;
  opacity: 0.8;
}

/* Tables */
table {
  border: 1px solid var(--md-char-color);
  margin: 1rem 0;
}

thead {
  background: #4d4d4d;
}

table tr:nth-child(2n) {
  background: var(--accent-color);
}

td,
th {
  padding: 0.35rem 0.7rem;
  border: 1px solid var(--md-char-color);
}

/* Table toolbar */
.md-table-edit {
  border-top: 1px solid var(--meta-content-color);
  margin-top: -29px !important;
  padding: 3px 0;
}

/* Table drag areas */
.typora-table-drag-area::after {
  content: "";
  position: absolute;
  border: 2px solid var(--text-color);
  opacity: 0;
  transition: opacity 0.4s;
}

#typora-table-row-tracker .typora-table-drag-area::after {
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 100%;
}

#typora-table-col-tracker .typora-table-drag-area::after {
  top: 50%;
  left: 0;
  transform: translateY(-50%);
  width: 100%;
  height: 0;
}

#typora-table-row-tracker .typora-table-drag-area:hover::after,
#typora-table-col-tracker .typora-table-drag-area:hover::after {
  opacity: 1;
}

/* Table of contents */
.md-toc-tooltip {
  z-index: 10;
}

span.md-toc-item {
  font-size: 1.1rem;
  color: var(--primary-btn-border-color);
}

span.md-toc-h1 {
  font-family: "Vazir-Bold";
  font-size: 1.3rem;
}

span.md-toc-h2 {
  font-size: 1.2rem;
}

/* Footnote */
sup.md-footnote {
  font-family: "Vazir-Bold";
  font-size: 0.8rem;
  padding: 0 4px;
}

span.md-def-split {
  min-width: 1ch;
}

.md-def-name::before,
.md-def-name::after {
  color: var(--meta-content-color);
}

/* Writing area */
#write {
  width: 90%;
  max-width: 700px;
}

/* Fill whole width of container */
#write h1,
#write h2,
#write h3,
#write h4,
#write h5,
#write h6,
#write p,
#write pre {
  width: auto;
}

/* Header prefix symbol */
/* Disable default header symbol */
#write h3.md-focus::before,
#write h4.md-focus::before,
#write h5.md-focus::before,
#write h6.md-focus::before {
  border: none;
  border-radius: 0;
  left: auto;
  float: none;
  padding: 0;
  vertical-align: baseline;
  line-height: 20px;
}

#write h1::before,
#write h2::before,
#write h3::before,
#write h4::before,
#write h5::before,
#write h6::before {
  position: absolute;
  top: 0;
  right: calc(100% + 10px);
  color: var(--md-char-color);
  font-size: 1rem;
  font-weight: bold;
  font-variant: "small-caps";
}

#write h1::before {
  content: "H1";
  top: 0.7rem;
}

#write h2::before {
  content: "H2";
  top: 0.37rem;
}

#write h3::before {
  content: "H3";
  top: 0.15rem;
}

#write h4::before {
  content: "H4";
}

#write h5::before {
  content: "H5";
}

#write h6::before {
  content: "H6";
}

/* Image meta text */
#write .md-image > .md-meta {
  color: var(--meta-content-color);
}

/* Inline styles */
.md-rawblock-tooltip {
  top: -1.5rem;
  height: 1.5rem;
  padding: 0.25rem;
}

/* Search results */
.md-search-hit {
  background: var(--search-hit-bg-color);
  border-radius: 0.125em;
}

.md-search-select {
  background: var(--search-select-bg-color);
  border: 1px solid var(--megamenu-button-border-color);
  padding: 0 1px;
}

/* Focus mode */
.on-focus-mode .md-end-block:not(.md-focus):not(.md-focus-container) *,
.on-focus-mode pre.md-end-block:not(.md-focus):not(.md-focus-container) {
  color: var(--md-char-color) !important;
}

.on-focus-mode .md-end-block:not(.md-focus):not(.md-focus-container) img,
.on-focus-mode
  blockquote
  .md-end-block:not(.md-focus):not(.md-focus-container)::before,
.on-focus-mode li:not(.md-focus-container)::before {
  opacity: 0.5;
}

.on-focus-mode .md-end-block:not(.md-focus):not(.md-focus-container) mark {
  background: var(--accent-color);
}

/* UI Sidebar */
#typora-sidebar {
  border-right: 1px solid #19191c;
}

.sidebar-tabs {
  font-family: "Vazir-Bold";
  border-bottom: 1px solid black;
}

.file-list-item-file-name {
  font-family: "Vazir-Bold";
  font-size: 1.2rem;
}

input.file-list-item-file-name, input.file-tree-rename-input {
  background: var(--side-bar-bg-color);
}

#file-library-search .file-list-item-file-name {
  font-size: 1.1rem;
}

#file-library-search .ty-search-item.active {
  background: var(--active-search-item-bg-color);
}

#file-library-search-input {
  background: var(--side-bar-bg-color);
}

.file-list-item-summary,
.ty-search-item-line {
  font-family: "Vazir", "Lato", sans-serif;
}

.ty-file-search-match-text,
.ty-outline-hit {
  font-weight: bold;
  background: transparent;
}

#outline-content {
  line-height: 1.4em;
}

#outline-content .outline-h1 > .outline-item {
  font-family: "Vazir-Bold";
}

.file-library-node,
.file-library-node .file-node-background {
  transition: background 0.4s;
}

.file-tree-node.file-library-file-node:not(.active):hover .file-node-background,
.file-list-item.file-library-node:not(.active):hover {
  background: var(--item-hover-bg-color);
}

.file-tree-node.file-library-file-node.active .file-node-background,
.file-list-item.file-library-file-node.active {
  border-left: 5px solid var(--primary-color);
}

/* Remove blinking animation when updating filename */
.blink-area {
  animation: none;
}

#ty-sidebar-footer {
  border-top: 1px solid black;
}

.sidebar-footer-item {
  transition: background 0.3s;
}

.outline-title-wrapper,
.outline-item-wrapper.outline-h1 > .outline-item {
  font-family: "Vazir-Bold";
  font-weight: bold;
}

/* Windows-specific */
/* Context and dropdown menus */
ul.dropdown-menu li.active a,
ul.dropdown-menu li.has-extra-menu.active a,
ul.dropdown-menu li.has-btn-submenu a.menu-style-btn.active,
#footer-word-count-info .ty-footer-word-count-all tr:hover,
#ty-spell-check-dict-missing-menu li:hover,
.ty-spell-check-panel-item.ty-active,
.ty-spell-check-panel-item:hover {
  background: var(--text-color) !important;
  color: var(--bg-color) !important;
}

/* Windows Unibody */
footer.ty-footer {
  border-top: 0;
}

.footer-item:hover {
  background: var(--text-color) !important;
  color: var(--bg-color) !important;
}

.form-control:focus {
  border-color: var(--primary-color);
  box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 2px var(--primary-color);
}

/* Windows Unibody megamenu */
.megamenu-opened header {
  background-image: none;
}

#top-titlebar, #top-titlebar * {
  color: inherit;
}

#megamenu-content {
  padding-top: 28px;
  background: var(--megamenu-bg-color);
  color: var(--text-color);
}

.megamenu-menu-panel:not(:first-of-type) {
  margin-top: 48px;
}

#megamenu-content .long-btn {
  border-color: var(--megamenu-button-border-color);
  transition: all 0.4s;
}

#megamenu-content .long-btn:hover {
  border-color: var(--primary-color);
  background: var(--megamenu-item-hover-bg-color);
  color: var(--megamenu-item-hover-text-color) !important;
}

#recent-file-panel-action-btn {
  background: inherit;
  border-color: var(--megamenu-button-border-color);
  transition: all 0.4s;
}

#recent-file-panel-action-btn:hover {
  border-color: var(--primary-color);
  background: var(--megamenu-item-hover-bg-color);
  color: var(--megamenu-item-hover-text-color);
}

#recent-document-table {
  border: 1px solid var(--accent-color);
}

#recent-file-panel tbody tr:nth-child(2n-1) {
  background-color: inherit;
}

#recent-file-panel tbody tr:hover {
  background-color: var(--megamenu-item-hover-bg-color) !important;
}

#recent-file-panel tbody tr:hover td:nth-child(1) {
  color: var(--megamenu-item-hover-text-color);
}

/* Windows Unibody sidebar */
#megamenu-menu-sidebar {
  background: var(--megamenu-sidebar-bg-color);
  color: var(--text-color);
}

.megamenu-menu-header, .megamenu-menu-list li:not(.saved) a {
  transition: all 0.4s;
}

.megamenu-menu-header {
  border-bottom: var(--window-border);
}

.megamenu-menu-header:hover, .megamenu-menu-list li:not(.saved) a:not(.active):hover {
  background: var(--megamenu-sidebar-hover-bg-color);
}

.megamenu-menu-list li a.active {
  background: var(--megamenu-sidebar-active-bg-color) !important;
}

#m-saved {
  background: inherit;
  color: inherit;
}

#megamenu-menu-list {
  margin: 0;
}

.theme-preview-div {
  transition: all 0.4s;
}

.theme-preview-div:hover {
  border: 4px solid var(--primary-btn-border-color);
}

.theme-preview-div.active, .theme-preview-div.active:hover {
  border: 4px solid var(--primary-color);
}

.theme-preview-div.active i {
  color: var(--primary-color);
}

/* Source Code */
.cm-s-typora-default .cm-s-inner.CodeMirror-line {
  border: 0 !important;
}

/* Print/PDF */
@media print {
  #write ol > li,
  #write ul > li {
    color: var(--text-color);
  }
  #write h1::before, #write h2::before, #write h3::before,
  #write h4::before, #write h5::before, #write h6::before {
    display: none;
  }
}




</style><title>Chapter 5. Terraform Tips and Tricks Loops, If-Statements,Deployment, and Gotchas</title>
</head>
<body class='typora-export'><div class='typora-export-content'>
<div id='write'  class=''><p>&nbsp;</p><h1 id='chapter-5-terraform-tips-and-tricks-loops-if-statementsdeployment-and-gotchas'><span>Chapter 5. Terraform Tips and Tricks: Loops, If-Statements,Deployment, and Gotchas</span></h1><p>&nbsp;</p><p><code>Terraform</code><span> هي </span><code>declarative language</code><span>. وزي ما اتكلمنا في الفصل الأول، الـ </span><code>IaC</code><span> اللي بيكون بـ </span><code>declarative language</code><span> بيبقى بيقدملك صورة أوضح للحاجة اللي معمولة </span><code>deploy</code><span> بالفعل مقارنة بـ </span><code>procedural language</code><span>، وده بيخلي الموضوع أسهل في الفهم، وبيسهل عليك تخلي الـ </span><code>codebase</code><span> بتاعك صغير. لكن، فيه أنواع معينة من الـ </span><code>tasks</code><span> بتبقى أصعب شوية في الـ </span><code>declarative language</code><span>.</span></p><p><span>كمثال، لإن الـ </span><code>declarative languages</code><span> عادةً مبيبقاش فيها </span><code>for-loops</code><span>، إزاي ممكن تكرر حتة </span><code>logic</code><span> معينة — زي مثلاً إنك تعمل </span><code>create</code><span> لكذا </span><code>resource</code><span> شبه بعض — من غير ما تعمل </span><code>copy and paste</code><span>؟ ولو الـ </span><code>declarative language</code><span> مش بتدعم الـ </span><code>if-statements</code><span>، إزاي تقدر تعمل </span><code>configure</code><span> للـ </span><code>resources</code><span> بشكل </span><code>conditionally</code><span>، زي مثلاً إنك تعمل </span><code>Terraform module</code><span> يقدر يعمل </span><code>create</code><span> لـ </span><code>resources</code><span> معينة لناس بتستخدم الـ </span><code>module</code><span> ده وميعملهاش لناس تانية؟ وأخيراً، إزاي ممكن تعبّر عن فكرة </span><code>procedural</code><span> بطبعها، زي الـ </span><code>zero-downtime deployment</code><span>، في </span><code>declarative language</code><span>؟</span></p><p><span>لحسن الحظ، </span><code>Terraform</code><span> بيوفر شوية </span><code>primitives</code><span> (أدوات أساسية) — </span>
<span>وهي بالتحديد الـ </span><code>meta-parameter count</code><span>، و الـ </span><code>for_each</code><span> و </span><code>for expressions</code><span>، </span>
<span>و الـ </span><code>ternary operator</code><span>، و </span><code>lifecycle block</code><span> اللي اسمه </span><code>create_before_destroy</code><span>، وعدد كبير من الـ </span><code>functions</code><span> — واللي بتسمحلك تعمل أنواع معينة من الـ </span><code>loops</code><span>، و الـ </span><code>if-statements</code><span>، و الـ </span><code>zero-downtime deployments</code><span>.</span></p><p><span>ودي النقط اللي هنتكلم عنها في الفصل ده:</span></p><ul><li><p><span>الـ </span><code>Loops</code></p></li><li><p><span>الـ </span><code>Conditionals</code></p></li><li><p><span>الـ </span><code>Zero-downtime deployment</code></p></li><li><p><span>الـ </span><code>Terraform gotchas</code></p></li></ul><p>&nbsp;</p><h2 id='الـ-loops'><strong><span>الـ </span><code>Loops</code><span> </span></strong></h2><p><code>Terraform</code><span> بيقدم كذا طريقة مختلفة للـ </span><code>looping</code><span>، كل واحدة منهم معمول عشان تستخدم في </span><code>scenario</code><span> (سيناريو) مختلف شوية:</span></p><ul><li><p><span>الـ </span><code>count parameter</code><span>، عشان تعمل </span><code>loop</code><span> على الـ </span><code>resources</code><span> والـ </span><code>modules</code><span>.</span></p></li><li><p><span>الـ </span><code>for_each expressions</code><span>، عشان تعمل </span><code>loop</code><span> على الـ </span><code>resources</code><span>، والـ </span><code>inline blocks</code><span> جوه الـ </span><code>resource</code><span>، والـ </span><code>modules</code><span>.</span></p></li><li><p><span>الـ </span><code>for expressions</code><span>، عشان تعمل </span><code>loop</code><span> على الـ </span><code>lists</code><span> والـ </span><code>maps</code><span>.</span></p></li><li><p><span>الـ </span><code>for string directive</code><span>، عشان تعمل </span><code>loop</code><span> على الـ </span><code>lists</code><span> والـ </span><code>maps</code><span> جوه الـ </span><code>string</code><span>.</span></p></li></ul><p><span>خلينا نشوف كل واحدة لوحدها.</span></p><h3 id='الـ-loops-باستخدام-الـ-count-parameter'><strong><span>الـ </span><code>Loops</code><span> باستخدام الـ </span><code>count Parameter</code></strong></h3><p><span>في الفصل التاني، أنت عملت </span><code>create</code><span> لـ </span><code>AWS Identity and Access Management (IAM) user</code><span> عن طريق الـ </span><code>Console</code><span>. دلوقتي بما إنك عندك الـ </span><code>user</code><span> ده، ممكن تعمل </span><code>create</code><span> وتدير كل الـ </span><code>IAM users</code><span> اللي جايين بـ </span><code>Terraform</code><span>. بص على كود </span><code>Terraform</code><span> اللي جاي ده، واللي المفروض يكون موجود في </span><code>live/global/iam/main.tf</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0235px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">provider</span> <span class="cm-string">"aws"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">region</span> <span class="cm-operator">=</span> <span class="cm-string">"us-east-2"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_iam_user"</span> <span class="cm-string">"example"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-string">"neo"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 157px;"></div><div class="CodeMirror-gutters" style="display: none; height: 157px;"></div></div></div></pre><p><span>الكود ده بيستخدم الـ </span><code>aws_iam_user resource</code><span> عشان يعمل </span><code>create</code><span> لـ </span><code>IAM user</code><span> واحد جديد. إيه اللي هيحصل لو عايز تعمل </span><code>create</code><span> لتلاتة </span><code>IAM users</code><span>؟ في أي لغة برمجة </span><code>general-purpose</code><span>، أنت غالبًا هتستخدم </span><code>for-loop</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="ruby"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="ruby"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0234px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># This is just pseudo code. It won't actually work in Terraform.</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> (<span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">3</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">resource</span> <span class="cm-string">"aws_iam_user"</span> <span class="cm-string">"example"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-string">"neo"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 134px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><p><code>Terraform</code><span> مفيش فيه </span><code>for-loops</code><span> أو أي </span><code>procedural logic</code><span> تانية تقليدية مدمجة في اللغة، عشان كده الـ </span><code>syntax</code><span> ده مش هيشتغل. لكن، كل </span><code>Terraform resource</code><span> ليه </span><code>meta-parameter</code><span> ممكن تستخدمه اسمه </span><code>count</code><span>. الـ </span><code>count</code><span> هو أقدم وأبسط وأكتر </span><code>iteration construct</code><span> (طريقة للتكرار) محدود في </span><code>Terraform</code><span>: كل اللي بيعمله هو إنه بيحدد كام نسخة من الـ </span><code>resource</code><span> ده يتعملها </span><code>create</code><span>. ودي طريقة استخدام </span><code>count</code><span> عشان تعمل </span><code>create</code><span> لتلاتة </span><code>IAM users</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0235px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_iam_user"</span> <span class="cm-string">"example"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">count</span> <span class="cm-operator">=</span> <span class="cm-number">3</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">name</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"neo"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><span>مشكلة واحدة في الكود ده هي إن التلاتة </span><code>IAM users</code><span> هيكون ليهم نفس الاسم، وده هيسبب </span><code>error</code><span>، لإن أسماء الـ </span><code>usernames</code><span> لازم تكون </span><code>unique</code><span> . لو كان عندك </span><code>standard for-loop</code><span>، كنت ممكن تستخدم الـ </span><code>index</code><span> في الـ </span><code>for-loop</code><span>، اللي هو </span><code>i</code><span>، عشان تدي لكل </span><code>user</code><span> اسم </span><code>unique</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="ruby"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="ruby"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0234px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># This is just pseudo code. It won't actually work in Terraform.</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> (<span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">3</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">resource</span> <span class="cm-string">"aws_iam_user"</span> <span class="cm-string">"example"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-string">"neo.${i}"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 134px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><p><span>عشان تحقق نفس الشيء في </span><code>Terraform</code><span>، ممكن تستخدم </span><code>count.index</code><span> عشان تجيب الـ </span><code>index</code><span> بتاع كل &quot;تكرار&quot; في الـ &quot;loop&quot;:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0234px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_iam_user"</span> <span class="cm-string">"example"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">count</span> <span class="cm-operator">=</span> <span class="cm-number">3</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">name</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"neo.${count.index}"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><span>لو عملت </span><code>run</code><span> لـ </span><code>plan command</code><span> على الكود اللي فات ده، هتشوف إن </span><code>Terraform</code><span> عايز يعمل </span><code>create</code><span> لتلاتة </span><code>IAM users</code><span>، كل واحد باسم مختلف (&quot;neo.0&quot;, &quot;neo.1&quot;, &quot;neo.2&quot;):</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0234px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Terraform will perform the following actions:</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  # aws_iam_user.example[0] will be created</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  + resource "aws_iam_user" "example" {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  + name = "neo.0"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  (...)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  # aws_iam_user.example[1] will be created</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  + resource "aws_iam_user" "example" {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  + name = "neo.1"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  (...)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  # aws_iam_user.example[2] will be created</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  + resource "aws_iam_user" "example" {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  + name = "neo.2"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  (...)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Plan: 3 to add, 0 to change, 0 to destroy.</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 470px;"></div><div class="CodeMirror-gutters" style="display: none; height: 470px;"></div></div></div></pre><p><span>طبعًا، </span><code>username</code><span> زي &quot;neo.0&quot; مش سهل استخدامه. لو دمجت </span><code>count.index</code><span> مع شوية </span><code>built-in functions</code><span> من </span><code>Terraform</code><span>، ممكن تعدّل كل &quot;تكرار&quot; في الـ &quot;loop&quot; أكتر من كده.</span></p><p><span>كمثال، ممكن تعرف كل الـ </span><code>IAM usernames</code><span> اللي عايزها في </span><code>input variable</code><span> في </span><code>live/global/iam/variables.tf</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0234px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"user_names"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"Create IAM users with these names"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">list</span>(<span class="cm-variable">string</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> &nbsp; &nbsp; <span class="cm-operator">=</span> [<span class="cm-string">"neo"</span>, <span class="cm-string">"trinity"</span>, <span class="cm-string">"morpheus"</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p><span>لو كنت بتستخدم لغة برمجة </span><code>general-purpose</code><span> فيها </span><code>loops</code><span> و </span><code>arrays</code><span>، كنت هتعمل </span><code>configure</code><span> لكل </span><code>IAM user</code><span> عشان يستخدم اسم مختلف عن طريق إنه يبص على الـ </span><code>index i</code><span> في الـ </span><code>array var.user_names</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="ruby"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="ruby"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0234px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># This is just pseudo code. It won't actually work in Terraform.</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> (<span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">3</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">resource</span> <span class="cm-string">"aws_iam_user"</span> <span class="cm-string">"example"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-variable">vars</span><span class="cm-operator">.</span><span class="cm-property">user_names</span>[<span class="cm-variable">i</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 134px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><p><span>في </span><code>Terraform</code><span>، ممكن تحقق نفس الشيء عن طريق استخدام </span><code>count</code><span> مع الآتي:</span></p><ul><li><p><strong><span>الـ </span><code>Array lookup syntax</code><span>:</span></strong>
<span>الـ </span><code>syntax</code><span> عشان تبص على عناصر الـ </span><code>array</code><span> في </span><code>Terraform</code><span> شبه معظم لغات البرمجة التانية:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0236px; left: 7.63022px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">ARRAY[&lt;INDEX&gt;]</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>كمثال، دي طريقة هتبص بيها على العنصر اللي في </span><code>index 1</code><span> من </span><code>var.user_names</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0234px; left: 7.63022px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">var.user_names[1]</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre></li><li><p><strong><span>الـ </span><code>length function</code><span>:</span></strong>
<code>Terraform</code><span> فيه </span><code>built-in function</code><span> اسمها </span><code>length</code><span> ليها الـ </span><code>syntax</code><span> ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0234px; left: 7.63022px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">length(&lt;ARRAY&gt;)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>زي ما ممكن تتوقع، الـ </span><code>length function</code><span> بترجع عدد العناصر اللي في الـ </span><code>ARRAY</code><span> اللي اديتها ليها. وهي كمان بتشتغل مع الـ </span><code>strings</code><span> والـ </span><code>maps</code><span>.</span></p></li></ul><p><span>لما نجمع دول مع بعض، بيطلعلك الكود ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0234px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_iam_user"</span> <span class="cm-string">"example"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">count</span> <span class="cm-operator">=</span> <span class="cm-variable">length</span>(<span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">user_names</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">name</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">user_names</span>[<span class="cm-variable">count</span><span class="cm-operator">.</span><span class="cm-property">index</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><span>دلوقتي لما تعمل </span><code>run</code><span> لـ </span><code>plan command</code><span>، هتشوف إن </span><code>Terraform</code><span> عايز يعمل </span><code>create</code><span> لتلاتة </span><code>IAM users</code><span>، كل واحد باسم </span><code>unique</code><span> وقابل للقراءة:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0234px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Terraform will perform the following actions:</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  # aws_iam_user.example[0] will be created</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  + resource "aws_iam_user" "example" {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  + name = "neo"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  (...)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  # aws_iam_user.example[1] will be created</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  + resource "aws_iam_user" "example" {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  + name = "trinity"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  (...)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  # aws_iam_user.example[2] will be created</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  + resource "aws_iam_user" "example" {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  + name = "morpheus"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  (...)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Plan: 3 to add, 0 to change, 0 to destroy.</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 470px;"></div><div class="CodeMirror-gutters" style="display: none; height: 470px;"></div></div></div></pre><p><span>خد بالك إن بعد ما بتستخدم </span><code>count</code><span> على </span><code>resource</code><span>، الـ </span><code>resource</code><span> ده بيتحول لـ </span><code>array</code><span> من الـ </span><code>resources</code><span> بدل ما يكون </span><code>resource</code><span> واحد بس. لإن </span><code>aws_iam_user.example</code><span> دلوقتي بقى </span><code>array</code><span> من الـ </span><code>IAM users</code><span>، فبدل ما تستخدم الـ </span><code>standard syntax</code><span> عشان تقرا </span><code>attribute</code><span> من الـ </span><code>resource</code><span> ده (</span><code>&lt;PROVIDER&gt;_&lt;TYPE&gt;.&lt;NAME&gt;.&lt;ATTRIBUTE&gt;</code><span>)، لازم تحدد أنهي </span><code>IAM user</code><span> اللي أنت مهتم بيه عن طريق تحديد الـ </span><code>index</code><span> بتاعه في الـ </span><code>array</code><span> باستخدام نفس الـ </span><code>array lookup syntax</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0236px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&lt;PROVIDER&gt;_&lt;TYPE&gt;.&lt;NAME&gt;[INDEX].ATTRIBUTE</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">aws_iam_user.example[INDEX].ATTRIBUTE</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="display: none; height: 45px;"></div></div></div></pre><p><span>كمثال، لو عايز تدي الـ </span><code>Amazon Resource Name (ARN)</code><span> بتاع أول </span><code>IAM user</code><span> في الـ </span><code>list</code><span> كـ </span><code>output variable</code><span>، هتحتاج تعمل كده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0236px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"first_arn"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">aws_iam_user</span><span class="cm-operator">.</span><span class="cm-property">example</span>[<span class="cm-number">0</span>]<span class="cm-operator">.</span><span class="cm-property">arn</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"The ARN for the first user"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><span>لو عايز الـ </span><code>ARNs</code><span> بتاعت كل الـ </span><code>IAM users</code><span>، هتحتاج تستخدم حاجة اسمها </span><code>splat expression</code><span>، اللي هي </span><code>&quot;*&quot;</code><span>، بدل الـ </span><code>index</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"all_arns"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">aws_iam_user</span><span class="cm-operator">.</span><span class="cm-property">example</span>[<span class="cm-operator">*</span>]<span class="cm-operator">.</span><span class="cm-property">arn</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"The ARNs for all users"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><span>لما تعمل </span><code>run</code><span> لـ </span><code>apply command</code><span>، الـ </span><code>output</code><span> اللي هو </span><code>first_arn</code><span> هيحتوي على الـ </span><code>ARN</code><span> بتاع </span><code>neo</code><span> بس، في حين إن الـ </span><code>all_arns output</code><span> هيحتوي على الـ </span><code>list</code><span> بتاع كل الـ </span><code>ARNs</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0236px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$ terraform</span> apply</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(...)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Apply complete! Resources: <span class="cm-number">3</span> added, <span class="cm-number">0</span> changed, <span class="cm-number">0</span> destroyed.</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Outputs:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">first_arn <span class="cm-operator">=</span> <span class="cm-string">"arn:aws:iam::123456789012:user/neo"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">all_arns <span class="cm-operator">=</span> [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string">"arn:aws:iam::123456789012:user/neo"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string">"arn:aws:iam::123456789012:user/trinity"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string">"arn:aws:iam::123456789012:user/morpheus"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">]</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 269px;"></div><div class="CodeMirror-gutters" style="display: none; height: 269px;"></div></div></div></pre><p><span>بدايةً من </span><code>Terraform 0.13</code><span>، الـ </span><code>count parameter</code><span> ممكن يستخدم على الـ </span><code>modules</code><span> كمان. كمثال، تخيل إن عندك </span><code>module</code><span> في </span><code>modules/landing-zone/iam-user</code><span> بيعمل </span><code>create</code><span> لـ </span><code>IAM user</code><span> واحد بس:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0236px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_iam_user"</span> <span class="cm-string">"example"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">user_name</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 67px;"></div><div class="CodeMirror-gutters" style="display: none; height: 67px;"></div></div></div></pre><p><span>الـ </span><code>username</code><span> بيتبعت للـ </span><code>module</code><span> ده كـ </span><code>input variable</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0236px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"user_name"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"The user name to use"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">string</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><span>والـ </span><code>module</code><span> بيرجع الـ </span><code>ARN</code><span> بتاع الـ </span><code>IAM user</code><span> اللي اتعمله </span><code>create</code><span> كـ </span><code>output variable</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0236px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"user_arn"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">aws_iam_user</span><span class="cm-operator">.</span><span class="cm-property">example</span><span class="cm-operator">.</span><span class="cm-property">arn</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"The ARN of the created IAM user"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><span>ممكن تستخدم الـ </span><code>module</code><span> ده مع </span><code>count parameter</code><span> عشان تعمل </span><code>create</code><span> لتلاتة </span><code>IAM users</code><span> بالشكل ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0236px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">module</span> <span class="cm-string">"users"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">source</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"../../../modules/landing-zone/iam-user"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">count</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">length</span>(<span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">user_names</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">user_name</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">user_names</span>[<span class="cm-variable">count</span><span class="cm-operator">.</span><span class="cm-property">index</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p><span>الكود اللي فات بيستخدم </span><code>count</code><span> عشان يعمل </span><code>loop</code><span> على الـ </span><code>list</code><span> ده من الـ </span><code>usernames</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0236px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"user_names"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"Create IAM users with these names"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">list</span>(<span class="cm-variable">string</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> &nbsp; &nbsp; <span class="cm-operator">=</span> [<span class="cm-string">"neo"</span>, <span class="cm-string">"trinity"</span>, <span class="cm-string">"morpheus"</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p><span>وهو بيطلع الـ </span><code>ARNs</code><span> بتاعت الـ </span><code>IAM users</code><span> اللي اتعملها </span><code>create</code><span> بالشكل ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0236px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"user_arns"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-keyword">module</span><span class="cm-operator">.</span><span class="cm-property">users</span>[<span class="cm-operator">*</span>]<span class="cm-operator">.</span><span class="cm-property">user_arn</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"The ARNs of the created IAM users"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><span>زي ما إضافة </span><code>count</code><span> لـ </span><code>resource</code><span> بتحوله لـ </span><code>array</code><span> من الـ </span><code>resources</code><span>، إضافة </span><code>count</code><span> لـ </span><code>module</code><span> بتحوله لـ </span><code>array</code><span> من الـ </span><code>modules</code><span>.</span></p><p><span>لو عملت </span><code>run</code><span> لـ </span><code>apply</code><span> على الكود ده، هيطلعلك الـ </span><code>output</code><span> ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$ terraform</span> apply</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(...)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Apply complete! Resources: <span class="cm-number">3</span> added, <span class="cm-number">0</span> changed, <span class="cm-number">0</span> destroyed.</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Outputs:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">all_arns <span class="cm-operator">=</span> [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string">"arn:aws:iam::123456789012:user/neo"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string">"arn:aws:iam::123456789012:user/trinity"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string">"arn:aws:iam::123456789012:user/morpheus"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">]</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 246px;"></div><div class="CodeMirror-gutters" style="display: none; height: 246px;"></div></div></div></pre><p><span>فزي ما أنت شايف، الـ </span><code>count</code><span> بيشتغل تقريبًا بنفس الطريقة مع الـ </span><code>resources</code><span> ومع الـ </span><code>modules</code><span>.</span></p><p><span>لسوء الحظ، الـ </span><code>count</code><span> فيه اتنين </span><code>limitations</code><span> (قيود) بيقللوا من فايدته بشكل كبير. أولاً، بالرغم من إنك ممكن تستخدم </span><code>count</code><span> عشان تعمل </span><code>loop</code><span> على </span><code>resource</code><span> كامل، لكن متقدرش تستخدم </span><code>count</code><span> جوه </span><code>resource</code><span> عشان تعمل </span><code>loop</code><span> على </span><code>inline blocks</code><span>. كمثال، بص على إزاي الـ </span><code>tags</code><span> بتتحط في الـ </span><code>aws_autoscaling_group resource</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0236px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_autoscaling_group"</span> <span class="cm-string">"example"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">launch_configuration</span> <span class="cm-operator">=</span> <span class="cm-variable">aws_launch_configuration</span><span class="cm-operator">.</span><span class="cm-property">example</span><span class="cm-operator">.</span><span class="cm-property">name</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">vpc_zone_identifier</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">data</span><span class="cm-operator">.</span><span class="cm-property">aws_subnets</span><span class="cm-operator">.</span><span class="cm-property">default</span><span class="cm-operator">.</span><span class="cm-property">ids</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">target_group_arns</span> &nbsp; &nbsp;<span class="cm-operator">=</span> [<span class="cm-variable">aws_lb_target_group</span><span class="cm-operator">.</span><span class="cm-property">asg</span><span class="cm-operator">.</span><span class="cm-property">arn</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">health_check_type</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"ELB"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">min_size</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">min_size</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">max_size</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">max_size</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">tag</span> { <span class="cm-comment"># &lt;--- ده Inline Block</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">key</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"Name"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">value</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">cluster_name</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">propagate_at_launch</span> <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 291px;"></div><div class="CodeMirror-gutters" style="display: none; height: 291px;"></div></div></div></pre><p>&nbsp;</p><p><span>كل </span><code>tag</code><span> بيحتاج إنك تعمل </span><code>create</code><span> لـ </span><code>inline block</code><span> جديد بـ </span><code>values</code><span> للـ </span><code>key</code><span>، والـ </span><code>value</code><span>، والـ </span><code>propagate_at_launch</code><span>. الكود اللي فات بيعمل </span><code>hardcode</code><span> لـ </span><code>tag</code><span> واحد بس، بس أنت ممكن تكون عايز تسمح للـ </span><code>users</code><span> إنهم يبعتوا </span><code>custom tags</code><span> .</span></p><div class="md-alert md-alert-tip tip"><p><span class='md-alert-text md-alert-text-tip'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>Tip</span><br></p><h3 id='propagateatlaunch'><strong><span>propagate_at_launch</span></strong></h3><p><span>ببساطة، لما بتحط tag على الـ Auto Scaling Group (ASG) نفسه، propagate_at_launch هو مفتاح بتشغله أو تقفله (true أو false) عشان يقرر مصير الـ tag ده.</span></p><ul><li><p><strong><span>لو خليتها propagate_at_launch = true (وده الشائع):</span></strong>
<span>ده معناه &quot;انشر الـ tag ده&quot;. أي EC2 instance جديدة هيعملها الـ ASG في المستقبل، هتاخد نسخة من الـ tag ده أوتوماتيك. يعني لو الـ ASG عليه tag اسمه</span>
<span> Environment = production، كل الـ instances اللي هتتنشاء منه هيتورث عنها نفس الـ tag. ده مفيد جدًا عشان تعرف تفرز الـ servers بتاعتك وتعمل عليها reports أو تطبق عليها policies.</span></p></li><li><p><strong><span>لو خليتها propagate_at_launch = false:</span></strong>
<span>ده معناه &quot;خلي الـ tag ده على الـ ASG بس ومتديهوش للـ instances الجديدة&quot;. الـ tag هيفضل موجود على الـ ASG نفسه كمعلومة ليه، لكن أي instance هتتنشاء هتبقى من غير الـ tag ده. الحالة دي استخدامها نادر، وممكن تكون مفيدة لو الـ tag ده خاص بإدارة الـ ASG نفسه ومش له علاقة بالـ instances اللي جواه.</span></p></li></ul></div><p><span>ممكن تيجي في بالك إنك تحاول تستخدم الـ </span><code>count parameter</code><span> عشان تعمل </span><code>loop</code><span> على الـ </span><code>tags</code><span> دي وتعمل </span><code>generate</code><span> لـ </span><code>dynamic inline tag blocks</code><span>، بس للأسف، استخدام </span><code>count</code><span> جوه </span><code>inline block</code><span> مش مدعوم.</span></p><p><span>الـ </span><code>limitation</code><span> التاني مع الـ </span><code>count</code><span> هو إيه اللي بيحصل لما تحاول تغير الـ </span><code>value</code><span> بتاعته. بص على الـ </span><code>list</code><span> بتاع الـ </span><code>IAM users</code><span> اللي عملته قبل كده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"user_names"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"Create IAM users with these names"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">list</span>(<span class="cm-variable">string</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> &nbsp; &nbsp; <span class="cm-operator">=</span> [<span class="cm-string">"neo"</span>, <span class="cm-string">"trinity"</span>, <span class="cm-string">"morpheus"</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p><span>تخيل إنك مسحت &quot;trinity&quot; من الـ </span><code>list</code><span> ده. إيه اللي بيحصل لما تعمل </span><code>run</code><span> لـ </span><code>terraform plan</code><span>؟</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">$ terraform plan</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(...)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Terraform will perform the following actions:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  # aws_iam_user.example[1] will be updated in-place</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  ~ resource "aws_iam_user" "example" {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  id &nbsp; = "trinity"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  ~ name = "trinity" -&gt; "morpheus"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  # aws_iam_user.example[2] will be destroyed</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  - resource "aws_iam_user" "example" {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  - id &nbsp; = "morpheus" -&gt; null</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  - name = "morpheus" -&gt; null</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Plan: 0 to add, 1 to change, 1 to destroy.</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 381px;"></div><div class="CodeMirror-gutters" style="display: none; height: 381px;"></div></div></div></pre><p><span>استنى دقيقة، ده غالبًا مش اللي كنت متوقعه! بدل ما يمسح الـ </span><code>IAM user</code><span> اللي اسمه &quot;trinity&quot; بس،</span>
<span> الـ </span><code>plan output</code><span> بيقول إن </span><code>Terraform</code><span> عايز يغير اسم الـ </span><code>IAM user</code><span> اللي اسمه &quot;trinity&quot; لـ &quot;morpheus&quot; ويمسح الـ </span><code>user</code><span> الأصلي اللي اسمه &quot;morpheus&quot;. إيه اللي بيحصل؟</span></p><p><span>لما بتستخدم الـ </span><code>count parameter</code><span> على </span><code>resource</code><span>، الـ </span><code>resource</code><span> ده بيتحول لـ </span><code>array</code><span> من الـ </span><code>resources</code><span>. للأسف، الطريقة اللي </span><code>Terraform</code><span> بيعرف بيها كل </span><code>resource</code><span> جوه الـ </span><code>array</code><span> ده بتكون عن طريق موقعه (</span><code>index</code><span>) في الـ </span><code>array</code><span> ده. بمعنى تاني، بعد ما عملت </span><code>run</code><span> لـ </span><code>apply</code><span> أول مرة بتلاتة </span><code>usernames</code><span>، التمثيل الداخلي لـ </span><code>Terraform</code><span> للـ </span><code>IAM users</code><span> دول شكله عامل كده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">aws_iam_user.example[0]: neo</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">aws_iam_user.example[1]: trinity</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">aws_iam_user.example[2]: morpheus</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 67px;"></div><div class="CodeMirror-gutters" style="display: none; height: 67px;"></div></div></div></pre><p><span>لما بتمسح </span><code>item</code><span> من نص الـ </span><code>array</code><span>، كل الـ </span><code>items</code><span> اللي بعده بتتحرك مكانها خطوة لورا، عشان كده بعد ما تعمل </span><code>run</code><span> لـ </span><code>plan</code><span> بـ </span><code>bucket names</code><span> اتنين بس، التمثيل الداخلي لـ </span><code>Terraform</code><span> هيكون شكله عامل كده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">aws_iam_user.example[0]: neo</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">aws_iam_user.example[1]: morpheus</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="display: none; height: 45px;"></div></div></div></pre><p><span>لاحظ إزاي &quot;morpheus&quot; اتحرك من </span><code>index 2</code><span> لـ </span><code>index 1</code><span>. ولأنه بيشوف الـ </span><code>index</code><span> على إنه هو </span><code>identity</code><span> (هوية) الـ </span><code>resource</code><span>، فبالنسبة لـ </span><code>Terraform</code><span>، التغيير ده بيترجم تقريباً لـ &quot;غيّر اسم الـ </span><code>bucket</code><span> اللي في </span><code>index 1</code><span> لـ morpheus وامسح الـ </span><code>bucket</code><span> اللي في </span><code>index 2</code><span>.&quot;</span></p><p><span>بمعنى تاني، كل مرة بتستخدم </span><code>count</code><span> عشان تعمل </span><code>create</code><span> لـ </span><code>list</code><span> من الـ </span><code>resources</code><span>، لو مسحت </span><code>item</code><span> من نص الـ </span><code>list</code><span>، </span><code>Terraform</code><span> هيمسح كل </span><code>resource</code><span> بعد الـ </span><code>item</code><span> ده وبعدين يعمل </span><code>re-create</code><span> للـ </span><code>resources</code><span> دي تاني من الصفر. آخ.</span></p><p><span>النتيجة النهائية، طبعًا، هي بالظبط اللي طلبته (يعني اتنين </span><code>IAM users</code><span> اسمهم &quot;morpheus&quot; و &quot;neo&quot;)، بس مسح الـ </span><code>resources</code><span> ده غالبًا مش الطريقة اللي عايز توصل بيها لنتيجة، لإنك ممكن تخسر </span><code>availability</code><span> (متقدرش تستخدم الـ </span><code>IAM user</code><span> خلال الـ </span><code>apply</code><span>)، والأسوأ من كده، ممكن تخسر </span><code>data</code><span> (لو الـ </span><code>resource</code><span> اللي بتمسحه ده </span><code>database</code><span>، ممكن تخسر كل الـ </span><code>data</code><span> اللي جواه!).</span></p><p><span>عشان نحل الـ </span><code>limitations</code><span> دول، </span><code>Terraform 0.12</code><span> قدّم الـ </span><code>for_each expressions</code><span>.</span></p><hr /><h4 id='شوية-امثلة'><span>شوية امثلة</span></h4><h5 id='1-استخدام-count-عشان-تعمل-create-لكذا-resource-بنفس-الإعدادات'><strong><span>1. استخدام </span><code>count</code><span> عشان تعمل </span><code>create</code><span> لكذا </span><code>Resource</code><span> بنفس الإعدادات:</span></strong></h5><p><span>ده أبسط استخدام للـ </span><code>count</code><span>. بيعمل </span><code>create</code><span> لعدد معين من الـ </span><code>resources</code><span> المتطابقة تمامًا.</span></p><ul><li><p><strong><span>مثال: عمل </span><code>create</code><span> لـ 3 </span><code>EC2 Instances</code><span> متطابقة:</span></strong>
<span>لو عايز 3 سيرفرات </span><code>EC2</code><span> بنفس المواصفات.</span></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_instance"</span> <span class="cm-string">"web_server"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">count</span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-number">3</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">ami</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"ami-0abcdef1234567890"</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">instance_type</span> <span class="cm-operator">=</span> <span class="cm-string">"t2.micro"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># ... (أي إعدادات تانية)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 134px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><p>&nbsp;</p><ul><li><p><span>الكود ده هيعمل </span><code>create</code><span> لـ 3 </span><code>EC2 instances</code><span> بنفس الـ </span><code>AMI</code><span> ونفس الـ </span><code>instance_type</code><span> بالظبط.</span></p></li></ul><h4 id='2-استخدام-countindex-عشان-تخلي-الـ-resources-unique'><strong><span>2. استخدام </span><code>count.index</code><span> عشان تخلي الـ </span><code>Resources</code><span> </span><code>Unique</code><span>:</span></strong></h4><p><span>عشان الـ </span><code>resources</code><span> اللي بتتعمل بـ </span><code>count</code><span> تكون </span><code>unique</code><span> ، بنستخدم </span><code>count.index</code><span> عشان نديها أسماء مختلفة أو </span><code>attributes</code><span> مختلفة.</span></p><ul><li><p><strong><span>مثال: عمل </span><code>create</code><span> لـ 5 </span><code>S3 Buckets</code><span> بأسماء مختلفة:</span></strong>
<span>لو عايز 5 </span><code>buckets</code><span> وكل واحد ليه اسم مميز.</span></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_s3_bucket"</span> <span class="cm-string">"data_storage"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">count</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-number">5</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">bucket</span> <span class="cm-operator">=</span> <span class="cm-string">"my-unique-bucket-${count.index}"</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">acl</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"private"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># ... (أي إعدادات تانية)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 134px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><p>&nbsp;</p><ul><li><p><span>هيعمل </span><code>create</code><span> لـ 5 </span><code>S3 buckets</code><span>، الـ </span><code>index</code><span> بتاع الـ </span><code>count</code><span> هيستخدم عشان يدي كل </span><code>bucket</code><span> اسم </span><code>unique</code><span>.</span></p></li><li><p><strong><span>مثال: عمل </span><code>create</code><span> لـ </span><code>IAM Users</code><span> من </span><code>List</code><span> (باستخدام </span><code>length</code><span> و </span><code>count.index</code><span>):</span></strong>
<span>دي الطريقة اللي كنا بنعمل بيها </span><code>loop</code><span> على </span><code>list</code><span> من الـ </span><code>strings</code><span> قبل </span><code>for_each</code><span>.</span></p><ul><li><p><strong><span>الـ </span><code>Variable</code><span>:</span></strong></p></li></ul></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"iam_user_names"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"List of IAM user names to create"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">list</span>(<span class="cm-variable">string</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> &nbsp; &nbsp; <span class="cm-operator">=</span> [<span class="cm-string">"neo"</span>, <span class="cm-string">"trinity"</span>, <span class="cm-string">"morpheus"</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><ul><li><p><strong><span>الـ </span><code>Resource</code><span> مع </span><code>count</code><span>:</span></strong></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_iam_user"</span> <span class="cm-string">"app_users_count"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">count</span> <span class="cm-operator">=</span> <span class="cm-variable">length</span>(<span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">iam_user_names</span>) </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">name</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">iam_user_names</span>[<span class="cm-variable">count</span><span class="cm-operator">.</span><span class="cm-property">index</span>] </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p>&nbsp;</p><ul><li><p><span>هيعمل </span><code>create</code><span> لـ </span><code>users</code><span> بالأسماء &quot;neo&quot;, &quot;trinity&quot;, &quot;morpheus&quot;.</span></p></li></ul><h4 id='3-الوصول-لـ-resources-معمولها-create-بـ-count'><strong><span>3. الوصول لـ </span><code>Resources</code><span> معمولها </span><code>create</code><span> بـ </span><code>count</code><span>:</span></strong></h4><p><span>لما بتستخدم </span><code>count</code><span>، الـ </span><code>resource</code><span> بيتحول لـ </span><code>array</code><span> في الـ </span><code>Terraform state</code><span>. عشان توصل لأي </span><code>attribute</code><span> منه، بتستخدم </span><code>array lookup syntax</code><span>.</span></p><ul><li><p><strong><span>مثال: الوصول لـ </span><code>ARN</code><span> بتاع </span><code>user</code><span> معين:</span></strong>
<span>لو عايز الـ </span><code>ARN</code><span> بتاع </span><code>user</code><span> معين من الـ </span><code>IAM users</code><span> اللي عملتها بـ </span><code>count</code><span>.</span></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"morpheus_user_arn"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">aws_iam_user</span><span class="cm-operator">.</span><span class="cm-property">app_users_count</span>[<span class="cm-number">2</span>]<span class="cm-operator">.</span><span class="cm-property">arn</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"The ARN for the Morpheus IAM user."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p>&nbsp;</p><ul><li><p><strong><span>مثال: جمع كل الـ </span><code>ARNs</code><span> باستخدام </span><code>Splat Expression</code><span>:</span></strong>
<span>عشان تجيب </span><code>attribute</code><span> معين من كل الـ </span><code>resources</code><span> اللي اتعملت بـ </span><code>count</code><span> في </span><code>list</code><span> واحد.</span></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"all_iam_users_arns"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">aws_iam_user</span><span class="cm-operator">.</span><span class="cm-property">app_users_count</span>[<span class="cm-operator">*</span>]<span class="cm-operator">.</span><span class="cm-property">arn</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"All ARNs of the created IAM users."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p>&nbsp;</p><h4 id='4-استخدام-count-مع-modules'><strong><span>4. استخدام </span><code>count</code><span> مع </span><code>Modules</code><span>:</span></strong></h4><p><span>زي ما بيشتغل مع الـ </span><code>resources</code><span>، </span><code>count</code><span> ممكن يستخدم كمان مع الـ </span><code>modules</code><span> عشان تعمل </span><code>create</code><span> لعدة نسخ من نفس الـ </span><code>module</code><span>.</span></p><ul><li><p><strong><span>مثال: عمل </span><code>create</code><span> لـ 2 </span><code>Web Server Clusters</code><span> في 2 </span><code>regions</code><span> مختلفة:</span></strong></p><ul><li><p><strong><span>الـ </span><code>Variable</code><span>:</span></strong></p></li></ul></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"cluster_regions"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"List of regions to deploy web server clusters"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">list</span>(<span class="cm-variable">string</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> &nbsp; &nbsp; <span class="cm-operator">=</span> [<span class="cm-string">"us-east-1"</span>, <span class="cm-string">"eu-west-1"</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p>&nbsp;</p><ul><li><p><strong><span>الـ </span><code>Module</code><span> مع </span><code>count</code><span>:</span></strong></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">module</span> <span class="cm-string">"web_cluster_by_region"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">source</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"../modules/webserver-cluster"</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">count</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">length</span>(<span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">cluster_regions</span>) </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">aws_region</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">cluster_regions</span>[<span class="cm-variable">count</span><span class="cm-operator">.</span><span class="cm-property">index</span>] &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">cluster_name</span> <span class="cm-operator">=</span> <span class="cm-string">"my-cluster-${count.index}"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 157px;"></div><div class="CodeMirror-gutters" style="display: none; height: 157px;"></div></div></div></pre><p>&nbsp;</p><ul><li><p><span>ده هيعمل </span><code>create</code><span> لـ 2 </span><code>web server clusters</code><span>، كل واحد في </span><code>region</code><span> مختلف.</span></p></li></ul><p><strong><span>ملاحظة هامة (حدود </span><code>count</code><span>):</span></strong>
<span>زي ما ذكرنا قبل كده، </span><code>count</code><span> فيه </span><code>limitations</code><span>. أهمها:</span></p><ol start='' ><li><p><strong><span>مش بيشتغل مع الـ </span><code>inline blocks</code><span>:</span></strong><span> يعني متقدرش تستخدم </span><code>count</code><span> جوه </span><code>resource</code><span> عشان تعمل </span><code>loop</code><span> على </span><code>tags</code><span> أو </span><code>ingress rules</code><span> مثلاً.</span></p></li><li><p><strong><span>مشكلة الـ </span><code>re-creation</code><span> لما بتعدل في الـ </span><code>list</code><span>:</span></strong><span> لو عندك </span><code>resource</code><span> معمول بـ </span><code>count</code><span> على </span><code>list</code><span>، ومسحت عنصر من نص الـ </span><code>list</code><span> ده، </span><code>Terraform</code><span> هيمسح كل الـ </span><code>resources</code><span> اللي بعد العنصر اللي اتمسح ويعيد إنشاءها تاني، وده ممكن يسبب </span><code>downtime</code><span> أو فقدان للبيانات.</span></p></li></ol><p><span>عشان كده، في معظم الحالات، يفضل استخدام </span><code>for_each</code><span> بدل </span><code>count</code><span> لما تكون بتعمل </span><code>loop</code><span> على </span><code>collection</code><span> (ليست أو ماب) وتكون عايز </span><code>stability</code><span> في حالة التغيير. لكن </span><code>count</code><span> لسه مفيد جدًا في حالات بسيطة زي لما عايز تعمل عدد ثابت من الـ </span><code>resources</code><span> ومش قلقان من ترتيبها أو تغييرها.</span></p><h3 id='loops-with-foreach-expressions'><span>Loops with for_each Expressions</span></h3><p><span>الـ </span><code>for_each expression</code><span> بيسمحلك تعمل </span><code>loop</code><span> على الـ </span><code>lists</code><span>، والـ </span><code>sets</code><span>، والـ </span><code>maps</code><span> عشان تعمل </span><code>create</code><span> لـ</span></p><p><span> (أ) كذا نسخة من </span><code>resource</code><span> كامل،</span></p><p><span> (ب) كذا نسخة من </span><code>inline block</code><span> جوه </span><code>resource</code><span>، </span></p><p><span>(ج) كذا نسخة من </span><code>module</code><span>. </span></p><p><span>خلينا الأول نمشي خطوة بخطوة في إزاي تستخدم </span><code>for_each</code><span> عشان تعمل </span><code>create</code><span> لكذا نسخة من </span><code>resource</code><span>.</span></p><p><span>الـ </span><code>syntax</code><span> بتاعه شكله كده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"&lt;PROVIDER&gt;_&lt;TYPE&gt;"</span> <span class="cm-string">"&lt;NAME&gt;"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">for_each</span> <span class="cm-operator">=</span> <span class="cm-operator">&lt;</span><span class="cm-tag">COLLECTION</span><span class="cm-operator">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[<span class="cm-tag">CONFIG</span> <span class="cm-operator">...</span>]</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><span>حيث إن </span><code>COLLECTION</code><span> دي بتكون </span><code>set</code><span> أو </span><code>map</code><span> عشان تعمل عليها </span><code>loop</code><span> (الـ </span><code>lists</code><span> مش مدعومة لما بتستخدم </span><code>for_each</code><span> على </span><code>resource</code><span>)، والـ </span><code>CONFIG</code><span> بيكون عبارة عن </span><code>argument</code><span> واحد أو أكتر خاص بالـ </span><code>resource</code><span> ده. جوه الـ </span><code>CONFIG</code><span>، ممكن تستخدم </span><code>each.key</code><span> و </span><code>each.value</code><span> عشان توصل للـ </span><code>key</code><span> والـ </span><code>value</code><span> بتاع العنصر الحالي في الـ </span><code>COLLECTION</code><span>.</span></p><p><span>كمثال، دي الطريقة اللي ممكن تعمل بيها </span><code>create</code><span> لنفس التلاتة </span><code>IAM users</code><span> باستخدام </span><code>for_each</code><span> على </span><code>resource</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_iam_user"</span> <span class="cm-string">"example"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">for_each</span> <span class="cm-operator">=</span> <span class="cm-variable">toset</span>(<span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">user_names</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">name</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">each</span><span class="cm-operator">.</span><span class="cm-property">value</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><span>لاحظ استخدام </span><code>toset</code><span> عشان تحول الـ </span><code>var.user_names list</code><span> لـ </span><code>set</code><span>. ده لإن الـ </span><code>for_each</code><span> بيدعم الـ </span><code>sets</code><span> والـ </span><code>maps</code><span> بس لما بيستخدم على </span><code>resource</code><span>. لما الـ </span><code>for_each</code><span> بيعمل </span><code>loop</code><span> على الـ </span><code>set</code><span> ده، بيخلي كل </span><code>username</code><span> هو في </span><code>each.value</code><span>. الـ </span><code>username</code><span> هيكون هو كمان في </span><code>each.key</code><span>، بالرغم من إنك عادةً بتستخدم </span><code>each.key</code><span> مع الـ </span><code>maps</code><span> اللي بتكون عبارة عن</span>
<span> </span><code>key-value pairs</code><span>.</span></p><p><span>بمجرد ما بتستخدم </span><code>for_each</code><span> على </span><code>resource</code><span>، الـ </span><code>resource</code><span> ده بيتحول لـ </span><code>map</code><span> من الـ </span><code>resources</code><span>، بدل ما يكون </span><code>resource</code><span> واحد بس (أو </span><code>array</code><span> من الـ </span><code>resources</code><span> زي ما بيحصل مع </span><code>count</code><span>). عشان تشوف ده معناه إيه، امسح الـ </span><code>output variables</code><span> الأصلية اللي هما </span><code>all_arns</code><span> و </span><code>first_arn</code><span>، وضيف </span><code>output variable</code><span> جديد اسمه </span><code>all_users</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"all_users"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-variable">aws_iam_user</span><span class="cm-operator">.</span><span class="cm-property">example</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 67px;"></div><div class="CodeMirror-gutters" style="display: none; height: 67px;"></div></div></div></pre><p><span>وده اللي بيحصل لما تعمل </span><code>run</code><span> لـ </span><code>terraform apply</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">$ terraform apply</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(...)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Apply complete! Resources: 3 added, 0 changed, 0 destroyed.</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Outputs:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">all_users = {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  "morpheus" = {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  "arn" = "arn:aws:iam::123456789012:user/morpheus"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  "force_destroy" = false</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  "id" = "morpheus"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  "name" = "morpheus"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  "path" = "/"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  "tags" = {}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  "neo" = {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  "arn" = "arn:aws:iam::123456789012:user/neo"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  "force_destroy" = false</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  "id" = "neo"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  "name" = "neo"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  "path" = "/"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  "tags" = {}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  "trinity" = {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  "arn" = "arn:aws:iam::123456789012:user/trinity"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  "force_destroy" = false</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  "id" = "trinity"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  "name" = "trinity"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  "path" = "/"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  "tags" = {}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 717px;"></div><div class="CodeMirror-gutters" style="display: none; height: 717px;"></div></div></div></pre><p><span>هتشوف إن </span><code>Terraform</code><span> عمل </span><code>create</code><span> لتلاتة </span><code>IAM users</code><span> وإن الـ </span><code>all_users output variable</code><span> بيحتوي على </span><code>map</code><span>، حيث الـ </span><code>keys</code><span> هي الـ </span><code>keys</code><span> اللي في الـ </span><code>for_each</code><span> (في الحالة دي، أسماء الـ </span><code>users</code><span>) والـ </span><code>values</code><span> هي كل الـ </span><code>outputs</code><span> للـ </span><code>resource</code><span> ده.</span></p><p><span>لو عايز ترجع الـ </span><code>all_arns output variable</code><span> تاني، هتحتاج تعمل شوية شغل زيادة عشان تستخرج الـ </span><code>ARNs</code><span> دي باستخدام الـ </span><code>values built-in function</code><span> (اللي بترجع الـ </span><code>values</code><span> بس من </span><code>map</code><span>) و </span><code>splat expression</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"all_arns"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-variable">values</span>(<span class="cm-variable">aws_iam_user</span><span class="cm-operator">.</span><span class="cm-property">example</span>)[<span class="cm-operator">*</span>]<span class="cm-operator">.</span><span class="cm-property">arn</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 67px;"></div><div class="CodeMirror-gutters" style="display: none; height: 67px;"></div></div></div></pre><p><span>ده بيديلك الـ </span><code>output</code><span> المتوقع وممكن كمان تستخدام دالة  keys </span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">$ terraform apply</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(...)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Apply complete! Resources: 0 added, 0 changed, 0 destroyed.</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Outputs:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">all_arns = [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  "arn:aws:iam::123456789012:user/morpheus",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  "arn:aws:iam::123456789012:user/neo",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  "arn:aws:iam::123456789012:user/trinity",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">]</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 246px;"></div><div class="CodeMirror-gutters" style="display: none; height: 246px;"></div></div></div></pre><p><span>الحقيقة إنك دلوقتي بقيت بتتعامل مع </span><code>map</code><span> من الـ </span><code>resources</code><span> بـ </span><code>for_each</code><span> بدل ما كنت بتتعامل مع </span><code>array</code><span> من الـ </span><code>resources</code><span> بـ </span><code>count</code><span>، ودي حاجة </span><code>big deal</code><span>، لإنها بتسمحلك تمسح </span><code>items</code><span> من نص الـ </span><code>collection</code><span> بأمان. كمثال، لو مسحت &quot;trinity&quot; تاني من نص الـ </span><code>var.user_names list</code><span> وعملت </span><code>run</code><span> لـ </span><code>terraform plan</code><span>، ده اللي هتشوفه:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">$ terraform plan</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Terraform will perform the following actions:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  # aws_iam_user.example["trinity"] will be destroyed</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  - resource "aws_iam_user" "example" {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  - arn  = "arn:aws:iam::123456789012:user/trinity" -&gt; null</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  - name = "trinity" -&gt; null</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Plan: 0 to add, 0 to change, 1 to destroy.</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 224px;"></div><div class="CodeMirror-gutters" style="display: none; height: 224px;"></div></div></div></pre><p><span>أه، كده مظبوط! أنت دلوقتي بتمسح الـ </span><code>resource</code><span> المحدد اللي عايزه بس، من غير ما تحرك كل الـ </span><code>resources</code><span> التانية. ده سبب إنك المفروض دايمًا تفضل استخدام </span><code>for_each</code><span> بدل </span><code>count</code><span> عشان تعمل </span><code>create</code><span> لكذا نسخة من </span><code>resource</code><span>.</span></p><p><span>الـ </span><code>for_each</code><span> بيشتغل مع الـ </span><code>modules</code><span> بنفس الطريقة تقريبًا. باستخدام الـ </span><code>iam-user module</code><span> اللي شفناه قبل كده، ممكن تعمل </span><code>create</code><span> لتلاتة </span><code>IAM users</code><span> عن طريقه باستخدام </span><code>for_each</code><span> بالشكل ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">module</span> <span class="cm-string">"users"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">source</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"../../../modules/landing-zone/iam-user"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">for_each</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">toset</span>(<span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">user_names</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">user_name</span> <span class="cm-operator">=</span> <span class="cm-variable">each</span><span class="cm-operator">.</span><span class="cm-property">value</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p><span>وممكن تطلع الـ </span><code>ARNs</code><span> بتاعت الـ </span><code>users</code><span> دول بالشكل ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"user_arns"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">values</span>(<span class="cm-keyword">module</span><span class="cm-operator">.</span><span class="cm-property">users</span>)[<span class="cm-operator">*</span>]<span class="cm-operator">.</span><span class="cm-property">user_arn</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"The ARNs of the created IAM users"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><span>لما تعمل </span><code>run</code><span> لـ </span><code>apply</code><span> على الكود ده، هيطلعلك الـ </span><code>output</code><span> المتوقع:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">$ terraform apply</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(...)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Apply complete! Resources: 3 added, 0 changed, 0 destroyed.</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Outputs:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">all_arns = [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  "arn:aws:iam::123456789012:user/morpheus",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  "arn:aws:iam::123456789012:user/neo",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  "arn:aws:iam::123456789012:user/trinity",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">]</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 246px;"></div><div class="CodeMirror-gutters" style="display: none; height: 246px;"></div></div></div></pre><p><span>دلوقتي خلينا نركز على ميزة تانية لـ </span><code>for_each</code><span>: قدرته على عمل </span><code>create</code><span> لكذا </span><code>inline block</code><span> جوه </span><code>resource</code><span>. كمثال، ممكن تستخدم </span><code>for_each</code><span> عشان تعمل </span><code>generate</code><span> بشكل </span><code>dynamically</code><span> لـ </span><code>tag inline blocks</code><span> للـ </span><code>ASG</code><span> في الـ </span><code>webserver-cluster module</code><span>. أولاً، عشان تسمح للـ </span><code>users</code><span> إنهم يحددوا </span><code>custom tags</code><span>، ضيف </span><code>map input variable</code><span> جديد اسمه </span><code>custom_tags</code><span> في </span><code>modules/services/webserver-cluster/variables.tf</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"custom_tags"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"Custom tags to set on the Instances in the ASG"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">map</span>(<span class="cm-variable">string</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> &nbsp; &nbsp; <span class="cm-operator">=</span> {}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p><span>بعد كده، حدد شوية </span><code>custom tags</code><span> في الـ </span><code>production environment</code><span>، في </span><code>live/prod/services/webserver-cluster/main.tf</code><span>، بالشكل ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">module</span> <span class="cm-string">"webserver_cluster"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">source</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"../../../../modules/services/webserver-cluster"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">cluster_name</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"webservers-prod"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">db_remote_state_bucket</span> <span class="cm-operator">=</span> <span class="cm-string">"(YOUR_BUCKET_NAME)"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">db_remote_state_key</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"prod/data-stores/mysql/terraform.tfstate"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">instance_type</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"m4.large"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">min_size</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-number">2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">max_size</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-number">10</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">custom_tags</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag">Owner</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"team-foo"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag">ManagedBy</span> <span class="cm-operator">=</span> <span class="cm-string">"terraform"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 314px;"></div><div class="CodeMirror-gutters" style="display: none; height: 314px;"></div></div></div></pre><p><span>الكود اللي فات بيحدد اتنين </span><code>tags</code><span> مفيدين: الـ </span><code>Owner tag</code><span> بيحدد أنهي </span><code>team</code><span> بيملك الـ </span><code>ASG</code><span> ده، والـ </span><code>ManagedBy tag</code><span> بيحدد إن الـ </span><code>infrastructure</code><span> دي معمولها </span><code>manage</code><span> بـ </span><code>Terraform</code><span> (وده بيدل على إن الـ </span><code>infrastructure</code><span> دي المفروض متتعدلش يدويًا).</span></p><div class="md-alert md-alert-important important"><p><span class='md-alert-text md-alert-text-important'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Important</span><br></p><p><span>الـ </span><code>propagate_at_launch = true</code><span> ده </span><code>parameter</code><span> بتلاقيه جوه الـ </span><code>tag block</code><span> بتاع </span><code>resource</code><span> زي الـ </span><code>aws_autoscaling_group</code><span>.</span></p><p><strong><span>معناه إيه؟</span></strong>
<span>لما بتدي </span><code>tag</code><span> لـ </span><code>Auto Scaling Group</code><span> (ASG)، الـ </span><code>tag</code><span> ده بيكون مربوط بالـ </span><code>ASG</code><span> نفسه. لو عايز الـ </span><code>tag</code><span> ده يتنقل تلقائيًا ويتضاف كمان على </span><strong><span>كل </span><code>EC2 instance</code><span> جديدة</span></strong><span> الـ </span><code>ASG</code><span> ده هيعملها </span><code>launch</code><span> (تشغيل)، بتحط </span><code>propagate_at_launch = true</code><span>.</span></p><p><span>هي بتخلي الـ </span><code>tag</code><span> اللي على الـ </span><code>ASG</code><span> &quot;يتورّث&quot; أو &quot;يتنسخ&quot; أوتوماتيكيًا لكل الـ </span><code>servers</code><span> اللي الـ </span><code>ASG</code><span> ده بيقومها.</span></p><p><strong><span>ليه بنحتاجها؟</span></strong>
<span>دي بتخلي إدارة الـ </span><code>instances</code><span> أسهل بكتير. بدل ما تضطر تحط الـ </span><code>tags</code><span> على كل </span><code>instance</code><span> لوحدها لما تقوم، الـ </span><code>ASG</code><span> بيتولى المهمة دي عنك. وده مهم جداً للـ </span><code>filtering</code><span>  والـ </span><code>cost allocation</code><span> (توزيع التكاليف) في </span><code>AWS Console</code><span> أو أي </span><code>tool</code><span> تاني بيعتمد على الـ </span><code>tags</code><span>.</span></p><p>&nbsp;</p></div><p><span>دلوقتي بما إنك حددت الـ </span><code>tags</code><span> بتاعتك، إزاي ممكن تحطها بالفعل على الـ </span><code>aws_autoscaling_group resource</code><span>؟ اللي أنت محتاجه هو </span><code>for-loop</code><span> على الـ </span><code>var.custom_tags</code><span>، شبه الـ </span><code>pseudocode</code><span> اللي جاي ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_autoscaling_group"</span> <span class="cm-string">"example"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">launch_configuration</span> <span class="cm-operator">=</span> <span class="cm-variable">aws_launch_configuration</span><span class="cm-operator">.</span><span class="cm-property">example</span><span class="cm-operator">.</span><span class="cm-property">name</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">vpc_zone_identifier</span> <span class="cm-operator">=</span> <span class="cm-variable">data</span><span class="cm-operator">.</span><span class="cm-property">aws_subnets</span><span class="cm-operator">.</span><span class="cm-property">default</span><span class="cm-operator">.</span><span class="cm-property">ids</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">target_group_arns</span> &nbsp; &nbsp;<span class="cm-operator">=</span> [<span class="cm-variable">aws_lb_target_group</span><span class="cm-operator">.</span><span class="cm-property">asg</span><span class="cm-operator">.</span><span class="cm-property">arn</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">health_check_type</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"ELB"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">min_size</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">min_size</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">max_size</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">max_size</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">tag</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">key</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"Name"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">value</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">cluster_name</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">propagate_at_launch</span> <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># This is just pseudo code. It won't actually work in Terraform.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">for</span> (<span class="cm-variable">tag</span> <span class="cm-keyword">in</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">custom_tags</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">tag</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">key</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">tag</span><span class="cm-operator">.</span><span class="cm-property">key</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">value</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">tag</span><span class="cm-operator">.</span><span class="cm-property">value</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">propagate_at_launch</span> <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 470px;"></div><div class="CodeMirror-gutters" style="display: none; height: 470px;"></div></div></div></pre><p><span>الـ </span><code>pseudocode</code><span> اللي فات ده مش هيشتغل، بس الـ </span><code>for_each expression</code><span> هيشتغل. الـ </span><code>syntax</code><span> بتاع استخدام </span><code>for_each</code><span> عشان تعمل </span><code>generate</code><span> لـ </span><code>inline blocks</code><span> بشكل </span><code>dynamically</code><span> شكله كده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dynamic</span> <span class="cm-string">"&lt;VAR_NAME&gt;"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">for_each</span> <span class="cm-operator">=</span> <span class="cm-operator">&lt;</span><span class="cm-tag">COLLECTION</span><span class="cm-operator">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">content</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  [<span class="cm-tag">CONFIG</span><span class="cm-operator">...</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 179px;"></div><div class="CodeMirror-gutters" style="display: none; height: 179px;"></div></div></div></pre><p><span>حيث إن </span><code>VAR_NAME</code><span> ده هو الاسم اللي هتستخدمه للـ </span><code>variable</code><span> اللي هيخزن قيمة كل &quot;تكرار&quot; (</span><code>iteration</code><span>) دا اسم inline block بمعنى اصح الفكرة انت بتحط اسمه وهو بيكرره وهو الاسم اللي هتنده بيه key و value من collection، والـ </span><code>COLLECTION</code><span> هي </span><code>list</code><span> أو </span><code>map</code><span> عشان تعمل عليها </span><code>iterate</code><span> (تكرار)، والـ </span><code>content block</code><span> ده هو اللي هيتعمله </span><code>generate</code><span> من كل </span><code>iteration</code><span>. ممكن تستخدم </span><code>&lt;VAR_NAME&gt;.key</code><span> و </span><code>&lt;VAR_NAME&gt;.value</code><span> جوه الـ </span><code>content block</code><span> عشان توصل للـ </span><code>key</code><span> والـ </span><code>value</code><span> ، للعنصر الحالي في الـ </span><code>COLLECTION</code><span>. خد بالك إنك لما بتستخدم </span><code>for_each</code><span> مع </span><code>list</code><span>، الـ </span><code>key</code><span> هيكون هو الـ </span><code>index</code><span>، والـ </span><code>value</code><span> هيكون هو الـ </span><code>item</code><span> اللي في الـ </span><code>list</code><span> عند الـ </span><code>index</code><span> ده. ولما بتستخدم </span><code>for_each</code><span> مع </span><code>map</code><span>، الـ </span><code>key</code><span> والـ </span><code>value</code><span> هيكونوا واحد من</span>
<span> الـ </span><code>key-value pairs</code><span> اللي في الـ </span><code>map</code><span>.</span></p><p><span>لما نجمع كل ده مع بعض، دي الطريقة اللي ممكن تعمل بيها </span><code>generate</code><span> لـ </span><code>tag blocks</code><span> بشكل </span><code>dynamically</code><span> باستخدام </span><code>for_each</code><span> في الـ </span><code>aws_autoscaling_group resource</code><span> (هنا </span><code>VAR_NAME</code><span> هو </span><code>tag</code><span>):</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_autoscaling_group"</span> <span class="cm-string">"example"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">launch_configuration</span> <span class="cm-operator">=</span> <span class="cm-variable">aws_launch_configuration</span><span class="cm-operator">.</span><span class="cm-property">example</span><span class="cm-operator">.</span><span class="cm-property">name</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">vpc_zone_identifier</span> <span class="cm-operator">=</span> <span class="cm-variable">data</span><span class="cm-operator">.</span><span class="cm-property">aws_subnets</span><span class="cm-operator">.</span><span class="cm-property">default</span><span class="cm-operator">.</span><span class="cm-property">ids</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">target_group_arns</span> &nbsp; &nbsp;<span class="cm-operator">=</span> [<span class="cm-variable">aws_lb_target_group</span><span class="cm-operator">.</span><span class="cm-property">asg</span><span class="cm-operator">.</span><span class="cm-property">arn</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">health_check_type</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"ELB"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">min_size</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">min_size</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">max_size</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">max_size</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">tag</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">key</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"Name"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">value</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">cluster_name</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">propagate_at_launch</span> <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">dynamic</span> <span class="cm-string">"tag"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">for_each</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">custom_tags</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">content</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">key</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">tag</span><span class="cm-operator">.</span><span class="cm-property">key</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">value</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">tag</span><span class="cm-operator">.</span><span class="cm-property">value</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">propagate_at_launch</span> <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 470px;"></div><div class="CodeMirror-gutters" style="display: none; height: 470px;"></div></div></div></pre><p><span>لو عملت </span><code>run</code><span> لـ </span><code>terraform plan</code><span> دلوقتي، المفروض تشوف </span><code>plan</code><span> شكله عامل كده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">$ terraform plan</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Terraform will perform the following actions:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  # aws_autoscaling_group.example will be updated in-place</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  ~ resource "aws_autoscaling_group" "example" {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  (...)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  tag {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;  key &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = "Name"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;  propagate_at_launch = true</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;  value &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = "webservers-prod"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  + tag {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  + key &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = "Owner"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  + propagate_at_launch = true</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  + value &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = "team-foo"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  + tag {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  + key &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = "ManagedBy"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  + propagate_at_launch = true</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  + value &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = "terraform"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Plan: 0 to add, 1 to change, 0 to destroy.</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 537px;"></div><div class="CodeMirror-gutters" style="display: none; height: 537px;"></div></div></div></pre><h4 id='شوية-امثلة-2'><span>شوية امثلة </span></h4><h5 id='1-استخدام-foreach-عشان-تعمل-create-لكذا-resource'><strong><span>1. استخدام </span><code>for_each</code><span> عشان تعمل </span><code>create</code><span> لكذا </span><code>Resource</code></strong></h5><p><span>ده الاستخدام الأشهر والأكثر أهمية لـ </span><code>for_each</code><span>. بيحل مشكلة الـ </span><code>re-creation</code><span> اللي كانت بتحصل مع </span><code>count</code><span> لما بتمسح عنصر من نص الـ </span><code>list</code><span>. هنا، </span><code>for_each</code><span> بيستخدم الـ </span><code>key</code><span> بتاع العنصر كهوية فريدة للـ </span><code>resource</code><span>.</span></p><ul><li><p><strong><span>أ. </span><code>Loop</code><span> على </span><code>List</code><span> من الـ </span><code>Strings</code><span>:</span></strong>
<span>لو عندك </span><code>list</code><span> بسيط بأسماء </span><code>users</code><span> أو أي حاجة عايز تعملها </span><code>create</code><span>. لازم تحوله لـ </span><code>set</code><span> الأول عشان </span><code>for_each</code><span> بيشتغل بـ </span><code>set</code><span> أو </span><code>map</code><span> مع الـ </span><code>resources</code><span>.</span></p><ul><li><p><strong><span>الـ </span><code>Variable</code><span>:</span></strong></p></li></ul></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"iam_user_names"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"List of IAM user names to create"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">list</span>(<span class="cm-variable">string</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> &nbsp; &nbsp; <span class="cm-operator">=</span> [<span class="cm-string">"neo"</span>, <span class="cm-string">"trinity"</span>, <span class="cm-string">"morpheus"</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><ul><li><p><strong><span>الـ </span><code>Resource</code><span> مع </span><code>for_each</code><span>:</span></strong></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_iam_user"</span> <span class="cm-string">"app_users"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">for_each</span> <span class="cm-operator">=</span> <span class="cm-variable">toset</span>(<span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">iam_user_names</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">name</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">each</span><span class="cm-operator">.</span><span class="cm-property">value</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><ul><li><p><strong><span>ب. </span><code>Loop</code><span> على </span><code>Map</code><span> من الـ </span><code>Objects</code><span>:</span></strong>
<span>لو عايز تعمل </span><code>create</code><span> لأكتر من </span><code>S3 bucket</code><span>، وكل </span><code>bucket</code><span> ليه إعدادات مختلفة. الـ </span><code>map</code><span> هنا بيديلك تحكم أكبر.</span></p><ul><li><p><strong><span>الـ </span><code>Variable</code><span>:</span></strong></p></li></ul></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"s3_bucket_configs"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"Map of S3 bucket configurations"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> <span class="cm-operator">=</span> <span class="cm-variable">map</span>(<span class="cm-variable">object</span>({</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-variable">string</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">acl</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">string</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">tags</span> <span class="cm-operator">=</span> <span class="cm-variable">map</span>(<span class="cm-variable">string</span>)}))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"docs"</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-string">"my-docs-bucket-prod"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">acl</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"private"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">tags</span> <span class="cm-operator">=</span> { <span class="cm-tag">Environment</span> <span class="cm-operator">=</span> <span class="cm-string">"Production"</span>, <span class="cm-tag">Department</span> <span class="cm-operator">=</span> <span class="cm-string">"IT"</span> }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"logs"</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-string">"my-logs-bucket-prod"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">acl</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"log-delivery-write"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">tags</span> <span class="cm-operator">=</span> { <span class="cm-tag">Environment</span> <span class="cm-operator">=</span> <span class="cm-string">"Production"</span>, <span class="cm-tag">Type</span> <span class="cm-operator">=</span> <span class="cm-string">"Logs"</span> }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 426px;"></div><div class="CodeMirror-gutters" style="display: none; height: 426px;"></div></div></div></pre><p>&nbsp;</p><ul><li><p><strong><span>الـ </span><code>Resource</code><span> مع </span><code>for_each</code><span>:</span></strong></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_s3_bucket"</span> <span class="cm-string">"app_buckets"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">for_each</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">s3_bucket_configs</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">bucket</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">each</span><span class="cm-operator">.</span><span class="cm-property">value</span><span class="cm-operator">.</span><span class="cm-property">name</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">acl</span> &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">each</span><span class="cm-operator">.</span><span class="cm-property">value</span><span class="cm-operator">.</span><span class="cm-property">acl</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">tags</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">each</span><span class="cm-operator">.</span><span class="cm-property">value</span><span class="cm-operator">.</span><span class="cm-property">tags</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 134px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><p><span>خلي بالك keys هنا هي default و logs</span></p><hr /><h5 id='2-استخدام-foreach-عشان-تعمل-create-لكذا-module'><strong><span>2. استخدام </span><code>for_each</code><span> عشان تعمل </span><code>create</code><span> لكذا </span><code>Module</code></strong></h5><p><span>نفس فكرة الـ </span><code>resources</code><span>، بس هنا بنعمل </span><code>create</code><span> لنسخ من الـ </span><code>module</code><span> بتاعنا. ده مفيد لو عايز تعمل </span><code>deploy</code><span> لنفس الـ </span><code>architecture</code><span> في كذا </span><code>region</code><span> أو بأسماء مختلفة.</span></p><ul><li><p><strong><span>الـ </span><code>Variable</code><span>:</span></strong></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"web_clusters"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"Configurations for multiple web server clusters"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> <span class="cm-operator">=</span> <span class="cm-variable">map</span>(<span class="cm-variable">object</span>({</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">region</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">string</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">instance_type</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">string</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">cluster_prefix</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">string</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"us-east-cluster"</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">region</span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"us-east-1"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">instance_type</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"t3.medium"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">cluster_prefix</span> <span class="cm-operator">=</span> <span class="cm-string">"east-app"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"eu-west-cluster"</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">region</span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"eu-west-1"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">instance_type</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"t3.large"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">cluster_prefix</span> <span class="cm-operator">=</span> <span class="cm-string">"west-app"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 448px;"></div><div class="CodeMirror-gutters" style="display: none; height: 448px;"></div></div></div></pre><p>&nbsp;</p><ul><li><p><strong><span>الـ </span><code>Module</code><span> مع </span><code>for_each</code><span>:</span></strong></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">module</span> <span class="cm-string">"webserver_deployments"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">source</span> <span class="cm-operator">=</span> <span class="cm-string">"../modules/webserver-cluster"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">for_each</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">web_clusters</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">aws_region</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">each</span><span class="cm-operator">.</span><span class="cm-property">value</span><span class="cm-operator">.</span><span class="cm-property">region</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">instance_type</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">each</span><span class="cm-operator">.</span><span class="cm-property">value</span><span class="cm-operator">.</span><span class="cm-property">instance_type</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">cluster_name</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">each</span><span class="cm-operator">.</span><span class="cm-property">value</span><span class="cm-operator">.</span><span class="cm-property">cluster_prefix</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 157px;"></div><div class="CodeMirror-gutters" style="display: none; height: 157px;"></div></div></div></pre><p>&nbsp;</p><hr /><h5 id='3-استخدام-foreach-عشان-تعمل-create-لكذا-inline-block-بواسطة-dynamic-block'><strong><span>3. استخدام </span><code>for_each</code><span> عشان تعمل </span><code>create</code><span> لكذا </span><code>Inline Block</code><span> (بواسطة </span><code>dynamic</code><span> block)</span></strong></h5><p><span>ده بيستخدم لما تكون عايز تعمل </span><code>loop</code><span> على </span><code>block</code><span> بيتكرر جوه </span><code>resource</code><span> واحد. المثال الكلاسيكي هو الـ </span><code>tags</code><span> أو الـ </span><code>ingress/egress rules</code><span> في الـ </span><code>Security Group</code><span>.</span></p><ul><li><p><strong><span>أ. </span><code>Loop</code><span> على </span><code>Map</code><span> من الـ </span><code>Strings</code><span> عشان تعمل </span><code>Tags</code><span>:</span></strong></p><ul><li><p><strong><span>الـ </span><code>Variable</code><span>:</span></strong></p></li></ul></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"common_tags"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"Common tags for resources"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">map</span>(<span class="cm-variable">string</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag">Project</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"MyWebApp"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag">Environment</span> <span class="cm-operator">=</span> <span class="cm-string">"Development"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 179px;"></div><div class="CodeMirror-gutters" style="display: none; height: 179px;"></div></div></div></pre><p>&nbsp;</p><ul><li><p><strong><span>الـ </span><code>Resource</code><span> مع </span><code>dynamic &quot;tag&quot;</code><span> block:</span></strong></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_instance"</span> <span class="cm-string">"example_instance"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">ami</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"ami-xxxxxxxxxxxxx"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">instance_type</span> <span class="cm-operator">=</span> <span class="cm-string">"t2.micro"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">tags</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag">Name</span> <span class="cm-operator">=</span> <span class="cm-string">"MyDynamicInstance"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">dynamic</span> <span class="cm-string">"tag"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">for_each</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">common_tags</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">content</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">key</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">tag</span><span class="cm-operator">.</span><span class="cm-property">key</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">value</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">tag</span><span class="cm-operator">.</span><span class="cm-property">value</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">propagate_at_launch</span> <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 381px;"></div><div class="CodeMirror-gutters" style="display: none; height: 381px;"></div></div></div></pre><p>&nbsp;</p><ul><li><p><strong><span>ب. </span><code>Loop</code><span> على </span><code>List</code><span> من الـ </span><code>Objects</code><span> عشان تعمل </span><code>Ingress Rules</code><span>:</span></strong></p><ul><li><p><strong><span>الـ </span><code>Variable</code><span>:</span></strong></p></li></ul></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"custom_ingress_rules"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"List of ingress rules to apply"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> <span class="cm-operator">=</span> <span class="cm-variable">list</span>(<span class="cm-variable">object</span>({</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">port</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">number</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">protocol</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">string</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">cidr_blocks</span> <span class="cm-operator">=</span> <span class="cm-variable">list</span>(<span class="cm-variable">string</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> <span class="cm-operator">=</span> [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  { <span class="cm-variable">port</span> <span class="cm-operator">=</span> <span class="cm-number">80</span>, <span class="cm-variable">protocol</span> <span class="cm-operator">=</span> <span class="cm-string">"tcp"</span>, <span class="cm-variable">cidr_blocks</span> <span class="cm-operator">=</span> [<span class="cm-string">"0.0.0.0/0"</span>] },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  { <span class="cm-variable">port</span> <span class="cm-operator">=</span> <span class="cm-number">443</span>, <span class="cm-variable">protocol</span> <span class="cm-operator">=</span> <span class="cm-string">"tcp"</span>, <span class="cm-variable">cidr_blocks</span> <span class="cm-operator">=</span> [<span class="cm-string">"0.0.0.0/0"</span>] },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> { <span class="cm-variable">port</span> <span class="cm-operator">=</span> <span class="cm-number">22</span>, <span class="cm-variable">protocol</span> <span class="cm-operator">=</span> <span class="cm-string">"tcp"</span>, <span class="cm-variable">cidr_blocks</span> <span class="cm-operator">=</span> [<span class="cm-string">"0.0.0.0/0/32"</span>] }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  ]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 291px;"></div><div class="CodeMirror-gutters" style="display: none; height: 291px;"></div></div></div></pre><p>&nbsp;</p><ul><li><p><strong><span>الـ </span><code>Resource</code><span> مع </span><code>dynamic &quot;ingress&quot;</code><span> block:</span></strong></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_security_group"</span> <span class="cm-string">"dynamic_sg"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">name</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"dynamic-rules-sg"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">vpc_id</span> &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">aws_vpc</span><span class="cm-operator">.</span><span class="cm-property">example_vpc</span><span class="cm-operator">.</span><span class="cm-property">id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">dynamic</span> <span class="cm-string">"ingress"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">for_each</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">custom_ingress_rules</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">content</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">from_port</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">ingress</span><span class="cm-operator">.</span><span class="cm-property">value</span><span class="cm-operator">.</span><span class="cm-property">port</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">to_port</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">ingress</span><span class="cm-operator">.</span><span class="cm-property">value</span><span class="cm-operator">.</span><span class="cm-property">port</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">protocol</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">ingress</span><span class="cm-operator">.</span><span class="cm-property">value</span><span class="cm-operator">.</span><span class="cm-property">protocol</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">cidr_blocks</span> <span class="cm-operator">=</span> <span class="cm-variable">ingress</span><span class="cm-operator">.</span><span class="cm-property">value</span><span class="cm-operator">.</span><span class="cm-property">cidr_blocks</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">egress</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">from_port</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-number">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">to_port</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-number">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">protocol</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"-1"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">cidr_blocks</span> <span class="cm-operator">=</span> [<span class="cm-string">"0.0.0.0/0"</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 448px;"></div><div class="CodeMirror-gutters" style="display: none; height: 448px;"></div></div></div></pre><div class="md-alert md-alert-important important"><p><span class='md-alert-text md-alert-text-important'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Important</span><br></p><p>&nbsp;</p><h3 id='1-foreach-مع-الـ-resources-والـ-modules'><strong><span>1. </span><code>for_each</code><span> مع الـ </span><code>resources</code><span> والـ </span><code>modules</code></strong></h3><ul><li><p><strong><span>شغلته إيه؟</span></strong><span> </span><strong><span>بينشئ كذا نسخة مستقلة</span></strong><span> من نفس الـ </span><code>resource</code><span> أو الـ </span><code>module</code><span>. كل نسخة ليها عنوان مميز في ملف الـ </span><code>state</code><span>.</span></p></li><li><p><strong><span>ليه بيحتاج </span><code>map</code><span> أو </span><code>set</code><span>؟</span></strong><span> لأنه محتاج </span><strong><code>key</code><span> ثابت ومميز</span></strong><span> لكل نسخة بيعملها عشان يعرف ينادي عليها. الـ </span><code>key</code><span> ده هو اللي بيبقى جزء من عنوان الـ </span><code>resource</code><span> في الـ </span><code>state</code><span>.</span></p><ul><li><p><span>لو استخدمت </span><code>map</code><span>، </span><code>Terraform</code><span> بياخد الـ </span><code>key</code><span> بتاع كل عنصر في الـ </span><code>map</code><span> كعنوان للـ </span><code>resource</code><span>.</span></p></li><li><p><span>لو استخدمت </span><code>set</code><span>، </span><code>Terraform</code><span> بياخد القيمة نفسها (اللي لازم تكون </span><code>string</code><span>) كعنوان للـ </span><code>resource</code><span>.</span></p></li></ul></li><li><p><strong><span>ليه الـ </span><code>list</code><span> متنفعش معاه؟</span></strong><span> لأن الـ </span><code>list</code><span> بتترقم بالترتيب (</span><code>0, 1, 2, ...</code><span>). لو جيت شيلت عنصر من نص الـ </span><code>list</code><span>، كل الأرقام اللي بعده هتتلخبط وتتغير. </span><code>Terraform</code><span> ساعتها هيتجنن ويفتكر إنه لازم يمسح ويعمل كل الـ </span><code>resources</code><span> اللي أرقامها اتغيرت، ودي مصيبة. </span><code>Terraform</code><span> عايز عنوان ثابت لكل </span><code>resource</code><span> عشان ميحصلش لخبطة.</span></p></li></ul><p><strong><span>مثال:</span></strong><span> لو عندك </span><code>set</code><span> زي </span><code>toset([&quot;a&quot;, &quot;b&quot;, &quot;c&quot;])</code><span>. </span><code>Terraform</code><span> </span><strong><span>هينشئ</span></strong><span> 3 </span><code>resources</code><span> عناوينهم كده: </span><code>aws_instance.example[&quot;a&quot;]</code><span>, </span><code>aws_instance.example[&quot;b&quot;]</code><span>, </span><code>aws_instance.example[&quot;c&quot;]</code><span>. لو مسحت </span><code>&quot;b&quot;</code><span>، </span><code>Terraform</code><span> هيبقى عارف بالظبط هو هيمسح مين، و</span><code>a</code><span> و</span><code>c</code><span> هيفضلوا في حالهم.</span></p><h3 id='2-dynamic-بلوك'><strong><span>2. </span><code>dynamic</code><span> بلوك</span></strong></h3><ul><li><p><strong><span>شغلته إيه؟</span></strong><span> ده مش </span><strong><span>بينشئ</span></strong><span> </span><code>resources</code><span> جديدة. ده بيكرر </span><strong><span>بلوك كود جوه </span><code>resource</code><span> واحد بس</span></strong><span> موجود أصلًا.</span></p></li><li><p><strong><span>ليه بيقبل </span><code>list</code><span> عادي؟</span></strong><span> لأنه مش محتاج </span><code>key</code><span> مميز لكل حتة بيكررها. هو ببساطة بيلف على الـ </span><code>collection</code><span> اللي إنت مديهاله (سواء </span><code>list</code><span> أو </span><code>map</code><span>) ويكرر البلوك ده بعددها. في الـ </span><code>state</code><span>، بيتسجل </span><code>resource</code><span> واحد بس، وجواه بيكون فيه </span><code>list</code><span> من الـ </span><code>ingress rules</code><span> مثلاً.</span></p></li><li><p><span>لو غيرت في الـ </span><code>list</code><span> (شيلت عنصر من النص)، </span><code>Terraform</code><span> بيبص على الـ </span><code>resource</code><span> كله على بعضه، ويقارن الـ </span><code>list</code><span> القديمة بالجديدة، ويصلح الفرق جوه </span><strong><span>نفس الـ </span><code>resource</code></strong><span>. مفيش خطر إنه يمسح </span><code>resource</code><span> تاني بالغلط.</span></p></li></ul><p><strong><span>مثال:</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.63019px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_security_group"</span> <span class="cm-string">"example"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-string">"example-sg"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">dynamic</span> <span class="cm-string">"ingress"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">for_each</span> <span class="cm-operator">=</span> [<span class="cm-string">"80"</span>, <span class="cm-string">"443"</span>, <span class="cm-string">"8080"</span>] </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">content</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">from_port</span> <span class="cm-operator">=</span> <span class="cm-variable">ingress</span><span class="cm-operator">.</span><span class="cm-property">value</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">to_port</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">ingress</span><span class="cm-operator">.</span><span class="cm-property">value</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-comment"># ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 291px;"></div><div class="CodeMirror-gutters" style="display: none; height: 291px;"></div></div></div></pre><p><span>هنا، </span><code>Terraform</code><span> </span><strong><span>هينشئ</span></strong><span> </span><code>resource</code><span> واحد بس اسمه </span><code>aws_security_group.example</code><span>. جواه، الـ </span><code>attribute</code><span> اللي اسمه </span><code>ingress</code><span> هيبقى عبارة عن </span><code>list</code><span> فيها 3 </span><code>objects</code><span>. لو مسحت </span><code>&quot;443&quot;</code><span> من الـ </span><code>list</code><span>، </span><code>Terraform</code><span> هيعمل </span><code>update</code><span> لنفس الـ </span><code>resource</code><span> ويشيل الـ </span><code>rule</code><span> دي بس.</span></p><p>&nbsp;</p></div><h3 id='loops-with-for-expressions'><span>Loops with for Expressions</span></h3><p><span>دلوقتي أنت شفت إزاي تستخدم الـ </span><code>loops</code><span> عشان تعمل </span><code>create</code><span> لكذا نسخة من الـ </span><code>resources</code><span> الكاملة والـ </span><code>inline blocks</code><span>، بس إيه اللي هيحصل لو أنت محتاج </span><code>loop</code><span> عشان تحدد قيمة </span><code>variable</code><span> واحد بس أو </span><code>parameter</code><span> واحد بس؟</span></p><p><span>تخيل إنك كتبت كود </span><code>Terraform</code><span> بياخد </span><code>list</code><span> من الأسماء:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"names"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"A list of names"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">list</span>(<span class="cm-variable">string</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> &nbsp; &nbsp; <span class="cm-operator">=</span> [<span class="cm-string">"neo"</span>, <span class="cm-string">"trinity"</span>, <span class="cm-string">"morpheus"</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p><span>إزاي ممكن تحول كل الأسماء دي لـ </span><code>uppercase</code><span> (حروف كبيرة)؟ في أي لغة برمجة </span><code>general-purpose</code><span> زي </span><code>Python</code><span>، ممكن تكتب الـ </span><code>for-loop</code><span> اللي جاي ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">names</span> <span class="cm-operator">=</span> [<span class="cm-string">"neo"</span>, <span class="cm-string">"trinity"</span>, <span class="cm-string">"morpheus"</span>]</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">upper_case_names</span> <span class="cm-operator">=</span> []</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> <span class="cm-variable">name</span> <span class="cm-keyword">in</span> <span class="cm-variable">names</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">upper_case_names</span>.<span class="cm-property">append</span>(<span class="cm-variable">name</span>.<span class="cm-property">upper</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">print</span>(<span class="cm-variable">upper_case_names</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Prints out: ['NEO', 'TRINITY', 'MORPHEUS']</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 134px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><p><code>Python</code><span> بيقدم طريقة تانية عشان تكتب نفس الكود بالظبط في سطر واحد باستخدام </span><code>syntax</code><span> معروف</span>
<span> بـ </span><code>list comprehension</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">names</span> <span class="cm-operator">=</span> [<span class="cm-string">"neo"</span>, <span class="cm-string">"trinity"</span>, <span class="cm-string">"morpheus"</span>]</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">upper_case_names</span> <span class="cm-operator">=</span> [<span class="cm-variable">name</span>.<span class="cm-property">upper</span>() <span class="cm-keyword">for</span> <span class="cm-variable">name</span> <span class="cm-keyword">in</span> <span class="cm-variable">names</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">print</span>(<span class="cm-variable">upper_case_names</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Prints out: ['NEO', 'TRINITY', 'MORPHEUS']</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><code>Python</code><span> بيسمحلك كمان تعمل </span><code>filter</code><span> للـ </span><code>list</code><span> الناتج عن طريق تحديد </span><code>condition</code><span> (شرط):</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">names</span> <span class="cm-operator">=</span> [<span class="cm-string">"neo"</span>, <span class="cm-string">"trinity"</span>, <span class="cm-string">"morpheus"</span>]</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">short_upper_case_names</span> <span class="cm-operator">=</span> [<span class="cm-variable">name</span>.<span class="cm-property">upper</span>() <span class="cm-keyword">for</span> <span class="cm-variable">name</span> <span class="cm-keyword">in</span> <span class="cm-variable">names</span> <span class="cm-keyword">if</span> <span class="cm-builtin">len</span>(<span class="cm-variable">name</span>) <span class="cm-operator">&lt;</span> <span class="cm-number">5</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">print</span>(<span class="cm-variable">short_upper_case_names</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Prints out: ['NEO']</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><code>Terraform</code><span> بيقدم </span><code>functionality</code><span> شبه دي في شكل </span><code>for expression</code><span> (متتلخبطش بينه وبين الـ </span><code>for_each expression</code><span> اللي شفته في الجزء اللي فات). الـ </span><code>syntax</code><span> الأساسي بتاع الـ </span><code>for expression</code><span> شكله كده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[for &lt;ITEM&gt; in &lt;LIST&gt; : &lt;OUTPUT&gt;]</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>حيث إن </span><code>LIST</code><span> ده </span><code>list</code><span> عشان تعمل عليه </span><code>loop</code><span>، و </span><code>ITEM</code><span> ده اسم الـ </span><code>local variable</code><span> اللي هيتم تخصيصه لكل </span><code>item</code><span> في الـ </span><code>LIST</code><span>، و </span><code>OUTPUT</code><span> ده </span><code>expression</code><span> بيغير شكل الـ </span><code>ITEM</code><span> بطريقة معينة. كمثال، ده كود </span><code>Terraform</code><span> عشان يحول الـ </span><code>list</code><span> بتاع الأسماء اللي في </span><code>var.names</code><span> لـ </span><code>uppercase</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"upper_names"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> [<span class="cm-keyword">for</span> <span class="cm-variable">name</span> <span class="cm-keyword">in</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">names</span> <span class="cm-operator">:</span> <span class="cm-variable">upper</span>(<span class="cm-variable">name</span>)]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 67px;"></div><div class="CodeMirror-gutters" style="display: none; height: 67px;"></div></div></div></pre><p><span>لو عملت </span><code>run</code><span> لـ </span><code>terraform apply</code><span> على الكود ده، هيطلعلك الـ </span><code>output</code><span> اللي جاي ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">$ terraform apply</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Apply complete! Resources: 0 added, 0 changed, 0 destroyed.</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Outputs:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">upper_names = [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  "NEO",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  "TRINITY",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  "MORPHEUS",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">]</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 224px;"></div><div class="CodeMirror-gutters" style="display: none; height: 224px;"></div></div></div></pre><p><span>زي الـ </span><code>list comprehensions</code><span> بتاعت </span><code>Python</code><span> بالظبط، ممكن تعمل </span><code>filter</code><span> للـ </span><code>list</code><span> الناتج عن طريق تحديد </span><code>condition</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"short_upper_names"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> [<span class="cm-keyword">for</span> <span class="cm-variable">name</span> <span class="cm-keyword">in</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">names</span> <span class="cm-operator">:</span> <span class="cm-variable">upper</span>(<span class="cm-variable">name</span>) <span class="cm-keyword">if</span> <span class="cm-variable">length</span>(<span class="cm-variable">name</span>) <span class="cm-operator">&lt;</span> <span class="cm-number">5</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 67px;"></div><div class="CodeMirror-gutters" style="display: none; height: 67px;"></div></div></div></pre><p><span>لما تعمل </span><code>run</code><span> لـ </span><code>terraform apply</code><span> على الكود ده هيطلعلك ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">short_upper_names = [</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  "NEO",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">]</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 67px;"></div><div class="CodeMirror-gutters" style="display: none; height: 67px;"></div></div></div></pre><p><span>الـ </span><code>for expression</code><span> في </span><code>Terraform</code><span> بيسمحلك كمان تعمل </span><code>loop</code><span> على </span><code>map</code><span> باستخدام الـ </span><code>syntax</code><span> ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[for &lt;KEY&gt;, &lt;VALUE&gt; in &lt;MAP&gt; : &lt;OUTPUT&gt;]</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>هنا، </span><code>MAP</code><span> ده </span><code>map</code><span> عشان تعمل عليه </span><code>loop</code><span>، و </span><code>KEY</code><span> و </span><code>VALUE</code><span> دول أسماء الـ </span><code>local variable</code><span> اللي هيتم تخصيصها لكل </span><code>key-value pair</code><span> في الـ </span><code>MAP</code><span>، و </span><code>OUTPUT</code><span> ده </span><code>expression</code><span> بيغير شكل الـ </span><code>KEY</code><span> والـ </span><code>VALUE</code><span> بطريقة معينة. وده مثال:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"hero_thousand_faces"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"map"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">map</span>(<span class="cm-variable">string</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">neo</span> &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"hero"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">trinity</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"love interest"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">morpheus</span> <span class="cm-operator">=</span> <span class="cm-string">"mentor"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"bios"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> [<span class="cm-keyword">for</span> <span class="cm-variable">name</span>, <span class="cm-variable">role</span> <span class="cm-keyword">in</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">hero_thousand_faces</span> <span class="cm-operator">:</span> <span class="cm-string">"${name} is the ${role}"</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 314px;"></div><div class="CodeMirror-gutters" style="display: none; height: 314px;"></div></div></div></pre><p><span>لما تعمل </span><code>run</code><span> لـ </span><code>terraform apply</code><span> على الكود ده، هيطلعلك اللي جاي ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">bios = [</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  "morpheus is the mentor",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  "neo is the hero",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  "trinity is the love interest",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">]</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p><span>ممكن كمان تستخدم الـ </span><code>for expressions</code><span> عشان تطلع </span><code>map</code><span> بدل </span><code>list</code><span> باستخدام الـ </span><code>syntax</code><span> ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"># Loop over a list and output a map</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{for &lt;ITEM&gt; in &lt;LIST&gt; : &lt;OUTPUT_KEY&gt; =&gt; &lt;OUTPUT_VALUE&gt;}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"># Loop over a map and output a map</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{for &lt;KEY&gt;, &lt;VALUE&gt; in &lt;MAP&gt; : &lt;OUTPUT_KEY&gt; =&gt; &lt;OUTPUT_VALUE&gt;}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p><span>الفرق الوحيد هو إن </span></p><p><span>(أ) بتحاوط الـ </span><code>expression</code><span> بـ </span><code>curly braces</code><span> (</span><code>{}</code><span>) بدل </span><code>square brackets</code><span> (</span><code>[]</code><span>)، </span></p><p><span> (ب) بدل ما بتطلع </span><code>value</code><span> واحد بس في كل تكرار، بتطلع </span><code>key</code><span> و </span><code>value</code><span>، مفصولين بـ </span><code>arrow</code><span> (</span><code>=&gt;</code><span>). كمثال، دي طريقة ممكن تحول بيها الـ </span><code>map</code><span> عشان تخلي كل الـ </span><code>keys</code><span> والـ </span><code>values</code><span> تكون </span><code>uppercase</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"upper_roles"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> {<span class="cm-keyword">for</span> <span class="cm-variable">name</span>, <span class="cm-variable">role</span> <span class="cm-keyword">in</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">hero_thousand_faces</span> <span class="cm-operator">:</span> <span class="cm-variable">upper</span>(<span class="cm-variable">name</span>) <span class="cm-operator">=&gt;</span> <span class="cm-variable">upper</span>(<span class="cm-variable">role</span>)}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><span>وده الـ </span><code>output</code><span> اللي هيطلع لما تعمل </span><code>run</code><span> للكود ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">upper_roles = {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  "MORPHEUS" = "MENTOR"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  "NEO" &nbsp; &nbsp;  = "HERO"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  "TRINITY"  = "LOVE INTEREST"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p>&nbsp;</p><hr /><h4 id='شوية-مثلة-لى-for-expression'><strong><span>شوية مثلة لى </span><code>for expression</code></strong></h4><p><span>الـ </span><code>for expression</code><span> دي أداة قوية جداً عشان تعمل </span><code>transform</code><span> (تغير شكل) أو </span><code>filter</code><span> (تصفّي) الـ </span><code>lists</code><span> والـ </span><code>maps</code><span> في </span><code>Terraform</code><span>. هي بتديلك مرونة كبيرة في تجهيز البيانات.</span></p><h4 id='1-تحويل-list-لـ-list-مع-أو-بدون-filter'><strong><span>1. تحويل </span><code>List</code><span> لـ </span><code>List</code><span> (مع أو بدون </span><code>Filter</code><span>)</span></strong></h4><ul><li><p><strong><span>المشكلة:</span></strong><span> عندك </span><code>list</code><span> من الـ </span><code>IDs</code><span> وعايز تضيف </span><code>prefix</code><span> لكل واحد، أو عايز تصفيهم بناءً على شرط معين.</span></p></li><li><p><strong><span>الـ </span><code>Variable</code><span>:</span></strong></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"server_ids"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">list</span>(<span class="cm-variable">string</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> <span class="cm-operator">=</span> [<span class="cm-string">"srv-001"</span>, <span class="cm-string">"srv-002"</span>, <span class="cm-string">"srv-003"</span>, <span class="cm-string">"srv-004-test"</span>, <span class="cm-string">"srv-005"</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p>&nbsp;</p><ul><li><p><strong><span>أ. إضافة </span><code>Prefix</code><span> لكل عنصر:</span></strong></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"prefixed_server_ids"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> [<span class="cm-keyword">for</span> <span class="cm-variable">id</span> <span class="cm-keyword">in</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">server_ids</span> <span class="cm-operator">:</span> <span class="cm-string">"prod-${id}"</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 67px;"></div><div class="CodeMirror-gutters" style="display: none; height: 67px;"></div></div></div></pre><p>&nbsp;</p><ul><li><p><span>**  :** </span><code>[&quot;prod-srv-001&quot;, &quot;prod-srv-002&quot;, &quot;prod-srv-003&quot;, &quot;prod-srv-004-test&quot;, &quot;prod-srv-005&quot;]</code></p></li><li><p><strong><span>ب. تصفية الـ </span><code>List</code><span>:</span></strong>
<span>لو عايز تجيب بس الـ </span><code>IDs</code><span> اللي مش بتحتوي على كلمة &quot;test&quot;.</span></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"non_test_server_ids"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> [<span class="cm-keyword">for</span> <span class="cm-variable">id</span> <span class="cm-keyword">in</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">server_ids</span> <span class="cm-operator">:</span> <span class="cm-variable">id</span> <span class="cm-keyword">if</span> !<span class="cm-variable">can</span>(<span class="cm-variable">regex</span>(<span class="cm-string">"test"</span>, <span class="cm-variable">id</span>))]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 67px;"></div><div class="CodeMirror-gutters" style="display: none; height: 67px;"></div></div></div></pre><p>&nbsp;</p><ul><li><p><strong><span>الـ </span><code>Output</code><span> المتوقع:</span></strong><span> </span><code>[&quot;srv-001&quot;, &quot;srv-002&quot;, &quot;srv-003&quot;, &quot;srv-005&quot;]</code></p></li><li><p><strong><span>شرح بسيط:</span></strong><span> </span><code>can(regex(&quot;test&quot;, id))</code><span> بتشوف لو </span><code>id</code><span> جواه كلمة &quot;test&quot;، و </span><code>!</code><span> بتعكس النتيجة.</span></p></li><li><p><strong><span>ج. دمج </span><code>Transform</code><span> و </span><code>Filter</code><span>:</span></strong>
<span>لو عايز الـ </span><code>IDs</code><span> اللي مش &quot;test&quot; وتضيف عليها </span><code>prefix</code><span>.</span></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"filtered_prefixed_ids"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">value</span> <span class="cm-operator">=</span> [<span class="cm-keyword">for</span> <span class="cm-variable">id</span> <span class="cm-keyword">in</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">server_ids</span> <span class="cm-operator">:</span> <span class="cm-string">"clean-${id}"</span> <span class="cm-keyword">if</span> !<span class="cm-variable">can</span>(<span class="cm-variable">regex</span>(<span class="cm-string">"test"</span>, <span class="cm-variable">id</span>))]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p>&nbsp;</p><ul><li><p><strong><span>الـ </span><code>Output</code><span> المتوقع:</span></strong><span> </span><code>[&quot;clean-srv-001&quot;, &quot;clean-srv-002&quot;, &quot;clean-srv-003&quot;, &quot;clean-srv-005&quot;]</code></p></li></ul><h4 id='2-تحويل-map-لـ-list-مع-أو-بدون-filter'><strong><span>2. تحويل </span><code>Map</code><span> لـ </span><code>List</code><span> (مع أو بدون </span><code>Filter</code><span>)</span></strong></h4><ul><li><p><strong><span>المشكلة:</span></strong><span> عندك </span><code>map</code><span> بيوصف إعدادات معينة وعايز تطلع منه </span><code>list</code><span> بـ </span><code>strings</code><span> معينة، أو تصفيهم.</span></p></li><li><p><strong><span>الـ </span><code>Variable</code><span>:</span></strong></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"instance_sizes"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> <span class="cm-operator">=</span> <span class="cm-variable">map</span>(<span class="cm-variable">object</span>({</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">env</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">string</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">size</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">string</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">cost</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">number</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"dev_web"</span> &nbsp;<span class="cm-operator">=</span> { <span class="cm-variable">env</span> <span class="cm-operator">=</span> <span class="cm-string">"dev"</span>, <span class="cm-variable">size</span> <span class="cm-operator">=</span> <span class="cm-string">"t2.micro"</span>, <span class="cm-variable">cost</span> <span class="cm-operator">=</span> <span class="cm-number">10</span> },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"prod_web"</span> <span class="cm-operator">=</span> { <span class="cm-variable">env</span> <span class="cm-operator">=</span> <span class="cm-string">"prod"</span>, <span class="cm-variable">size</span> <span class="cm-operator">=</span> <span class="cm-string">"m5.large"</span>, <span class="cm-variable">cost</span> <span class="cm-operator">=</span> <span class="cm-number">100</span> },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"dev_db"</span> &nbsp; <span class="cm-operator">=</span> { <span class="cm-variable">env</span> <span class="cm-operator">=</span> <span class="cm-string">"dev"</span>, <span class="cm-variable">size</span> <span class="cm-operator">=</span> <span class="cm-string">"t3.small"</span>, <span class="cm-variable">cost</span> <span class="cm-operator">=</span> <span class="cm-number">30</span> }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 269px;"></div><div class="CodeMirror-gutters" style="display: none; height: 269px;"></div></div></div></pre><ul><li><p><strong><span>أ. استخراج قيم معينة كـ </span><code>List</code><span>:</span></strong>
<span>لو عايز </span><code>list</code><span> بأسماء الـ </span><code>instance</code><span> والـ </span><code>size</code><span> بتاعها.</span></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"instance_descriptions"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> [<span class="cm-keyword">for</span> <span class="cm-variable">name</span>, <span class="cm-variable">config</span> <span class="cm-keyword">in</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">instance_sizes</span> <span class="cm-operator">:</span> <span class="cm-string">"${name}: ${config.size}"</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p>&nbsp;</p><ul><li><p><strong><span>الـ </span><code>Output</code><span> المتوقع:</span></strong><span> </span><code>[&quot;dev_web: t2.micro&quot;, &quot;prod_web: m5.large&quot;, &quot;dev_db: t3.small&quot;]</code></p></li><li><p><strong><span>ب. تصفية و استخراج قيم من </span><code>Map</code><span>:</span></strong>
<span>لو عايز تجيب بس الـ </span><code>instances</code><span> اللي في الـ </span><code>environment</code><span> بتاع &quot;dev&quot;.</span></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"dev_instance_sizes"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> [<span class="cm-keyword">for</span> <span class="cm-variable">name</span>, <span class="cm-variable">config</span> <span class="cm-keyword">in</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">instance_sizes</span> <span class="cm-operator">:</span> <span class="cm-string">"${name} (${config.size})"</span> <span class="cm-keyword">if</span> <span class="cm-variable">config</span><span class="cm-operator">.</span><span class="cm-property">env</span> <span class="cm-operator">==</span> <span class="cm-string">"dev"</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p>&nbsp;</p><ul><li><p><strong><span>الـ </span><code>Output</code><span> المتوقع:</span></strong><span> </span><code>[&quot;dev_web (t2.micro)&quot;, &quot;dev_db (t3.small)&quot;]</code></p></li></ul><h4 id='3-تحويل-list-لـ-map'><strong><span>3. تحويل </span><code>List</code><span> لـ </span><code>Map</code></strong></h4><ul><li><p><strong><span>المشكلة:</span></strong><span> عندك </span><code>list</code><span> من الـ </span><code>objects</code><span> أو الـ </span><code>strings</code><span> وعايز تحولها لـ </span><code>map</code><span> عشان تقدر توصلها بـ </span><code>key</code><span> معين.</span></p></li><li><p><strong><span>أ. تحويل </span><code>List</code><span> من الـ </span><code>Strings</code><span> لـ </span><code>Map</code><span> بـ </span><code>key</code><span> من نفس الـ </span><code>value</code><span>:</span></strong></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"feature_flags"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">list</span>(<span class="cm-variable">string</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> <span class="cm-operator">=</span> [<span class="cm-string">"new_dashboard"</span>, <span class="cm-string">"dark_mode"</span>, <span class="cm-string">"user_profile_v2"</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"feature_flag_map"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> {<span class="cm-keyword">for</span> <span class="cm-variable">flag</span> <span class="cm-keyword">in</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">feature_flags</span> <span class="cm-operator">:</span> <span class="cm-variable">flag</span> <span class="cm-operator">=&gt;</span> <span class="cm-keyword">true</span>} </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 179px;"></div><div class="CodeMirror-gutters" style="display: none; height: 179px;"></div></div></div></pre><p>&nbsp;</p><ul><li><p><strong><span>الـ </span><code>Output</code><span> المتوقع:</span></strong><span> </span><code>{&quot;new_dashboard&quot; = true, &quot;dark_mode&quot; = true, &quot;user_profile_v2&quot; = true}</code></p></li><li><p><strong><span>ب. تحويل </span><code>List</code><span> من الـ </span><code>Objects</code><span> لـ </span><code>Map</code><span> بـ </span><code>key</code><span> محدد:</span></strong></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"users_details"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> <span class="cm-operator">=</span> <span class="cm-variable">list</span>(<span class="cm-variable">object</span>({</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">id</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">string</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">name</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">string</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">email</span> <span class="cm-operator">=</span> <span class="cm-variable">string</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> <span class="cm-operator">=</span> [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  { <span class="cm-variable">id</span> <span class="cm-operator">=</span> <span class="cm-string">"u1"</span>, <span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-string">"Alice"</span>, <span class="cm-variable">email</span> <span class="cm-operator">=</span> <span class="cm-string">"alice@example.com"</span> },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  { <span class="cm-variable">id</span> <span class="cm-operator">=</span> <span class="cm-string">"u2"</span>, <span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-string">"Bob"</span>, &nbsp; <span class="cm-variable">email</span> <span class="cm-operator">=</span> <span class="cm-string">"bob@example.com"</span> }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  ]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"users_by_id"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> {<span class="cm-keyword">for</span> <span class="cm-variable">user</span> <span class="cm-keyword">in</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">users_details</span> <span class="cm-operator">:</span> <span class="cm-variable">user</span><span class="cm-operator">.</span><span class="cm-property">id</span> <span class="cm-operator">=&gt;</span> <span class="cm-variable">user</span><span class="cm-operator">.</span><span class="cm-property">name</span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 336px;"></div><div class="CodeMirror-gutters" style="display: none; height: 336px;"></div></div></div></pre><p>&nbsp;</p><ul><li><p><strong><span>الـ </span><code>Output</code><span> المتوقع:</span></strong><span> </span><code>{&quot;u1&quot; = &quot;Alice&quot;, &quot;u2&quot; = &quot;Bob&quot;}</code></p></li></ul><h4 id='4-تحويل-map-لـ-map-مع-أو-بدون-filter'><strong><span>4. تحويل </span><code>Map</code><span> لـ </span><code>Map</code><span> (مع أو بدون </span><code>Filter</code><span>)</span></strong></h4><ul><li><p><strong><span>المشكلة:</span></strong><span> عندك </span><code>map</code><span> وعايز تغير شكل الـ </span><code>keys</code><span> أو الـ </span><code>values</code><span> بتاعته، أو تصفيه.</span></p></li><li><p><strong><span>أ. تغيير الـ </span><code>Keys</code><span> في </span><code>Map</code><span>:</span></strong>
<span>لو عايز تضيف </span><code>prefix</code><span> لكل </span><code>key</code><span> في الـ </span><code>map</code><span>.</span></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"app_settings"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">map</span>(<span class="cm-variable">string</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">timeout_seconds</span> <span class="cm-operator">=</span> <span class="cm-string">"30"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">retries_count</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"5"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"prefixed_settings"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> {<span class="cm-keyword">for</span> <span class="cm-variable">k</span>, <span class="cm-variable">v</span> <span class="cm-keyword">in</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">app_settings</span> <span class="cm-operator">:</span> <span class="cm-string">"APP_${upper(k)}"</span> <span class="cm-operator">=&gt;</span> <span class="cm-variable">v</span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 246px;"></div><div class="CodeMirror-gutters" style="display: none; height: 246px;"></div></div></div></pre><p>&nbsp;</p><ul><li><p><strong><span>الـ </span><code>Output</code><span> المتوقع:</span></strong><span> </span><code>{&quot;APP_TIMEOUT_SECONDS&quot; = &quot;30&quot;, &quot;APP_RETRIES_COUNT&quot; = &quot;5&quot;}</code></p></li><li><p><strong><span>ب. تصفية </span><code>Map</code><span> بناءً على الـ </span><code>Value</code><span>:</span></strong>
<span>لو عايز تجيب بس الـ </span><code>settings</code><span> اللي قيمتها أرقام.</span></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"numeric_settings"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> {<span class="cm-keyword">for</span> <span class="cm-variable">k</span>, <span class="cm-variable">v</span> <span class="cm-keyword">in</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">app_settings</span> <span class="cm-operator">:</span> <span class="cm-variable">k</span> <span class="cm-operator">=&gt;</span> <span class="cm-variable">v</span> <span class="cm-keyword">if</span> <span class="cm-variable">can</span>(<span class="cm-variable">tonumber</span>(<span class="cm-variable">v</span>))}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 67px;"></div><div class="CodeMirror-gutters" style="display: none; height: 67px;"></div></div></div></pre><p>&nbsp;</p><ul><li><p><strong><span>الـ </span><code>Output</code><span> المتوقع:</span></strong><span> </span><code>{&quot;timeout_seconds&quot; = &quot;30&quot;, &quot;retries_count&quot; = &quot;5&quot;}</code></p><p><code>can(tonumber(v))</code><span> بتشوف لو الـ </span><code>value</code><span> ممكن يتحول لرقم ولا لأ.</span></p></li></ul><p><span>الأمثلة دي بتوريلك قد إيه </span><code>for expression</code><span> مرنة وقوية في التعامل مع البيانات في </span><code>Terraform</code><span>.</span></p><p>&nbsp;</p><h3 id='loops-with-the-for-string-directive'><span>Loops with the for String Directive</span></h3><p><span>قبل كده في الكتاب، أنت اتعلمت عن الـ </span><code>string interpolations</code><span> (دمج الـ </span><code>strings</code><span>)، واللي بتسمحلك تشاور على كود </span><code>Terraform</code><span> جوه الـ </span><code>strings</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">"Hello, ${var.name}"</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>الـ </span><code>String directives</code><span> بتسمحلك تستخدم </span><code>control statements</code><span> (أوامر تحكم) (زي الـ </span><code>for-loops</code><span> و الـ </span><code>if-statements</code><span>) جوه الـ </span><code>strings</code><span> باستخدام </span><code>syntax</code><span> شبه الـ </span><code>string interpolations</code><span>، بس بدل ما بتستخدم علامة الـ </span><code>dollar sign</code><span> والـ </span><code>curly braces</code><span> (</span><code>${...}</code><span>)، بتستخدم علامة الـ </span><code>percent sign</code><span> والـ </span><code>curly braces</code><span> (</span><code>%{...}</code><span>).</span></p><p><code>Terraform</code><span> بيدعم نوعين من الـ </span><code>string directives</code><span>: الـ </span><code>for-loops</code><span> والـ </span><code>conditionals</code><span>. في الجزء ده، هنتكلم عن الـ </span><code>for-loops</code><span>؛ وهنرجع للـ </span><code>conditionals</code><span> بعدين في الفصل.</span></p><p><span>الـ </span><code>for string directive</code><span> بيستخدم الـ </span><code>syntax</code><span> اللي جاي ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">%{ for &lt;ITEM&gt; in &lt;COLLECTION&gt; }&lt;BODY&gt;%{ endfor }</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>حيث إن </span><code>COLLECTION</code><span> دي </span><code>list</code><span> أو </span><code>map</code><span> عشان تعمل عليها </span><code>loop</code><span>، و </span><code>ITEM</code><span> ده اسم الـ </span><code>local variable</code><span> اللي هيتم تخصيصه لكل </span><code>item</code><span> في الـ </span><code>COLLECTION</code><span>، و </span><code>BODY</code><span> ده هو اللي هيتعمله </span><code>render</code><span> (إظهار/توليد) في كل </span><code>iteration</code><span> (تكرار) (واللي ممكن يشاور على </span><code>ITEM</code><span>). وده مثال:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"names"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"Names to render"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">list</span>(<span class="cm-variable">string</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> &nbsp; &nbsp; <span class="cm-operator">=</span> [<span class="cm-string">"neo"</span>, <span class="cm-string">"trinity"</span>, <span class="cm-string">"morpheus"</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"for_directive"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-string">"%{ for name in var.names }${name}, %{ endfor }"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 202px;"></div><div class="CodeMirror-gutters" style="display: none; height: 202px;"></div></div></div></pre><p><span>لما تعمل </span><code>run</code><span> لـ </span><code>terraform apply</code><span>، هيطلعلك الـ </span><code>output</code><span> اللي جاي ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">$ terraform apply</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(...)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Outputs:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">for_directive = "neo, trinity, morpheus, "</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p><span>فيه كمان </span><code>version</code><span> من الـ </span><code>for string directive syntax</code><span> بيديلك الـ </span><code>index</code><span> في الـ </span><code>for-loop</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">%{ for &lt;INDEX&gt;, &lt;ITEM&gt; in &lt;COLLECTION&gt; }&lt;BODY&gt;%{ endfor }</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>وده مثال بيستخدم الـ </span><code>index</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"for_directive_index"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-string">"%{ for i, name in var.names }(${i}) ${name}, %{ endfor }"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 67px;"></div><div class="CodeMirror-gutters" style="display: none; height: 67px;"></div></div></div></pre><p><span>لما تعمل </span><code>run</code><span> لـ </span><code>terraform apply</code><span>، هيطلعلك الـ </span><code>output</code><span> اللي جاي ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">$ terraform apply</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(...)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Outputs:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">for_directive_index = "(0) neo, (1) trinity, (2) morpheus, "</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p><span>لاحظ إزاي في الاتنين </span><code>outputs</code><span> فيه </span><code>trailing comma and space</code><span> (فاصلة ومسافة زيادة في الآخر). ممكن تصلح المشكلة دي باستخدام الـ </span><code>conditionals</code><span> — وبالتحديد، الـ </span><code>if string directive</code><span> — زي ما هو مشروح في الجزء اللي جاي.</span></p><h2 id='conditionals'><span>Conditionals</span></h2><p><span> زي ما </span><code>Terraform</code><span> بيديلك كذا طريقة مختلفة تعمل بيها </span><code>loops</code><span>، هو برضه بيديلك كذا طريقة مختلفة تعمل بيها الـ </span><strong><code>conditionals</code></strong><span> ، وكل واحدة فيهم معمولة عشان تستخدم في </span><code>scenario</code><span> \ مختلف شوية عن التانية:</span></p><ul><li><p><strong><code>count parameter</code></strong>
<span>ده بيستخدم للـ </span><code>conditional resources</code><span> (يعني تعمل </span><code>resource</code><span> بشرط أو متعملهوش خالص).</span></p></li><li><p><strong><code>for_each</code><span> و </span><code>for expressions</code></strong>
<span>دول بيستخدموا برضه للـ </span><code>conditional resources</code><span>، وكمان للـ </span><code>inline blocks</code><span> اللي بتبقى جوه </span><code>resource</code><span> نفسه.</span></p></li><li><p><strong><code>if string directive</code></strong>
<span>ده بيستخدم عشان تعمل </span><code>conditionals</code><span> جوه </span><code>string</code><span> نفسه.</span></p></li></ul><p><span>خلينا نمسكهم واحدة واحدة ونشرحهم.</span></p><h3 id='الـ-if-statements-باستخدام--الـ-count'><strong><span>الـ If-statements باستخدام  الـ </span><code>count</code></strong></h3><p><span>في الفصل الرابع، إنت عملت </span><code>module</code><span> زي ما يكون &quot;blue print&quot; تقدر تستخدمه عشان تعمل </span><code>deploy</code><span> لـ </span><code>web server clusters</code><span>. الـ </span><code>module</code><span> ده كان بيعمل </span><code>Auto Scaling Group (ASG)</code><span>، و </span><code>Application Load Balancer (ALB)</code><span>، و </span><code>security groups</code><span>، وشوية حاجات تانية. بس كان فيه حاجة واحدة الـ </span><code>module</code><span> ده مش بيعملها: الـ </span><code>scheduled action</code><span>.</span></p><p><span>ولأنك كنت عايز تعمل </span><code>scale</code><span> (تكبير وتصغير) للـ </span><code>cluster</code><span> في الـ </span><code>production</code><span> بس، عرّفت الـ </span><code>aws_autoscaling_schedule resources</code><span> دي مباشرةً في الكود بتاع الـ </span><code>production</code><span> في الـpath اللي هو </span><code>live/prod/services/webserver-cluster/main.tf</code><span>.</span></p><p><span>السؤال هنا: هل فيه طريقة تقدر تعرف بيها الـ </span><code>aws_autoscaling_schedule resources</code><span> دي جوه الـ </span><code>webserver-cluster module</code><span> نفسه، وتخليها تتنفذ لناس ومش لناس تانية؟ يعني تعملها </span><code>enable</code><span> في الـ </span><code>production</code><span> وتعملها </span><code>disable</code><span> في الـ </span><code>staging</code><span>؟</span></p><p><span>يلا نجرب. أول خطوة هي إننا نضيف </span><code>input variable</code><span> جديد من نوع </span><code>boolean</code><span> (يعني </span><code>true</code><span> أو </span><code>false</code><span>) في ملف </span><code>modules/services/webserver-cluster/variables.tf</code><span>. هنستخدم الـ </span><code>variable</code><span> ده عشان نحدد إذا كنا هنشغل الـ </span><code>auto scaling</code><span> ولا لأ:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"enable_autoscaling"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"If set to true, enable auto scaling"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">bool</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><span>دلوقتي، لو دي كانت لغة برمجة عادية، كنت ممكن تستخدم الـ </span><code>variable</code><span> ده في </span><code>if-statement</code><span> زي كده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># ده مجرد كود توضيحي، مش هيشتغل في Terraform</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">if</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">enable_autoscaling</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">resource</span> <span class="cm-string">"aws_autoscaling_schedule"</span> <span class="cm-string">"scale_out_during_business_hours"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># ... (باقي الكود)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">resource</span> <span class="cm-string">"aws_autoscaling_schedule"</span> <span class="cm-string">"scale_in_at_night"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># ... (باقي الكود)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 202px;"></div><div class="CodeMirror-gutters" style="display: none; height: 202px;"></div></div></div></pre><p><code>Terraform</code><span> مش بيدعم </span><code>if-statements</code><span> بالشكل ده، فالكود ده مش هيشتغل. بس إحنا نقدر نعمل نفس الحاجة بالظبط باستخدام الـ </span><code>count parameter</code><span> ونستغل خاصيتين:</span></p><ol start='' ><li><p><span>لو خليت </span><code>count = 1</code><span> على أي </span><code>resource</code><span>، </span><code>Terraform</code><span> هينشئ نسخة واحدة منه. ولو خليت </span><code>count = 0</code><span>، الـ </span><code>resource</code><span> ده مش هيتعمل خالص.</span></p></li><li><p><code>Terraform</code><span> بيدعم حاجة اسمها </span><code>conditional expressions</code>
<span>(أو </span><code>ternary operator</code><span>) اللي شكلها كده: </span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 335.234px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">`&lt;CONDITION&gt; ? &lt;TRUE_VAL&gt; : &lt;FALSE_VAL&gt;`</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p>&nbsp;</p></li><li><p><span>. دي بتشوف الشرط اللي في </span><code>CONDITION</code><span>، لو طلع </span><code>true</code><span> بترجع </span><code>TRUE_VAL</code><span>، ولو طلع </span><code>false</code><span> بترجع </span><code>FALSE_VAL</code><span>.</span></p></li></ol><p><span>لما نركب الفكرتين دول مع بعض، نقدر نعدل الـ </span><code>webserver-cluster module</code><span> بالشكل ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_autoscaling_schedule"</span> <span class="cm-string">"scale_out_during_business_hours"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">count</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">enable_autoscaling</span> <span class="cm-string">? </span><span class="cm-number">1</span> <span class="cm-operator">:</span> <span class="cm-number">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">scheduled_action_name</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"${var.cluster_name}-scale-out-during-business-hours"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">min_size</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-number">2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">max_size</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-number">10</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">desired_capacity</span> &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-number">10</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">recurrence</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"0 9 * * *"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">autoscaling_group_name</span> <span class="cm-operator">=</span> <span class="cm-variable">aws_autoscaling_group</span><span class="cm-operator">.</span><span class="cm-property">example</span><span class="cm-operator">.</span><span class="cm-property">name</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_autoscaling_schedule"</span> <span class="cm-string">"scale_in_at_night"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">count</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">enable_autoscaling</span> <span class="cm-string">? </span><span class="cm-number">1</span> <span class="cm-operator">:</span> <span class="cm-number">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">scheduled_action_name</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"${var.cluster_name}-scale-in-at-night"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">min_size</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-number">2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">max_size</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-number">10</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">desired_capacity</span> &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-number">2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">recurrence</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"0 17 * * *"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">autoscaling_group_name</span> <span class="cm-operator">=</span> <span class="cm-variable">aws_autoscaling_group</span><span class="cm-operator">.</span><span class="cm-property">example</span><span class="cm-operator">.</span><span class="cm-property">name</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 493px;"></div><div class="CodeMirror-gutters" style="display: none; height: 493px;"></div></div></div></pre><p><span>لو </span><code>var.enable_autoscaling</code><span> كانت بـ </span><code>true</code><span>، الـ </span><code>count</code><span> بتاع كل </span><code>aws_autoscaling_schedule resource</code><span> هيبقى بـ </span><code>1</code><span>، فهيتعمل منهم نسخة واحدة. ولو </span><code>var.enable_autoscaling</code><span> كانت بـ </span><code>false</code><span>، الـ </span><code>count</code><span> بتاعهم هيبقى بـ </span><code>0</code><span>، فمش هيتعملوا خالص. وده بالظبط الـ </span><code>logic</code><span> اللي إحنا عايزينه!</span></p><p><span>دلوقتي تقدر تعدل طريقة استخدام الـ </span><code>module</code><span> ده في الـ </span><code>staging</code><span> (في ملف </span><code>live/stage/services/webserver-cluster/main.tf</code><span>) عشان تقفل الـ </span><code>auto scaling</code><span> عن طريق إنك تخلي </span><code>enable_autoscaling</code><span> بـ </span><code>false</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">module</span> <span class="cm-string">"webserver_cluster"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">source</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"../../../../modules/services/webserver-cluster"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">cluster_name</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"webservers-stage"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">db_remote_state_bucket</span> <span class="cm-operator">=</span> <span class="cm-string">"(YOUR_BUCKET_NAME)"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">db_remote_state_key</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"stage/data-stores/mysql/terraform.tfstate"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">instance_type</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"t2.micro"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">min_size</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-number">2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">max_size</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-number">2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">enable_autoscaling</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-keyword">false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 246px;"></div><div class="CodeMirror-gutters" style="display: none; height: 246px;"></div></div></div></pre><p><span>وبنفس الطريقة، تقدر تعدل استخدامه في الـ </span><code>production</code><span> (في ملف </span><code>live/prod/services/webserver-cluster/main.tf</code><span>) عشان تشغل الـ </span><code>auto scaling</code><span> عن طريق إنك تخلي </span><code>enable_autoscaling</code><span> بـ </span><code>true</code><span>. (متنساش تشيل الـ </span><code>aws_autoscaling_schedule resources</code><span> اللي كنت كاتبها يدوي في الـ </span><code>production</code><span> في الفصل الرابع):</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">module</span> <span class="cm-string">"webserver_cluster"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">source</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"../../../../modules/services/webserver-cluster"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">cluster_name</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"webservers-prod"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">db_remote_state_bucket</span> <span class="cm-operator">=</span> <span class="cm-string">"(YOUR_BUCKET_NAME)"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">db_remote_state_key</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"prod/data-stores/mysql/terraform.tfstate"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">instance_type</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"m4.large"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">min_size</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-number">2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">max_size</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-number">10</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">enable_autoscaling</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 246px;"></div><div class="CodeMirror-gutters" style="display: none; height: 246px;"></div></div></div></pre><p><strong><span>المبدأ الأساسي: الـ </span><code>Conditional Logic</code><span> في </span><code>Terraform</code></strong></p><p><span>زي ما اتفقنا، </span><code>Terraform</code><span> معندوش </span><code>if-statement</code><span> صريح زي لغات البرمجة، بس بنستخدم 2 tricks عشان نعمل نفس التأثير:</span></p><ol start='' ><li><p><strong><span>للتحكم في وجود </span><code>Resource</code><span> (إنشاء أو عدم إنشاء):</span></strong></p><ul><li><p><code>count = &lt;condition&gt; ? 1 : 0</code></p></li></ul></li><li><p><strong><span>للتحكم في قيمة </span><code>Argument</code><span> (تغيير قيمة بناءً على شرط):</span></strong></p><ul><li><p><code>argument = &lt;condition&gt; ? &quot;value_if_true&quot; : &quot;value_if_false&quot;</code></p></li></ul></li></ol><p><span>خلينا نشوف أمثلة عملية على كل ده.</span></p><hr /><p><strong><span>أمثلة على التحكم في وجود الـ </span><code>Resource</code><span> (الإنشاء من عدمه)</span></strong></p><p><strong><span>مثال 1: إنشاء </span><code>CloudWatch Alarm</code><span> للـ </span><code>Production</code><span> فقط</span></strong></p><p><strong><span>السيناريو:</span></strong><span> عايز تعمل </span><code>alarm</code><span> يبعتلك تنبيه لو استخدام الـ </span><code>CPU</code><span> على الـ </span><code>EC2 instance</code><span> بتاعتك عدى 90%، بس الـ </span><code>alarm</code><span> ده مهم بس في الـ </span><code>production</code><span> عشان متتزعجش من تنبيهات وهمية في بيئة الـ </span><code>staging</code><span>.</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"is_prod"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">bool</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> <span class="cm-operator">=</span> <span class="cm-keyword">false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_cloudwatch_metric_alarm"</span> <span class="cm-string">"high_cpu"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">count</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">is_prod</span> <span class="cm-string">? </span><span class="cm-number">1</span> <span class="cm-operator">:</span> <span class="cm-number">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">alarm_name</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"high-cpu-utilization"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">comparison_operator</span> <span class="cm-operator">=</span> <span class="cm-string">"GreaterThanOrEqualToThreshold"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">evaluation_periods</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"2"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">metric_name</span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"CPUUtilization"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">namespace</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"AWS/EC2"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">period</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"120"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">statistic</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"Average"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">threshold</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-number">90</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">alarm_description</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"This metric monitors ec2 cpu utilization"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">dimensions</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag">InstanceId</span> <span class="cm-operator">=</span> <span class="cm-variable">aws_instance</span><span class="cm-operator">.</span><span class="cm-property">my_server</span><span class="cm-operator">.</span><span class="cm-property">id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 470px;"></div><div class="CodeMirror-gutters" style="display: none; height: 470px;"></div></div></div></pre><p><span> الـ </span><code>alarm</code><span> هيتعمل بس لو </span><code>is_prod</code><span> بـ </span><code>true</code><span>.</span></p><hr /><p><strong><span>مثال 2: إنشاء </span><code>S3 Bucket</code><span> لتخزين الـ </span><code>Access Logs</code><span> (لو طلبنا كده)</span></strong></p><p><strong><span>السيناريو:</span></strong><span> عندك </span><code>Load Balancer</code><span>، وعايز تدي للمستخدم خيار (عن طريق </span><code>variable</code><span>) إنه يفعل أو يلغي تسجيل الـ </span><code>access logs</code><span>. لو فعلها، </span><code>Terraform</code><span> المفروض ينشئ </span><code>S3 bucket</code><span> جديد عشان يخزن فيه الـ </span><code>logs</code><span> دي.</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"enable_lb_access_logs"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">bool</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> <span class="cm-operator">=</span> <span class="cm-keyword">false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_s3_bucket"</span> <span class="cm-string">"lb_logs"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">count</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">enable_lb_access_logs</span> <span class="cm-string">? </span><span class="cm-number">1</span> <span class="cm-operator">:</span> <span class="cm-number">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">bucket</span> <span class="cm-operator">=</span> <span class="cm-string">"my-app-lb-logs-${random_id.id.hex}"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_lb"</span> <span class="cm-string">"my_app_lb"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">access_logs</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">count</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">enable_lb_access_logs</span> <span class="cm-string">? </span><span class="cm-number">1</span> <span class="cm-operator">:</span> <span class="cm-number">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">bucket</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">aws_s3_bucket</span><span class="cm-operator">.</span><span class="cm-property">lb_logs</span>[<span class="cm-number">0</span>]<span class="cm-operator">.</span><span class="cm-property">bucket</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">prefix</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"app-lb"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">enabled</span> <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 448px;"></div><div class="CodeMirror-gutters" style="display: none; height: 448px;"></div></div></div></pre><p><strong><span>ملاحظة هامة:</span></strong><span> لما تستخدم </span><code>count</code><span> على </span><code>resource</code><span>، لازم تشاور عليه بعد كده بالـ </span><code>index</code><span> بتاعه، زي </span><code>aws_s3_bucket.lb_logs[0]</code><span>.</span></p><hr /><p><strong><span>أمثلة على التحكم في قيمة </span><code>Argument</code><span> </span></strong></p><p><strong><span>مثال 3: اختيار حجم الـ </span><code>Instance</code><span> بناءً على البيئة</span></strong></p><p><strong><span>السيناريو:</span></strong><span> عايز الـ </span><code>EC2 instance</code><span> بتاعتك تكون صغيرة ورخيصة (</span><code>t2.micro</code><span>) في الـ </span><code>staging</code><span>، وتكون كبيرة وقوية (</span><code>m5.large</code><span>) في الـ </span><code>production</code><span>.</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"environment"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">string</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> <span class="cm-operator">=</span> <span class="cm-string">"staging"</span> <span class="cm-comment"># staging or prod</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_instance"</span> <span class="cm-string">"my_server"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">ami</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"ami-123456"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># هنا السحر كله</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">instance_type</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">environment</span> <span class="cm-operator">==</span> <span class="cm-string">"prod"</span> <span class="cm-string">? "m5.large"</span> <span class="cm-operator">:</span> <span class="cm-string">"t2.micro"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 291px;"></div><div class="CodeMirror-gutters" style="display: none; height: 291px;"></div></div></div></pre><p><strong><span>النتيجة:</span></strong><span> </span><code>Terraform</code><span> هيقارن قيمة </span><code>var.environment</code><span>، لو هي </span><code>prod</code><span> هيختار </span><code>m5.large</code><span>، ولو أي حاجة تانية هيختار </span><code>t2.micro</code><span>.</span></p><hr /><p><strong><span>مثال 4: تغيير الـ </span><code>Tags</code><span> بناءً على البيئة</span></strong></p><p><strong><span>السيناريو:</span></strong><span> عايز تضيف </span><code>tag</code><span> معين اسمه </span><code>CostCenter</code><span> على كل الـ </span><code>resources</code><span>، بس القيمة بتاعته تختلف. في الـ </span><code>prod</code><span> يبقى </span><code>PROD-FINANCE</code><span>، وفي الـ </span><code>staging</code><span> يبقى </span><code>DEV-TESTING</code><span>.</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># هنستخدم نفس الـ variable اللي اسمها environment</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_vpc"</span> <span class="cm-string">"main"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">cidr_block</span> <span class="cm-operator">=</span> <span class="cm-string">"10.0.0.0/16"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">tags</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag">Name</span> <span class="cm-operator">=</span> <span class="cm-string">"main-vpc"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag">Env</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">environment</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-tag">CostCenter</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">environment</span> <span class="cm-operator">==</span> <span class="cm-string">"prod"</span> <span class="cm-string">? "PROD-FINANCE"</span> <span class="cm-operator">:</span> <span class="cm-string">"DEV-TESTING"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 269px;"></div><div class="CodeMirror-gutters" style="display: none; height: 269px;"></div></div></div></pre><p>&nbsp;</p><h3 id='الـ-if-else-statements-باستخدام--الـ-count'><strong><span>الـ If-else-statements باستخدام  الـ </span><code>count</code></strong></h3><p><span>دلوقتي بعد ما عرفت إزاي تعمل </span><code>if-statement</code><span>، طب لو عايز تعمل </span><code>if-else</code><span>؟ يعني لو حصل كذا اعمل حاجة، ولو محصلش اعمل حاجة تانية خالص.</span></p><p><span>في أول الفصل، إحنا عملنا كذا </span><code>IAM user</code><span> ليهم صلاحيات قراءة بس على </span><code>EC2</code><span>. تخيل إنك عايز تدي لواحد منهم، اسمه </span><code>neo</code><span>، صلاحيات على </span><code>CloudWatch</code><span> كمان. بس عايز اللي بيشغل الكود هو اللي يقرر: هل </span><code>neo</code><span> ياخد صلاحيات قراءة بس (</span><code>read-only</code><span>) ولا صلاحيات كاملة (</span><code>full access</code><span>)؟ ده مثال ممكن يكون متفبرك شوية، بس مفيد عشان يوضح الفكرة.</span></p><p><span>دي </span><code>IAM Policy</code><span> بتدي صلاحيات قراءة بس على </span><code>CloudWatch</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_iam_policy"</span> <span class="cm-string">"cloudwatch_read_only"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">name</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"cloudwatch-read-only"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">policy</span> <span class="cm-operator">=</span> <span class="cm-variable">data</span><span class="cm-operator">.</span><span class="cm-property">aws_iam_policy_document</span><span class="cm-operator">.</span><span class="cm-property">cloudwatch_read_only</span><span class="cm-operator">.</span><span class="cm-property">json</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">data</span> <span class="cm-string">"aws_iam_policy_document"</span> <span class="cm-string">"cloudwatch_read_only"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">statement</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">effect</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"Allow"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">actions</span> &nbsp; <span class="cm-operator">=</span> [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string">"cloudwatch:Describe*"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string">"cloudwatch:Get*"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string">"cloudwatch:List*"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">resources</span> <span class="cm-operator">=</span> [<span class="cm-string">"*"</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 358px;"></div><div class="CodeMirror-gutters" style="display: none; height: 358px;"></div></div></div></pre><p><span>ودي </span><code>IAM Policy</code><span> تانية بتدي صلاحيات كاملة (</span><code>full access</code><span>) على </span><code>CloudWatch</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_iam_policy"</span> <span class="cm-string">"cloudwatch_full_access"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">name</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"cloudwatch-full-access"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">policy</span> <span class="cm-operator">=</span> <span class="cm-variable">data</span><span class="cm-operator">.</span><span class="cm-property">aws_iam_policy_document</span><span class="cm-operator">.</span><span class="cm-property">cloudwatch_full_access</span><span class="cm-operator">.</span><span class="cm-property">json</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">data</span> <span class="cm-string">"aws_iam_policy_document"</span> <span class="cm-string">"cloudwatch_full_access"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">statement</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">effect</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"Allow"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">actions</span> &nbsp; <span class="cm-operator">=</span> [<span class="cm-string">"cloudwatch:*"</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">resources</span> <span class="cm-operator">=</span> [<span class="cm-string">"*"</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 269px;"></div><div class="CodeMirror-gutters" style="display: none; height: 269px;"></div></div></div></pre><p><span>الهدف إننا نعمل </span><code>attach</code><span> لواحدة بس من الاتنين دول لـ </span><code>user</code><span> اللي اسمه </span><code>neo</code><span>، وده هيعتمد على قيمة </span><code>variable</code><span> جديد اسمه </span><code>give_neo_cloudwatch_full_access</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"give_neo_cloudwatch_full_access"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"If true, neo gets full access to CloudWatch"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">bool</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><span>لو دي لغة برمجة عادية، كنت هتعمل </span><code>if-else</code><span> بالشكل ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">if</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">give_neo_cloudwatch_full_access</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">resource</span> <span class="cm-string">"aws_iam_user_policy_attachment"</span> <span class="cm-string">"neo_cloudwatch_full_access"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">user</span> &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">aws_iam_user</span><span class="cm-operator">.</span><span class="cm-property">example</span>[<span class="cm-number">0</span>]<span class="cm-operator">.</span><span class="cm-property">name</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">policy_arn</span> <span class="cm-operator">=</span> <span class="cm-variable">aws_iam_policy</span><span class="cm-operator">.</span><span class="cm-property">cloudwatch_full_access</span><span class="cm-operator">.</span><span class="cm-property">arn</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">} <span class="cm-keyword">else</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">resource</span> <span class="cm-string">"aws_iam_user_policy_attachment"</span> <span class="cm-string">"neo_cloudwatch_read_only"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">user</span> &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">aws_iam_user</span><span class="cm-operator">.</span><span class="cm-property">example</span>[<span class="cm-number">0</span>]<span class="cm-operator">.</span><span class="cm-property">name</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">policy_arn</span> <span class="cm-operator">=</span> <span class="cm-variable">aws_iam_policy</span><span class="cm-operator">.</span><span class="cm-property">cloudwatch_read_only</span><span class="cm-operator">.</span><span class="cm-property">arn</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 246px;"></div><div class="CodeMirror-gutters" style="display: none; height: 246px;"></div></div></div></pre><p><span>عشان نعمل الحركة دي في </span><code>Terraform</code><span>، بنستخدم  الـ </span><code>count</code><span> مع الـ </span><code>ternary operator</code><span> على كل </span><code>resource</code><span> لوحده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_iam_user_policy_attachment"</span> <span class="cm-string">"neo_cloudwatch_full_access"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">count</span> &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">give_neo_cloudwatch_full_access</span> <span class="cm-string">? </span><span class="cm-number">1</span> <span class="cm-operator">:</span> <span class="cm-number">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">user</span> &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">aws_iam_user</span><span class="cm-operator">.</span><span class="cm-property">example</span>[<span class="cm-number">0</span>]<span class="cm-operator">.</span><span class="cm-property">name</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">policy_arn</span> <span class="cm-operator">=</span> <span class="cm-variable">aws_iam_policy</span><span class="cm-operator">.</span><span class="cm-property">cloudwatch_full_access</span><span class="cm-operator">.</span><span class="cm-property">arn</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_iam_user_policy_attachment"</span> <span class="cm-string">"neo_cloudwatch_read_only"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">count</span> &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">give_neo_cloudwatch_full_access</span> <span class="cm-string">? </span><span class="cm-number">0</span> <span class="cm-operator">:</span> <span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">user</span> &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">aws_iam_user</span><span class="cm-operator">.</span><span class="cm-property">example</span>[<span class="cm-number">0</span>]<span class="cm-operator">.</span><span class="cm-property">name</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">policy_arn</span> <span class="cm-operator">=</span> <span class="cm-variable">aws_iam_policy</span><span class="cm-operator">.</span><span class="cm-property">cloudwatch_read_only</span><span class="cm-operator">.</span><span class="cm-property">arn</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 246px;"></div><div class="CodeMirror-gutters" style="display: none; height: 246px;"></div></div></div></pre><p><span>الكود ده فيه اتنين </span><code>aws_iam_user_policy_attachment resources</code><span>. الأولاني بتاع الـ </span><code>full access</code><span>، الشرط بتاعه (</span><code>? 1 : 0</code><span>) هيخليه يتنفذ (يعني الـ </span><code>count</code><span> يبقى 1) لو الـ </span><code>variable</code><span> بـ </span><code>true</code><span>. ده جزء الـ </span><strong><code>if</code></strong><span>. التاني بتاع الـ </span><code>read-only</code><span> بيعمل العكس بالظبط (</span><code>? 0 : 1</code><span>)، فالـ </span><code>count</code><span> بتاعه هيبقى 1 لو الـ </span><code>variable</code><span> بـ </span><code>false</code><span>. ده جزء الـ </span><strong><code>else</code></strong><span>.</span>
<span>وبكده، أنت ضمنت إن واحد بس منهم هو اللي هيتعمله </span><code>create</code><span> كل مرة. مبروك، كده عملت </span><code>if-else</code><span>!</span></p><p><strong><span>المشكلة اللي بعد كده: إزاي توصل للـ </span><code>output</code><span> الصح؟</span></strong></p><p><span>طيب، دلوقتي إزاي أوصل للـ </span><code>attribute</code><span> بتاع الـ </span><code>resource</code><span> اللي اتعمل </span><strong><span>فعلًا</span></strong><span>؟ يعني لو عايز أعمل </span><code>output</code><span> للـ </span><code>ARN</code><span> بتاع البوليسي اللي اتربطت فعلًا؟</span></p><p><span>الحل السريع إنك تستخدم </span><code>ternary operator</code><span> تاني:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"neo_cloudwatch_policy_arn"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> (</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">give_neo_cloudwatch_full_access</span> <span class="cm-string">? </span><span class="cm-variable">aws_iam_user_policy_attachment</span><span class="cm-operator">.</span><span class="cm-property">neo_cloudwatch_full_access</span>[<span class="cm-number">0</span>]<span class="cm-operator">.</span><span class="cm-property">policy_arn</span> <span class="cm-operator">:</span> <span class="cm-variable">aws_iam_user_policy_attachment</span><span class="cm-operator">.</span><span class="cm-property">neo_cloudwatch_read_only</span>[<span class="cm-number">0</span>]<span class="cm-operator">.</span><span class="cm-property">policy_arn</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  )</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 157px;"></div><div class="CodeMirror-gutters" style="display: none; height: 157px;"></div></div></div></pre><p><span>الكود ده هيشتغل، بس بنقول عليه </span><code>brittle</code><span> أو &quot;هش&quot;. ليه؟ عشان لو الشرط اللي فوق اتغير وبقى أعقد شوية، سهل أوي تنسى تعدل نفس الشرط هنا في الـ </span><code>output</code><span>. وساعتها هيجيلك </span><code>error</code><span> غريب عشان بتحاول توصل لحاجة في </span><code>list</code><span> فاضية.</span></p><p><strong><span>الحل الأحسن والأكثر أمانًا</span></strong></p><p><span>الحل الأفضل هو إننا نستخدم اتنين </span><code>functions</code><span> مع بعض: </span><strong><code>concat</code></strong><span> و </span><strong><code>one</code></strong><span>، ومعاهم  </span><code>[*]</code><span>.</span></p><ul><li><p><strong><code>concat</code><span>:</span></strong><span> بتاخد كذا </span><code>list</code><span> وتلزقهم في بعض وتعمل منهم </span><code>list</code><span> واحدة كبيرة.</span></p></li><li><p><strong><code>one</code><span>:</span></strong><span> بتاخد </span><code>list</code><span>. لو الـ </span><code>list</code><span> دي فاضية، بترجع </span><code>null</code><span> فاضية لو فيها عنصر واحد بس، بترجعهولك. لو فيها أكتر من عنصر، بتضرب </span><code>error</code><span>.</span></p></li><li><p><strong><code>[*]</code><span> (Splat Expression):</span></strong><span> لما بنحطها، إحنا بنقول لـ </span><code>Terraform</code><span>: &quot;هاتلي </span><code>list</code><span> بكل قيم الـ </span><code>policy_arn</code><span> من كل النسخ اللي اتعملت من الـ </span><code>resource</code><span> ده&quot;.</span></p></li></ul><p><span>لما نركبهم مع بعض، الكود بيبقى كده:</span></p><p>&nbsp;</p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"neo_cloudwatch_policy_arn"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-variable">one</span>(<span class="cm-variable">concat</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">aws_iam_user_policy_attachment</span><span class="cm-operator">.</span><span class="cm-property">neo_cloudwatch_full_access</span>[<span class="cm-operator">*</span>]<span class="cm-operator">.</span><span class="cm-property">policy_arn</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">aws_iam_user_policy_attachment</span><span class="cm-operator">.</span><span class="cm-property">neo_cloudwatch_read_only</span>[<span class="cm-operator">*</span>]<span class="cm-operator">.</span><span class="cm-property">policy_arn</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  ))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 157px;"></div><div class="CodeMirror-gutters" style="display: none; height: 157px;"></div></div></div></pre><div class="md-alert md-alert-tip tip"><p><span class='md-alert-text md-alert-text-tip'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>Tip</span><br></p><p><span>لما بتستخدم </span><code>count</code><span> عشان تعمل </span><code>if-else</code><span>، بيبقى عندك اتنين </span><code>resources</code><span>، واحد منهم بس هو اللي بيتعمل. إحنا عايزين نوصل للـ </span><code>output</code><span> بتاع اللي اتعمل ده من غير ما نكرر الشرط.</span></p><p><span>الحل بيتلخص في 3 خطوات:</span></p><ol start='' ><li><p><strong><code>[*]</code><span>:</span></strong><span> دي بتحول كل </span><code>resource</code><span> لـ </span><code>list</code><span>. فالـ </span><code>resource</code><span> اللي اتعمل بتبقى </span><code>list</code><span> فيها </span><code>ARN</code><span>، واللي متعملش بتبقى </span><code>list</code><span> فاضية </span><code>[]</code><span>.</span></p></li><li><p><strong><code>concat</code><span>:</span></strong><span> دي بتاخد الاتنين </span><code>lists</code><span> دول (الواحدة المليانة والتانية الفاضية) وتلزقهم في بعض. الناتج النهائي بيبقى </span><code>list</code><span> واحدة فيها الـ </span><code>ARN</code><span> الوحيد اللي إحنا عايزينه.</span></p></li><li><p><strong><code>one</code><span>:</span></strong><span> دي بتاخد الـ </span><code>list</code><span> النهائية دي (اللي فيها عنصر واحد بس)، وتشيلها من الـ </span><code>list</code><span> وترجعلك القيمة نفسها كـ </span><code>string</code><span>.</span></p></li></ol><p><span>باختصار، إحنا بنحول الاتنين </span><code>resources</code><span> لـ </span><code>lists</code><span>، ندمجهم في </span><code>list</code><span> واحدة أكيد فيها عنصر واحد، وبعدين بنطلع العنصر ده. الطريقة دي بتضمن إن الكود بتاعك يفضل شغال صح حتى لو غيرت شرط الـ </span><code>if-else</code><span> في المستقبل.</span></p></div><p><strong><span>ده بيشتغل إزاي؟</span></strong>
<span>اللي بيحصل هنا إن واحد من الـ </span><code>resources</code><span> دول الـ </span><code>list</code><span> بتاعته هتبقى فاضية (لأن الـ </span><code>count</code><span> بتاعه بصفر)، والتاني الـ </span><code>list</code><span> بتاعته هيبقى فيها عنصر واحد. لما </span><code>concat</code><span> تلزقهم، الناتج النهائي هيبقى </span><code>list</code><span> واحدة فيها عنصر واحد بس. ولما </span><code>one</code><span> تشتغل عليها، هترجعلك العنصر الوحيد ده بأمان. والطريقة دي هتفضل شغالة صح مهما كان الشرط بتاعك معقد، من غير ما تحتاج تكرر الـ </span><code>logic</code><span>.</span></p><p><span>استخدام </span><code>count</code><span> بالطريقة دي ممكن يبان &quot;لفة&quot; أو &quot;tricks&quot;، بس هي trick ذكية جدًا وشغالة كويس، وبتخليك تخفي التعقيد عن اللي بيستخدم الكود بتاعك.</span></p><p><strong><span>المبدأ الأساسي: الـ </span><code>If-Else</code><span> باستخدام </span><code>count</code><span> متعاكس</span></strong></p><p><span>الفكرة كلها بتعتمد على إنك بتعرّف </span><strong><span>الاحتمالين</span></strong><span> كـ </span><code>resources</code><span> منفصلة، وتستخدم </span><code>count</code><span> عشان تضمن إن واحد بس منهم هو اللي يتنفذ في كل مرة.</span></p><ul><li><p><code>resource &quot;A&quot;</code><span>: </span><code>count = &lt;condition&gt; ? 1 : 0</code><span> (جزء الـ </span><code>if</code><span>)</span></p></li><li><p><code>resource &quot;B&quot;</code><span>: </span><code>count = &lt;condition&gt; ? 0 : 1</code><span> (جزء الـ </span><code>else</code><span>)</span></p></li></ul><p><strong><span>مثال 1: وضع </span><code>EC2 Instance</code><span> بـ </span><code>Subnet</code><span> تكون public أو private</span></strong></p><p><span>عندك </span><code>EC2 instance</code><span> وعايز تدي للمستخدم خيار: هل السيرفر ده يتعمل في </span><code>public subnet</code><span> (ويكون معرض للإنترنت) ولا في </span><code>private subnet</code><span> (ويكون معزول)؟</span></p><p><strong><span>المشكلة:</span></strong><span> </span><code>EC2 instance</code><span> بتتربط بـ </span><code>subnet</code><span> واحدة بس، لكن </span><code>Terraform</code><span> معندوش طريقة مباشرة يقول بيها &quot;لو كذا حطه هنا، ولو كذا حطه هنا&quot;.</span></p><p><strong><span>الحل:</span></strong>
<span>هنعمل </span><code>resource</code><span> من نوع </span><code>aws_network_interface</code><span>، وهو ده اللي هنخليه يا في </span><code>public</code><span> يا في </span><code>private</code><span>، وبعدين نربطه بالـ </span><code>instance</code><span>.</span></p><p><strong><span>1. تعريف الـ </span><code>Variable</code><span>:</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"deploy_in_public_subnet"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"If true, deploy the instance in the public subnet. Otherwise, private."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">bool</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-keyword">false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 134px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><p><strong><span>2. بناء الـ </span><code>if-else</code><span>:</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_network_interface"</span> <span class="cm-string">"app_nic_public"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">count</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">deploy_in_public_subnet</span> <span class="cm-string">? </span><span class="cm-number">1</span> <span class="cm-operator">:</span> <span class="cm-number">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">subnet_id</span> <span class="cm-operator">=</span> <span class="cm-variable">aws_subnet</span><span class="cm-operator">.</span><span class="cm-property">public</span><span class="cm-operator">.</span><span class="cm-property">id</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_network_interface"</span> <span class="cm-string">"app_nic_private"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">count</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">deploy_in_public_subnet</span> <span class="cm-string">? </span><span class="cm-number">0</span> <span class="cm-operator">:</span> <span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">subnet_id</span> <span class="cm-operator">=</span> <span class="cm-variable">aws_subnet</span><span class="cm-operator">.</span><span class="cm-property">private</span><span class="cm-operator">.</span><span class="cm-property">id</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_instance"</span> <span class="cm-string">"app_server"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">ami</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"ami-123456"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">instance_type</span> <span class="cm-operator">=</span> <span class="cm-string">"t2.micro"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">network_interface</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">network_interface_id</span> <span class="cm-operator">=</span> <span class="cm-variable">one</span>(<span class="cm-variable">concat</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">aws_network_interface</span><span class="cm-operator">.</span><span class="cm-property">app_nic_public</span>[<span class="cm-operator">*</span>]<span class="cm-operator">.</span><span class="cm-property">id</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">aws_network_interface</span><span class="cm-operator">.</span><span class="cm-property">app_nic_private</span>[<span class="cm-operator">*</span>]<span class="cm-operator">.</span><span class="cm-property">id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">device_index</span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-number">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 627px;"></div><div class="CodeMirror-gutters" style="display: none; height: 627px;"></div></div></div></pre><p><span>لو </span><code>deploy_in_public_subnet</code><span> بـ </span><code>true</code><span>، هيتعمل </span><code>app_nic_public</code><span> والـ </span><code>list</code><span> بتاعته هيبقى فيها </span><code>ID</code><span> واحد، والتانية هتبقى فاضية. </span><code>concat</code><span> هتدمجهم، و</span><code>one</code><span> هتطلع الـ </span><code>ID</code><span> الصح وتربطه بالـ </span><code>instance</code><span>. والعكس صحيح.</span></p><hr /><p><strong><span>مثال 2: إعطاء صلاحيات </span><code>S3</code><span> مختلفة (قراءة فقط أو قراءة وكتابة)</span></strong></p><p><span>عندك </span><code>IAM Role</code><span> وعايز تديها صلاحيات على </span><code>S3 Bucket</code><span>. عايز خيار يحدد: هل الـ </span><code>Role</code><span> دي هتقدر تقرأ بس من الـ </span><code>bucket</code><span>، ولا هتقدر تقرأ وتكتب؟</span></p><p><strong><span>1. تعريف الـ </span><code>Variable</code><span>:</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"allow_s3_write_access"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"If true, the role gets read/write access. Otherwise, read-only."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">bool</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-keyword">false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 134px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><p><strong><span>2. بناء الـ </span><code>if-else</code><span>:</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_iam_role_policy"</span> <span class="cm-string">"s3_read_write_policy"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">count</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">allow_s3_write_access</span> <span class="cm-string">? </span><span class="cm-number">1</span> <span class="cm-operator">:</span> <span class="cm-number">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-string">"s3-read-write-policy"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">role</span> <span class="cm-operator">=</span> <span class="cm-variable">aws_iam_role</span><span class="cm-operator">.</span><span class="cm-property">example</span><span class="cm-operator">.</span><span class="cm-property">id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">policy</span> <span class="cm-operator">=</span> <span class="cm-variable">jsonencode</span>({</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag">Version</span> <span class="cm-operator">=</span> <span class="cm-string">"2012-10-17"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag">Statement</span> <span class="cm-operator">=</span> [{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-tag">Effect</span> <span class="cm-operator">=</span> <span class="cm-string">"Allow"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-tag">Action</span> <span class="cm-operator">=</span> [<span class="cm-string">"s3:GetObject"</span>, <span class="cm-string">"s3:PutObject"</span>, <span class="cm-string">"s3:DeleteObject"</span>],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-tag">Resource</span> <span class="cm-operator">=</span> <span class="cm-string">"${aws_s3_bucket.example.arn}/*"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  })</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_iam_role_policy"</span> <span class="cm-string">"s3_read_only_policy"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">count</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">allow_s3_write_access</span> <span class="cm-string">? </span><span class="cm-number">0</span> <span class="cm-operator">:</span> <span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-string">"s3-read-only-policy"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">role</span> <span class="cm-operator">=</span> <span class="cm-variable">aws_iam_role</span><span class="cm-operator">.</span><span class="cm-property">example</span><span class="cm-operator">.</span><span class="cm-property">id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">policy</span> <span class="cm-operator">=</span> <span class="cm-variable">jsonencode</span>({</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag">Version</span> <span class="cm-operator">=</span> <span class="cm-string">"2012-10-17"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag">Statement</span> <span class="cm-operator">=</span> [{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-tag">Effect</span> <span class="cm-operator">=</span> <span class="cm-string">"Allow"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-tag">Action</span> <span class="cm-operator">=</span> <span class="cm-string">"s3:GetObject"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-tag">Resource</span> <span class="cm-operator">=</span> <span class="cm-string">"${aws_s3_bucket.example.arn}/*"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  })</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 649px;"></div><div class="CodeMirror-gutters" style="display: none; height: 649px;"></div></div></div></pre><p><code>Terraform</code><span> هينشئ </span><code>policy</code><span> واحدة بس ويربطها بالـ </span><code>role</code><span> بناءً على قيمة </span><code>var.allow_s3_write_access</code><span>. لاحظ إننا هنا مش محتاجين </span><code>output</code><span>، فمش محتاجين  الـ </span><code>one(concat(...))</code><span>.</span></p><hr /><p><strong><span>مثال 3: استخدام </span><code>module</code><span> مختلف بناءً على شرط</span></strong></p><p><strong><span>السيناريو:</span></strong>
<span>عندك اتنين </span><code>modules</code><span> مختلفين لإنشاء قاعدة بيانات: </span><code>module</code><span> بسيط بيعمل </span><code>RDS instance</code><span> واحدة، و</span><code>module</code><span> تاني معقد بيعمل </span><code>RDS Aurora Cluster</code><span> (اللي فيه كذا </span><code>instance</code><span> عشان الـ </span><code>high availability</code><span>). أنت عايز تستخدم الـ </span><code>module</code><span> البسيط في الـ </span><code>staging</code><span>، والـ </span><code>module</code><span> المعقد في الـ </span><code>prod</code><span>.</span></p><p><strong><span>1. تعريف الـ </span><code>Variable</code><span>:</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"use_aurora_cluster"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">bool</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> <span class="cm-operator">=</span> <span class="cm-keyword">false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><strong><span>2. بناء الـ </span><code>if-else</code><span> للمـ </span><code>modules</code><span>:</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">module</span> <span class="cm-string">"standard_rds"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">count</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">use_aurora_cluster</span> <span class="cm-string">? </span><span class="cm-number">0</span> <span class="cm-operator">:</span> <span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">source</span> <span class="cm-operator">=</span> <span class="cm-string">"./modules/standard-rds"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># ....</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">module</span> <span class="cm-string">"aurora_cluster_rds"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">count</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">use_aurora_cluster</span> <span class="cm-string">? </span><span class="cm-number">1</span> <span class="cm-operator">:</span> <span class="cm-number">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">source</span> <span class="cm-operator">=</span> <span class="cm-string">"./modules/aurora-cluster"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"database_endpoint"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-variable">one</span>(<span class="cm-variable">concat</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">module</span><span class="cm-operator">.</span><span class="cm-property">aurora_cluster_rds</span>[<span class="cm-operator">*</span>]<span class="cm-operator">.</span><span class="cm-property">cluster_endpoint</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">module</span><span class="cm-operator">.</span><span class="cm-property">standard_rds</span>[<span class="cm-operator">*</span>]<span class="cm-operator">.</span><span class="cm-property">instance_endpoint</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  ))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 470px;"></div><div class="CodeMirror-gutters" style="display: none; height: 470px;"></div></div></div></pre><p><code>Terraform</code><span> هيعمل </span><code>call</code><span> لـ</span><code>module</code><span> واحد بس من الاتنين. ولما نحب نجيب الـ</span><code>endpoint</code><span> بتاع قاعدة البيانات اللي اتعملت فعلًا، بنستخدم نفس  </span><code>one(concat(...))</code><span> عشان نضمن إننا بنجيب القيمة من الـ</span><code>module</code><span> اللي اشتغل فعلًا، من غير ما نكرر الشرط.</span></p><p>&nbsp;</p><p>&nbsp;</p><h3 id='conditionals-باستخدام-foreach-و-for-expressions'><strong><span>Conditionals باستخدام </span><code>for_each</code><span> و </span><code>for expressions</code></strong></h3><p><span>دلوقتي بعد ما فهمت إزاي تعمل </span><code>logic</code><span> بالشروط باستخدام الـ </span><code>count parameter</code><span>، أكيد خمنت إنك ممكن تعمل نفس الحركة باستخدام </span><code>for_each</code><span>.</span></p><p><span>الفكرة بسيطة: لو اديت لـ </span><code>for_each</code><span> أي </span><code>collection</code><span> فاضي (</span><code>empty map</code><span> أو </span><code>empty set</code><span>)، النتيجة هتكون صفر نسخة من الـ </span><code>resource</code><span> أو الـ </span><code>module</code><span> ده. ولو اديته </span><code>collection</code><span> مليان، هيعمل نسخة أو أكتر. السؤال الوحيد هو: إزاي تقرر بشكل conditional إذا كان الـ </span><code>collection</code><span> ده هيبقى فاضي ولا لأ؟</span></p><p><span>الإجابة هي إنك تدمج </span><code>for_each</code><span> مع </span><code>for expression</code><span>. كمثال، فاكر الطريقة اللي كنا بنحط بيها </span><code>tags</code><span> في </span><code>webserver-cluster module</code><span>؟</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dynamic</span> <span class="cm-string">"tag"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">for_each</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">custom_tags</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">content</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">key</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">tag</span><span class="cm-operator">.</span><span class="cm-property">key</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">value</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">tag</span><span class="cm-operator">.</span><span class="cm-property">value</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">propagate_at_launch</span> <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 202px;"></div><div class="CodeMirror-gutters" style="display: none; height: 202px;"></div></div></div></pre><p><span>لو </span><code>var.custom_tags</code><span> ده فاضي، </span><code>for_each</code><span> مش هتلاقي حاجة تلف عليها، فمش هيتحط أي </span><code>tags</code><span>. يعني إحنا بالفعل عندنا نوع من الشروط هنا. بس إحنا ممكن نعمل حاجات أعقد من كده بكتير لما ندمج </span><code>for_each</code><span> مع </span><code>for expression</code><span> بالشكل ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dynamic</span> <span class="cm-string">"tag"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">for_each</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">key</span>, <span class="cm-variable">value</span> <span class="cm-keyword">in</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">custom_tags</span> <span class="cm-operator">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">key</span> <span class="cm-operator">=&gt;</span> <span class="cm-variable">upper</span>(<span class="cm-variable">value</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">key</span> !<span class="cm-operator">=</span> <span class="cm-string">"Name"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">content</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">key</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">tag</span><span class="cm-operator">.</span><span class="cm-property">key</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">value</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">tag</span><span class="cm-operator">.</span><span class="cm-property">value</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">propagate_at_launch</span> <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 291px;"></div><div class="CodeMirror-gutters" style="display: none; height: 291px;"></div></div></div></pre><p><span>الـ </span><code>for expression</code><span> اللي جوه ده بيلف على </span><code>var.custom_tags</code><span>، بيحول كل </span><code>value</code><span> لـ </span><code>UPPERCASE</code><span> (يمكن عشان يخلي الشكل موحد)، وبيستخدم شرط </span><code>if</code><span> عشان يفلتر أي </span><code>tag</code><span> الـ </span><code>key</code><span> بتاعه اسمه </span><code>Name</code><span>، وده لأن الـ </span><code>module</code><span> بتاعنا بيحط </span><code>Name tag</code><span> خاص بيه. عن طريق إنك تفلتر القيم في </span><code>for expression</code><span>، تقدر تعمل أي </span><code>logic</code><span> بالشروط أنت عايزه.</span></p><p><strong><span>ملحوظة مهمة:</span></strong><span> مع إنك المفروض دايمًا تفضل </span><code>for_each</code><span> عن </span><code>count</code><span> لما تكون بتعمل كذا نسخة من </span><code>resource</code><span>، إلا إنه في conditional logic ، إنك تخلي </span><code>count</code><span> بصفر أو واحد بيبقى أسهل وأوضح من إنك تحاول تخلي </span><code>for_each</code><span> ياخد </span><code>collection</code><span> فاضي أو مليان. عشان كده، أنا بنصح باستخدام </span><code>count</code><span> عشان تعمل </span><code>resources</code><span> أو </span><code>modules</code><span> بشكل شرطي، وتستخدم </span><code>for_each</code><span> لكل أنواع الـ </span><code>loops</code><span> والشروط التانية.</span></p><p>&nbsp;</p><hr /><h4 id='مثال-١-إنشاء-iam-users-فقط-للمطورين-developers'><strong><span>مثال ١: إنشاء </span><code>IAM users</code><span> فقط للمطورين (</span><code>developers</code><span>)</span></strong></h4><p><strong><span>السيناريو:</span></strong><span> لنفترض إن عندك </span><code>map</code><span> فيها كل الموظفين وأدوارهم، وأنت عايز تنشئ </span><code>IAM user</code><span> فقط للموظفين اللي دورهم </span><code>developer</code><span>.</span></p><p><strong><span>المدخلات (</span><code>variables.tf</code><span>):</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"employees"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"A map of employees and their roles"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">map</span>(<span class="cm-variable">string</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"taha"</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"developer"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"ali"</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"manager"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"sara"</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"developer"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"ahmed"</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"qa_engineer"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 224px;"></div><div class="CodeMirror-gutters" style="display: none; height: 224px;"></div></div></div></pre><p><strong><span>الكود بالحل (</span><code>main.tf</code><span>):</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_iam_user"</span> <span class="cm-string">"developers"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># for_each will receive the map produced by the for expression</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">for_each</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># Loop over all employees in the original map</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">name</span>, <span class="cm-variable">role</span> <span class="cm-keyword">in</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">employees</span> <span class="cm-operator">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-comment"># The output of this iteration is a key =&gt; value pair</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">name</span> <span class="cm-operator">=&gt;</span> <span class="cm-variable">role</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-comment"># Condition: produce an output only if the role is 'developer'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">role</span> <span class="cm-operator">==</span> <span class="cm-string">"developer"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># now, for_each = { "taha" = "developer", "sara" = "developer" }</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-variable">each</span><span class="cm-operator">.</span><span class="cm-property">key</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">tags</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag">Role</span> <span class="cm-operator">=</span> <span class="cm-variable">each</span><span class="cm-operator">.</span><span class="cm-property">value</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 403px;"></div><div class="CodeMirror-gutters" style="display: none; height: 403px;"></div></div></div></pre><p><strong><span>إيه اللي بيحصل هنا؟</span></strong>
<span>الـ </span><code>for expression</code><span> اللي جوه </span><code>for_each</code><span> بيشتغل الأول. هو بيلف على </span><code>var.employees</code><span> وبيعمل </span><code>map</code><span> جديدة في الذاكرة. الشرط </span><code>if role == &quot;developer&quot;</code><span> بيخليه </span><strong><span>يفلتر</span></strong><span> الموظفين، فمش بيحط في الـ </span><code>map</code><span> الجديدة دي غير </span><code>taha</code><span> و </span><code>sara</code><span>. بعد كده، </span><code>for_each</code><span> بتشتغل على الـ </span><code>map</code><span> الجديدة المفلترة دي، وبتنشئ اتنين </span><code>IAM users</code><span> بس.</span></p><hr /><p><strong><span>مثال ٢: إنشاء </span><code>Security Group Rules</code><span> فقط للـ </span><code>Admins</code></strong></p><p><strong><span>السيناريو:</span></strong><span> عندك </span><code>map</code><span> للمستخدمين، وعايز تعمل </span><code>Security Group Rule</code><span> تسمح بالـ </span><code>SSH</code><span> فقط للـ </span><code>IPs</code><span> بتاعة الـ </span><code>Admins</code><span>، ومش بس كده، ده لازم يكون فيه </span><code>variable</code><span> تاني بيشغل أو يقفل الميزة دي كلها.</span></p><p><strong><span>(</span><code>variables.tf</code><span>):</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"users"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"A map of users with their roles and IPs"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> <span class="cm-operator">=</span> <span class="cm-variable">map</span>(<span class="cm-variable">object</span>({</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">role</span> <span class="cm-operator">=</span> <span class="cm-variable">string</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ip</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">string</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"taha"</span> &nbsp;<span class="cm-operator">=</span> { <span class="cm-variable">role</span> <span class="cm-operator">=</span> <span class="cm-string">"admin"</span>, <span class="cm-variable">ip</span> <span class="cm-operator">=</span> <span class="cm-string">"1.1.1.1/32"</span> },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"ahmed"</span> <span class="cm-operator">=</span> { <span class="cm-variable">role</span> <span class="cm-operator">=</span> <span class="cm-string">"guest"</span>, <span class="cm-variable">ip</span> <span class="cm-operator">=</span> <span class="cm-string">"2.2.2.2/32"</span> },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"samy"</span> &nbsp;<span class="cm-operator">=</span> { <span class="cm-variable">role</span> <span class="cm-operator">=</span> <span class="cm-string">"admin"</span>, <span class="cm-variable">ip</span> <span class="cm-operator">=</span> <span class="cm-string">"3.3.3.3/32"</span> }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"allow_admin_ssh"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"A boolean to enable or disable SSH access for admins"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">bool</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 403px;"></div><div class="CodeMirror-gutters" style="display: none; height: 403px;"></div></div></div></pre><p><strong><span>(</span><code>main.tf</code><span>):</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_security_group"</span> <span class="cm-string">"example"</span> { <span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-string">"allow-admin-ssh-sg"</span> }</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_security_group_rule"</span> <span class="cm-string">"admin_ssh_access"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">for_each</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># Loop over the original users map</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">user_name</span>, <span class="cm-variable">user_details</span> <span class="cm-keyword">in</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">users</span> <span class="cm-operator">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">user_name</span> <span class="cm-operator">=&gt;</span> <span class="cm-variable">user_details</span><span class="cm-operator">.</span><span class="cm-property">ip</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">user_details</span><span class="cm-operator">.</span><span class="cm-property">role</span> <span class="cm-operator">==</span> <span class="cm-string">"admin"</span> &amp;&amp; <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">allow_admin_ssh</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"ingress"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">from_port</span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-number">22</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">to_port</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-number">22</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">protocol</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"tcp"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">cidr_blocks</span> &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> [<span class="cm-variable">each</span><span class="cm-operator">.</span><span class="cm-property">value</span>] <span class="cm-comment"># each.value here is the IP address</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"Allow SSH for admin: ${each.key}"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">security_group_id</span> <span class="cm-operator">=</span> <span class="cm-variable">aws_security_group</span><span class="cm-operator">.</span><span class="cm-property">example</span><span class="cm-operator">.</span><span class="cm-property">id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 403px;"></div><div class="CodeMirror-gutters" style="display: none; height: 403px;"></div></div></div></pre><p><span> الـ </span><code>for expression</code><span> مش هينتج أي حاجة إلا لو الشرطين اتحققوا: إن المستخدم يكون </span><code>admin</code><span> </span><strong><span>و</span></strong><span> إن </span><code>var.allow_admin_ssh</code><span> تكون </span><code>true</code><span>. لو غيرت قيمة </span><code>var.allow_admin_ssh</code><span> لـ </span><code>false</code><span> وشغلت </span><code>plan</code><span>، </span><code>Terraform</code><span> هيقولك إنه عايز يمسح كل الـ </span><code>rules</code><span> دي لأن الـ </span><code>map</code><span> اللي </span><code>for_each</code><span> استلمتها بقت فاضية.</span></p><hr /><p><strong><span>مثال ٣: </span><code>Filtering &amp; Transformation</code><span> للـ </span><code>Tags</code></strong></p><p><strong><span>السيناريو:</span></strong><span> عندك </span><code>map</code><span> للـ </span><code>tags</code><span> عايز تحطها على </span><code>EC2 instance</code><span>. بس فيه شرطين:</span></p><ol start='' ><li><p><span>أي </span><code>tag</code><span> الـ </span><code>key</code><span> بتاعه اسمه </span><code>&quot;Sensitive&quot;</code><span> لازم يتم فلترته وميتحطش خالص.</span></p></li><li><p><span>لو البيئة هي </span><code>production</code><span>، لازم تضيف </span><code>prefix</code><span> (بادئة) </span><code>PROD-</code><span> لكل قيم الـ </span><code>tags</code><span> التانية.</span></p></li></ol><p><strong><span>المدخلات (</span><code>variables.tf</code><span>):</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"instance_tags"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> <span class="cm-operator">=</span> <span class="cm-variable">map</span>(<span class="cm-variable">string</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"Name"</span> &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"app-server"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"Owner"</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"taha-samy"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"Sensitive"</span> <span class="cm-operator">=</span> <span class="cm-string">"some-secret-info"</span> <span class="cm-comment"># This should be filtered out</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"environment"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">string</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> <span class="cm-operator">=</span> <span class="cm-string">"production"</span> <span class="cm-comment"># Could be "staging"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 291px;"></div><div class="CodeMirror-gutters" style="display: none; height: 291px;"></div></div></div></pre><p><strong><span>الكود بالحل (</span><code>main.tf</code><span>):</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_instance"</span> <span class="cm-string">"example"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">ami</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"ami-0c55b159cbfafe1f0"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">instance_type</span> <span class="cm-operator">=</span> <span class="cm-string">"t2.micro"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">dynamic</span> <span class="cm-string">"tags"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">for_each</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">key</span>, <span class="cm-variable">value</span> <span class="cm-keyword">in</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">instance_tags</span> <span class="cm-operator">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">key</span> <span class="cm-operator">=&gt;</span> (<span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">environment</span> <span class="cm-operator">==</span> <span class="cm-string">"production"</span> <span class="cm-string">? "PROD-${value}"</span> <span class="cm-operator">:</span> <span class="cm-variable">value</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">key</span> !<span class="cm-operator">=</span> <span class="cm-string">"Sensitive"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">content</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">key</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">tags</span><span class="cm-operator">.</span><span class="cm-property">key</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-variable">tags</span><span class="cm-operator">.</span><span class="cm-property">value</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 403px;"></div><div class="CodeMirror-gutters" style="display: none; height: 403px;"></div></div></div></pre><p><strong><span>إيه اللي بيحصل هنا؟</span></strong>
<span>ده مثال بيوريك القوة الكاملة. الـ </span><code>for expression</code><span> عمل حاجتين في نفس الوقت:</span></p><ol start='' ><li><p><strong><span>فلترة:</span></strong><span> الشرط </span><code>if key != &quot;Sensitive&quot;</code><span> ضمن إن الـ </span><code>tag</code><span> اللي بيكون Sensitive  مش هيوصل أبدًا للـ </span><code>for_each</code><span>.</span></p></li><li><p><strong><span>تحويل:</span></strong><span> الجزء </span><code>key =&gt; (....)</code><span> مش بس بيرجع الـ </span><code>value</code><span> زي ما هو. ده بيستخدم </span><code>ternary operator</code><span> عشان يقرر: لو البيئة </span><code>production</code><span>، رجع &quot;PROD-&quot; زائد القيمة، غير كده رجع القيمة الأصلية.</span></p></li></ol><p><span>ده بيخليك تعمل </span><code>logic</code><span> معقد جدًا وتجهز الـ </span><code>data</code><span> بتاعتك بالظبط زي ما أنت عايز قبل ما </span><code>for_each</code><span> تبدأ شغلها.</span></p><hr /><hr /><p>&nbsp;</p><h3 id='if-string-directive'><strong><span>if String Directive</span></strong></h3><p><span>دلوقتي خلينا نشوف الـ </span><code>if string directive</code><span>، ودي شكلها عامل كده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">%{ if &lt;CONDITION&gt; }&lt;TRUEVAL&gt;%{ endif }</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p>&nbsp;</p><p><span>هنا </span><code>CONDITION</code><span> هو أي تعبير بيرجع </span><code>boolean</code><span> (</span><code>true</code><span> أو </span><code>false</code><span>)، و</span><code>TRUEVAL</code><span> هو التعبير اللي هيتعرض لو الشرط طلع </span><code>true</code><span>.</span></p><p><span>في أول الفصل، استخدمنا </span><code>for string directive</code><span> عشان نلف جوه </span><code>string</code><span> ونطلع كذا اسم بينهم فاصلة. المشكلة كانت إننا بيبقى عندنا فاصلة زيادة في آخر الـ </span><code>string</code><span>. إحنا ممكن نستخدم </span><code>if string directive</code><span> عشان نصلح المشكلة دي:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"for_directive_index_if"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-string">&lt;&lt;EOF</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">%{ for i, name in var.names }</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">${name}%{ if i &lt; length(var.names) - 1 }, %{ endif }</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">%{ endfor }</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">EOF</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 157px;"></div><div class="CodeMirror-gutters" style="display: none; height: 157px;"></div></div></div></pre><p><span>فيه كام تغيير هنا عن النسخة الأصلية:</span></p><ol start='' ><li><p><span>حطيت الكود في </span><code>HEREDOC</code><span>، ودي طريقة عشان تعرف </span><code>string</code><span> على كذا سطر. ده بيخلي الكود مقروء أكتر.</span></p></li><li><p><span>استخدمت </span><code>if string directive</code><span> عشان متطبعش الفاصلة والمسافة لآخر عنصر في الـ </span><code>list</code><span>.</span></p></li></ol><p><span>لما تشغل </span><code>terraform apply</code><span>، هيطلعلك الناتج ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">$ terraform apply</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(...)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Outputs:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">for_directive_index_if = &lt;&lt;EOT</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">neo,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">trinity,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">morpheus</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">EOT</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 179px;"></div><div class="CodeMirror-gutters" style="display: none; height: 179px;"></div></div></div></pre><p><span>أوبس. الفاصلة الأخيرة اتشالت، بس دخلنا مسافات زيادة وسطور جديدة. أي مسافة بيضا بتحطها في </span><code>HEREDOC</code><span> بتظهر في الـ </span><code>string</code><span> النهائي. ممكن نصلح ده بإننا نضيف </span><code>strip markers</code><span> (</span><code>~</code><span>)، ودي بتشيل أي مسافات بيضا قبلها أو بعدها:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"for_directive_index_if_strip"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-string">&lt;&lt;EOF</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">%{~ for i, name in var.names ~}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">${name}%{ if i &lt; length(var.names) - 1 }, %{ endif }</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">%{~ endfor ~}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">EOF</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 157px;"></div><div class="CodeMirror-gutters" style="display: none; height: 157px;"></div></div></div></pre><p><span>يلا نجرب النسخة دي:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">$ terraform apply</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(...)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Outputs:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">for_directive_index_if_strip = "neo, trinity, morpheus"</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><span>أوكيه، كده أحسن بكتير: مفيش مسافات بيضا زيادة ولا فواصل. ممكن تخلي الناتج ده أحلى كمان لو ضفت </span><code>else</code><span> للـ </span><code>string directive</code><span>، ودي شكلها كده:</span>
<code>%{ if &lt;CONDITION&gt; }&lt;TRUEVAL&gt;%{ else }&lt;FALSEVAL&gt;%{ endif }</code></p><p><span>هنا </span><code>FALSEVAL</code><span> هو التعبير اللي هيتعرض لو الشرط طلع </span><code>false</code><span>.</span></p><p><span>ده مثال إزاي نستخدم </span><code>else</code><span> عشان نضيف نقطة في الآخر:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"for_directive_index_if_else_strip"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-string">&lt;&lt;EOF</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">%{~ for i, name in var.names ~}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">${name}%{ if i &lt; length(var.names) - 1 }, %{ else }.%{ endif }</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">%{~ endfor ~}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">EOF</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 157px;"></div><div class="CodeMirror-gutters" style="display: none; height: 157px;"></div></div></div></pre><p><span>لما تشغل </span><code>terraform apply</code><span>، هيطلعلك الناتج ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">$ terraform apply</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(...)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Outputs:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">for_directive_index_if_else_strip = "neo, trinity, morpheus."</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p>&nbsp;</p><h2 id='zero-downtime-deployment'><span>Zero-Downtime Deployment</span></h2><h3 id='الـ-zero-downtime-deployment-باستخدام-launch-templates'><strong><span>الـ </span><code>Zero-Downtime Deployment</code><span> (باستخدام </span><code>Launch Templates</code><span>)</span></strong></h3><p><span>دلوقتي بعد ما الـ </span><code>module</code><span> بتاعك بقى ليه </span><code>API</code><span> نضيف وبسيط عشان تعمل </span><code>deploy</code>
<span> لـ </span><code>web server cluster</code><span>، فيه سؤال مهم لازم تسأله: إزاي هتعمل </span><code>update</code><span> للـ </span><code>cluster</code><span> ده؟ يعني لما تعمل تغيير في الكود بتاعك، إزاي هتعمل </span><code>deploy</code><span> لـ </span><code>Amazon Machine Image (AMI)</code><span> جديدة على الـ </span><code>cluster</code><span> كله؟ والأهم، إزاي هتعمل كده من غير ما الخدمة تقع على الـ </span><code>users</code><span> بتوعك؟</span></p><div class="md-alert md-alert-tip tip"><p><span class='md-alert-text md-alert-text-tip'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>Tip</span><br></p><p><span>الـ </span><code>Launch Template</code><span> بيتميز عن الـ </span><code>Launch Configuration</code><span> القديم بميزة قوية جدًا وهي الـ </span><strong><code>Versioning</code></strong><span> (إدارة الإصدارات).</span></p><p><span>ببساطة، كل مرة بتعدل فيها </span><code>Launch Template</code><span> (زي إنك تغير الـ </span><code>AMI</code><span> أو الـ </span><code>User Data</code><span>)، هو مش بيمسح القديم، لأ، ده بيعمل </span><strong><code>version</code><span> جديدة</span></strong><span> منه وبيخلي القديمة موجودة.</span></p><p><span>يعني بيبقى عندك </span><code>Launch Template</code><span> واحد، وليه كذا </span><code>version</code><span>:</span></p><ul><li><p><code>Version 1</code><span> (الـ </span><code>AMI</code><span> القديمة)</span></p></li><li><p><code>Version 2</code><span> (الـ </span><code>AMI</code><span> الجديدة)</span></p></li><li><p><code>Version 3</code><span> (غيرت فيها الـ </span><code>instance type</code><span>)</span></p></li></ul><p><span>الـ </span><code>Auto Scaling Group</code><span> بتاعك ممكن يشاور على </span><code>version</code><span> معينة (زي </span><code>version = &quot;1&quot;</code><span>)، أو ممكن تخليه يشاور دايمًا على آخر </span><code>version</code><span> عن طريق </span><code>version = &quot;$Latest&quot;</code><span>، أو على الـ </span><code>default version</code><span> عن طريق </span><code>version = &quot;$Default&quot;</code><span>.</span></p><p><span>الميزة دي بتديلك مرونة وتحكم كبير جدًا. بتخليك تقدر تعمل </span><code>roll back</code><span> (ترجع لإصدار أقدم) بسهولة لو حصلت مشكلة، مجرد إنك تغير رقم الـ </span><code>version</code><span> اللي الـ </span><code>ASG</code><span> بيستخدمه. بدل ما تمسح وتعمل </span><code>resources</code><span> من الأول، أنت بس بتغير رقم الإصدار.</span></p></div><p>&nbsp;</p><p><span>أول خطوة هي هي: إننا نخلي الـ </span><code>AMI</code><span> عبارة عن </span><code>input variable</code><span>، وهنضيف </span><code>variable</code><span> تاني عشان نتحكم في النص اللي الـ </span><code>web server</code><span> بيرجعه عشان نشوف التغيير بعنينا.</span></p><p><span>ملف </span><code>variables.tf</code><span> هيفضل زي ما هو:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"ami"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"The AMI to run in the cluster"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">string</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"ami-0c55b159cbfafe1f0"</span> <span class="cm-comment"># Amazon Linux 2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"server_text"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"The text the web server should return"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">string</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">default</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"Hello, World"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 246px;"></div><div class="CodeMirror-gutters" style="display: none; height: 246px;"></div></div></div></pre><p><span>وملف </span><code>user-data.sh</code><span> برضه هيفضل زي ما هو:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#!/bin/bash</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cat</span> &gt; index.html &lt;&lt;EOF</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&lt;h1&gt;<span class="cm-def">${server_text}</span>&lt;/h1&gt;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&lt;p&gt;DB address: <span class="cm-def">${db_address}</span>&lt;/p&gt;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&lt;p&gt;DB port: <span class="cm-def">${db_port}</span>&lt;/p&gt;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">EOF</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">nohup busybox httpd <span class="cm-attribute">-f</span> <span class="cm-attribute">-p</span> <span class="cm-def">${server_port}</span> &amp;</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 157px;"></div><div class="CodeMirror-gutters" style="display: none; height: 157px;"></div></div></div></pre><p><strong><span>هنا بقى هيبدأ التغيير.</span></strong><span> بدل ما نعمل </span><code>resource</code><span> من نوع </span><code>aws_launch_configuration</code><span>، هنعمل </span><code>resource</code><span> من نوع </span><code>aws_launch_template</code><span>.</span></p><p><span>في ملف </span><code>modules/services/webserver-cluster/main.tf</code><span>، هنستبدل الـ </span><code>aws_launch_configuration</code><span> بالآتي:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_launch_template"</span> <span class="cm-string">"example"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">name_prefix</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"${var.cluster_name}-"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">image_id</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">ami</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">instance_type</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">instance_type</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">vpc_security_group_ids</span> <span class="cm-operator">=</span> [<span class="cm-variable">aws_security_group</span><span class="cm-operator">.</span><span class="cm-property">instance</span><span class="cm-operator">.</span><span class="cm-property">id</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">user_data</span> <span class="cm-operator">=</span> <span class="cm-variable">base64encode</span>(<span class="cm-variable">templatefile</span>(<span class="cm-string">"${path.module}/user-data.sh"</span>, {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">server_port</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">server_port</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">db_address</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">data</span><span class="cm-operator">.</span><span class="cm-property">terraform_remote_state</span><span class="cm-operator">.</span><span class="cm-property">db</span><span class="cm-operator">.</span><span class="cm-property">outputs</span><span class="cm-operator">.</span><span class="cm-property">address</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">db_port</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">data</span><span class="cm-operator">.</span><span class="cm-property">terraform_remote_state</span><span class="cm-operator">.</span><span class="cm-property">db</span><span class="cm-operator">.</span><span class="cm-property">outputs</span><span class="cm-operator">.</span><span class="cm-property">port</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">server_text</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">server_text</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">lifecycle</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">create_before_destroy</span> <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 403px;"></div><div class="CodeMirror-gutters" style="display: none; height: 403px;"></div></div></div></pre><p><strong><span>لاحظ الفروقات:</span></strong></p><ul><li><p><span>اسم الـ </span><code>resource</code><span> بقى </span><code>aws_launch_template</code><span>.</span></p></li><li><p><span>استخدمنا </span><code>name_prefix</code><span> عشان </span><code>Terraform</code><span> يعمل اسم فريد.</span></p></li><li><p><span>استخدمنا </span><code>vpc_security_group_ids</code><span> بدل </span><code>security_groups</code><span>.</span></p></li><li><p><span>الـ </span><code>user_data</code><span> لازم يتعمله </span><code>base64encode</code><span>.</span></p></li></ul><p><span>دلوقتي، لما تيجي تعمل </span><code>update</code><span> للـ </span><code>staging environment</code><span> في </span><code>live/stage/services/webserver-cluster/main.tf</code><span>، الكود هيفضل شبه ما هو، لأن التغيير حصل جوه الـ </span><code>module</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">module</span> <span class="cm-string">"webserver_cluster"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">source</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"../../../../modules/services/webserver-cluster"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">ami</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"ami-0c55b159cbfafe1f0"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">server_text</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"New server text with Launch Template!"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">cluster_name</span> &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"webservers-stage"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># ... باقي الـ variables ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 157px;"></div><div class="CodeMirror-gutters" style="display: none; height: 157px;"></div></div></div></pre><p><span>لو شغلت </span><code>terraform plan</code><span>، المفروض تشوف حاجة شبه كده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Terraform will perform the following actions:</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  # module.webserver_cluster.aws_autoscaling_group.example will be updated in-place</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  ~ resource "aws_autoscaling_group" "example" {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  id = "webservers-stage-lt-..."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  # ...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  # Terraform will try to change the version of the launch template</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  # module.webserver_cluster.aws_launch_template.example must be replaced</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  +/- resource "aws_launch_template" "example" {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  ~ id &nbsp; &nbsp; &nbsp;  = "lt-012345" -&gt; (known after apply)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  # ...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  ~ user_data = "ey..." -&gt; "ey..." # forces replacement</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  # ...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Plan: 1 to add, 1 to change, 1 to destroy.</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 426px;"></div><div class="CodeMirror-gutters" style="display: none; height: 426px;"></div></div></div></pre><p><strong><span>هنا بنقابل مشكلة أساسية في طريقة عمل </span><code>Terraform</code><span> مع </span><code>Auto Scaling Groups</code><span>:</span></strong><span> الـ </span><code>plan</code><span> اللي طلع بيقولنا إنه هينشئ </span><code>launch_template</code><span> جديد (لأننا غيرنا الكود)، وبعدين هيعمل </span><code>update</code><span> بسيط للـ </span><code>Auto Scaling Group (ASG)</code><span> عشان يخليه يشاور على الـ </span><code>template</code><span> الجديد ده.</span></p><p><span>المشكلة إن مجرد الـ </span><code>update</code><span> ده مش كفاية. هو بيقول للـ </span><code>ASG</code><span>: &quot;لو احتجت تقوم أي </span><code>server</code><span> </span><strong><span>جديد في المستقبل</span></strong><span>، استخدم الـ </span><code>template</code><span> الجديد ده&quot;. لكنه مش بيعمل أي حاجة للـ </span><code>servers</code><span> القديمة اللي شغالة بالفعل. هتفضل شغالة بالإصدار القديم من الكود، وده معناه إن الـ </span><code>deployment</code><span> بتاعك في الحقيقة محصلش. إحنا عايزين نعمل </span><code>rollout</code><span> كامل للسيرفرات الجديدة من غير ما الخدمة تقع، يعني </span><strong><code>zero-downtime deployment</code></strong><span>.</span></p><p><span>الفكرة كلها هي إننا &quot;نتحايل&quot; على </span><code>Terraform</code><span> ونجبره يعمل اللي إحنا عايزينه بالترتيب الصح، بدل السلوك الافتراضي بتاعه.</span></p><p><strong><span>خطوات تحقيق الـ </span><code>Zero-Downtime Deployment</code><span>:</span></strong></p><h4 id='الخطوة-الأولى-إجبار-terraform-على-تبديل-الـ-asg-بالكامل'><strong><span>الخطوة الأولى: إجبار </span><code>Terraform</code><span> على تبديل الـ </span><code>ASG</code><span> بالكامل</span></strong></h4><ul><li><p><strong><span>المشكلة:</span></strong><span> إزاي نجبر </span><code>Terraform</code><span> إنه يمسح الـ </span><code>ASG</code><span> القديم ويعمل واحد جديد بدل ما يعمل </span><code>update</code><span> بسيط؟</span></p></li><li><p><strong><span>الحل:</span></strong><span> نغير </span><code>attribute</code><span> في الـ </span><code>ASG</code><span> يكون </span><code>Terraform</code><span> عارف إنه مينفعش يتعدل، ولازم يعمل </span><code>replace</code><span> للـ </span><code>resource</code><span> كله لو اتغير. أفضل </span><code>attribute</code><span> للحركة دي هو الـ </span><code>name</code><span>.</span></p></li><li><p><strong><span>التطبيق:</span></strong><span> هنخلي اسم الـ </span><code>ASG</code><span> يعتمد على اسم الـ </span><code>launch_template</code><span>. كل مرة الـ </span><code>launch_template</code><span> بيتغير (عشان عدلت في الـ </span><code>AMI</code><span> أو الـ </span><code>User Data</code><span>)، </span><code>Terraform</code><span> بينشئ واحد جديد باسم فريد. لما نربط اسم الـ </span><code>ASG</code><span> باسم الـ </span><code>launch_template</code><span>، ده معناه إن اسم الـ </span><code>ASG</code><span> كمان هيتغير كل مرة. بالنسبة لـ </span><code>Terraform</code><span>، تغيير اسم </span><code>resource</code><span> معناه </span><strong><span>&quot;امسح القديم وهات الجديد&quot; (</span><code>replace</code><span>)</span></strong><span>.</span></p></li></ul><h4 id='الخطوة-الثانية-منع-انقطاع-الخدمة-أثناء-التبديل'><strong><span>الخطوة الثانية: منع انقطاع الخدمة أثناء التبديل</span></strong></h4><ul><li><p><strong><span>المشكلة:</span></strong><span> طب ما احنا لو عملنا </span><code>replace</code><span> على طول، </span><code>Terraform</code><span> هيمسح القديم الأول وبعدين يعمل الجديد، وكده الخدمة هتقع!</span></p></li><li><p><strong><span>الحل:</span></strong><span> نستخدم الـ </span><code>lifecycle</code><span> بلوك ونحط جواه </span><code>create_before_destroy = true</code><span>.</span></p></li><li><p><strong><span>التطبيق:</span></strong><span> الإعداد ده بيغير ترتيب الأحداث. بدل ما </span><code>Terraform</code><span> يمشي بترتيب </span><code>Destroy -&gt; Create</code><span>، هيمشي بترتيب </span><strong><code>Create -&gt; Destroy</code></strong><span>. يعني هيعمل </span><code>deploy</code><span> للـ </span><code>ASG</code><span> الجديد بكل سيرفراته، ولما يشتغل ويقوم، يروح ماسح الـ </span><code>ASG</code><span> القديم. بكده، بيبقى فيه فترة انتقالية الاتنين </span><code>ASG</code><span> شغالين فيها مع بعض، والـ </span><code>Load Balancer</code><span> بيوزع الـ </span><code>traffic</code><span> عليهم.</span></p></li></ul><h4 id='الخطوة-الثالثة-التأكد-من-جاهزية-السيرفرات-الجديدة-صمام-الأمان'><strong><span>الخطوة الثالثة: التأكد من جاهزية السيرفرات الجديدة (صمام الأمان)</span></strong></h4><ul><li><p><strong><span>المشكلة:</span></strong><span> إمتى بالظبط </span><code>Terraform</code><span> يقرر إن الـ </span><code>ASG</code><span> الجديد &quot;اشتغل&quot; عشان يبدأ يمسح القديم؟ ممكن يكون لسه بيقوم السيرفرات والسيرفرات لسه مش </span><code>healthy</code><span>.</span></p></li><li><p><strong><span>الحل:</span></strong><span> نستخدم </span><code>argument</code><span> مهم جدًا اسمه </span><code>min_elb_capacity</code><span>.</span></p></li><li><p><strong><span>التطبيق:</span></strong><span> بنحط </span><code>min_elb_capacity</code><span> ونخلي قيمته بتساوي الـ </span><code>min_size</code><span> بتاع الـ </span><code>cluster</code><span>. ده بيقول لـ </span><code>Terraform</code><span>: &quot;اصبر، متتهورش وتمسح القديم. متعتبرش الـ </span><code>deployment</code><span> نجح إلا لما تتأكد إن عدد </span><code>X</code><span> من السيرفرات الجديدة اشتغلت وبقت </span><code>healthy</code><span> جوه الـ </span><code>Load Balancer</code><span> وبدأت تستقبل </span><code>traffic</code><span> فعلاً&quot;. ده صمام الأمان اللي بيضمن إن الخدمة مش هتتأثر.</span></p></li></ul><p><span>ده شكل </span><code>aws_autoscaling_group</code><span> بعد ما نطبق عليه التلات خطوات دول عشان يشتغل صح مع الـ </span><code>Launch Template</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_autoscaling_group"</span> <span class="cm-string">"example"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-string">"${var.cluster_name}-${aws_launch_template.example.name}"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">launch_template</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">id</span> &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">aws_launch_template</span><span class="cm-operator">.</span><span class="cm-property">example</span><span class="cm-operator">.</span><span class="cm-property">id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">version</span> <span class="cm-operator">=</span> <span class="cm-string">"$Latest"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">vpc_zone_identifier</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">data</span><span class="cm-operator">.</span><span class="cm-property">aws_subnets</span><span class="cm-operator">.</span><span class="cm-property">default</span><span class="cm-operator">.</span><span class="cm-property">ids</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">target_group_arns</span> &nbsp; &nbsp;<span class="cm-operator">=</span> [<span class="cm-variable">aws_lb_target_group</span><span class="cm-operator">.</span><span class="cm-property">asg</span><span class="cm-operator">.</span><span class="cm-property">arn</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">health_check_type</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"ELB"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">min_size</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">min_size</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">max_size</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">max_size</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">min_elb_capacity</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">min_size</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">lifecycle</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">create_before_destroy</span> <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 515px;"></div><div class="CodeMirror-gutters" style="display: none; height: 515px;"></div></div></div></pre><p><span>لو شغلت </span><code>terraform plan</code><span> دلوقتي، هتلاقي نفس النتيجة اللي إحنا عايزينها:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Terraform will perform the following actions:</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  # module.webserver_cluster.aws_autoscaling_group.example must be replaced</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  +/- resource "aws_autoscaling_group" "example" {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  ~ id &nbsp; = "webservers-stage-lt-..." -&gt; (known after apply)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  ~ name = "webservers-stage-lt-..." -&gt; (known after apply) # forces replacement</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  # ...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  # module.webserver_cluster.aws_launch_template.example must be replaced</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  +/- resource "aws_launch_template" "example" {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  ~ id &nbsp; &nbsp; &nbsp;  = "lt-012345" -&gt; (known after apply)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  ~ user_data = "ey..." -&gt; "ey..." # forces replacement</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  # ...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 381px;"></div><div class="CodeMirror-gutters" style="display: none; height: 381px;"></div></div></div></pre><p><span>أهم حاجة تلاحظها هي إن جنب </span><code>aws_autoscaling_group</code><span> بقى مكتوب </span><code>forces replacement</code><span>. ده معناه إن </span><code>Terraform</code><span> هيبدله بـ </span><code>ASG</code><span> جديد شغال بالـ </span><code>AMI</code><span> أو الـ </span><code>User Data</code><span> الجديد بتاعك. شغل </span><code>terraform apply</code><span> عشان تبدأ الـ </span><code>deployment</code><span>، وشوف إزاي بيتم من غير ما الخدمة تقع.</span></p><p>&nbsp;</p><hr /><h2 id='terraform-gotchas'><strong><code>Terraform Gotchas</code><span> </span></strong></h2><p><span>بعد ما عدينا على كل النصايح tricks دي، مهم إننا نرجع خطوة لورا ونشاور على كام </span><code>gotcha</code><span> (أو &quot;مقلب&quot; أو &quot;حتة ممكن تخدعك&quot;)، بما فيهم الحاجات اللي ليها علاقة بالـ </span><code>loop</code><span>، والـ </span><code>if-statement</code><span>، وتقنيات الـ </span><code>deployment</code><span> اللي لسه شارحينها، وكمان مشاكل عامة بتأثر على </span><code>Terraform</code><span> كله:</span></p><ol start='' ><li><p><strong><span>الـ </span><code>count</code><span> والـ </span><code>for_each</code><span> ليهم حدود ومشاكل.</span></strong>
<span>مش كل حاجة وردي معاهم، فيه سيناريوهات معينة ممكن يعملوا فيها مشاكل أو ميكونوش الحل الأمثل.</span></p></li><li><p><strong><span>الـ </span><code>Zero-downtime deployment</code><span> ليه حدود ومشاكل برضه.</span></strong>
<span>الطريقة اللي شرحناها مش سحرية ومش بتشتغل 100% في كل الحالات. فيه مواقف معينة ممكن متشتغلش فيها صح أو تحتاج شغل زيادة.</span></p></li><li><p><strong><span>الـ </span><code>Plans</code><span> اللي شكلها سليم ممكن تفشل.</span></strong>
<span>مش كل مرة </span><code>terraform plan</code><span> يقولك الدنيا تمام، يبقى الـ </span><code>apply</code><span> هيعدي بسلام. ممكن تحصل مشاكل وقت التنفيذ الفعلي على الكلاود.</span></p></li><li><p><strong><span>إعادة هيكلة الكود (</span><code>Refactoring</code><span>) ممكن تبقى صعبة.</span></strong>
<span>لما تحب تغير أسماء الـ </span><code>resources</code><span> أو تنقل الكود من مكان لمكان، الموضوع مش مجرد </span><code>copy-paste</code><span>. </span><code>Terraform</code><span> ممكن يعتبر ده إنك عايز تمسح القديم وتعمل جديد، وده ممكن يبوظ الدنيا.</span></p></li></ol><p>&nbsp;</p><hr /><h3 id='الـ-count-والـ-foreach-ليهم-حدود-ومشاكل'><strong><span>الـ </span><code>count</code><span> والـ </span><code>for_each</code><span> ليهم حدود ومشاكل</span></strong></h3><p><span>في الأمثلة اللي فاتت في الفصل ده، إنت استخدمت الـ </span><code>count</code><span> والـ </span><code>for_each</code><span> بكثافة في </span>
<span>الـ </span><code>loops</code><span> والـ </span><code>if-statements</code><span>. ده بيشتغل كويس، بس فيه &quot;حدود&quot; أو &quot;مشكلة&quot; مهمة لازم تبقى عارفها: </span><strong><span>أنت مينفعش تستخدم </span><code>output</code><span> بتاع </span><code>resource</code><span> لسه هيتعمل في الـ </span><code>count</code><span> أو الـ </span><code>for_each</code></strong><span>.</span></p><p><span>تخيل إنك عايز تعمل </span><code>deploy</code><span> لكذا </span><code>EC2 Instance</code><span>، ولسبب ما مش عايز تستخدم </span><code>ASG</code><span>. الكود ممكن يبقى شكله كده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_instance"</span> <span class="cm-string">"example_1"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">count</span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-number">3</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">ami</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"ami-0c55b159cbfafe1f0"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">instance_type</span> <span class="cm-operator">=</span> <span class="cm-string">"t2.micro"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p><span>عشان الـ </span><code>count</code><span> هنا واخد قيمة ثابتة (</span><code>hardcoded</code><span>)، الكود ده هيشتغل من غير أي مشاكل، ولما تعمل </span><code>apply</code><span>، هيعمل 3 </span><code>EC2 Instances</code><span>.</span></p><p><span>طيب، لو عايز تعمل </span><code>deploy</code><span> لـ </span><code>EC2 Instance</code><span> واحدة في كل </span><code>Availability Zone (AZ)</code><span> في </span>
<span>الـ </span><code>region</code><span> اللي أنت فيها؟ ممكن تعدل الكود عشان يجيب </span><code>list</code><span> بالـ </span><code>AZs</code><span> باستخدام </span><code>aws_availability_zones data source</code><span>، وتستخدم الـ </span><code>count</code><span> عشان تلف على كل </span><code>AZ</code><span> وتعمل </span><code>EC2 Instance</code><span> فيها:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">data</span> <span class="cm-string">"aws_availability_zones"</span> <span class="cm-string">"all"</span> {}</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_instance"</span> <span class="cm-string">"example_2"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">count</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">length</span>(<span class="cm-variable">data</span><span class="cm-operator">.</span><span class="cm-property">aws_availability_zones</span><span class="cm-operator">.</span><span class="cm-property">all</span><span class="cm-operator">.</span><span class="cm-property">names</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">availability_zone</span> <span class="cm-operator">=</span> <span class="cm-variable">data</span><span class="cm-operator">.</span><span class="cm-property">aws_availability_zones</span><span class="cm-operator">.</span><span class="cm-property">all</span><span class="cm-operator">.</span><span class="cm-property">names</span>[<span class="cm-variable">count</span><span class="cm-operator">.</span><span class="cm-property">index</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">ami</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"ami-0c55b159cbfafe1f0"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">instance_type</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"t2.micro"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 179px;"></div><div class="CodeMirror-gutters" style="display: none; height: 179px;"></div></div></div></pre><p><span>برضه، الكود ده هيشتغل زي الفل، لأن </span><code>count</code><span> يقدر يستخدم </span><code>data sources</code><span> من غير مشاكل.</span></p><p><strong><span>هنا بقى بتحصل المشكلة:</span></strong><span> إيه اللي هيحصل لو عدد الـ </span><code>instances</code><span> اللي أنت عايز تعملها بيعتمد على </span><code>output</code><span> بتاع </span><code>resource</code><span> تاني؟ أسهل طريقة نجرب بيها الموضوع ده هي باستخدام </span><code>random_integer resource</code><span>، واللي زي ما واضح من اسمه، بيرجع رقم عشوائي:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"random_integer"</span> <span class="cm-string">"num_instances"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">min</span> <span class="cm-operator">=</span> <span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">max</span> <span class="cm-operator">=</span> <span class="cm-number">3</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><span>الكود ده بيولد رقم عشوائي بين 1 و 3. يلا نشوف إيه اللي هيحصل لو حاولنا نستخدم الـ </span><code>output</code><span> اللي اسمه </span><code>result</code><span> من الـ </span><code>resource</code><span> ده في الـ </span><code>count</code><span> بتاع </span><code>aws_instance</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_instance"</span> <span class="cm-string">"example_3"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">count</span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">random_integer</span><span class="cm-operator">.</span><span class="cm-property">num_instances</span><span class="cm-operator">.</span><span class="cm-property">result</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">ami</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"ami-0c55b159cbfafe1f0"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">instance_type</span> <span class="cm-operator">=</span> <span class="cm-string">"t2.micro"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p><span>لو شغلت </span><code>terraform plan</code><span> على الكود ده، هيجيلك الـ </span><code>error</code><span> ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Error: Invalid count argument</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">on main.tf line 30, in resource "aws_instance" "example_3":</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">30:  count = random_integer.num_instances.result</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">The "count" value depends on resource attributes that cannot be determined</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">until apply, so Terraform cannot predict how many instances will be created.</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">To work around this, use the -target argument to first apply only the</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">resources that the count depends on.</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 224px;"></div><div class="CodeMirror-gutters" style="display: none; height: 224px;"></div></div></div></pre><p><code>Terraform</code><span> بيشترط إنه لازم يكون قادر يحسب قيمة </span><code>count</code><span> و </span><code>for_each</code><span> في مرحلة الـ </span><code>plan</code><span>، قبل ما أي </span><code>resource</code><span> يتعمل أو يتعدل. ده معناه إن </span><code>count</code><span> و </span><code>for_each</code><span> يقدروا يستخدموا قيم ثابتة، و </span><code>variables</code><span>، و </span><code>data sources</code><span>، وحتى </span><code>lists</code><span> من </span><code>resources</code><span> (طالما طول الـ </span><code>list</code><span> معروف وقت الـ </span><code>plan</code><span>)، </span><strong><span>لكن مش بيقدروا يستخدموا </span><code>outputs</code><span> محسوبة من </span><code>resources</code><span> لسه هتتعمل وقت الـ </span><code>apply</code></strong><span>.</span></p><p>&nbsp;</p><h3 id='الـ-zero-downtime-deployment-ليه-حدود-ومشاكل'><strong><span>الـ </span><code>Zero-Downtime Deployment</code><span> ليه حدود ومشاكل</span></strong></h3><p><span> لما بتستخدم  </span><code>create_before_destroy</code><span> مع تغيير اسم الـ </span><code>ASG</code><span>، أنت بتتحايل على </span><code>Terraform</code><span> عشان يعمل اللي أنت عايزه. لكن دي ليها مشاكل وعيوب خطيرة، خصوصًا في بيئة شغل حقيقية.</span></p><h4 id='المشكلة-الأولى-الـ-deployment-بيبوظ-الـ-auto-scaling-بتاعك'><strong><span>المشكلة الأولى: الـ </span><code>Deployment</code><span> بيبوظ الـ </span><code>Auto Scaling</code><span> بتاعك</span></strong></h4><ul><li><p><strong><span>السيناريو:</span></strong><span> تخيل إن الـ </span><code>ASG</code><span> بتاعك متظبط إنه يبدأ بسيرفرين (</span><code>min_size = 2</code><span>)، بس فيه </span><code>schedule</code><span> (جدول زمني) بيخليه يكبر ويبقى 10 سيرفرات الساعة 9 الصبح عشان يواجه ضغط الشغل.</span></p></li><li><p><strong><span>إيه اللي بيحصل؟</span></strong><span> الساعة 11 الصبح، الـ </span><code>ASG</code><span> بتاعك شغال بـ 10 سيرفرات وزي الفل. أنت جيت تعمل </span><code>deployment</code><span> لتغيير بسيط.</span></p></li><li><p><strong><span>الكارثة:</span></strong><span> </span><code>Terraform</code><span>، بسبب trick تغيير الاسم، بيقرر إنه لازم </span><strong><span>يمسح الـ </span><code>ASG</code><span> القديم (أبو 10 سيرفرات) ويعمل واحد جديد خالص من الصفر</span></strong><span>.</span></p></li><li><p><strong><span>طب الـ </span><code>ASG</code><span> الجديد ده مواصفاته إيه؟</span></strong><span> </span><code>Terraform</code><span> هيروح يقرأ الكود بتاعك. هيلاقي مكتوب فيه </span><code>min_size = 2</code><span>. هو </span><strong><span>معندوش أي فكرة</span></strong><span> إن الـ </span><code>ASG</code><span> القديم كان كبر وبقى 10 سيرفرات. المعلومة دي مش متسجلة في الكود.</span></p></li><li><p><strong><span>النتيجة:</span></strong><span> الـ </span><code>ASG</code><span> الجديد هيقوم بسيرفرين بس. وبكده، أنت في نص يوم الشغل والضغط العالي، نزلت بالـ </span><code>capacity</code><span> بتاعتك من 10 سيرفرات لسيرفرين بس. ده ممكن يوقعلك السيستم كله.</span></p></li></ul><p><span>الـ </span><code>ASG</code><span> الجديد هيفضل على سيرفرين لحد ما الـ </span><code>schedule</code><span> بتاع تاني يوم يشتغل الساعة 9 الصبح ويرجعه 10 تاني.</span></p><h4 id='المشكلة-التانية-والأهم-دي-طريقة-مترقعة-مش-حل-احترافي'><strong><span>المشكلة التانية (والأهم): دي طريقة &quot;مترقعة&quot; مش حل احترافي</span></strong></h4><p><span>الفكرة كلها إنك بتلزق كذا حاجة في بعض عشان توصل لنتيجة معينة:</span></p><ol start='' ><li><p><span>بتغير </span><code>name</code><span> عشان </span><strong><span>تجبر</span></strong><span> </span><code>Terraform</code><span> يعمل </span><code>replace</code><span>.</span></p></li><li><p><span>بتستخدم </span><code>create_before_destroy</code><span> عشان </span><strong><span>تتحكم</span></strong><span> في ترتيب الـ </span><code>replace</code><span>.</span></p></li><li><p><span>بتستخدم </span><code>min_elb_capacity</code><span> عشان </span><strong><span>تخمن</span></strong><span> إمتى الـ </span><code>deployment</code><span> بقى آمن.</span></p></li></ol><p><span>ده مش حل نظيف. للمهام المعقدة والمهمة زي الـ </span><code>deployment</code><span>، أنت محتاج حل يكون مصمم للمهمة دي بالذات. أنت محتاج حل أصلي (</span><code>native</code><span>).</span></p><p><strong><span>الحل النظيف : </span><code>Instance Refresh</code></strong></p><p><span>الخبر الحلو إن </span><code>AWS</code><span> نفسها عملت حل للمشكلة دي ودمجته جوه الـ </span><code>ASG</code><span>. الحل ده اسمه </span><strong><code>Instance Refresh</code></strong><span>.</span></p><p><strong><span>فكرته إيه؟</span></strong>
<span>بدل ما نمسح الـ </span><code>ASG</code><span> كله ونعمل واحد جديد، إحنا بنقول للـ </span><code>ASG</code><span> القديم اللي شغال: &quot;لو سمحت، الـ </span><code>launch template</code><span> بتاعك اتغير. ابدأ بنفسك عملية </span><strong><span>تبديل تدريجي</span></strong><span> للسيرفرات القديمة اللي جواك بسيرفرات جديدة بتستخدم الـ </span><code>template</code><span> المحدث&quot;.</span></p><p><span>الـ </span><code>ASG</code><span> نفسه بيفضل موجود، مش بيتمسح. اللي بيتبدل هو السيرفرات اللي جواه بس.</span></p><h4 id='إزاي-بنطبق-الحل-ده'><strong><span>إزاي بنطبق الحل ده؟</span></strong></h4><p><span>زي ما الشرح بيقول، بنرجع الكود لأصله ونضيف بلوك الـ </span><code>instance_refresh</code><span>.</span></p><ol start='' ><li><p><strong><span>رجع الـ </span><code>name</code><span> لـ </span><code>var.cluster_name</code><span>:</span></strong><span> إحنا خلاص مش محتاجين نتحايل على </span><code>Terraform</code><span> عشان يغير الاسم.</span></p></li><li><p><strong><span>شيل </span><code>lifecycle { create_before_destroy = true }</code><span> و </span><code>min_elb_capacity</code><span>:</span></strong><span> دول كانوا جزء من trick القديمة، خلاص مش محتاجينهم.</span></p></li><li><p><strong><span>ضيف الـ </span><code>instance_refresh</code><span> بلوك:</span></strong></p></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_autoscaling_group"</span> <span class="cm-string">"example"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">name</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">cluster_name</span> <span class="cm-comment"># رجعنا الاسم للأصل</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">launch_configuration</span> <span class="cm-operator">=</span> <span class="cm-variable">aws_launch_configuration</span><span class="cm-operator">.</span><span class="cm-property">example</span><span class="cm-operator">.</span><span class="cm-property">name</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">vpc_zone_identifier</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">data</span><span class="cm-operator">.</span><span class="cm-property">aws_subnets</span><span class="cm-operator">.</span><span class="cm-property">default</span><span class="cm-operator">.</span><span class="cm-property">ids</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">target_group_arns</span> &nbsp; &nbsp;<span class="cm-operator">=</span> [<span class="cm-variable">aws_lb_target_group</span><span class="cm-operator">.</span><span class="cm-property">asg</span><span class="cm-operator">.</span><span class="cm-property">arn</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">health_check_type</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"ELB"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">min_size</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">min_size</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">max_size</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">max_size</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">instance_refresh</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">strategy</span> <span class="cm-operator">=</span> <span class="cm-string">"Rolling"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">preferences</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">min_healthy_percentage</span> <span class="cm-operator">=</span> <span class="cm-number">50</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 381px;"></div><div class="CodeMirror-gutters" style="display: none; height: 381px;"></div></div></div></pre><p><strong><span>إيه اللي هيحصل دلوقتي؟</span></strong>
<span>لما تعمل </span><code>apply</code><span>، </span><code>Terraform</code><span> هيعمل </span><code>update</code><span> بسيط للـ </span><code>ASG</code><span> عشان يضيف عليه خاصية الـ </span><code>instance refresh</code><span>. وبعدها، </span><strong><code>AWS</code><span> نفسها هي اللي هتتكفل بالباقي</span></strong><span>. أول ما تكتشف إن الـ </span><code>launch configuration</code><span> أو </span><code>template</code><span> اتغير، هتبدأ هي في الخلفية عملية الـ </span><code>Rolling Update</code><span> المنظمة والآمنة، من غير ما </span><code>Terraform</code><span> يضطر يمسح أي حاجة.</span></p><p>&nbsp;</p><p><span>لو عملت </span><code>deploy</code><span> للـ </span><code>ASG</code><span> ده وهو متظبط بـ </span><code>instance refresh</code><span>، وبعدين غيرت </span><code>parameter</code><span> معين (زي </span><code>server_text</code><span>) وشغلت </span><code>plan</code><span>، الـ </span><code>diff</code><span> هيرجع تاني إنه بس بيعمل </span><code>update</code><span> للـ </span><code>Launch Template</code><span> و </span><code>update</code><span> بسيط للـ </span><code>ASG</code><span>.</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Terraform will perform the following actions:</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  # module.webserver_cluster.aws_autoscaling_group.example will be updated in-place</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  ~ resource "aws_autoscaling_group" "example" {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  id = "webservers-stage-..."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  # ... (Terraform will just update the launch_template version)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  # module.webserver_cluster.aws_launch_template.example must be replaced</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  +/- resource "aws_launch_template" "example" {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  ~ id &nbsp; &nbsp; &nbsp;  = "lt-012345" -&gt; (known after apply)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  # ...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  ~ user_data = "ey..." -&gt; "ey..." # forces replacement</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  # ...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Plan: 1 to add, 1 to change, 1 to destroy.</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 403px;"></div><div class="CodeMirror-gutters" style="display: none; height: 403px;"></div></div></div></pre><p><span>لما تعمل </span><code>apply</code><span>، هيخلص بسرعة جدًا. في الأول، هتحس إن مفيش حاجة جديدة اتعملها </span><code>deploy</code><span>. </span><strong><span>لكن، في الخلفية،</span></strong><span> عشان أنت عدلت الـ </span><code>Launch Template</code><span>، </span><code>AWS</code><span> هتبدأ عملية الـ </span><strong><code>instance refresh</code></strong><span>، زي ما هو واضح في شكل 5-7.</span></p><p>&nbsp;</p><p><code>AWS</code><span> هتبدأ بنفسها عملية التبديل التدريجي. في الأول، هتعمل </span><code>launch</code><span> (هتقوم) لـ </span><code>instance</code><span> واحدة جديدة بالـ </span><code>template</code><span> الجديد، وهتستنى لحد ما تعدي الـ </span><code>health checks</code><span> (تتأكد إنها سليمة وشغالة)، وبعدين هتقفل واحدة من الـ </span><code>instances</code><span> القديمة. بعد كده، هتكرر نفس العملية مع الـ </span><code>instance</code><span> التانية، وهكذا لحد ما عملية الـ </span><code>instance refresh</code><span> تخلص بالكامل، ويبقى كل السيرفرات اللي شغالة بالإصدار الجديد، زي ما هو واضح في شكل 5-8.</span></p><p>&nbsp;</p><p><span>العملية دي (</span><code>instance refresh</code><span>) بتديرها </span><code>AWS</code><span> بالكامل، وتقدر تعدل فيها بشكل معقول، وبتتعامل مع الأخطاء كويس جدًا، ومش محتاجة أي tricks . العيب الوحيد هو إن العملية دي ممكن تكون بطيئة أحيانًا (ممكن تاخد لحد 20 دقيقة عشان تبدل سيرفرين بس)، لكن بعيدًا عن كده، هي حل أقوى بكتير تستخدمه في أغلب عمليات الـ </span><code>zero-downtime deployments</code><span>.</span></p><p><strong><span>كقاعدة عامة،</span></strong><span> أنت المفروض تفضل استخدام خيارات الـ </span><code>deployment</code><span> اللي تكون </span><code>native</code><span> من الدرجة الأولى زي </span><code>instance refresh</code><span> كلما أمكن. مع إن الخيارات دي مكنتش دايمًا متاحة في الأيام الأولى لـ </span><code>Terraform</code><span>، لكن دلوقتي، </span><code>resources</code><span> كتير بتدعم خيارات </span><code>deployment</code><span> أصلية.</span></p><p><strong><span>كمثال:</span></strong></p><ul><li><p><span>لو بتستخدم </span><code>Amazon Elastic Container Service (ECS)</code><span> عشان تعمل </span><code>deploy</code><span> لـ </span><code>Docker containers</code><span>، الـ </span><code>aws_ecs_service</code><span> </span><code>resource</code><span> بيدعم </span><code>zero-downtime deployments</code><span> بشكل </span><code>native</code><span> عن طريق الـ </span><code>parameters</code><span> اللي اسمها </span><code>deployment_maximum_percent</code><span> و </span><code>deployment_minimum_healthy_percent</code><span>.</span></p></li><li><p><span>لو بتستخدم </span><code>Kubernetes</code><span> عشان تعمل </span><code>deploy</code><span> لـ </span><code>Docker containers</code><span>، الـ </span><code>kubernetes_deployment</code><span> </span><code>resource</code><span> بيدعم </span><code>zero-downtime deployments</code><span> بشكل native عن طريق إنك تخلي الـ </span><code>strategy</code><span> بـ </span><code>RollingUpdate</code><span> وتديله إعدادات عن طريق </span><code>rolling_update</code><span> بلوك.</span></p></li></ul><p><strong><span>نصيحة:</span></strong><span> بص دايمًا في الـ </span><code>documentation</code><span> ( بتاع الـ </span><code>resources</code><span> اللي بتستخدمها، واستغل الـ </span><code>native functionality</code><span> لما تكون متاحة</span></p><h3 id='valid-plans-can-fail-الـ-plans-اللي-شكلها-سليم-ممكن-تفشل'><span>Valid Plans Can Fail (</span><strong><span>الـ </span><code>Plans</code><span> اللي شكلها سليم ممكن تفشل</span></strong><span>)</span></h3><p><span>ساعات، بتشغل </span><code>terraform plan</code><span> وبيطلعلك </span><code>plan</code><span> شكلها سليم ومية مية، بس لما تيجي تشغل </span><code>apply</code><span>، تلاقي </span><code>error</code><span> ضرب في وشك. كمثال، جرب تضيف </span><code>aws_iam_user resource</code><span> بنفس الاسم بالظبط بتاع الـ </span><code>IAM user</code><span> اللي عملته بإيدك في الفصل التاني:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_iam_user"</span> <span class="cm-string">"existing_user"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-string">"yevgeniy.brikman"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><span>لو شغلت </span><code>terraform plan</code><span> دلوقتي، </span><code>Terraform</code><span> هيوريك </span><code>plan</code><span> شكلها معقول:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Terraform will perform the following actions:</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  # aws_iam_user.existing_user will be created</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  + resource "aws_iam_user" "existing_user" {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  + arn &nbsp; &nbsp; &nbsp; &nbsp; = (known after apply)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  # ...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  + name &nbsp; &nbsp; &nbsp;  = "yevgeniy.brikman"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  # ...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Plan: 1 to add, 0 to change, 0 to destroy.</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 246px;"></div><div class="CodeMirror-gutters" style="display: none; height: 246px;"></div></div></div></pre><p><span>لو شغلت </span><code>apply</code><span>، هيجيلك الـ </span><code>error</code><span> ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Error: Error creating IAM User yevgeniy.brikman: EntityAlreadyExists:</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">User with name yevgeniy.brikman already exists.</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="display: none; height: 45px;"></div></div></div></pre><p><span>المشكلة، طبعًا، هي إن فيه </span><code>IAM user</code><span> بالاسم ده موجود أصلًا. ده ممكن يحصل مش بس مع الـ </span><code>IAM users</code><span>، لأ ده مع أي </span><code>resource</code><span> تقريبًا. يمكن حد عمل الـ </span><code>resource</code><span> ده بإيده أو عن طريق الـ </span><code>CLI</code><span>، بس في كل الأحوال، فيه </span><code>identifier</code><span> متكرر، وده بيعمل </span><code>conflict</code><span>. فيه أشكال كتير من الـ </span><code>error</code><span> ده، والناس الجديدة على </span><code>Terraform</code><span> دايمًا بتتفاجئ بيها.</span></p><p><strong><span>الفكرة الأساسية هنا</span></strong><span> هي إن </span><code>terraform plan</code><span> بيبص بس على الـ </span><code>resources</code><span> اللي في ملف الـ </span><code>Terraform state</code><span> بتاعه. لو عملت </span><code>resources</code><span> &quot;من بره&quot; (</span><code>out of band</code><span>) — زي إنك تعملها بإيدك من الـ </span><code>AWS Console</code><span> — مش هتبقى موجودة في الـ </span><code>state file</code><span> بتاع </span><code>Terraform</code><span>، وبالتالي، </span><code>Terraform</code><span> مش هياخدها في اعتباره لما تشغل </span><code>plan</code><span>. وكنتيجة لده، </span><code>plan</code><span> شكلها سليم هتفشل برضه.</span></p><p><span>فيه درسين مهمين تاخدهم من الموضوع ده:</span></p><ol start='' ><li><p><strong><span>بعد ما تبدأ تستخدم </span><code>Terraform</code><span>، المفروض تستخدم </span><code>Terraform</code><span> وبس.</span></strong>
<span>لما جزء من الـ </span><code>infrastructure</code><span> بتاعتك يبقى </span><code>Terraform</code><span> هو اللي بيديره، مينفعش أبدًا تعمل فيه تغييرات بإيدك. لو عملت كده، مش بس هتسبب لنفسك </span><code>errors</code><span> غريبة في </span><code>Terraform</code><span>، لأ ده أنت كمان بتضيع مميزات كتير من استخدام </span><code>Infrastructure as Code</code><span> من أساسه، لإن الكود بتاعك مبقاش هو الصورة الحقيقية للـ </span><code>infrastructure</code><span> بتاعتك.</span></p></li><li><p><strong><span>لو عندك </span><code>infrastructure</code><span> موجودة بالفعل، استخدم </span><code>import</code><span> command.</span></strong>
<span>لو عملت </span><code>infrastructure</code><span> قبل ما تبدأ تستخدم </span><code>Terraform</code><span>، ممكن تستخدم </span><code>terraform import</code><span> عشان تضيف الـ </span><code>infrastructure</code><span> دي لملف الـ </span><code>state</code><span> بتاع </span><code>Terraform</code><span> عشان يبقى عارف بيها ويقدر يديرها. الـ </span><code>import command</code><span> بياخد اتنين </span><code>arguments</code><span>. الأولاني هو &quot;عنوان&quot; الـ </span><code>resource</code><span> في ملفات الـ </span><code>Terraform configuration</code><span> بتاعتك (زي </span><code>aws_iam_user.existing_user</code><span>). التاني هو </span><code>ID</code><span> خاص بالـ </span><code>resource</code><span> نفسه بيعرفه. كمثال، الـ </span><code>ID</code><span> بتاع </span><code>aws_iam_user</code><span> هو اسم اليوزر، والـ </span><code>ID</code><span> بتاع </span><code>aws_instance</code><span> هو الـ </span><code>EC2 Instance ID</code><span>. الـ </span><code>documentation</code><span> اللي في آخر صفحة كل </span><code>resource</code><span> عادةً بتحدد إزاي تعمل </span><code>import</code><span> ليه.</span></p></li></ol><p><span>كمثال، ده الـ </span><code>import command</code><span> اللي ممكن تستخدمه عشان تعمل </span><code>sync</code><span> بين الـ </span><code>aws_iam_user</code><span> اللي لسه ضايفه في الكود بتاعك وبين الـ </span><code>IAM user</code><span> اللي عملته في الفصل التاني (طبعًا غير اسم اليوزر لاسمك):</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$ terraform</span> import aws_iam_user.existing_user yevgeniy.brikman</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><code>Terraform</code><span> هيستخدم الـ </span><code>AWS API</code><span> عشان يلاقي الـ </span><code>IAM user</code><span> بتاعك ويعمل ربط في الـ </span><code>state file</code><span> بتاعه بين اليوزر ده وبين </span><code>aws_iam_user.existing_user resource</code><span> اللي في الكود بتاعك. من بعدها، لما تشغل </span><code>plan</code><span>، </span><code>Terraform</code><span> هيبقى عارف إن الـ </span><code>IAM user</code><span> موجود أصلًا ومش هيحاول يعمله من الأول تاني.</span></p><p><strong><span>ملحوظة:</span></strong><span> لو عندك </span><code>resources</code><span> كتير موجودة وعايز تعملها </span><code>import</code><span> لـ </span><code>Terraform</code><span>، إنك تكتب الكود بتاعها من الصفر وتعمل </span><code>import</code><span> ليهم واحد واحد بالتأكيد موضوع رخم قوي. عشان كده، ممكن تبص على أدوات زي </span><strong><code>terraformer</code></strong><span> و </span><strong><code>terracognita</code></strong><span>، اللي بتقدر تعمل </span><code>import</code><span> للكود والـ </span><code>state</code><span> مع بعض من </span>
<span>الـ </span><code>cloud environments</code><span> المدعومة بشكل أوتوماتيكي.</span></p><p>&nbsp;</p><h3 id='إعادة-هيكلة-الكود-refactoring-ممكن-تبقى-صعبة'><strong><span>إعادة هيكلة الكود (</span><code>Refactoring</code><span>) ممكن تبقى صعبة</span></strong></h3><p><span>واحدة من common practice في البرمجة هي الـ </span><code>refactoring</code><span>، ودي إنك تعيد هيكلة التفاصيل الداخلية لجزء من الكود من غير ما تغير سلوكه الخارجي. الهدف هو إنك تحسن قراءة الكود، وصيانته، ونظافته بشكل عام. الـ </span><code>Refactoring</code><span> ممارسة أساسية في البرمجة والمفروض تعملها بانتظام. </span><strong><span>لكن،</span></strong><span> لما الموضوع يتعلق بـ </span><code>Terraform</code><span>، أو أي أداة </span><code>IaC</code><span>، لازم تاخد بالك كويس من إيه اللي بيحدد &quot;السلوك الخارجي&quot; لقطعة الكود، وإلا هتلاقي نفسك في مشاكل مكنتش متوقعها.</span></p><p><span>كمثال، ممارسة </span><code>refactoring</code><span> شائعة هي إنك تغير اسم </span><code>variable</code><span> أو </span><code>function</code><span> عشان تديله اسم أوضح. برامج كتير زي الـ </span><code>IDEs</code><span> فيها دعم مدمج للـ </span><code>refactoring</code><span> وممكن تغيرلك اسم الـ </span><code>variable</code><span> أو الـ </span><code>function</code><span> أوتوماتيك في الكود كله. مع إن تغيير الاسم ده حاجة ممكن تعملها من غير تفكير في لغات البرمجة العادية، لازم تبقى حذر جدًا إزاي بتعملها في </span><code>Terraform</code><span>، وإلا ممكن تسبب </span><code>outage</code><span> (انقطاع للخدمة).</span></p><p><span>كمثال، الـ </span><code>webserver-cluster module</code><span> عنده </span><code>input variable</code><span> اسمه </span><code>cluster_name</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"cluster_name"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"The name to use for all the cluster resources"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">string</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><span>يمكن بدأت تستخدم الـ </span><code>module</code><span> ده عشان تعمل </span><code>deploy</code><span> لـ </span><code>microservice</code><span>، وفي الأول سميته </span><code>foo</code><span>. بعد كده، قررت إنك عايز تغير اسم الـ </span><code>service</code><span> لـ </span><code>bar</code><span>. ده ممكن يبان تغيير تافه، بس في الحقيقة ممكن يسبب </span><code>outage</code><span>!</span></p><p><span>ده لأن </span><code>webserver-cluster module</code><span> بيستخدم </span><code>cluster_name</code><span> </span><code>variable</code><span> في كذا </span><code>resource</code><span>، بما فيهم الـ </span><code>name</code><span> بتاع اتنين </span><code>security groups</code><span> والـ </span><code>ALB</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_lb"</span> <span class="cm-string">"example"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">name</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">cluster_name</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">load_balancer_type</span> <span class="cm-operator">=</span> <span class="cm-string">"application"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p><span>لو غيرت الـ </span><code>name parameter</code><span> بتاع </span><code>resources</code><span> معينة، </span><code>Terraform</code><span> هيمسح النسخة القديمة من الـ </span><code>resource</code><span> ويعمل نسخة جديدة عشان يبدلها. لو الـ </span><code>resource</code><span> اللي بتمسحه ده كان </span><code>ALB</code><span>، مش هيبقى فيه حاجة توجه الـ </span><code>traffic</code><span> للـ </span><code>web server cluster</code><span> بتاعك لحد ما الـ </span><code>ALB</code><span> الجديد يقوم. وبالمثل، لو الـ </span><code>resource</code><span> اللي بتمسحه كان </span><code>security group</code><span>، السيرفرات بتاعتك هترفض كل الـ </span><code>network traffic</code><span> لحد ما الـ </span><code>security group</code><span> الجديد يتعمل.</span></p><p><code>Refactor</code><span> تاني ممكن تحب تعمله هو إنك تغير </span><code>Terraform identifier</code><span>. كمثال، بص على </span><code>aws_security_group resource</code><span> اللي في </span><code>webserver-cluster module</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_security_group"</span> <span class="cm-string">"instance"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># (...)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 67px;"></div><div class="CodeMirror-gutters" style="display: none; height: 67px;"></div></div></div></pre><p><span>الـ </span><code>identifier</code><span> بتاع الـ </span><code>resource</code><span> ده اسمه </span><code>instance</code><span>. يمكن وانت بتعمل </span><code>refactor</code><span> فكرت إنه هيبقى أوضح لو غيرت الاسم ده لـ </span><code>cluster_instance</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_security_group"</span> <span class="cm-string">"cluster_instance"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># (...)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 67px;"></div><div class="CodeMirror-gutters" style="display: none; height: 67px;"></div></div></div></pre><p><span>إيه النتيجة؟ أيوه، زي ما خمنت: </span><code>downtime</code><span>.</span></p><p><code>Terraform</code><span> بيربط كل </span><code>resource identifier</code><span> بـ </span><code>identifier</code><span> من الـ </span><code>cloud provider</code><span>، زي إنه يربط </span><code>iam_user</code><span> بـ </span><code>AWS IAM User ID</code><span> أو </span><code>aws_instance</code><span> بـ </span><code>AWS EC2 Instance ID</code><span>. لو غيرت الـ </span><code>resource identifier</code><span>، زي إنك تغير </span><code>aws_security_group</code><span> </span><code>identifier</code><span> من </span><code>instance</code><span> لـ </span><code>cluster_instance</code><span>، فبقدر ما </span><code>Terraform</code><span> عارف، أنت مسحت الـ </span><code>resource</code><span> القديم وضفت واحد جديد تمامًا. وكنتيجة لده، لو عملت </span><code>apply</code><span> للتغييرات دي، </span><code>Terraform</code><span> هيمسح الـ </span><code>security group</code><span> القديم ويعمل واحد جديد، وفي الفترة اللي في النص دي، السيرفرات بتاعتك هترفض كل الـ </span><code>network traffic</code><span>. ممكن تقابلك مشاكل شبه كده لو غيرت الـ </span><code>identifier</code><span> بتاع </span><code>module</code><span>، أو قسمت </span><code>module</code><span> واحد لكذا </span><code>module</code><span>، أو ضفت </span><code>count</code><span> أو </span><code>for_each</code><span> لـ </span><code>resource</code><span> أو </span><code>module</code><span> مكنش فيه قبل كده.</span></p><p><span>فيه أربع دروس أساسية المفروض تاخدهم من النقاش ده:</span></p><ol start='' ><li><p><strong><span>دايمًا استخدم </span><code>plan</code><span> command</span></strong>
<span>تقدر تلقط كل الـ </span><code>gotchas</code><span> دي بإنك تشغل </span><code>plan</code><span> command، تبص كويس في الـ </span><code>output</code><span>، وتلاحظ إن </span><code>Terraform</code><span> بيخطط إنه يمسح </span><code>resource</code><span> أنت غالبًا مش عايزه يتمسح.</span></p></li><li><p><strong><code>Create before destroy</code></strong>
<span>لو أنت فعلًا عايز تبدل </span><code>resource</code><span>، فكر كويس إذا كان البديل بتاعه المفروض يتعمل قبل ما تمسح الأصلي. لو كده، ممكن تقدر تستخدم </span><code>create_before_destroy</code><span> عشان تعمل ده. بدلاً من كده، ممكن توصل لنفس النتيجة بخطوتين يدويتين: أولًا، ضيف الـ </span><code>resource</code><span> الجديد للكود بتاعك وشغل </span><code>apply</code><span>؛ ثانيًا، شيل الـ </span><code>resource</code><span> القديم من الكود وشغل </span><code>apply</code><span> تاني.</span></p></li><li><p><strong><span>الـ </span><code>Refactoring</code><span> ممكن يحتاج تغيير في الـ </span><code>state</code></strong>
<span>لو عايز تعمل </span><code>refactor</code><span> للكود بتاعك من غير ما تسبب </span><code>downtime</code><span> بالغلط، هتحتاج تعدل الـ </span><code>Terraform state</code><span> عشان يتماشى مع التغيير. </span><strong><span>لكن، مينفعش أبدًا تعدل ملفات الـ </span><code>Terraform state</code><span> بإيدك!</span></strong><span> بدل كده، عندك حلين: تعمله يدويًا بإنك تشغل </span><code>terraform state mv</code><span> command، أو تعمله أوتوماتيك بإنك تضيف </span><code>moved</code><span> بلوك للكود بتاعك.</span></p><p><span>خلينا نبص الأول على </span><code>terraform state mv</code><span> command، اللي شكله كده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 469.635px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&lt;terraform state mv &lt;ORIGINAL_REFERENCE&gt; &lt;NEW_REFERENCE&gt;</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p>&nbsp;</p><p>&nbsp;</p><p><span>هنا </span><code>ORIGINAL_REFERENCE</code><span> هو عنوان الـ </span><code>resource</code><span> زي ما هو دلوقتي، و </span><code>NEW_REFERENCE</code><span> هو المكان الجديد اللي عايز تنقله ليه. كمثال، لو بتغير اسم </span><code>aws_security_group</code><span> من </span><code>instance</code><span> لـ </span><code>cluster_instance</code><span>، ممكن تشغل الكود ده:</span></p></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$ terraform</span> state <span class="cm-builtin">mv</span> \</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  aws_security_group.instance \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  aws_security_group.cluster_instance</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 67px;"></div><div class="CodeMirror-gutters" style="display: none; height: 67px;"></div></div></div></pre><p>&nbsp;</p><p><span>ده بيقول لـ </span><code>Terraform</code><span> إن الـ </span><code>state</code><span> اللي كان مرتبط بـ </span><code>aws_security_group.instance</code><span> المفروض دلوقتي يبقى مرتبط بـ </span><code>aws_security_group.cluster_instance</code><span>. لو غيرت </span><code>identifier</code><span> وشغلت الكوماند ده، هتعرف إنك عملتها صح لو الـ </span><code>terraform plan</code><span> اللي بعده طلع </span><code>no changes</code><span>.</span></p><p><span>إنك تضطر تفتكر تشغل كوماندات </span><code>CLI</code><span> يدويًا معرض للغلط، خصوصًا لو عملت </span><code>refactor</code><span> لـ </span><code>module</code><span> بتستخدمه عشرات الفرق في شركتك، وكل فريق منهم محتاج يفتكر يشغل </span><code>terraform state mv</code><span> عشان يتجنب الـ </span><code>downtime</code><span>. لحسن الحظ، </span><code>Terraform 1.1</code><span> ضاف طريقة عشان تتعامل مع ده أوتوماتيك: </span><code>moved</code><span> بلوك. أي وقت بتعمل </span><code>refactor</code><span> للكود بتاعك، المفروض تضيف </span><code>moved</code><span> بلوك عشان تسجل إزاي الـ </span><code>state</code><span> المفروض يتعدل. كمثال، عشان تسجل إن </span><code>aws_security_group</code><span> اتغير اسمه من </span><code>instance</code><span> لـ </span><code>cluster_instance</code><span>، هتضيف الـ </span><code>moved</code><span> بلوك ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">moved</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">from</span> <span class="cm-operator">=</span> <span class="cm-variable">aws_security_group</span><span class="cm-operator">.</span><span class="cm-property">instance</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">to</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">aws_security_group</span><span class="cm-operator">.</span><span class="cm-property">cluster_instance</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><span>دلوقتي، كل ما أي حد يشغل </span><code>apply</code><span> على الكود ده، </span><code>Terraform</code><span> هيكتشف أوتوماتيك إذا كان محتاج يعدل الـ </span><code>state file</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Terraform will perform the following actions:</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  # aws_security_group.instance has moved to</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  # aws_security_group.cluster_instance</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  # ...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Plan: 0 to add, 0 to change, 0 to destroy.</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Do you want to perform these actions?</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 134px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><p><span>لو كتبت </span><code>yes</code><span>، </span><code>Terraform</code><span> هيعدل الـ </span><code>state</code><span> أوتوماتيك، وزي ما الـ </span><code>plan</code><span> بيوضح، مفيش أي </span><code>resources</code><span> هتتضاف أو تتغير أو تتمسح، وده بالظبط اللي أنت عايزه!</span></p><ol start='' ><li><p><strong><span>بعض الـ </span><code>parameters</code><span> مينفعش تتغير (</span><code>immutable</code><span>)</span></strong>
<span>الـ </span><code>parameters</code><span> بتاعة </span><code>resources</code><span> كتير بتكون </span><code>immutable</code><span>، يعني لو غيرتها، </span><code>Terraform</code><span> هيمسح الـ </span><code>resource</code><span> القديم ويعمل واحد جديد عشان يبدله. الـ </span><code>documentation</code><span> بتاع كل </span><code>resource</code><span> غالبًا بتحدد إيه اللي بيحصل لو غيرت </span><code>parameter</code><span>، فاتعود إنك تبص في الـ </span><code>documentation</code><span>. ومرة تانية، اتأكد إنك دايمًا تستخدم </span><code>plan</code><span> command وتفكر إذا كنت المفروض تستخدم استراتيجية </span><code>create_before_destroy</code><span>.</span></p></li></ol><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><hr /><p>&nbsp;</p><div class="md-alert md-alert-note note"><p><span class='md-alert-text md-alert-text-note'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</span><br></p><p><strong><span>طريقة أحدث للـ </span><code>Conditionals</code><span>: استخدام </span><code>null</code><span> بدل </span><code>count = 0</code></strong></p><p><span>في </span><code>Terraform 0.15</code><span> وما بعده، بقى فيه طريقة أوضح وأكثر مباشرة لعمل الـ </span><code>conditional logic</code><span> لـ </span><code>optional arguments</code><span>. بدل ما تستخدم tricks الخاصة بـ </span><code>count</code><span>، تقدر ببساطة تخلي قيمة الـ </span><code>argument</code><span> بـ </span><strong><code>null</code></strong><span> لو مش عايزه يتنفذ.</span></p><p><strong><span>مثال: تفعيل أو إلغاء </span><code>access_logs</code><span> بشكل أنظف</span></strong></p><p><strong><span>الطريقة القديمة (بـ </span><code>count</code><span>):</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.63019px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_lb"</span> <span class="cm-string">"my_app_lb"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">access_logs</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">count</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">enable_lb_access_logs</span> <span class="cm-string">? </span><span class="cm-number">1</span> <span class="cm-operator">:</span> <span class="cm-number">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">bucket</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">aws_s3_bucket</span><span class="cm-operator">.</span><span class="cm-property">lb_logs</span>[<span class="cm-number">0</span>]<span class="cm-operator">.</span><span class="cm-property">bucket</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 179px;"></div><div class="CodeMirror-gutters" style="display: none; height: 179px;"></div></div></div></pre><p><strong><span>الطريقة الحديثة (بـ </span><code>null</code><span>):</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.63019px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_lb"</span> <span class="cm-string">"my_app_lb"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">access_logs</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">bucket</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">enable_lb_access_logs</span> <span class="cm-string">? </span><span class="cm-variable">aws_s3_bucket</span><span class="cm-operator">.</span><span class="cm-property">lb_logs</span>[<span class="cm-number">0</span>]<span class="cm-operator">.</span><span class="cm-property">bucket</span> <span class="cm-operator">:</span> <span class="cm-variable">null</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">enabled</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">enable_lb_access_logs</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 202px;"></div><div class="CodeMirror-gutters" style="display: none; height: 202px;"></div></div></div></pre><p><code>Terraform</code><span> لما بيلاقي </span><code>argument</code><span> قيمته </span><code>null</code><span>، بيتجاهله تمامًا كأنه مش مكتوب. الطريقة دي أنظف وأسهل في القراءة، وبتتجنب التعقيدات اللي بتيجي مع استخدام </span><code>count</code><span> (زي إن الـ </span><code>resource</code><span> يتحول لـ </span><code>list</code><span>). </span><strong><span>لو شغال على </span><code>Terraform</code><span> حديث، حاول تستخدم الطريقة دي كلما أمكن.</span></strong></p></div><hr /><p><strong><span>2. خطورة الـ </span><code>Splat Expression</code><span> مع الـ </span><code>Conditional Resources</code></strong></p><p><span>مهم نوضح للقارئ خطورة ممكن يقع فيها لو استخدم </span><code>splat expression</code><span> من غير </span><code>one(concat(...))</code><span>.</span></p><div class="md-alert md-alert-warning warning"><p><span class='md-alert-text md-alert-text-warning'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Warning</span><br></p><h3 id='خطر-0-المباشر-مع-conditional-resources'><strong><span>خطر: </span><code>[0]</code><span> المباشر مع </span><code>Conditional Resources</code></strong></h3><p><span>لما عملنا </span><code>if-else</code><span>، استخدمنا  </span><code>one(concat(...))</code><span> عشان نوصل للـ </span><code>output</code><span> الصح. ممكن حد يفكر ويقول: &quot;طب ما أستخدم </span><code>if-statement</code><span> عادي في الـ </span><code>output</code><span>؟&quot; زي كده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.63019px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># !! كود خطر !!</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"bad_example"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">give_neo_cloudwatch_full_access</span> <span class="cm-string">? </span><span class="cm-variable">aws_iam_user_policy_attachment</span><span class="cm-operator">.</span><span class="cm-property">neo_cloudwatch_full_access</span>[<span class="cm-number">0</span>]<span class="cm-operator">.</span><span class="cm-property">policy_arn</span> <span class="cm-operator">:</span> <span class="cm-string">"some_default_value"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 134px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><p><strong><span>المشكلة هنا قاتلة:</span></strong><span> </span><code>Terraform</code><span> لازم يجيب قيمة </span><strong><span>كل أجزاء</span></strong><span> الـ </span><code>ternary operator</code><span> قبل ما يختار منهم. لو </span><code>var.give_neo_cloudwatch_full_access</code><span> كانت بـ </span><code>false</code><span>، </span><code>Terraform</code><span> برضه هيحاول يقيم الجزء الأول (</span><code>...full_access[0]...</code><span>). وبما إن الـ </span><code>resource</code><span> ده مش موجود (لأن الـ </span><code>count</code><span> بتاعه بصفر)، فالـ </span><code>list</code><span> بتاعته فاضية، ومحاولة الوصول للـ </span><code>index [0]</code><span> بتاع </span><code>list</code><span> فاضية هتسبب </span><code>crash</code><span> و </span><code>error</code><span>.</span></p><p><code>one(concat(...))</code><span> بتتجنب المشكلة دي لأنها بتتعامل مع الـ </span><code>lists</code><span> كلها الأول قبل ما تحاول توصل لأي عنصر. </span><strong><span>تجنب استخدام </span><code>[0]</code><span> مباشرةً على </span><code>resource</code><span> معمول بـ </span><code>count</code><span> إلا لو أنت متأكد 100% إن الـ </span><code>count</code><span> بتاعه عمره ما هيكون صفر.</span></strong></p></div><p><span>.</span></p><div class="md-alert md-alert-tip tip"><p><span class='md-alert-text md-alert-text-tip'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>Tip</span><br></p><p>&nbsp;</p><h3 id='لاستراتيجيات-الـ-instance-refresh'><strong><span>لاستراتيجيات الـ </span><code>Instance Refresh</code></strong></h3><p><span>لما بتعمل </span><code>deployment</code><span> جديد، أهم حاجة بتفكر فيها هي: &quot;إزاي أبدل السيرفرات القديمة بالجديدة من غير ما الخدمة تقع أو تتأثر؟&quot;. الـ </span><code>Instance Refresh</code><span> في </span><code>AWS</code><span> بيديلك طريقتين أساسيتين تعمل بيهم الحركة دي، وكل طريقة ليها مميزاتها وعيوبها.</span></p><h4 id='الاستراتيجية-الأولى-rolling'><strong><span>الاستراتيجية الأولى: </span><code>Rolling</code><span> </span></strong></h4><p><span>دي الاستراتيجية الافتراضية والأكثر شيوعًا. فكرتها بسيطة جدًا:</span></p><ol start='' ><li><p><strong><span>امسح سيرفر قديم واحد.</span></strong><span> (الـ </span><code>capacity</code><span> بتاعتك بتقل واحد مؤقتًا).</span></p></li><li><p><strong><span>قوم سيرفر جديد واحد مكانه.</span></strong></p></li><li><p><strong><span>استنى</span></strong><span> لحد ما السيرفر الجديد ده يبقى </span><code>healthy</code><span> في الـ </span><code>Load Balancer</code><span> ويبدأ يستقبل </span><code>traffic</code><span>.</span></p></li><li><p><strong><span>كرر</span></strong><span> الخطوات دي واحد ورا التاني لحد ما كل السيرفرات القديمة تتبدل.</span></p></li></ol><p><strong><span>إمتى تستخدمها؟</span></strong>
<span>دي ممتازة لو الـ </span><code>application</code><span> بتاعك يقدر يستحمل نقص بسيط ومؤقت في الـ </span><code>capacity</code><span> (يعني لو عندك 10 سيرفرات وبقوا 9 لفترة قصيرة، الدنيا مش هتقع). هي أحسن اختيار من ناحية التكلفة لأنك مش بتزود عدد السيرفرات اللي شغال في نفس الوقت.</span></p><p><strong><span>مثال بالكود:</span></strong>
<span>ده نفس الكود اللي شفناه قبل كده. لو مكتبتش </span><code>strategy</code><span> خالص، </span><code>AWS</code><span> بتستخدم </span><code>Rolling</code><span> كافتراضي.</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.63019px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_autoscaling_group"</span> <span class="cm-string">"example"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># ... (name, launch_template, etc.)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">min_size</span> <span class="cm-operator">=</span> <span class="cm-number">4</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">max_size</span> <span class="cm-operator">=</span> <span class="cm-number">10</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">instance_refresh</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">strategy</span> <span class="cm-operator">=</span> <span class="cm-string">"Rolling"</span> <span class="cm-comment"># This is the default strategy</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">preferences</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-comment"># Do not let the healthy capacity fall below 75% of the desired size.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-comment"># If desired capacity is 4, at least 3 instances must remain healthy.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">min_healthy_percentage</span> <span class="cm-operator">=</span> <span class="cm-number">75</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">triggers</span> <span class="cm-operator">=</span> [<span class="cm-string">"launch_template"</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 381px;"></div><div class="CodeMirror-gutters" style="display: none; height: 381px;"></div></div></div></pre><p><strong><span>اللي هيحصل في المثال ده:</span></strong>
<span>الـ </span><code>ASG</code><span> هيمسح سيرفر واحد (تبقى الـ </span><code>capacity</code><span> 3)، يقوم واحد جديد. لما الجديد يبقى </span><code>healthy</code><span>، يرجعوا 4. بعدين يمسح واحد قديم تاني، وهكذا. </span><code>min_healthy_percentage = 75</code><span> بتضمن إن العملية دي هتقف لو عدد السيرفرات السليمة قل عن 3 لأي سبب.</span></p><hr /><h4 id='الاستراتيجية-الثانية-rollingwithadditionalbatch-اسمها-الجديد-standby'><strong><span>الاستراتيجية الثانية: </span><code>RollingWithAdditionalBatch</code><span> (اسمها الجديد </span><code>Standby</code><span>)</span></strong></h4><p><span>الاستراتيجية دي بتتبع سياسة &quot;الأمان أولًا&quot;. فكرتها هي إنها </span><strong><span>مبتلمسش أي سيرفر قديم</span></strong><span> إلا لما تكون جهزت البُدلاء بتوعه الأول.</span></p><ol start='' ><li><p><strong><span>قوم مجموعة سيرفرات جديدة الأول.</span></strong><span> (الـ </span><code>capacity</code><span> بتاعتك بتزيد مؤقتًا). حجم المجموعة دي أنت بتحدده.</span></p></li><li><p><strong><span>استنى</span></strong><span> لحد ما كل السيرفرات الجديدة دي تبقى </span><code>healthy</code><span> في الـ </span><code>Load Balancer</code><span> وتبدأ تستقبل </span><code>traffic</code><span>.</span></p></li><li><p><strong><span>دلوقتي بس،</span></strong><span> ابدأ امسح نفس العدد من السيرفرات القديمة.</span></p></li><li><p><strong><span>كرر</span></strong><span> العملية دي لحد ما كل القديم يتبدل.</span></p></li></ol><p><strong><span>إمتى تستخدمها؟</span></strong>
<span>دي هي الحل الأمثل لو الـ </span><code>application</code><span> بتاعك حساس جدًا لأي نقص في الـ </span><code>capacity</code><span> وميقدرش يستحمله (زي وقت الـ </span><code>peak traffic</code><span> أو الـ </span><code>Black Friday</code><span>). هي بتضمن إنك </span><strong><span>دايمًا عندك </span><code>capacity</code><span> زيادة</span></strong><span> أثناء الـ </span><code>deployment</code><span>، مش ناقصة. العيب الوحيد هو إنها بتكلفك فلوس زيادة مؤقتًا لأنك بتشغل سيرفرات أكتر من اللازم لفترة التحديث.</span></p><p><strong><span>مثال بالكود:</span></strong>
<span>هنا بنحدد الـ </span><code>strategy</code><span> بشكل صريح وبنضيف </span><code>instance_warmup</code><span>.</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.63019px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_autoscaling_group"</span> <span class="cm-string">"example"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># ... (name, launch_template, etc.)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">min_size</span> <span class="cm-operator">=</span> <span class="cm-number">4</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">max_size</span> <span class="cm-operator">=</span> <span class="cm-number">10</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">instance_refresh</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">strategy</span> <span class="cm-operator">=</span> <span class="cm-string">"RollingWithAdditionalBatch"</span> <span class="cm-comment"># Strategy for maximum safety</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">preferences</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-comment"># You can set this to 100% to ensure old instances are terminated</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-comment"># only after the new batch is fully healthy.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">min_healthy_percentage</span> <span class="cm-operator">=</span> <span class="cm-number">100</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-comment"># Give new instances 5 minutes (300 seconds) to warm up</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-comment"># and run initialization scripts before health checks start.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">instance_warmup</span> <span class="cm-operator">=</span> <span class="cm-number">300</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">triggers</span> <span class="cm-operator">=</span> [<span class="cm-string">"launch_template"</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 470px;"></div><div class="CodeMirror-gutters" style="display: none; height: 470px;"></div></div></div></pre><p>&nbsp;</p><p><strong><span>اللي هيحصل في المثال ده:</span></strong>
<span>لو الـ </span><code>ASG</code><span> شغال بـ 4 سيرفرات، </span><code>AWS</code><span> هتقوم سيرفرات 100% معناها هيقوم 4 (العدد ده ممكن تتحكم فيه برضه). لما السيرفرات الجديدة دي تبقى </span><code>healthy</code><span>، هيبدأ يمسح نفس العدد من السيرفرات القديمة. الـ </span><code>capacity</code><span> بتاعتك ممكن توصل لـ 5 أو 6 سيرفرات مؤقتًا، لكن عمرها ما هتقل عن 4. </span><code>instance_warmup</code><span> بتدي فرصة للسيرفرات الجديدة إنها &quot;تسخن&quot; وتحمل كل حاجة قبل ما الـ </span><code>Load Balancer</code><span> يعتبرها جاهزة، وده بيزود الأمان أكتر.</span></p><p>&nbsp;</p></div><hr /><p>&nbsp;</p><div class="md-alert md-alert-note note"><p><span class='md-alert-text md-alert-text-note'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</span><br></p><p>&nbsp;</p><p><span>الـ </span><code>moved</code><span> بلوك ده وظيفته إنه يدي تعليمات مباشرة لـ </span><code>Terraform</code><span>. بيقوله: &quot;يا تيرافورم، الـ </span><code>resource</code><span> اللي كان متسجل في الـ </span><code>state</code><span> بالعنوان القديم </span><code>from</code><span>، دلوقتي بقى عنوانه الجديد </span><code>to</code><span>. لما تعمل </span><code>apply</code><span>، متفكرش تمسح وتعمل من جديد، لأ، أنت بس عدّل العنوان ده في ملف الـ </span><code>state</code><span>&quot;.</span></p><p><span>الطريقة دي بتضمن إن عمليات </span><code>refactoring</code><span> - زي لما تغير اسم </span><code>resource</code><span> أو تنقله لـ </span><code>module</code><span> تاني - تعدي بسلاسة عند كل الناس اللي شغالة على نفس الكود، من غير ما يحصل </span><code>downtime</code><span>.</span></p><p><strong><span>لكن،</span></strong><span> الـ </span><code>moved</code><span> بلوك ده مش المفروض يفضل في الكود بتاعك على طول. هو أداة مؤقتة ليها دور محدد بينتهي.</span></p><h4 id='ليه-لازم-أشيل-الـ-moved-بلوك-أساسًا'><strong><span>ليه لازم أشيل الـ </span><code>moved</code><span> بلوك أساسًا؟</span></strong></h4><p><span>لو سبته في الكود فترة طويلة، هيعملك شوية مشاكل ودوشة تقنية:</span></p><ol start='' ><li><p><strong><span>الكود هيبقى زحمة على الفاضي (</span><code>Code Clutter</code><span>):</span></strong><span> تخيل كل ما تعمل </span><code>refactor</code><span> تسيب الـ </span><code>moved</code><span> بلوك. بعد سنة، ملفات </span><code>Terraform</code><span> هتبقى مليانة بعشرات، ويمكن مئات، من الـ </span><code>moved</code><span> بلوكات. ده بيخلي الكود طويل، صعب تقراه، ومليان بتاريخ قديم محدش محتاج يعرفه. الكود المفروض يقول </span><strong><span>إيه اللي شغال دلوقتي</span></strong><span>، مش كل التعديلات اللي حصلت قبل كده.</span></p></li><li><p><strong><span>هتعمل &quot;نقل فوق نقل&quot; وهتلخبط الدنيا (</span><code>Chained Moves</code><span>):</span></strong><span> إيه اللي هيحصل لو عملت </span><code>refactor</code><span> لنفس الـ </span><code>resource</code><span> مرتين ورا بعض؟</span></p><ul><li><p><span>الأسبوع ده: نقلت </span><code>aws_instance.foo</code><span> لـ </span><code>aws_instance.bar</code><span>.</span></p></li><li><p><span>الأسبوع اللي بعده: غيرت رأيك ونقلته لـ </span><code>aws_instance.baz</code><span>.</span>
<span>لو سبت الـ </span><code>moved</code><span> بلوك القديم، هتعمل سلسلة من عمليات النقل اللي بتخلي </span><code>Terraform</code><span> نفسه يتلخبط وهو بيحاول يعرف الـ </span><code>resource</code><span> ده أصله كان فين، وده بيزود فرصة الغلط.</span></p></li></ul></li><li><p><strong><span>هتصعب أي </span><code>Refactoring</code><span> جاي:</span></strong><span> لو سبت كل الـ </span><code>moved</code><span> بلوكات القديمة، أي حد هيجي بعدك يعمل </span><code>refactor</code><span> هيحتاج يفهم كل تاريخ عمليات النقل دي عشان ميبوظش حاجة. ده بيخلي الشغل أبطأ وأخطر في المستقبل.</span></p></li><li><p><strong><span>بيغطي على الكود :</span></strong><span> الـ </span><code>moved</code><span> بلوك ده مجرد &quot;comand عشان تصلح الـ </span><code>state</code><span>&quot;. أول ما الـ </span><code>state</code><span> يتصلح، التعليمات دي بتبقى ولا ليها أي لازمة. وجودها بيشتت أي حد بيقرأ الكود ويخليه يفكر في الماضي بدل ما يركز في الـ </span><code>logic</code><span> بتاع دلوقتي.</span></p></li></ol><p><span>باختصار، الـ </span><code>moved</code><span> بلوك هو آلية انتقالية. أول ما يخلص مهمته، وجوده بيعتبر </span><code>technical debt</code><span> لازم تتنضف.</span></p><h4 id='إمتى-بالظبط-أقدر-أشيله-وأنا-متطمن-القاعدة-العامة'><strong><span>إمتى بالظبط أقدر أشيله وأنا متطمن؟ (القاعدة العامة)</span></strong></h4><p><strong><span>القاعدة الذهبية:</span></strong><span> تقدر تمسح الـ </span><code>moved</code><span> بلوك بأمان </span><strong><span>بعد ما تتأكد إن كل ملفات الـ </span><code>state</code></strong><span> اللي بتستخدم الكود ده اتعملها </span><code>apply</code><span> واتصلحت بعملية النقل.</span></p><p><strong><span>يعني إيه الكلام ده عمليًا؟</span></strong></p><p><span>نقول إن الـ </span><code>module</code><span> اللي عملت فيه </span><code>refactor</code><span> شغال في 3 بيئات (</span><code>environments</code><span>): </span><code>dev</code><span>, </span><code>staging</code><span>, </span><code>production</code><span>. كل واحدة ليها ملف </span><code>state</code><span> لوحدها.</span></p><ol start='' ><li><p><strong><span>أنت بتضيف الـ </span><code>moved</code><span> بلوك</span></strong><span> وبتعمل </span><code>commit</code><span> و </span><code>push</code><span> للكود.</span></p></li><li><p><strong><span>بتعمل </span><code>terraform apply</code><span> على بيئة </span><code>dev</code><span>:</span></strong><span> </span><code>Terraform</code><span> بيشوف الـ </span><code>moved</code><span> بلوك، ويصلح الـ </span><code>state</code><span> بتاع </span><code>dev</code><span>. كده الـ </span><code>state</code><span> بتاع </span><code>dev</code><span> بقى &quot;نضيف&quot; وعارف العناوين الجديدة.</span></p></li><li><p><strong><span>بتعمل </span><code>terraform apply</code><span> على بيئة </span><code>staging</code><span>:</span></strong><span> نفس الكلام، الـ </span><code>state</code><span> بتاع </span><code>staging</code><span> بيتصلح.</span></p></li><li><p><strong><span>بتعمل </span><code>terraform apply</code><span> على بيئة </span><code>production</code><span>:</span></strong><span> نفس الكلام، الـ </span><code>state</code><span> بتاع </span><code>production</code><span> بيتصلح.</span></p></li></ol><p><strong><span>في اللحظة دي،</span></strong><span> بعد ما كل ملفات الـ </span><code>state</code><span> عندك في كل البيئات بقت بتشاور على العناوين الجديدة، الـ </span><code>moved</code><span> بلوك مبقاش ليه أي وظيفة. دوره انتهى. لو أي حد عمل </span><code>apply</code><span> تاني، </span><code>Terraform</code><span> هيبص على الـ </span><code>state</code><span> وهيلاقيه متوافق مع الكود الجديد، ومش هيحتاج الـ </span><code>moved</code><span> بلوك في حاجة.</span></p><p><strong><span>عند هذه النقطة، يمكنك تقدر تنشاء  </span><code>commit</code><span> جديد يشيل  الـ </span><code>moved</code><span> بلوك من الكود نهائيًا.</span></strong></p></div></div></div>
</body>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn&display=swap" rel="stylesheet">

<style>
    /* تطبيق الخط على كل الصفحة */
    body {
        font-family: "Vazirmatn", sans-serif;
        font-optical-sizing: auto;
        font-weight: 400;
        font-style: normal;
    }
    h1 h2 h3 h4 h5 h6 {
        font-family: "Vazirmatn", sans-serif;
        font-optical-sizing: auto;
        font-weight: 400;
        font-style: normal;
    }
    </style>

</html>