<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>

<style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color: #ffffff; --text-color: #333333; --select-text-bg-color: #B5D6FC; --select-text-font-color: auto; --monospace: "Lucida Console",Consolas,"Courier",monospace; --title-bar-height: 20px; }
.mac-os-11 { --title-bar-height: 28px; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
h1, h2, h3, h4, h5 { white-space: pre-wrap; }
body { margin: 0px; padding: 0px; height: auto; inset: 0px; font-size: 1rem; line-height: 1.42857; overflow-x: hidden; background: inherit; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; overflow-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 36px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
.typora-export .task-list-item input { pointer-events: none; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; image-orientation: from-image; }
button, input, select, textarea { color: inherit; font: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 4; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px; }
thead, tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right: 0px; background-color: inherit; }
.CodeMirror-linenumber { user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }
.md-fences-adv-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
svg { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: 0px 0px; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; -webkit-tap-highlight-color: transparent; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li blockquote { margin: 1rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; font-variant-ligatures: no-common-ligatures; }
  #write { margin-top: 0px; border-color: transparent !important; padding-top: 0px !important; padding-bottom: 0px !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  .typora-export #write { break-after: avoid; }
  .typora-export #write::after { height: 0px; }
  .is-mac table { break-inside: avoid; }
  #write > p:nth-child(1) { margin-top: 0px; }
  .typora-export-show-outline .typora-export-sidebar { display: none; }
  figure { overflow-x: visible; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
#write.first-line-indent p > .md-image:only-child:not(.md-img-error) img { left: -2em; position: relative; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
.MathJax_ref { fill: currentcolor; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.reversefootnote { font-family: ui-monospace, sans-serif; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.6; font-family: var(--monospace); }
code { text-align: left; vertical-align: initial; }
a.md-print-anchor { white-space: pre !important; border-width: initial !important; border-style: none !important; border-color: initial !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; background: 0px 0px !important; text-decoration: initial !important; text-shadow: initial !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
mark { background: rgb(255, 255, 0); color: rgb(0, 0, 0); }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
.md-expand mark .md-meta { opacity: 0.3 !important; }
mark .md-meta { color: rgb(0, 0, 0); }
@media print {
  .typora-export h1, .typora-export h2, .typora-export h3, .typora-export h4, .typora-export h5, .typora-export h6 { break-inside: avoid; }
}
.md-diagram-panel .messageText { stroke: none !important; }
.md-diagram-panel .start-state { fill: var(--node-fill); }
.md-diagram-panel .edgeLabel rect { opacity: 1 !important; }
.md-fences.md-fences-math { font-size: 1em; }
.md-fences-advanced:not(.md-focus) { padding: 0px; white-space: nowrap; border: 0px; }
.md-fences-advanced:not(.md-focus) { background: inherit; }
.typora-export-show-outline .typora-export-content { max-width: 1440px; margin: auto; display: flex; flex-direction: row; }
.typora-export-sidebar { width: 300px; font-size: 0.8rem; margin-top: 80px; margin-right: 18px; }
.typora-export-show-outline #write { --webkit-flex: 2; flex: 2 1 0%; }
.typora-export-sidebar .outline-content { position: fixed; top: 0px; max-height: 100%; overflow: hidden auto; padding-bottom: 30px; padding-top: 60px; width: 300px; }
@media screen and (max-width: 1024px) {
  .typora-export-sidebar, .typora-export-sidebar .outline-content { width: 240px; }
}
@media screen and (max-width: 800px) {
  .typora-export-sidebar { display: none; }
}
.outline-content li, .outline-content ul { margin-left: 0px; margin-right: 0px; padding-left: 0px; padding-right: 0px; list-style: none; overflow-wrap: anywhere; }
.outline-content ul { margin-top: 0px; margin-bottom: 0px; }
.outline-content strong { font-weight: 400; }
.outline-expander { width: 1rem; height: 1.42857rem; position: relative; display: table-cell; vertical-align: middle; cursor: pointer; padding-left: 4px; }
.outline-expander::before { content: ""; position: relative; font-family: Ionicons; display: inline-block; font-size: 8px; vertical-align: middle; }
.outline-item { padding-top: 3px; padding-bottom: 3px; cursor: pointer; }
.outline-expander:hover::before { content: ""; }
.outline-h1 > .outline-item { padding-left: 0px; }
.outline-h2 > .outline-item { padding-left: 1em; }
.outline-h3 > .outline-item { padding-left: 2em; }
.outline-h4 > .outline-item { padding-left: 3em; }
.outline-h5 > .outline-item { padding-left: 4em; }
.outline-h6 > .outline-item { padding-left: 5em; }
.outline-label { cursor: pointer; display: table-cell; vertical-align: middle; text-decoration: none; color: inherit; }
.outline-label:hover { text-decoration: underline; }
.outline-item:hover { border-color: rgb(245, 245, 245); background-color: var(--item-hover-bg-color); }
.outline-item:hover { margin-left: -28px; margin-right: -28px; border-left: 28px solid transparent; border-right: 28px solid transparent; }
.outline-item-single .outline-expander::before, .outline-item-single .outline-expander:hover::before { display: none; }
.outline-item-open > .outline-item > .outline-expander::before { content: ""; }
.outline-children { display: none; }
.info-panel-tab-wrapper { display: none; }
.outline-item-open > .outline-children { display: block; }
.typora-export .outline-item { padding-top: 1px; padding-bottom: 1px; }
.typora-export .outline-item:hover { margin-right: -8px; border-right: 8px solid transparent; }
.typora-export .outline-expander::before { content: "+"; font-family: inherit; top: -1px; }
.typora-export .outline-expander:hover::before, .typora-export .outline-item-open > .outline-item > .outline-expander::before { content: "−"; }
.typora-export-collapse-outline .outline-children { display: none; }
.typora-export-collapse-outline .outline-item-open > .outline-children, .typora-export-no-collapse-outline .outline-children { display: block; }
.typora-export-no-collapse-outline .outline-expander::before { content: "" !important; }
.typora-export-show-outline .outline-item-active > .outline-item .outline-label { font-weight: 700; }
.md-inline-math-container mjx-container { zoom: 0.95; }
mjx-container { break-inside: avoid; }
.md-alert.md-alert-note { border-left-color: rgb(9, 105, 218); }
.md-alert.md-alert-important { border-left-color: rgb(130, 80, 223); }
.md-alert.md-alert-warning { border-left-color: rgb(154, 103, 0); }
.md-alert.md-alert-tip { border-left-color: rgb(31, 136, 61); }
.md-alert.md-alert-caution { border-left-color: rgb(207, 34, 46); }
.md-alert { padding: 0px 1em; margin-bottom: 16px; color: inherit; border-left: 0.25em solid rgb(0, 0, 0); }
.md-alert-text-note { color: rgb(9, 105, 218); }
.md-alert-text-important { color: rgb(130, 80, 223); }
.md-alert-text-warning { color: rgb(154, 103, 0); }
.md-alert-text-tip { color: rgb(31, 136, 61); }
.md-alert-text-caution { color: rgb(207, 34, 46); }
.md-alert-text { font-size: 0.9rem; font-weight: 700; }
.md-alert-text svg { fill: currentcolor; position: relative; top: 0.125em; margin-right: 1ch; overflow: visible; }
.md-alert-text-container::after { content: attr(data-text); text-transform: capitalize; pointer-events: none; margin-right: 1ch; }


.CodeMirror { height: auto; }
.CodeMirror.cm-s-inner { background: inherit; }
.CodeMirror-scroll { overflow: auto hidden; z-index: 3; }
.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }
.CodeMirror-gutters { border-right: 1px solid rgb(221, 221, 221); background: inherit; white-space: nowrap; }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-property { color: rgb(0, 0, 0); }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: 700; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: red; }
.cm-invalidchar { color: red; }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background: inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background: inherit; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; outline: 0px; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: auto hidden; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 10px; z-index: 3; overflow-y: hidden; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; background: 0px 0px !important; border: none !important; }
.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-radius: 0px; border-width: 0px; background: 0px 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; overflow-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; }
.CodeMirror-wrap pre { overflow-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right: 30px solid transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right: none; width: auto; }
.CodeMirror-linebackground { position: absolute; inset: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right: none; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.cm-searching { background: rgba(255, 255, 0, 0.4); }
span.cm-underlined { text-decoration: underline; }
span.cm-strikethrough { text-decoration: line-through; }
.cm-tw-syntaxerror { color: rgb(255, 255, 255); background-color: rgb(153, 0, 0); }
.cm-tw-deleted { text-decoration: line-through; }
.cm-tw-header5 { font-weight: 700; }
.cm-tw-listitem:first-child { padding-left: 10px; }
.cm-tw-box { border-style: solid; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-color: inherit; border-top-width: 0px !important; }
.cm-tw-underline { text-decoration: underline; }
@media print {
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}


/* Theme adapted from https://codemirror.net/theme/dracula.css */
/*
    Name:       dracula
    Author:     Michael Kaminsky (http://github.com/mkaminsky11)

    Original dracula color scheme by Zeno Rocha (https://github.com/zenorocha/dracula-theme)
*/

.cm-s-inner {
  padding: 0.5rem 0.2rem;
  border: 1px solid var(--accent-color) !important;
  border-radius: 0.25rem;
}

.cm-s-inner.CodeMirror, .cm-s-inner .CodeMirror-gutters {
  background-color: #282a36 !important;
  color: #f8f8f2 !important;
  border: none;
}

.cm-s-inner .CodeMirror-gutters {
  width: 5ch;
  color: #282a36;
}
.cm-s-inner .CodeMirror-cursor { border-left: solid thin #f8f8f2 !important; }
.cm-s-inner .CodeMirror-linenumber {
  width: 4ch !important;
  color: #6D8A88;
}

.cm-s-inner .CodeMirror-line::selection,
.cm-s-inner .CodeMirror-line > span::selection,
.cm-s-inner .CodeMirror-line > span > span::selection { background: rgba(255, 255, 255, 0.10); }
.cm-s-inner .CodeMirror-line::-moz-selection,
.cm-s-inner .CodeMirror-line > span::-moz-selection,
.cm-s-inner .CodeMirror-line > span > span::-moz-selection { background: rgba(255, 255, 255, 0.10); }
.cm-s-inner span.cm-comment { color: #6272a4; }
.cm-s-inner span.cm-string, .cm-s-inner span.cm-string-2 { color: #f1fa8c; }
.cm-s-inner span.cm-number { color: #bd93f9; }
.cm-s-inner span.cm-variable, .cm-s-inner span.cm-variable-2 { color: #50fa7b; }
.cm-s-inner span.cm-def { color: white; }
.cm-s-inner span.cm-operator { color: #ff79c6; }
.cm-s-inner span.cm-keyword { color: #ff79c6; }
.cm-s-inner span.cm-atom { color: #bd93f9; }
.cm-s-inner span.cm-meta { color: #f8f8f2; }
.cm-s-inner span.cm-tag { color: #ff79c6; }
.cm-s-inner span.cm-attribute { color: #50fa7b; }
.cm-s-inner span.cm-qualifier { color: #50fa7b; }
.cm-s-inner span.cm-property { color: #66d9ef; }
.cm-s-inner span.cm-builtin { color: #50fa7b; }
.cm-s-inner span.cm-variable-3, .cm-s-inner span.cm-type { color: #ffb86c; }

.cm-s-inner .CodeMirror-activeline-background { background: rgba(255,255,255,0.1); }
.cm-s-inner .CodeMirror-matchingbracket {
  text-decoration: underline;
  color: white !important;
}
.CodeMirror-selectedtext, .CodeMirror-selected {
  background: #313746 !important;
  text-shadow: none;
}
/* 
  Middle East - Night
  Typora RTL theme
  design: isapanah.com
  date: 2019
  version: 1.1
*/

@import url("file:////home/Taha/.config/Typora/themes/");

/*
  Vazir provided by Rastikerdar
  Downloaded from `https://github.com/rastikerdar/vazir-font`
*/
/*
	Cousine provided by Steve Matteson from Google Fonts
	Downloaded from `https://fonts.google.com/specimen/Cousine`
*/
/** ROOT VARIABLES **/

:root {
  --bg-color: #1e2022; /* change background */
  --text-color: #dddddd; /* change text color */
  --md-char-color: #5b5b5b; /* change color of mbeta characetrs like `*` in markdown */
  --meta-content-color: #757575; /* change color of meta contents like image text or link address in markdown */
  --link-color: #6bcafb; /* change color of hyperlinks */

  --primary-color: #428bca; /* primary color */
  --primary-btn-border-color: #285e8e; /* primary color for buttons */
  --primary-btn-text-color: #fff; /* primary text color for buttons */
  --accent-color: #3c3c3c; /* background accent color */

  --window-border: 1px solid #16161a; /* border for sidebar, etc*/

  --active-file-bg-color: #16161a; /* background color if list item in file tree or file list*/
  --active-file-text-color: inherit; /* text color for selected file */
  --active-file-border-color: #777; /* border color for selected file */
  --active-search-item-bg-color: #212121; /* background color for active search item */

  --side-bar-bg-color: #2b2b2b; /* change background of sidebar*/
  --item-hover-bg-color: var(--bg-color); /* background of control items when hover, like menu in sidebar*/
  --item-hover-text-color: white; /* text color upon hovering over menu items */
  --search-hit-bg-color: #428bca40;
  --search-select-text-color: var(--text-color); /* Text color for selected searched text */
  --search-select-bg-color: #428bca90; /* Background color for selected searched text */
  --rawblock-edit-panel-bd: var(--accent-color); /* Background color for inline HTML "edit panel" blocks */
  --monospace: "Cousine"; /* monospace font for codes, fences */

  --megamenu-bg-color: var(--side-bar-bg-color); /* background color for unibody megamenu */
  --megamenu-sidebar-bg-color: var(--bg-color); /* background color for megamenu sidebar */
  --megamenu-sidebar-hover-bg-color: #161819; /* background color for hovering megamenu sidebar items */
  --megamenu-sidebar-active-bg-color: #101010; /* background color for active megamenu sidebar items */
  --megamenu-button-border-color: #9292928f; /* background color for megamenu buttons */
  --megamenu-item-hover-bg-color: var(--bg-color); /* background color for hovering megamenu items */
  --megamenu-item-hover-text-color: white; /* text color for hovering megamenu items */
}

/** TAGS **/

html,
body {
  font-family: "Vazir", "Lato", sans-serif;
}

body {
  font-size: 14px;
}

h1,
h2,
h3,
h4,
h5,
h6, p, a, del, mark, #write p, #write a, #write del, #write mark, #write ul, #write li, #write ol,
#write table, #write tr, #write td, table, tr, td {
  direction: rtl;
}

.outline-item{
  direction: rtl;
}
.outline-h2, .outline-h3, .outline-h4,
 .outline-h5, .outline-h6 {
  margin-right: 10px !important;
}

#md-notification, #md-notification *{
  direction: ltr;
}

h1,
h2,
h3,
h4,
h5,
h6 {
  font-family: "Vazir-Bold";
}

h1 {
  font-size: 1.8rem;
  margin: 1rem 0;
}

h2 {
  font-size: 1.4rem;
  margin: 0.7rem 0;
}

h3 {
  font-size: 1.2rem;
  margin: 0.5rem 0;
}

h4 {
  font-size: 1.1rem;
  margin: 0.2rem 0;
}

h5 {
  font-size: 1rem;
  margin: 0;
}

h6 {
  font-size: 1rem;
  margin: 0;
}

p {
  margin: 0.5rem 0;
}

a {
  color: var(--link-color);
}

del {
  color: var(--md-char-color);
}

mark {
  padding: 2px 1px;
  background: #fee405;
}

/* Writing area -> line height */
#write {
	line-height: 1.6;
}

/* Custom list-style */
#write ol,
#write ul {
  padding-left: 2rem;
  margin: 0.5rem 0;
  margin-left: 0 !important;
  padding-left: 0 !important;
}

#write ul {
  list-style-type: disc;
}

#write ol > li,
#write ul > li {
  color: var(--primary-color);
  padding-left: 0.25em;
}

#write ol li > *,
#write ul li > * {
  color: var(--text-color);
}

#write .md-task-list-item {
  transition: all 0.3s;
}

#write .md-task-list-item > input {
  -webkit-appearance: initial;
  display: block;
  position: absolute;
  border: 1px solid var(--md-char-color);
  border-radius: 0.25rem;
  margin-top: 0.1rem;
  margin-right: -1.8rem;
  height: 1.2rem;
  width: 1.2rem;
  transition: background 0.4s;
  right: 0;
}

#write .md-task-list-item > input:focus {
  outline: none;
  box-shadow: none;
}

#write .md-task-list-item > input:hover {
  background: var(--accent-color);
}

#write .md-task-list-item.task-list-done > p {
  color: var(--md-char-color);
  text-decoration: line-through;
}

#write .md-task-list-item > input[checked]::before {
  content: "";
  position: absolute;
  top: 20%;
  left: 50%;
  height: 60%;
  width: 2px;
  transform: rotate(40deg);
  background: var(--text-color);
}

#write .md-task-list-item > input[checked]::after {
  content: "";
  position: absolute;
  top: 46%;
  left: 25%;
  height: 30%;
  width: 2px;
  transform: rotate(-40deg);
  background: var(--text-color);
}

blockquote {
  margin: 1rem 0rem 1rem 0;
  font-family: "Vazir-Bold";
}

blockquote p::before {
  content: "";
  position: absolute;
  right: -2rem;
  height: 100%;
  width: 0.25rem;
  background: var(--primary-color);
}

blockquote p:not(:last-child):before {
  height: calc(100% + 1rem);
}

code,
.md-fences,
tt {
  font-family: "Cousine", monospace;
  font-size: 1rem;
}

code {
  border: 1px solid var(--accent-color);
  border-radius: 0.25rem;
  padding: 0 0.125rem;
}

/* Code auto-suggest list menu */
#fences-auto-suggest .active {
  background: var(--accent-color);
}

hr {
  border-color: var(--md-char-color);
}

/* YAML */
pre.md-meta-block {
  background-color: transparent;
  border-bottom: 1px solid var(--md-char-color);
  padding-bottom: 1rem;
  opacity: 0.8;
}

/* Tables */
table {
  border: 1px solid var(--md-char-color);
  margin: 1rem 0;
}

thead {
  background: #4d4d4d;
}

table tr:nth-child(2n) {
  background: var(--accent-color);
}

td,
th {
  padding: 0.35rem 0.7rem;
  border: 1px solid var(--md-char-color);
}

/* Table toolbar */
.md-table-edit {
  border-top: 1px solid var(--meta-content-color);
  margin-top: -29px !important;
  padding: 3px 0;
}

/* Table drag areas */
.typora-table-drag-area::after {
  content: "";
  position: absolute;
  border: 2px solid var(--text-color);
  opacity: 0;
  transition: opacity 0.4s;
}

#typora-table-row-tracker .typora-table-drag-area::after {
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 100%;
}

#typora-table-col-tracker .typora-table-drag-area::after {
  top: 50%;
  left: 0;
  transform: translateY(-50%);
  width: 100%;
  height: 0;
}

#typora-table-row-tracker .typora-table-drag-area:hover::after,
#typora-table-col-tracker .typora-table-drag-area:hover::after {
  opacity: 1;
}

/* Table of contents */
.md-toc-tooltip {
  z-index: 10;
}

span.md-toc-item {
  font-size: 1.1rem;
  color: var(--primary-btn-border-color);
}

span.md-toc-h1 {
  font-family: "Vazir-Bold";
  font-size: 1.3rem;
}

span.md-toc-h2 {
  font-size: 1.2rem;
}

/* Footnote */
sup.md-footnote {
  font-family: "Vazir-Bold";
  font-size: 0.8rem;
  padding: 0 4px;
}

span.md-def-split {
  min-width: 1ch;
}

.md-def-name::before,
.md-def-name::after {
  color: var(--meta-content-color);
}

/* Writing area */
#write {
  width: 90%;
  max-width: 700px;
}

/* Fill whole width of container */
#write h1,
#write h2,
#write h3,
#write h4,
#write h5,
#write h6,
#write p,
#write pre {
  width: auto;
}

/* Header prefix symbol */
/* Disable default header symbol */
#write h3.md-focus::before,
#write h4.md-focus::before,
#write h5.md-focus::before,
#write h6.md-focus::before {
  border: none;
  border-radius: 0;
  left: auto;
  float: none;
  padding: 0;
  vertical-align: baseline;
  line-height: 20px;
}

#write h1::before,
#write h2::before,
#write h3::before,
#write h4::before,
#write h5::before,
#write h6::before {
  position: absolute;
  top: 0;
  right: calc(100% + 10px);
  color: var(--md-char-color);
  font-size: 1rem;
  font-weight: bold;
  font-variant: "small-caps";
}

#write h1::before {
  content: "H1";
  top: 0.7rem;
}

#write h2::before {
  content: "H2";
  top: 0.37rem;
}

#write h3::before {
  content: "H3";
  top: 0.15rem;
}

#write h4::before {
  content: "H4";
}

#write h5::before {
  content: "H5";
}

#write h6::before {
  content: "H6";
}

/* Image meta text */
#write .md-image > .md-meta {
  color: var(--meta-content-color);
}

/* Inline styles */
.md-rawblock-tooltip {
  top: -1.5rem;
  height: 1.5rem;
  padding: 0.25rem;
}

/* Search results */
.md-search-hit {
  background: var(--search-hit-bg-color);
  border-radius: 0.125em;
}

.md-search-select {
  background: var(--search-select-bg-color);
  border: 1px solid var(--megamenu-button-border-color);
  padding: 0 1px;
}

/* Focus mode */
.on-focus-mode .md-end-block:not(.md-focus):not(.md-focus-container) *,
.on-focus-mode pre.md-end-block:not(.md-focus):not(.md-focus-container) {
  color: var(--md-char-color) !important;
}

.on-focus-mode .md-end-block:not(.md-focus):not(.md-focus-container) img,
.on-focus-mode
  blockquote
  .md-end-block:not(.md-focus):not(.md-focus-container)::before,
.on-focus-mode li:not(.md-focus-container)::before {
  opacity: 0.5;
}

.on-focus-mode .md-end-block:not(.md-focus):not(.md-focus-container) mark {
  background: var(--accent-color);
}

/* UI Sidebar */
#typora-sidebar {
  border-right: 1px solid #19191c;
}

.sidebar-tabs {
  font-family: "Vazir-Bold";
  border-bottom: 1px solid black;
}

.file-list-item-file-name {
  font-family: "Vazir-Bold";
  font-size: 1.2rem;
}

input.file-list-item-file-name, input.file-tree-rename-input {
  background: var(--side-bar-bg-color);
}

#file-library-search .file-list-item-file-name {
  font-size: 1.1rem;
}

#file-library-search .ty-search-item.active {
  background: var(--active-search-item-bg-color);
}

#file-library-search-input {
  background: var(--side-bar-bg-color);
}

.file-list-item-summary,
.ty-search-item-line {
  font-family: "Vazir", "Lato", sans-serif;
}

.ty-file-search-match-text,
.ty-outline-hit {
  font-weight: bold;
  background: transparent;
}

#outline-content {
  line-height: 1.4em;
}

#outline-content .outline-h1 > .outline-item {
  font-family: "Vazir-Bold";
}

.file-library-node,
.file-library-node .file-node-background {
  transition: background 0.4s;
}

.file-tree-node.file-library-file-node:not(.active):hover .file-node-background,
.file-list-item.file-library-node:not(.active):hover {
  background: var(--item-hover-bg-color);
}

.file-tree-node.file-library-file-node.active .file-node-background,
.file-list-item.file-library-file-node.active {
  border-left: 5px solid var(--primary-color);
}

/* Remove blinking animation when updating filename */
.blink-area {
  animation: none;
}

#ty-sidebar-footer {
  border-top: 1px solid black;
}

.sidebar-footer-item {
  transition: background 0.3s;
}

.outline-title-wrapper,
.outline-item-wrapper.outline-h1 > .outline-item {
  font-family: "Vazir-Bold";
  font-weight: bold;
}

/* Windows-specific */
/* Context and dropdown menus */
ul.dropdown-menu li.active a,
ul.dropdown-menu li.has-extra-menu.active a,
ul.dropdown-menu li.has-btn-submenu a.menu-style-btn.active,
#footer-word-count-info .ty-footer-word-count-all tr:hover,
#ty-spell-check-dict-missing-menu li:hover,
.ty-spell-check-panel-item.ty-active,
.ty-spell-check-panel-item:hover {
  background: var(--text-color) !important;
  color: var(--bg-color) !important;
}

/* Windows Unibody */
footer.ty-footer {
  border-top: 0;
}

.footer-item:hover {
  background: var(--text-color) !important;
  color: var(--bg-color) !important;
}

.form-control:focus {
  border-color: var(--primary-color);
  box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 2px var(--primary-color);
}

/* Windows Unibody megamenu */
.megamenu-opened header {
  background-image: none;
}

#top-titlebar, #top-titlebar * {
  color: inherit;
}

#megamenu-content {
  padding-top: 28px;
  background: var(--megamenu-bg-color);
  color: var(--text-color);
}

.megamenu-menu-panel:not(:first-of-type) {
  margin-top: 48px;
}

#megamenu-content .long-btn {
  border-color: var(--megamenu-button-border-color);
  transition: all 0.4s;
}

#megamenu-content .long-btn:hover {
  border-color: var(--primary-color);
  background: var(--megamenu-item-hover-bg-color);
  color: var(--megamenu-item-hover-text-color) !important;
}

#recent-file-panel-action-btn {
  background: inherit;
  border-color: var(--megamenu-button-border-color);
  transition: all 0.4s;
}

#recent-file-panel-action-btn:hover {
  border-color: var(--primary-color);
  background: var(--megamenu-item-hover-bg-color);
  color: var(--megamenu-item-hover-text-color);
}

#recent-document-table {
  border: 1px solid var(--accent-color);
}

#recent-file-panel tbody tr:nth-child(2n-1) {
  background-color: inherit;
}

#recent-file-panel tbody tr:hover {
  background-color: var(--megamenu-item-hover-bg-color) !important;
}

#recent-file-panel tbody tr:hover td:nth-child(1) {
  color: var(--megamenu-item-hover-text-color);
}

/* Windows Unibody sidebar */
#megamenu-menu-sidebar {
  background: var(--megamenu-sidebar-bg-color);
  color: var(--text-color);
}

.megamenu-menu-header, .megamenu-menu-list li:not(.saved) a {
  transition: all 0.4s;
}

.megamenu-menu-header {
  border-bottom: var(--window-border);
}

.megamenu-menu-header:hover, .megamenu-menu-list li:not(.saved) a:not(.active):hover {
  background: var(--megamenu-sidebar-hover-bg-color);
}

.megamenu-menu-list li a.active {
  background: var(--megamenu-sidebar-active-bg-color) !important;
}

#m-saved {
  background: inherit;
  color: inherit;
}

#megamenu-menu-list {
  margin: 0;
}

.theme-preview-div {
  transition: all 0.4s;
}

.theme-preview-div:hover {
  border: 4px solid var(--primary-btn-border-color);
}

.theme-preview-div.active, .theme-preview-div.active:hover {
  border: 4px solid var(--primary-color);
}

.theme-preview-div.active i {
  color: var(--primary-color);
}

/* Source Code */
.cm-s-typora-default .cm-s-inner.CodeMirror-line {
  border: 0 !important;
}

/* Print/PDF */
@media print {
  #write ol > li,
  #write ul > li {
    color: var(--text-color);
  }
  #write h1::before, #write h2::before, #write h3::before,
  #write h4::before, #write h5::before, #write h6::before {
    display: none;
  }
}




</style><title>ch3</title>
</head>
<body class='typora-export'><div class='typora-export-content'>
<div id='write'  class=''><h1 id='الفصل-التالت-إزاي-تعمل-manage-للـ-terraform-state'><strong><span>الفصل التالت: إزاي تعمل Manage للـ Terraform State</span></strong></h1><p><span>في الفصل التاني، وانت بتستخدم </span><code>Terraform</code><span> عشان تعمل </span><code>create</code><span> وتعدّل في الـ </span><code>resources</code><span> بتاعتك، يمكن تكون لاحظت إن كل مرة كنت بتعمل </span><code>run</code><span> لأمر </span><code>terraform plan</code><span> أو </span><code>terraform apply</code><span>، </span><code>Terraform</code><span> كان بيقدر يلاقي الـ </span><code>resources</code><span> اللي عملها قبل كده ويعملها </span><code>update</code><span> على الأساس ده.</span></p><p><span>بس إزاي </span><code>Terraform</code><span> كان بيعرف إيه هي الـ </span><code>resources</code><span> اللي المفروض يعملها </span><code>manage</code><span>؟ ممكن يكون عندك كل أنواع الـ </span><code>infrastructure</code><span> في الـ </span><code>AWS account</code><span> بتاعك، معمولها </span><code>deploy</code><span> بطرق مختلفة كتير (شوية </span><code>manually</code><span> بإيدك، وشوية عن طريق </span><code>Terraform</code><span>، وشوية بالـ </span><code>CLI</code><span>). فإزاي </span><code>Terraform</code><span> بيعرف أنهي </span><code>infrastructure</code><span> بالظبط هو مسئول عنها؟</span></p><p><span>في الفصل ده، هنشوف إزاي </span><code>Terraform</code><span> بيعمل </span><code>track</code><span> للـ </span><code>state</code><span> بتاع الـ </span><code>infrastructure</code><span> بتاعتك، وإيه تأثير ده على الـ </span><code>file layout</code><span> والـ </span><code>isolation</code><span> والـ </span><code>locking</code><span> جوه أي </span><code>Terraform project</code><span>.</span></p><p><span>دي أهم النقط اللي هنتكلم عنها:</span></p><ul><li><p><span>إيه هو الـ </span><code>Terraform state</code><span>؟</span></p></li><li><p><span>الـ </span><code>Shared storage</code><span> للـ </span><code>state files</code><span>.</span></p></li><li><p><span>الـ </span><code>Limitations</code><span> أو المشاكل اللي بتقابلنا مع الـ </span><code>backends</code><span> بتاعة </span><code>Terraform</code><span>.</span></p></li><li><p><span>إزاي نعمل </span><code>isolation</code><span> للـ </span><code>state file</code><span>.</span></p></li><li><p><span>الـ </span><code>Isolation</code><span> عن طريق الـ </span><code>workspaces</code><span>.</span></p></li><li><p><span>الـ </span><code>Isolation</code><span> عن طريق الـ </span><code>file layout</code><span>.</span></p></li><li><p><span>الـ </span><code>data source</code><span> اللي اسمه </span><code>terraform_remote_state</code><span>.</span></p></li></ul><h2 id='إيه-هو-الـ-terraform-state'><span>إيه هو الـ </span><code>Terraform State</code><span>؟</span></h2><p><span>كل مرة بتعمل </span><code>run</code><span> لـ </span><code>Terraform</code><span>، هو بيسجل معلومات عن الـ </span><code>infrastructure</code><span> اللي عملها </span><code>create</code><span> في فايل اسمه </span><code>Terraform state file</code><span>.</span></p><p><code>By default</code><span>، لما بتعمل </span><code>run</code><span> لـ </span><code>Terraform</code><span> في فولدر زي </span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0234px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">/foo/bar/Terraform </span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>بيعمل </span><code>create</code><span> لفايل اسمه </span><code>/foo/bar/terraform.tfstate</code><span>. الفايل ده بيبقى فيه </span>
<code>custom JSON format</code><span>، بيسجل </span><code>mapping</code><span> ما بين الـ </span><code>Terraform resources</code><span> اللي في الـ </span><code>configuration files</code><span> بتاعتك، وما بين شكل الـ </span><code>resources</code><span> دي على أرض الواقع.</span></p><p><span>مثلاً، هنقول إن الـ </span><code>Terraform configuration</code><span> بتاعتك فيها الكود ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0235px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_instance"</span> <span class="cm-string">"example"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">ami</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"ami-0fb653ca2d3203ac1"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">instance_type</span> <span class="cm-operator">=</span> <span class="cm-string">"t2.micro"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><span>بعد ما بتعمل </span><code>run</code><span> لأمر </span><code>terraform apply</code><span>، ده جزء صغير من محتويات فايل الـ </span><code>terraform.tfstate</code><span> (طبعاً أنا قصيت منه أجزاء عشان يبقى سهل في القراية):</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="json" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="json"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0234px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string cm-property">"version"</span>: <span class="cm-number">4</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string cm-property">"terraform_version"</span>: <span class="cm-string">"1.2.3"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string cm-property">"serial"</span>: <span class="cm-number">1</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string cm-property">"lineage"</span>: <span class="cm-string">"86545604-7463-4aa5-e9e8-a2a221de98d2"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string cm-property">"outputs"</span>: {},</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string cm-property">"resources"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"mode"</span>: <span class="cm-string">"managed"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"type"</span>: <span class="cm-string">"aws_instance"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"name"</span>: <span class="cm-string">"example"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"provider"</span>: <span class="cm-string">"provider[\"registry.terraform.io/hashicorp/aws\"]"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"instances"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"schema_version"</span>: <span class="cm-number">1</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"attributes"</span>: {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"ami"</span>: <span class="cm-string">"ami-0fb653ca2d3203ac1"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"availability_zone"</span>: <span class="cm-string">"us-east-2b"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"id"</span>: <span class="cm-string">"i-0bc4bbe5b84387543"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"instance_state"</span>: <span class="cm-string">"running"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"instance_type"</span>: <span class="cm-string">"t2.micro"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"(...)"</span>: <span class="cm-string">"(truncated)"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  ]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  ]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 627px;"></div><div class="CodeMirror-gutters" style="display: none; height: 627px;"></div></div></div></pre><p><span>باستخدام الـ </span><code>JSON format</code><span> ده، </span><code>Terraform</code><span> بيبقى عارف إن الـ </span><code>resource</code><span> اللي الـ </span><code>type</code><span> بتاعه </span><code>aws_instance</code><span> والـ </span><code>name</code><span> بتاعه </span><code>example</code><span>، بيمثل </span><code>EC2 Instance</code><span> موجودة في الـ </span><code>AWS account</code><span> بتاعك والـ </span><code>ID</code><span> بتاعها هو </span><code>i-0bc4bbe5b84387543</code><span>.</span></p><p><span>كل مرة بتعمل </span><code>run</code><span> لـ </span><code>Terraform</code><span>، هو بيقدر يجيب آخر </span><code>status</code><span> للـ </span><code>EC2 Instance</code><span> دي من </span><code>AWS</code><span> ويقارنها باللي مكتوب في الـ </span><code>Terraform configurations</code><span> بتاعتك، عشان يحدد إيه التغييرات اللي محتاجة تتعمل </span><code>apply</code><span>.</span></p><p><span>بمعنى تاني، الـ </span><code>output</code><span> اللي بيطلع من أمر </span><code>plan</code><span> هو عبارة عن </span><code>diff</code><span> ما بين الكود اللي عندك على الجهاز والـ </span><code>infrastructure</code><span> اللي معمولها </span><code>deploy</code><span> على أرض الواقع، وده بيعرفه عن طريق الـ </span><code>IDs</code><span> اللي متسجلة في الـ </span><code>state file</code><span>.</span></p><div class="md-alert md-alert-tip tip"><p><span class='md-alert-text md-alert-text-tip'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>Tip</span><br></p><h3 id='الـ-state-file-ده-private-api'><strong><span>الـ </span><code>State File</code><span> ده </span><code>Private API</code></strong></h3><p><strong><span>نقطة مهمة جداً:</span></strong><span> الـ </span><code>format</code><span> بتاع الـ </span><code>state file</code><span> هو عبارة عن </span><code>private API</code><span>، وده معمول بس للـ </span><code>internal use</code><span> جوه </span><code>Terraform</code><span> نفسه. المفروض عمرك ما تعدّل في الـ </span><code>Terraform state files</code><span> دي بإيدك، ولا تكتب كود بيقرأها </span><code>directly</code><span>.</span></p><p><span>لو لأي سبب احتاجت تعمل </span><code>manipulate</code><span> للـ </span><code>state file</code><span> — ودي حاجة المفروض تحصل نادر جداً — يبقى لازم تستخدم الـ </span><code>commands</code><span> المخصصة لكده زي </span><code>terraform import</code><span> أو </span><code>terraform state</code><span> (وهنشوف أمثلة على الاتنين دول في </span><code>Chapter 5</code><span>).</span></p></div><p><span>لو بتستخدم </span><code>Terraform</code><span> في </span><code>personal project</code><span>، ففكرة إنك تخزن الـ </span><code>state</code><span> في </span><code>terraform.tfstate file</code><span> واحد بس على جهازك لوكال شغالة وزي الفل. لكن لو هتستخدم </span><code>Terraform</code><span> كـ </span><code>team</code><span> على </span><code>product</code><span> حقيقي، هتبدأ تقابلك كذا مشكلة:</span></p><ul><li><p><strong><code>Shared storage</code><span> للـ </span><code>state files</code></strong><span></span><br/><span>عشان تقدروا كـ </span><code>team</code><span> تستخدموا </span><code>Terraform</code><span> وتعملوا </span><code>update</code><span> للـ </span><code>infrastructure</code><span>، كل واحد فيكم لازم يكون عنده </span><code>access</code><span> على نفس الـ </span><code>Terraform state files</code><span>. ده معناه إنكم محتاجين تخزنوا الفايلات دي في مكان </span><code>shared</code><span>.</span></p></li><li><p><strong><code>Locking</code><span> للـ </span><code>state files</code></strong><span></span><br/><span>أول ما الداتا دي بتبقى </span><code>shared</code><span>، بتظهرلك مشكلة جديدة على طول: الـ </span><code>locking</code><span>. من غير </span><code>locking</code><span>، لو اتنين في الـ </span><code>team</code><span> بيعملوا </span><code>run</code><span> لـ </span><code>Terraform</code><span> في نفس الوقت، ممكن يحصل </span><code>race conditions</code><span>. ده بيحصل لما كذا </span><code>Terraform process</code><span> بيحاولوا يعملوا </span><code>concurrent updates</code><span> على</span>
<span> الـ </span><code>state files</code><span>، وده بيؤدي لـ </span><code>conflicts</code><span>، و </span><code>data loss</code><span>، وممكن يبوظ الـ </span><code>state file</code><span> خالص (</span><code>corruption</code><span>).</span></p></li><li><p><strong><code>Isolation</code><span> للـ </span><code>state files</code></strong><span></span><br/><span>لما تيجي تعمل تغييرات في الـ </span><code>infrastructure</code><span> بتاعتك، من الـ </span><code>best practices</code><span> إنك تعمل </span><code>isolate</code><span> للـ </span><code>environments</code><span> المختلفة عن بعض. مثلاً، لما بتعمل تغيير في </span><code>environment</code><span> زي الـ </span><code>testing</code><span> أو الـ </span><code>staging</code><span>، لازم تبقى متأكد 100% إنك مستحيل تبوظ الـ </span><code>production</code><span> بالغلط. طيب إزاي هتقدر تعمل </span><code>isolate</code><span> للتغييرات دي لو الـ </span><code>infrastructure</code><span> بتاعتك كلها متعرفة في نفس الـ </span><code>Terraform state file</code><span>؟</span></p></li></ul><p><span>في الأجزاء اللي جاية، هنتكلم بالتفصيل عن كل مشكلة من دول وهنشوف إزاي نحلها.</span></p><h2 id='الـ-shared-storage-للـ-state-files'><strong><span>الـ </span><code>Shared Storage</code><span> للـ </span><code>State Files</code></strong></h2><p><span>أكتر تكنيك مشهور عشان تخلي كذا </span><code>team member</code><span> يعملوا </span><code>access</code><span> على مجموعة فايلات مشتركة هو إنهم يحطوها في </span><code>version control</code><span> (زي </span><code>Git</code><span> مثلاً). مع إنك أكيد لازم تخزن الـ </span><code>Terraform code</code><span> بتاعك في </span><code>version control</code><span>، إلا إن فكرة تخزين الـ </span><code>Terraform state</code><span> نفسه في الـ </span><code>version control</code><span> دي فكرة سيئة جداً، وده للأسباب دي:</span></p><ul><li><p><strong><code>Manual error</code><span> (الغلطات اليدوية)</span></strong><span></span><br/><span>سهل جداً إنك تنسى تعمل </span><code>pull</code><span> لآخر </span><code>changes</code><span> من الـ </span><code>version control</code><span> قبل ما تعمل </span><code>run</code>
<span> لـ </span><code>Terraform</code><span>، أو تنسى تعمل </span><code>push</code><span> لآخر </span><code>changes</code><span> عملتها بعد ما تخلص. هي مسألة وقت مش أكتر قبل ما تلاقي حد في الـ </span><code>team</code><span> بتاعك عمل </span><code>run</code><span> لـ </span><code>Terraform</code><span> وهو معاه </span><code>state files</code><span> قديمة (</span><code>out-of-date</code><span>)، ونتيجة لكده، هيبوظ الشغل بالغلط، يا إما هيرجع </span><code>deployment</code><span> قديم (</span><code>roll back</code><span>)، أو هيكرر </span><code>deployment</code><span> كان معمول قبل كده (</span><code>duplicate</code><span>).</span></p></li><li><p><strong><code>Locking</code></strong><span></span><br/><span>أغلب الـ </span><code>version control systems</code><span> مفيهاش أي نوع من أنواع الـ </span><code>locking</code><span> اللي يمنع اتنين </span><code>team members</code><span> إنهم يعملوا </span><code>run</code><span> لـ </span><code>terraform apply</code><span> على نفس الـ </span><code>state file</code><span> في نفس الوقت.</span></p></li><li><p><strong><code>Secrets</code></strong><span></span><br/><span>كل الداتا اللي في الـ </span><code>Terraform state files</code><span> بتتخزن </span><code>plain text</code><span> (نص صريح). ودي مشكلة لإن فيه </span><code>Terraform resources</code><span> معينة بتحتاج تخزن داتا حساسة. مثلاً، لو استخدمت الـ </span><code>aws_db_instance</code><span>  عشان تعمل </span><code>database</code><span>، </span><code>Terraform</code><span> هيخزن الـ </span><code>username</code><span> والـ </span><code>password</code><span> بتوع الداتابيز في الـ </span><code>state file</code><span> كـ </span><code>plain text</code><span>، وطبعاً مينفعش أبداً تخزن </span><code>secrets</code><span> بالشكل ده في </span><code>version control</code><span>.</span></p></li></ul><p><span>بدل ما نستخدم </span><code>version control</code><span>، أحسن طريقة نعمل بيها </span><code>manage</code><span> للـ </span><code>shared storage</code><span> بتاع الـ </span><code>state files</code><span> هي إننا نستخدم الدعم الـ </span><code>built-in</code><span> اللي </span><code>Terraform</code><span> بيقدمه لحاجة اسمها </span><strong><code>remote backends</code></strong><span>.</span></p><hr /><hr /><p>&nbsp;</p><p><span>الـ </span><code>Terraform backend</code><span> هو اللي بيحدد الطريقة اللي </span><code>Terraform</code><span> بيعمل بيها </span><code>load</code><span> و </span><code>store</code><span> للـ </span><code>state</code><span>. الـ </span><code>backend</code><span> الـ </span><code>default</code><span>، اللي إنت شغال بيه طول الوقت ده، هو الـ </span><code>local backend</code><span>، وده بيخزن الـ </span><code>state file</code><span> على الـ </span><code>local disk</code><span> بتاعك. أما الـ </span><code>Remote backends</code><span> بتخليك تخزن الـ </span><code>state file</code><span> في مكان </span><code>remote</code><span> و </span><code>shared</code><span>. فيه </span><code>backends</code><span> كتير مدعومة زي </span><code>Amazon S3</code><span>, </span><code>Azure Storage</code><span>, </span><code>Google Cloud Storage</code><span>، وخدمات </span><code>HashiCorp</code><span> زي </span><code>Terraform Cloud</code><span> و </span><code>Terraform Enterprise</code><span>.</span></p><p><span>الـ </span><code>Remote backends</code><span> بتحل التلات مشاكل اللي لسه قايلينهم:</span></p><ol start='' ><li><p><strong><code>Manual error</code><span>:</span></strong><span> أول ما بتظبط الـ </span><code>remote backend</code><span>، </span><code>Terraform</code><span> أوتوماتيك هيعمل </span><code>load</code><span> للـ </span><code>state file</code><span> من الـ </span><code>backend</code><span> ده كل مرة تعمل فيها </span><code>plan</code><span> أو </span><code>apply</code><span>، وهيعمل </span><code>store</code><span> للفايل أوتوماتيك بعد كل </span><code>apply</code><span>. فبكده مفيش أي فرصة للغلط اليدوي.</span></p></li><li><p><strong><code>Locking</code><span>:</span></strong><span> أغلب الـ </span><code>remote backends</code><span> بتدعم الـ </span><code>locking</code><span> بشكل </span><code>native</code><span>. عشان تعمل </span><code>run</code><span> لـ </span><code>terraform apply</code><span>،  هيحاول ياخد </span><code>lock</code><span> بشكل أوتوماتيكي. لو فيه حد تاني بيعمل </span><code>apply</code><span> في نفس الوقت، هيكون هو واخد الـ </span><code>lock</code><span> قبلك، وإنت هتضطر تستنى. ممكن تعمل </span><code>run</code><span> للأمر مع </span><code>parameter</code><span> زيادة اسمه </span><code>-lock-timeout=&lt;TIME&gt;</code><span> عشان تقول لـ </span><code>Terraform</code><span> يستنى لحد وقت معين (مثلاً </span><code>-lock-timeout=10m</code><span> هيخليه يستنى 10 دقايق).</span></p></li><li><p><strong><code>Secrets</code><span>:</span></strong><span> أغلب الـ </span><code>remote backends</code><span> بتدعم </span><code>encryption in transit</code><span> و </span><code>encryption at rest</code><span> للـ </span><code>state file</code><span>. والأهم من كده، الـ </span><code>backends</code><span> دي بتديك طرق تظبط بيها صلاحيات الـ </span><code>access</code><span> (مثلاً باستخدام </span><code>IAM policies</code><span> مع </span><code>Amazon S3 bucket</code><span>)، فتقدر تتحكم مين يقدر يوصل للـ </span><code>state files</code><span> بتاعتك وللـ </span><code>secrets</code><span> اللي ممكن تكون جواها. كان هيبقى أفضل لو </span><code>Terraform</code><span> نفسه بيدعم تشفير الـ </span><code>secrets</code><span> جوه الـ </span><code>state file</code><span>، لكن الـ </span><code>remote backends</code><span> بتقلل أغلب المخاوف الأمنية دي، على الأقل الـ </span><code>state file</code><span> مش متخزن </span><code>plain text</code><span> على أي جهاز.</span></p></li></ol><div class="md-alert md-alert-note note"><p><span class='md-alert-text md-alert-text-note'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</span><br></p><p>&nbsp;</p><h3 id='encryption-in-transit-التشفير-وقت-النقل'><strong><span>Encryption in Transit (التشفير وقت النقل)</span></strong></h3><p><span>دي ببساطة معناها إن الداتا وهي بتتبعت من جهازك لـ </span><code>AWS</code><span> (مثلاً لما بتعمل </span><code>apply</code><span>)، بتكون متشفرة وهي ماشية في السكة على الإنترنت.</span></p><p><strong><span>الفايدة:</span></strong><span> لو فيه هكر في النص بيحاول يتصنت على الـ </span><code>network traffic</code><span>، هيشوف داتا متشفرة ومش هيفهم منها أي حاجة. ده بيحصل ببروتوكول </span><code>TLS</code><span> (اللي هو بتاع </span><code>HTTPS</code><span>).</span></p><hr /><h3 id='encryption-at-rest-التشغفير-وقت-التخزين'><strong><span>Encryption at Rest (التشغفير وقت التخزين)</span></strong></h3><p><span>دي معناها إن الداتا بعد ما وصلت خلاص عند </span><code>AWS</code><span> واتخزنت على الهاردات بتاعتهم (في الـ </span><code>S3 bucket</code><span> مثلاً)، بتفضل متشفرة وهي متخزنة.</span></p><p><strong><span>الفايدة:</span></strong><span> لو حصل واخترقوا الداتا سنتر بتاع أمازون نفسه وسرقوا الهارد ديسك اللي عليه الـ </span><code>state file</code><span> بتاعك، مش هيعرفوا يفتحوه أو يقروا اللي جواه لأنه متخزن وهو متشفر.</span></p></div><p>&nbsp;</p><p><span>لو بتستخدم </span><code>Terraform</code><span> مع </span><code>AWS</code><span>، يبقى </span><code>Amazon S3 (Simple Storage Service)</code><span> — اللي هو خدمة تخزين الملفات الـ </span><code>managed</code><span> من أمازون — هو غالباً أحسن اختيار ليك كـ </span><code>remote backend</code><span> للأسباب دي:</span></p><ul><li><p><strong><span>خدمة </span><code>managed</code><span>:</span></strong><span> فانت مش محتاج تعمل </span><code>deploy</code><span> أو تدير أي </span><code>infrastructure</code><span> زيادة عشان تستخدمها.</span></p></li><li><p><strong><span>متصممة عشان تبقى متينة ومتاحة:</span></strong><span> متصممة بنسبة </span><code>durability</code><span> 99.999999999% و </span><code>availability</code><span> 99.99%، وده معناه إنك مش محتاج تقلق خالص على إن الداتا تضيع أو الخدمة تقع.</span></p></li><li><p><strong><span>بتدعم الـ </span><code>encryption</code><span>:</span></strong><span> وده بيقلل القلق من تخزين أي </span><code>sensitive data</code><span> في الـ </span><code>state files</code><span>. طبعاً لازم تفضل حريص جداً مين في الـ </span><code>team</code><span> بتاعك يقدر يعمل </span><code>access</code><span> على الـ </span><code>S3 bucket</code><span>، بس على الأقل الداتا هتبقى </span><code>encrypted at rest</code><span> (أمازون S3 بيدعم </span><code>server-side encryption</code><span> باستخدام </span><code>AES-256</code><span>) و </span><code>in transit</code><span> (تيرافورم بيستخدم </span><code>TLS</code><span> وهو بيكلم </span><code>Amazon S3</code><span>).</span></p></li><li><p><strong><span>بتدعم الـ </span><code>locking</code><span> عن طريق </span><code>DynamoDB</code><span>:</span></strong><span> (هنتكلم في دي أكتر بعدين).</span></p></li><li><p><strong><span>بتدعم الـ </span><code>versioning</code><span>:</span></strong><span> فكل نسخة من الـ </span><code>state file</code><span> بتاعك بتفضل متخزنة، وتقدر ترجع لأي نسخة قديمة لو حصلت مشكلة.</span></p></li><li><p><strong><span>رخيصة جداً:</span></strong><span> أغلب استخدامات </span><code>Terraform</code><span> بتدخل بسهولة ضمن الـ </span><code>AWS Free Tier</code><span>.</span></p></li></ul><p><span>عشان تفعّل الـ </span><code>remote state storage</code><span> مع </span><code>Amazon S3</code><span>، أول خطوة هي إنك تعمل </span><code>create</code><span> لـ </span><code>S3 bucket</code><span>.</span></p><p><span>اعمل فايل </span><code>main.tf</code><span> في فولدر جديد (لازم يكون فولدر مختلف عن اللي خزنت فيه الـ </span><code>configurations</code><span> بتاعة </span><code>Chapter 2</code><span>)، وفي أول الفايل، حدد </span><code>AWS</code><span> كـ </span><code>provider</code><span> بتاعك:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">provider</span> <span class="cm-string">"aws"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">region</span> <span class="cm-operator">=</span> <span class="cm-string">"us-east-2"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 67px;"></div><div class="CodeMirror-gutters" style="display: none; height: 67px;"></div></div></div></pre><p><span>بعد كده، اعمل </span><code>create</code><span> لـ </span><code>S3 bucket</code><span> بإنك تستخدم الـ </span><code>resource</code><span> اللي اسمه </span><code>aws_s3_bucket</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_s3_bucket"</span> <span class="cm-string">"terraform_state"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">bucket</span> <span class="cm-operator">=</span> <span class="cm-string">"terraform-up-and-running-state"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># to prevent remove s3 by mistake</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">lifecycle</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">prevent_destroy</span> <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 179px;"></div><div class="CodeMirror-gutters" style="display: none; height: 179px;"></div></div></div></pre><p><span>الكود ده بيظبط الـ </span><code>arguments</code><span> دي:</span></p><ul><li><p><strong><code>bucket</code></strong><span></span><br/><span>ده اسم الـ </span><code>S3 bucket</code><span>. خد بالك إن أسماء الـ </span><code>S3 buckets</code><span> لازم تكون </span><code>globally unique</code><span> على مستوى كل عملاء </span><code>AWS</code><span>. عشان كده، هتحتاج تغير قيمة الـ </span><code>bucket</code><span> من </span><code>&quot;terraform-up-and-running-state&quot;</code><span> (اللي أنا خلاص عملتله </span><code>create</code><span>) لاسم خاص بيك إنت. اتأكد إنك فاكر الاسم ده والـ </span><code>AWS region</code><span> اللي بتستخدمه عشان هتحتاج المعلومتين دول تاني كمان شوية.</span></p></li></ul><div class="md-alert md-alert-note note"><p><span class='md-alert-text md-alert-text-note'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</span><br></p><p><span>سهل على نفسك واستخدام </span><code>resource</code><span> من نوع </span><code>random_string</code><span> بيطلع نص عشوائي</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.63019px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"random_string"</span> <span class="cm-string">"random"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">length</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-number">8</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">special</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-keyword">false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">upper</span> <span class="cm-tab" role="presentation" cm-text="	">  </span> &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-keyword">false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.63019px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_s3_bucket"</span> <span class="cm-string">"terraform_state"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">bucket</span> <span class="cm-operator">=</span> <span class="cm-string">"terraform-up-and-running-state-${random}"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># to prevent remove s3 by mistake</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">lifecycle</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">prevent_destroy</span> <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 179px;"></div><div class="CodeMirror-gutters" style="display: none; height: 179px;"></div></div></div></pre><p>&nbsp;</p></div><p>&nbsp;</p><ul><li><p><strong><code>prevent_destroy</code></strong><span></span><br/><span>دي تاني </span><code>lifecycle setting</code><span> تشوفها (الأولى كانت </span><code>create_before_destroy</code><span> في </span><code>Chapter 2</code><span>). لما بتخلي </span><code>prevent_destroy</code><span> بـ </span><code>true</code><span> على أي </span><code>resource</code><span>، أي محاولة إنك تمسح الـ </span><code>resource</code><span> ده (مثلاً لو عملت </span><code>run</code><span> لـ </span><code>terraform destroy</code><span>) هتخلي </span><code>Terraform</code><span> يقف ويطلع </span><code>error</code><span>. دي طريقة كويسة جداً عشان تمنع إنك تمسح </span><code>resource</code><span> مهم بالغلط، زي الـ </span><code>S3 bucket</code><span> ده بالذات اللي هيخزن كل الـ </span><code>Terraform state</code><span> بتاعك. وطبعاً لو عايز تمسحه بجد، كل اللي هتعمله إنك تعمل </span><code>comment out</code><span> للـ </span><code>setting</code><span> دي أو تشيلها.</span></p></li></ul><p><span>دلوقتي، خلينا نزود كذا طبقة حماية إضافية على الـ </span><code>S3 bucket</code><span> ده.</span></p><p><strong><span>أولاً</span></strong><span>، استخدم الـ </span><code>resource</code><span> اللي اسمه </span><code>aws_s3_bucket_versioning</code><span> عشان تفعّل الـ </span><code>versioning</code><span> على الـ </span><code>S3 bucket</code><span>. بكده، كل </span><code>update</code><span> بيحصل على أي فايل في الـ </span><code>bucket</code><span> هيعمل </span><code>version</code><span> جديدة من الفايل ده. ده بيخليك تقدر تشوف الـ </span><code>versions</code><span> القديمة وترجعلها في أي وقت، ودي آلية رجوع (</span><code>fallback mechanism</code><span>) ممتازة لو حاجة باظت.</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_s3_bucket_versioning"</span> <span class="cm-string">"enabled"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">bucket</span> <span class="cm-operator">=</span> <span class="cm-variable">aws_s3_bucket</span><span class="cm-operator">.</span><span class="cm-property">terraform_state</span><span class="cm-operator">.</span><span class="cm-property">id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">versioning_configuration</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">status</span> <span class="cm-operator">=</span> <span class="cm-string">"Enabled"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 157px;"></div><div class="CodeMirror-gutters" style="display: none; height: 157px;"></div></div></div></pre><p><strong><span>ثانياً</span></strong><span>، استخدم الـ </span><code>resource</code><span> اللي اسمه </span><code>aws_s3_bucket_server_side_encryption_configuration</code><span> عشان تشغل الـ </span><code>server-side encryption</code><span> بشكل </span><code>default</code><span> على أي داتا بتتكتب في الـ </span><code>S3 bucket</code><span> ده. ده بيضمن إن الـ </span><code>state files</code><span> بتاعتك، وأي </span><code>secrets</code><span> جواها، تكون دايماً </span><code>encrypted</code><span> على الـ </span><code>disk</code><span> وهي متخزنة في </span><code>S3</code><span>.</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># تفعيل الـ server-side encryption بشكل default</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_s3_bucket_server_side_encryption_configuration"</span> <span class="cm-string">"default"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">bucket</span> <span class="cm-operator">=</span> <span class="cm-variable">aws_s3_bucket</span><span class="cm-operator">.</span><span class="cm-property">terraform_state</span><span class="cm-operator">.</span><span class="cm-property">id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">rule</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">apply_server_side_encryption_by_default</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">sse_algorithm</span> <span class="cm-operator">=</span> <span class="cm-string">"AES256"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 224px;"></div><div class="CodeMirror-gutters" style="display: none; height: 224px;"></div></div></div></pre><p><strong><span>ثالثاً</span></strong><span>، استخدم الـ </span><code>resource</code><span> اللي اسمه </span><code>aws_s3_bucket_public_access_block</code><span> عشان تعمل </span><code>block</code><span> لكل الـ </span><code>public access</code><span> على الـ </span><code>S3 bucket</code><span> ده. الـ </span><code>S3 buckets</code><span> أصلاً بتبقى </span><code>private</code><span> كـ </span><code>default</code><span>، بس عشان هي كتير بتُستخدم في تقديم </span><code>static content</code><span> — زي الصور والفونتات وملفات </span><code>CSS</code><span>, </span><code>JS</code><span>, </span><code>HTML</code><span> — فممكن، وسهل كمان، إنها تتعمل </span><code>public</code><span>. وبما إن الـ </span><code>Terraform state files</code><span> بتاعتك ممكن يكون فيها </span><code>sensitive data</code><span> و </span><code>secrets</code><span>، فمهم جداً إننا نزود طبقة الحماية الزيادة دي عشان نضمن إن مفيش حد في الـ </span><code>team</code><span> بتاعك يقدر بالغلط يخلي الـ </span><code>S3 bucket</code><span> ده </span><code>public</code><span>.</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0236px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># اعمل Block لكل الـ public access على الـ S3 bucket بشكل صريح</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_s3_bucket_public_access_block"</span> <span class="cm-string">"public_access"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">bucket</span> <span class="cm-operator">=</span> <span class="cm-variable">aws_s3_bucket</span><span class="cm-operator">.</span><span class="cm-property">terraform_state</span><span class="cm-operator">.</span><span class="cm-property">id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">block_public_acls</span> &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">block_public_policy</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">ignore_public_acls</span> &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">restrict_public_buckets</span> <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 202px;"></div><div class="CodeMirror-gutters" style="display: none; height: 202px;"></div></div></div></pre><p><span>بعد كده، محتاج تعمل </span><code>create</code><span> لـ </span><code>DynamoDB table</code><span> عشان نستخدمها في الـ </span><code>locking</code><span>. </span><code>DynamoDB</code><span> هي خدمة الـ </span><code>key-value store</code><span>  من أمازون. هي بتدعم </span><code>strongly consistent reads</code><span> و </span><code>conditional writes</code><span>، ودي كل المكونات اللي إنت محتاجها عشان تعمل </span><code>distributed lock system</code><span>. والأهم من كده، هي </span><code>completely managed</code><span>، فانت مش محتاج تشغل أي </span><code>infrastructure</code><span> بنفسك، وكمان رخيصة، وأغلب استخدامات </span><code>Terraform</code><span> بتدخل بسهولة ضمن الـ </span><code>AWS Free Tier</code><span>.</span></p><p><span>عشان تستخدم </span><code>DynamoDB</code><span> للـ </span><code>locking</code><span> مع </span><code>Terraform</code><span>، لازم تعمل </span><code>create</code><span> لـ </span><code>DynamoDB table</code><span> يكون ليها </span><code>primary key</code><span> اسمه </span><code>LockID</code><span> (بنفس الـ </span><code>spelling</code><span> والـ </span><code>capitalization</code><span> بالظبط). ممكن تعمل </span><code>table</code><span> زي دي باستخدام الـ </span><code>resource</code><span> اللي اسمه </span><code>aws_dynamodb_table</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0236px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_dynamodb_table"</span> <span class="cm-string">"terraform_locks"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">name</span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"terraform-up-and-running-locks"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">billing_mode</span> <span class="cm-operator">=</span> <span class="cm-string">"PAY_PER_REQUEST"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">hash_key</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"LockID"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">attribute</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-string">"LockID"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">type</span> <span class="cm-operator">=</span> <span class="cm-string">"S"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 224px;"></div><div class="CodeMirror-gutters" style="display: none; height: 224px;"></div></div></div></pre><p><span>اعمل </span><code>run</code><span> لأمر </span><code>terraform init</code><span> عشان ينزل الـ </span><code>provider code</code><span>، وبعدين اعمل </span><code>run</code><span> لـ </span><code>terraform apply</code><span> عشان تعمل </span><code>deploy</code><span>. بعد ما كل حاجة تتعملها </span><code>deploy</code><span>، هيبقى عندك </span><code>S3 bucket</code><span> و </span><code>DynamoDB table</code><span>، بس الـ </span><code>Terraform state</code><span> بتاعك هيفضل لسه متخزن </span><code>locally</code><span>.</span></p><div class="md-alert md-alert-important important"><p><span class='md-alert-text md-alert-text-important'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Important</span><br></p><p><span>بفضل دايما تعمل دا في folder اللي هو انشاء remote backend يكون فى folder منفصل وبعدها المشروع الرئيسي بتاعك تاخد من النواتج تستخدمها فيه هتعرف ليه قدام مينفعش تستخدمهم مع بعض</span>
<span>اعمل دا فى folder و اللي جي folder عشان تعرف تعمل destroy للاثنين بسهوله </span></p></div><p>&nbsp;</p><p><span>عشان تخلي </span><code>Terraform</code><span> يخزن الـ </span><code>state</code><span> في الـ </span><code>S3 bucket</code><span> بتاعك (مع الـ </span><code>encryption</code><span> والـ </span><code>locking</code><span>)، محتاج تضيف </span><code>backend configuration</code><span> للكود بتاعك. الـ </span><code>configuration</code><span> دي خاصة بـ </span><code>Terraform</code><span> نفسه، وعشان كده بتتكتب جوه </span><code>terraform block</code><span> وليها الـ </span><code>syntax</code><span> ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">terraform</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">backend</span> <span class="cm-string">"&lt;BACKEND_NAME&gt;"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  [<span class="cm-tag">CONFIG</span><span class="cm-operator">...</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p><span>هنا </span><code>&lt;BACKEND_NAME&gt;</code><span> هو اسم الـ </span><code>backend</code><span> اللي عايز تستخدمه (مثلاً </span><code>&quot;s3&quot;</code><span>) دا عشان انت بتستخدام s3 الاسم مش بتغيره على مزاجك لا s3 يبقى terraform فهم انك بتستخدام s3 في انواع ثاني azurerm و gcs وفيه برده local  دا الوضع الافتراضي ممكن تستخدمه جو شركة بيحيث يكون على nfs وعادي جدا تعمله lock ويكون عبارة عن ملف بس ده مش وقته نكلم فيه، والـ </span><code>CONFIG</code><span> هي </span><code>arguments</code><span> خاصة بالـ </span><code>backend</code><span> ده (زي اسم الـ </span><code>S3 bucket</code><span> اللي هتستخدمه).</span></p><p><span>ده شكل الـ </span><code>backend configuration</code><span> لـ </span><code>S3 bucket</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0236px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">terraform</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">backend</span> <span class="cm-string">"s3"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">bucket</span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"terraform-up-and-running-state"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">key</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"global/s3/terraform.tfstate"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">region</span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"us-east-2"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">dynamodb_table</span> <span class="cm-operator">=</span> <span class="cm-string">"terraform-up-and-running-locks"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">encrypt</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 246px;"></div><div class="CodeMirror-gutters" style="display: none; height: 246px;"></div></div></div></pre><p><span>خلينا نعدي على الـ </span><code>settings</code><span> دي واحدة واحدة:</span></p><ul><li><p><strong><code>bucket</code></strong><span></span><br/><span>اسم الـ </span><code>S3 bucket</code><span> اللي هتستخدمه. اتأكد إنك تغيره لاسم الـ </span><code>S3 bucket</code><span> اللي إنت عملته من شوية.</span></p></li><li><p><strong><code>key</code></strong><span></span><br/><span> </span><code>filepath</code><span> جوه الـ </span><code>S3 bucket</code><span> اللي هيتكتب فيه الـ </span><code>Terraform state file</code><span>. هتشوف كمان شوية ليه الكود اللي في المثال بيحطه بالقيمة </span><code>global/s3/terraform.tfstate</code><span>.</span></p></li><li><p><strong><code>region</code></strong><span></span><br/><span>الـ </span><code>AWS region</code><span> اللي الـ </span><code>S3 bucket</code><span> بتاعك موجود فيه. اتأكد إنك تغيره للـ </span><code>region</code><span> بتاع الـ </span><code>S3 bucket</code><span> اللي عملته.</span></p></li><li><p><strong><code>dynamodb_table</code></strong><span></span><br/><span>الـ </span><code>DynamoDB table</code><span> اللي هتستخدمها للـ </span><code>locking</code><span>. اتأكد إنك تغيرها لاسم الـ </span><code>DynamoDB table</code><span> اللي عملتها من شوية.</span></p></li><li><p><strong><code>encrypt</code></strong><span></span><br/><span>لما تخلي دي بـ </span><code>true</code><span>، ده بيضمن إن الـ </span><code>Terraform state</code><span> بتاعك هيبقى </span><code>encrypted</code><span> على الـ </span><code>disk</code><span> وهو متخزن في </span><code>S3</code><span>. إحنا أصلاً فعلنا الـ </span><code>default encryption</code><span> في الـ </span><code>S3 bucket</code><span> نفسه، فدي تعتبر طبقة حماية تانية عشان نضمن إن الداتا دايماً </span><code>encrypted</code><span>.</span></p></li></ul><p><span>عشان تدي أمر لـ </span><code>Terraform</code><span> إنه يخزن الـ </span><code>state file</code><span> بتاعك في الـ </span><code>S3 bucket</code><span> ده، هتستخدم أمر </span><code>terraform init</code><span> تاني. الأمر ده مش بس بينزل الـ </span><code>provider code</code><span>، ده كمان بيعمل </span><code>configure</code><span> للـ </span><code>Terraform backend</code><span> بتاعك (وهتشوفله استخدام تالت كمان بعدين). والأهم من كده، إن الـ </span><code>init command</code><span> ده </span><code>idempotent</code><span>، يعني آمن إنك تشغله أكتر من مرة.</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$ terraform</span> init</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Initializing the backend...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Acquiring state lock. This may take a few moments...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Do you want to copy existing state to the new backend?</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  Pre-existing state was found <span class="cm-keyword">while</span> migrating the previous <span class="cm-string">"local"</span> backend</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  to the newly configured <span class="cm-string">"s3"</span> backend. No existing state was found <span class="cm-keyword">in</span> the</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  newly configured <span class="cm-string">"s3"</span> backend. Do you want to copy this state to the new</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string">"s3"</span> backend? Enter <span class="cm-string">"yes"</span> to copy and <span class="cm-string">"no"</span> to <span class="cm-builtin">start</span> with an empty state.</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  Enter a value:</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 246px;"></div><div class="CodeMirror-gutters" style="display: none; height: 246px;"></div></div></div></pre><p><code>Terraform</code><span> هيلاحظ أوتوماتيك إنك أصلاً عندك </span><code>state file</code><span> موجود </span><code>locally</code><span>، وهيسألك إذا كنت عايز تنسخه للـ </span><code>S3 backend</code><span> الجديد. لو كتبت </span><code>yes</code><span>، المفروض هتشوف الكلام ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Successfully configured the backend <span class="cm-string">"s3"</span>! Terraform will automatically</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">use this backend unless the backend configuration changes.</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="display: none; height: 45px;"></div></div></div></pre><p><span>بعد ما تشغل الأمر ده، الـ </span><code>Terraform state</code><span> بتاعك هيتخزن في الـ </span><code>S3 bucket</code><span>. تقدر تتأكد من ده بإنك تروح على الـ </span><code>S3 Management Console</code><span> في الـ </span><code>browser</code><span> بتاعك وتدوس على الـ </span><code>bucket</code><span> بتاعك. المفروض هتشوف حاجة شبه </span><code>Figure 3-1</code><span>.</span></p><p><img src="imgs/image-20250703162226812.png" referrerpolicy="no-referrer" alt="image-20250703162226812"></p><p><img src="imgs/image-20250703162256269.png" referrerpolicy="no-referrer" alt="image-20250703162256269"></p><p><span>لما الـ </span><code>backend</code><span> ده بيبقى </span><code>enabled</code><span>، </span><code>Terraform</code><span> هيعمل </span><code>pull</code><span> لأحدث </span><code>state</code><span> من الـ </span><code>S3 bucket</code><span> ده بشكل أوتوماتيكي قبل ما يشغل أي </span><code>command</code><span>، وهيعمل </span><code>push</code><span> لأحدث </span><code>state</code><span> للـ </span><code>S3 bucket</code><span> برضه بشكل أوتوماتيكي بعد ما الـ </span><code>command</code><span> يخلص.</span></p><p><span>عشان تشوف ده وهو بيحصل، ضيف الـ </span><code>output variables</code><span> دي:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"s3_bucket_arn"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">aws_s3_bucket</span><span class="cm-operator">.</span><span class="cm-property">terraform_state</span><span class="cm-operator">.</span><span class="cm-property">arn</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"The ARN of the S3 bucket"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"dynamodb_table_name"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">aws_dynamodb_table</span><span class="cm-operator">.</span><span class="cm-property">terraform_locks</span><span class="cm-operator">.</span><span class="cm-property">name</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"The name of the DynamoDB table"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 202px;"></div><div class="CodeMirror-gutters" style="display: none; height: 202px;"></div></div></div></pre><p><span>الـ </span><code>variables</code><span> دي هتطبع الـ </span><code>Amazon Resource Name (ARN)</code><span> بتاع الـ </span><code>S3 bucket</code><span> بتاعك، واسم الـ </span><code>DynamoDB table</code><span> بتاعتك. اعمل </span><code>run</code><span> لـ </span><code>terraform apply</code><span> عشان تشوف النتيجة:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$ terraform</span> apply</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(...)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Acquiring state lock. This may take a few moments...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">aws_dynamodb_table.terraform_locks: Refreshing state...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">aws_s3_bucket.terraform_state: Refreshing state...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Apply complete! Resources: <span class="cm-number">0</span> added, <span class="cm-number">0</span> changed, <span class="cm-number">0</span> destroyed.</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Releasing state lock. This may take a few moments...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Outputs:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">dynamodb_table_name <span class="cm-operator">=</span> <span class="cm-string">"terraform-up-and-running-locks"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">s3_bucket_arn <span class="cm-operator">=</span> <span class="cm-string">"arn:aws:s3:::terraform-up-and-running-state"</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 291px;"></div><div class="CodeMirror-gutters" style="display: none; height: 291px;"></div></div></div></pre><p><span>لاحظ إزاي </span><code>Terraform</code><span> دلوقتي بقى بياخد </span><code>lock</code><span> قبل ما يشغل </span><code>apply</code><span> وبيسيب الـ </span><code>lock</code><span> بعد ما يخلص!</span></p><p><span>دلوقتي، روح على الـ </span><code>S3 console</code><span> تاني، اعمل </span><code>refresh</code><span> للصفحة، ودوس على زرار </span><code>Show</code><span> الرمادي اللي جنب </span><code>Versions</code><span>. المفروض دلوقتي تشوف كذا </span><code>version</code><span> من فايل الـ </span><code>terraform.tfstate</code><span> بتاعك في الـ </span><code>S3 bucket</code><span>، زي ما هو موضح في </span><code>Figure 3-2</code><span>.</span></p><p><img src="imgs/image-20250703163013762.png" referrerpolicy="no-referrer" alt="image-20250703163013762"></p><p><span>ده معناه إن Terraform بيعمل push و pull للـ state data أوتوماتيك من وإلى S3، وإن S3 بيخزن كل revision للـ state file.</span></p><p><span>ودي حاجة مفيدة جداً في الـ debugging، وإنك تقدر تعمل roll back لـ versions أقدم لو حصلت أي مشكلة.</span></p><h2 id='القصور-او-limitations-في-الـ-backends-بتاعة-terraform'><span>القصور او Limitations في الـ Backends بتاعة Terraform</span></h2><p><span>الـ </span><code>backends</code><span> بتاعة </span><code>Terraform</code><span> فيها شوية قصور ونقط لازم تاخد بالك منها.</span></p><p><span>أول مشكلة هي &quot;مشكلة البيضة والفرخة&quot; اللي بتقابلك لما تيجي تستخدم </span><code>Terraform</code><span> عشان تعمل </span><code>create</code><span> للـ </span><code>S3 bucket</code><span> اللي إنت أصلاً عايز تخزن فيه الـ </span><code>Terraform state</code><span> بتاعك. عشان تحل المشكلة دي، اضطرينا نمشي على عملية من خطوتين:</span></p><ol start='' ><li><p><span>تكتب كود </span><code>Terraform</code><span> عشان تعمل </span><code>create</code><span> للـ </span><code>S3 bucket</code><span> والـ </span><code>DynamoDB table</code><span>، وتعمل </span><code>deploy</code><span> للكود ده وانت بتستخدم </span><code>local backend</code><span>.</span></p></li><li><p><span>ترجع تاني لكود </span><code>Terraform</code><span>، وتضيف </span><code>remote backend configuration</code><span> عشان تستخدم الـ </span><code>S3 bucket</code><span> والـ </span><code>DynamoDB table</code><span> اللي لسه عاملينلهم </span><code>create</code><span>، وبعدين تشغل </span><code>terraform init</code><span> عشان تنسخ الـ </span><code>local state</code><span> بتاعك لـ </span><code>S3</code><span>.</span></p></li></ol><p><span>ولو حبيت في أي وقت تمسح الـ </span><code>S3 bucket</code><span> والـ </span><code>DynamoDB table</code><span> دول، هتحتاج تعمل نفس العملية اللي من خطوتين دي بس بالعكس:</span></p><ol start='' ><li><p><span>تروح لكود </span><code>Terraform</code><span>، تشيل الـ </span><code>backend configuration</code><span>، وتشغل </span><code>terraform init</code><span> من تاني عشان ترجع الـ </span><code>Terraform state</code><span> تاني للـ </span><code>local disk</code><span> بتاعك.</span></p></li><li><p><span>تشغل </span><code>terraform destroy</code><span> عشان تمسح الـ </span><code>S3 bucket</code><span> والـ </span><code>DynamoDB table</code><span>.</span></p></li></ol><p><span>العملية اللي من خطوتين دي رخمة شوية، بس الخبر الكويس إنك ممكن تستخدم نفس الـ </span><code>S3 bucket</code><span> والـ </span><code>DynamoDB table</code><span> لكل كود </span><code>Terraform</code><span> بتاعك، فغالباً هتحتاج تعملها مرة واحدة بس (أو مرة لكل </span><code>AWS account</code><span> لو عندك كذا حساب). بعد ما الـ </span><code>S3 bucket</code><span> يتعمل، في باقي كود الـ </span><code>Terraform</code><span> بتاعك، تقدر تحدد الـ </span><code>backend configuration</code><span> من أول لحظة من غير أي خطوات زيادة.</span></p><p><span>المشكلة التانية مؤلمة أكتر: الـ </span><code>backend block</code><span> في </span><code>Terraform</code><span> مش بيسمحلك تستخدم أي </span><code>variables</code><span> أو </span><code>references</code><span>. الكود اللي جاي ده </span><strong><span>مش هيشتغل</span></strong><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># ده مش هيشتغل. الـ Variables مش مسموح بيها في الـ backend configuration.</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">terraform</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">backend</span> <span class="cm-string">"s3"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">bucket</span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">bucket</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">region</span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">region</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">dynamodb_table</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">dynamodb_table</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">key</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"example/terraform.tfstate"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">encrypt</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 224px;"></div><div class="CodeMirror-gutters" style="display: none; height: 224px;"></div></div></div></pre><p><span>ده معناه إنك محتاج تعمل </span><code>copy-paste</code><span> للاسم بتاع الـ </span><code>S3 bucket</code><span> والـ </span><code>region</code><span> واسم الـ </span><code>DynamoDB table</code><span> وغيره، في كل </span><code>Terraform module</code><span> عندك.</span></p><p><span> (هنتعلم كل حاجة عن الـ </span><code>Terraform modules</code><span> في </span><code>Chapter 4</code><span> و </span><code>8</code><span>؛ دلوقتي، كفاية إنك تفهم إن الـ </span><code>modules</code><span> هي طريقة تنظم بيها كود </span><code>Terraform</code><span> وتعيد استخدامه، وإن الشغل الحقيقي بيبقى متقسم لـ </span><code>modules</code><span> صغيرة كتير).</span></p><p><span>الأسوأ من كده، إنك لازم تاخد بالك أوي ومتعملش </span><code>copy-paste</code><span> لقيمة الـ </span><code>key</code><span>، بالعكس، لازم تتأكد إن كل </span><code>component</code><span> في كل env بتعمله </span><code>deploy</code><span> ليه </span><code>key</code><span> مختلف ومميز عشان متعملش </span><code>overwrite</code><span> بالغلط على الـ </span><code>state</code><span> بتاع </span><code>module</code><span> تاني! إنك تضطر تعمل </span><code>copy-paste</code><span> كتير وتغييرات يدوية كتير ده بيفتح باب كبير للغلط، خصوصاً لو محتاج تعمل </span><code>deploy</code><span> و </span><code>manage</code><span> لـ </span><code>Terraform component</code><span> كتير في </span><code>environments</code><span> مختلفة.</span></p><div class="md-alert md-alert-important important"><p><span class='md-alert-text md-alert-text-important'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Important</span><br></p><p><span>نفهم مفهوم component انت تقسم الـenv بتاعك على اكثر من directory بحيث مثلا كل اعدادات الشبكة زي vpc , subnets و غيره فى directory لوحده دا مفهوم للـisolation اعلى شوية من مفهوم العزل على مستوى envs زي كده </span>
<img src="imgs/image-20250703193955973.png" referrerpolicy="no-referrer" alt="image-20250703193955973"></p><p><span>زي كده frontend في فولدر و backend فى فولدر المقصود بكده infrastructure بتاع كل واحد فيهم انت مضطر تروح تعمل cop-paste للـhcl وتزبط key زي قولت ودي عملية يدوية وممكن يحصل غلط هنا بيجي دور terragrunt بس سؤال ازاي اخد معلومات مثلا من Backend محتاجه فى frontend دي فى اخر الفصل مشروحه </span></p></div><p><span>أحد الحلول عشان تقلل الـ </span><code>copy-paste</code><span> هو إنك تستخدم حاجة اسمها </span><strong><code>partial configurations</code></strong><span>. </span>
<span>الفكرة إنك بتشيل </span><code>parameters</code><span> معينة من الـ </span><code>backend configuration</code><span> في الكود بتاعك، وبتباصيها كـ </span><code>command-line arguments</code><span> عن طريق </span><code>-backend-config</code><span> لما بتشغل </span><code>terraform init</code><span>.</span></p><p><span>مثلاً، ممكن تاخد الـ </span><code>arguments</code><span> المتكررة زي </span><code>bucket</code><span> و </span><code>region</code><span>، وتحطهم في فايل لوحده اسمه </span><code>backend.hcl</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="hcl"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="hcl"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"># backend.hcl</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">bucket &nbsp; &nbsp; &nbsp; &nbsp; = "terraform-up-and-running-state"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">region &nbsp; &nbsp; &nbsp; &nbsp; = "us-east-2"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">dynamodb_table = "terraform-up-and-running-locks"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">encrypt &nbsp; &nbsp; &nbsp;  = true</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p><span>الـ </span><code>parameter</code><span> الوحيد اللي بيفضل في كود </span><code>Terraform</code><span> هو الـ </span><code>key</code><span>، لأنك لسه محتاج تظبط قيمة </span><code>key</code><span> مختلفة لكل </span><code>module</code><span>:</span></p><p><span>Partial configuration. باقي الـ settings (زي bucket, region)</span></p><p><span>هتتباصى من فايل عن طريق -backend-config arguments لـ &#39;terraform init&#39;</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">terraform</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">backend</span> <span class="cm-string">"s3"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">key</span> <span class="cm-operator">=</span> <span class="cm-string">"example/terraform.tfstate"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p><span>عشان تجمع الـ </span><code>partial configurations</code><span> بتاعتك مع بعض، شغل </span><code>terraform init</code><span> مع الـ </span><code>argument</code><span> اللي اسمه </span><code>-backend-config</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$ terraform</span> init <span class="cm-attribute">-backend-config</span><span class="cm-operator">=</span>backend.hcl</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><code>Terraform</code><span> بيعمل </span><code>merge</code><span> للـ </span><code>partial configuration</code><span> اللي في </span><code>backend.hcl</code><span> مع الـ </span><code>partial configuration</code><span> اللي في كود </span><code>Terraform</code><span> بتاعك عشان يكون الـ </span><code>full configuration</code><span> اللي الـ </span><code>module</code><span> بتاعك بيستخدمها. ممكن تستخدم نفس الفايل </span><code>backend.hcl</code><span> مع كل الـ </span><code>modules</code><span> بتاعتك، وده بيقلل التكرار بشكل كبير جداً؛ بس برضه هتفضل محتاج تظبط قيمة </span><code>key</code><span> مختلفة لكل </span><code>module</code><span> بنفسك.</span></p><div class="md-alert md-alert-tip tip"><p><span class='md-alert-text md-alert-text-tip'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>Tip</span><br></p><p><span>على فكرة عادي  تحط key في ملفات hcl بتحصل عادي وهو بيفهم انه من ضمن backend بس لما يكون عندك كذا module محتاج تغير ده في كل ملف hcl هتحطه فى module وانت ودماغك </span></p><p><span>انا ذات نفسي بخلي انشاء الملف ده يحصل اتوامتك عادي وجدا زي كده </span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.63019px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"region"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"The AWS region to deploy resources in"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">default</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"eu-west-1"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">type</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">string</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">provider</span> <span class="cm-string">"aws"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">region</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">region</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"random_string"</span> <span class="cm-string">"random"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">length</span> <span class="cm-operator">=</span> <span class="cm-number">8</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">special</span> <span class="cm-operator">=</span> <span class="cm-keyword">false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">upper</span> <span class="cm-operator">=</span> <span class="cm-keyword">false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_s3_bucket"</span> <span class="cm-string">"backend_bucket"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">bucket</span> <span class="cm-operator">=</span> <span class="cm-string">"my-terraform-backend-bucket-${random_string.random.result}"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">force_destroy</span> <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_s3_bucket_public_access_block"</span> <span class="cm-string">"public_access"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">bucket</span> <span class="cm-operator">=</span> <span class="cm-variable">aws_s3_bucket</span><span class="cm-operator">.</span><span class="cm-property">backend_bucket</span><span class="cm-operator">.</span><span class="cm-property">id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">block_public_acls</span> &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">block_public_policy</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">ignore_public_acls</span> &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">restrict_public_buckets</span> <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_s3_bucket_server_side_encryption_configuration"</span> <span class="cm-string">"s3_encryption"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">bucket</span> <span class="cm-operator">=</span> <span class="cm-variable">aws_s3_bucket</span><span class="cm-operator">.</span><span class="cm-property">backend_bucket</span><span class="cm-operator">.</span><span class="cm-property">id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">rule</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-variable">apply_server_side_encryption_by_default</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">sse_algorithm</span> <span class="cm-operator">=</span> <span class="cm-string">"AES256"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_s3_bucket_versioning"</span> <span class="cm-string">"enable"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">bucket</span> <span class="cm-operator">=</span> <span class="cm-variable">aws_s3_bucket</span><span class="cm-operator">.</span><span class="cm-property">backend_bucket</span><span class="cm-operator">.</span><span class="cm-property">id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">versioning_configuration</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-variable">status</span> <span class="cm-operator">=</span> <span class="cm-string">"Enabled"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_dynamodb_table"</span> <span class="cm-string">"terraform_locks"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">name</span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"backend_locks-${random_string.random.result}"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">billing_mode</span> <span class="cm-operator">=</span> <span class="cm-string">"PAY_PER_REQUEST"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">hash_key</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"LockID"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">attribute</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-string">"LockID"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-variable">type</span> <span class="cm-operator">=</span> <span class="cm-string">"S"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"local_file"</span> <span class="cm-string">"backend_config"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">content</span> <span class="cm-operator">=</span> <span class="cm-string">&lt;&lt;EOF</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">bucket = "${aws_s3_bucket.backend_bucket.bucket}"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">region = "${var.region}"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">encrypt = true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">key = "terraform.tfstate.production"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">dynamodb_table = "${aws_dynamodb_table.terraform_locks.name}"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">EOF</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">filename</span> <span class="cm-operator">=</span> <span class="cm-string">"./production_backend_config.hcl"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1612px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1612px;"></div></div></div></pre><p><span>ممكن تكون محتاج اكثر من ملف لاكثر من module ساعته هتحتاج تعمل </span><code>loops</code><span> لسه هنشوفه فى الفصل الخامس</span></p><p><span>لان لازم كل واحد ليه key مخلتف</span></p><p><span>او تريح نفسك  كل واحد وتحط key فى كل module فى ملفات terraform ودا الصح </span></p><p><span>طب السؤال ايه ليه سمى key بالاسم ده </span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.63019px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">example/terraform.tfstate"</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>دي حتة مهمة قوي لما يكون عندك اكثر من Module واحد webserver وواحد للـdatabase .....وهكذا دلوقتي فى مشكلة لو كل واحد سمى key على مزاجه هتبقى نصيبة اعرف ده تبع مين وده تبع مين ازاي هنا يجي الحل حط Key بـrelative path يعني كأنه موجود داخل  ملفات المشروع وتحطه بالـkey اللي يساوي نفس relative path بتاع terraform.tfstate لو كان local</span></p><p><span>بص هنا كمثال </span></p><p><img src="imgs/image-20250703171835593.png" referrerpolicy="no-referrer" alt="image-20250703171835593"></p><p><span>شوف لو كان terraform.tfstate موجود فى backend-app  كا local هيكون شكله كده </span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0231px; left: 7.63019px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">stage/services.backend-app/terraform.tfstate</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>ببساطة خليه key فى s3 فى حالة بقى لما يكون remote backend عشان انت تعرف على طول هو تبع انهي Module سواء backend-app او frontend هي دي الفكرة مجرد تنظيم بس</span></p></div><p><span>حل تاني عشان تقلل الـ </span><code>copy-paste</code><span> هو إنك تستخدم </span><strong><code>Terragrunt</code></strong><span>، دي أداة </span><code>open source</code><span> بتحاول تسد شوية ثغرات موجودة في </span><code>Terraform</code><span>. </span><code>Terragrunt</code><span> بتساعدك تخلي الـ </span><code>backend configuration</code><span> بتاعتك كلها </span><code>DRY</code><span> (يعني </span><code>Don’t Repeat Yourself</code><span>)، عن طريق إنك بتعرّف كل الـ </span><code>backend settings</code><span> الأساسية (اسم الـ </span><code>bucket</code><span>، الـ </span><code>region</code><span>، اسم الـ </span><code>DynamoDB table</code><span>) في فايل واحد، وهي أوتوماتيك بتظبط الـ </span><code>key</code><span> إنه يبقى الـrealtive path للفولدر بتاع الـ </span><code>module</code><span>.</span></p><p><span>هنشوف مثال إزاي نستخدم </span><code>Terragrunt</code><span> في </span><code>Chapter 10</code><span>.</span></p><p>&nbsp;</p><p>&nbsp;</p><h2 id='state-file-isolation'><strong><span>State File Isolation</span></strong></h2><p><span>بوجود الـ </span><code>remote backend</code><span> والـ </span><code>locking</code><span>، الشغل كـ </span><code>team</code><span> مبقاش فيه مشكلة. بس لسه فاضل مشكلة كمان: الـ </span><code>isolation</code><span>.</span></p><p><span>في الأول لما بتبدأ تستخدم </span><code>Terraform</code><span>، ممكن تلاقي نفسك عايز تعرّف كل الـ </span><code>infrastructure</code><span> بتاعتك في </span><code>Terraform file</code><span> واحد، أو في مجموعة </span><code>Terraform files</code><span> في فولدر واحد. المشكلة في الطريقة دي إن كل الـ </span><code>Terraform state</code><span> بتاعك هو كمان بيتخزن في فايل واحد، وأي غلطة في أي حتة ممكن تبوظ الدنيا كلها.</span></p><p><span>مثلاً، وانت بتحاول تعمل </span><code>deploy</code><span> لـ </span><code>version</code><span> جديدة من الأبلكيشن بتاعك على الـ </span><code>staging</code><span>، ممكن تبوظ الأبلكيشن اللي على الـ </span><code>production</code><span>. أو الأسوأ من كده، إنك ممكن تعمل </span><code>corrupt</code><span> للـ </span><code>state file</code><span> بتاعك كله، يا إما عشان مستخدمتش </span><code>locking</code><span> أو بسبب </span><code>bug</code><span> نادر في </span><code>Terraform</code><span>، وساعتها كل الـ </span><code>infrastructure</code><span> بتاعتك في كل الـ </span><code>environments</code><span> هتبوظ.</span></p><p><span>الفكرة كلها من وجود </span><code>environments</code><span> منفصلة هي إنها تكون </span><code>isolated</code><span> عن بعضها. فلو إنت بتعمل </span><code>manage</code><span> لكل الـ </span><code>environments</code><span> من مجموعة </span><code>Terraform configurations</code><span> واحدة، يبقى إنت كده بتكسر الـ </span><code>isolation</code><span> ده.</span></p><p><span>بالظبط زي ما السفينة بيكون فيها </span><code>bulkheads</code><span> (حواجز) بتمنع إن تسريب في جزء يغرق السفينة كلها، إنت كمان لازم يكون عندك </span><code>bulkheads</code><span> في تصميم الـ </span><code>Terraform</code><span> بتاعك، زي ما هو واضح في </span><code>Figure 3-3</code><span>.</span></p><p><img src="https://i.ytimg.com/vi/ZwTocGzeWGQ/maxresdefault.jpg" referrerpolicy="no-referrer" alt="Bulkheads In Ships"></p><p><img src="imgs/image-20250703172634988.png" referrerpolicy="no-referrer" alt="image-20250703172634988"></p><p><span>زي ما </span><code>Figure 3-3</code><span> بيوضح، بدل ما تعرّف كل الـ </span><code>environments</code><span> بتاعتك في مجموعة </span><code>Terraform configurations</code><span> واحدة (الجزء اللي فوق)، الصح إنك تعرّف كل </span><code>environment</code><span> في مجموعة </span><code>configurations</code><span> منفصلة (الجزء اللي تحت)، بحيث إن أي مشكلة في </span><code>environment</code><span> معينة تكون معزولة تماماً عن الباقي.</span></p><p><span>فيه طريقتين تقدر تعمل بيهم </span><code>isolate</code><span> للـ </span><code>state files</code><span>:</span></p><ul><li><p><strong><span>الـ </span><code>Isolation</code><span> عن طريق الـ </span><code>workspaces</code></strong><span></span><br/><span>ودي مفيدة للـ </span><code>tests</code><span> السريعة والمنفصلة على نفس الـ </span><code>configuration</code><span>.</span></p></li><li><p><strong><span>الـ </span><code>Isolation</code><span> عن طريق الـ </span><code>file layout</code></strong><span></span><br/><span>ودي مفيدة في حالات الـ </span><code>production</code><span> اللي بتحتاج فيها </span><code>separation</code><span> قوي بين الـ </span><code>environments</code><span>.</span></p></li></ul><p><span>خلينا نتكلم بالتفصيل عن كل واحدة منهم في الجزئين اللي جايين.</span></p><h3 id='الـ-isolation-عن-طريق-الـ-workspaces'><strong><span>الـ </span><code>Isolation</code><span> عن طريق الـ </span><code>Workspaces</code></strong></h3><p><span>الـ </span><code>Terraform workspaces</code><span> بتخليك تخزن الـ </span><code>Terraform state</code><span> بتاعك في كذا </span><code>workspace</code><span> منفصل وليه اسم معين. </span><code>Terraform</code><span> بيبدأ بـ </span><code>workspace</code><span> واحد بس اسمه </span><code>default</code><span>، ولو إنت عمرك ما حددت </span><code>workspace</code><span> معين بشكل صريح، يبقى الـ </span><code>default workspace</code><span> هو اللي هتفضل تستخدمه طول الوقت.</span></p><p><span>عشان تعمل </span><code>create</code><span> لـ </span><code>workspace</code><span> جديد أو تبدل ما بين الـ </span><code>workspaces</code><span>، بتستخدم الأوامر بتاعة </span><code>terraform workspace</code><span>. خلينا نجرب الـ </span><code>workspaces</code><span> دي على كود </span><code>Terraform</code><span> بيعمل </span><code>deploy</code><span> لـ </span><code>EC2 Instance</code><span> واحدة:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_instance"</span> <span class="cm-string">"example"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">ami</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"ami-0c55b159cbfafe1f0"</span> <span class="cm-comment"># Amazon Linux 2 AMI</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">instance_type</span> <span class="cm-operator">=</span> <span class="cm-string">"t2.micro"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><span>اعمل </span><code>configure</code><span> لـ </span><code>backend</code><span> للـ </span><code>Instance</code><span> دي، باستخدام الـ </span><code>S3 bucket</code><span> والـ </span><code>DynamoDB table</code><span> اللي عملناهم </span><code>create</code><span> قبل كده في الشابتر ده، بس خلي الـ </span><code>key</code><span> متظبط على </span><code>workspaces-example/terraform.tfstate</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">terraform</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">backend</span> <span class="cm-string">"s3"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">bucket</span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"terraform-up-and-running-state"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">key</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"workspaces-example/terraform.tfstate"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">region</span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"us-east-2"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">dynamodb_table</span> <span class="cm-operator">=</span> <span class="cm-string">"terraform-up-and-running-locks"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">encrypt</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 269px;"></div><div class="CodeMirror-gutters" style="display: none; height: 269px;"></div></div></div></pre><p><span>اعمل </span><code>run</code><span> لأمر </span><code>terraform init</code><span> و </span><code>terraform apply</code><span> عشان تعمل </span><code>deploy</code><span> للكود ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$ terraform</span> init</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Initializing the backend...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Successfully configured the backend <span class="cm-string">"s3"</span>! Terraform will automatically</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">use this backend unless the backend configuration changes.</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Initializing provider plugins...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(...)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Terraform has been successfully initialized!</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$ terraform</span> apply</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(...)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Apply complete! Resources: <span class="cm-number">1</span> added, <span class="cm-number">0</span> changed, <span class="cm-number">0</span> destroyed.</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 291px;"></div><div class="CodeMirror-gutters" style="display: none; height: 291px;"></div></div></div></pre><p><span>الـ </span><code>state</code><span> بتاع الـ </span><code>deployment</code><span> ده متخزن في الـ </span><code>default workspace</code><span>. تقدر تتأكد من كده بإنك تشغل أمر </span><code>terraform workspace show</code><span>، اللي هيقولك إنت في أنهي </span><code>workspace</code><span> حالياً:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$ terraform</span> workspace show</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">default</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="display: none; height: 45px;"></div></div></div></pre><p><span>الـ </span><code>default workspace</code><span> بيخزن الـ </span><code>state</code><span> بتاعك في نفس المكان اللي إنت حددته بالظبط في الـ </span><code>key</code><span>. زي ما هو واضح في </span><code>Figure 3-4</code><span>، لو بصيت في الـ </span><code>S3 bucket</code><span> بتاعك، هتلاقي فايل </span><code>terraform.tfstate</code><span> موجود جوه فولدر </span><code>workspaces-example</code><span>.</span></p><p><img src="imgs/image-20250703173257450.png" referrerpolicy="no-referrer" alt="image-20250703173257450"></p><p>&nbsp;</p><p><span>لما جرب دا اللي ظهر معايا default كان في ملف لوحدة فى اول s3 اما باقي workspaces كان فى folder اسممه env./ s زي مابين فى الصورة</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$ terraform</span> workspace new example1</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Created and switched to workspace <span class="cm-string">"example1"</span>!</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">You<span class="cm-string">'re now on a new, empty workspace. Workspaces isolate their state,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">so <span class="cm-keyword">if</span> you run <span class="cm-string">"terraform plan"</span> Terraform will not see any existing state</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> this configuration.</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 134px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><p><span>دلوقتي، خد بالك إيه اللي هيحصل لو حاولت تشغل </span><code>terraform plan</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$ terraform</span> plan</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Terraform will perform the following actions:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># aws_instance.example will be created</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-operator">+</span> resource <span class="cm-string">"aws_instance"</span> <span class="cm-string">"example"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-operator">+</span> ami &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"ami-0c55b159cbfafe1f0"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-operator">+</span> instance_type <span class="cm-operator">=</span> <span class="cm-string">"t2.micro"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  (...)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Plan: <span class="cm-number">1</span> to add, <span class="cm-number">0</span> to change, <span class="cm-number">0</span> to destroy.</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 246px;"></div><div class="CodeMirror-gutters" style="display: none; height: 246px;"></div></div></div></pre><p><code>Terraform</code><span> عايز يعمل </span><code>create</code><span> لـ </span><code>EC2 Instance</code><span> جديدة خالص من الصفر! ده لأن الـ </span><code>state files</code><span> في كل </span><code>workspace</code><span> معزولة عن بعضها، وبما إنك دلوقتي في الـ </span><code>workspace</code><span> اللي اسمه </span><code>example1</code><span>، </span><code>Terraform</code><span> مش بيستخدم الـ </span><code>state file</code><span> بتاع الـ </span><code>default workspace</code><span>، وبالتالي مش شايف إن الـ </span><code>EC2 Instance</code><span> اتعملت </span><code>create</code><span> هناك أصلاً.</span></p><p><span>جرب تشغل </span><code>terraform apply</code><span> عشان تعمل </span><code>deploy</code><span> للـ </span><code>EC2 Instance</code><span> التانية دي في الـ </span><code>workspace</code><span> الجديد:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$ terraform</span> apply</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(...)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Apply complete! Resources: <span class="cm-number">1</span> added, <span class="cm-number">0</span> changed, <span class="cm-number">0</span> destroyed.</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 67px;"></div><div class="CodeMirror-gutters" style="display: none; height: 67px;"></div></div></div></pre><p><span>كرر نفس الموضوع مرة كمان واعمل </span><code>create</code><span> لـ </span><code>workspace</code><span> تالت اسمه </span><code>example2</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$ terraform</span> workspace new example2</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Created and switched to workspace <span class="cm-string">"example2"</span>!</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">You<span class="cm-string">'re now on a new, empty workspace. Workspaces isolate their state,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">so <span class="cm-keyword">if</span> you run <span class="cm-string">"terraform plan"</span> Terraform will not see any existing state</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> this configuration.</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 134px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><p><span>شغل </span><code>terraform apply</code><span> تاني عشان تعمل </span><code>deploy</code><span> لـ </span><code>EC2 Instance</code><span> تالتة:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$ terraform</span> apply</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(...)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Apply complete! Resources: <span class="cm-number">1</span> added, <span class="cm-number">0</span> changed, <span class="cm-number">0</span> destroyed.</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 67px;"></div><div class="CodeMirror-gutters" style="display: none; height: 67px;"></div></div></div></pre><p><span>دلوقتي بقى عندك تلاتة </span><code>workspaces</code><span> متاحين، تقدر تشوفهم باستخدام أمر </span><code>terraform workspace list</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$ terraform</span> workspace list</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  default</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  example1</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">* example2</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><span>وتقدر تبدل بينهم في أي وقت باستخدام أمر </span><code>terraform workspace select</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$ terraform</span> workspace select example1</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Switched to workspace <span class="cm-string">"example1"</span>.</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="display: none; height: 45px;"></div></div></div></pre><p><span>عشان تفهم إزاي ده بيشتغل </span><code>under the hood</code><span> (يعني في الكواليس)، بص تاني في الـ </span><code>S3 bucket</code><span> بتاعك؛ المفروض دلوقتي تشوف فولدر جديد اسمه </span><code>env:</code><span>، زي ما هو واضح في </span><code>Figure 3-5</code><span>.</span></p><p>&nbsp;</p><p><img src="imgs/image-20250703175506277.png" referrerpolicy="no-referrer" alt="image-20250703175506277"></p><p><span>جوه الفولدر اللي اسمه env:، هتلاقي فولدر لكل workspace من اللي عندك، زي ما هو واضح في Figure 3-6.</span></p><p><img src="imgs/image-20250703175607297.png" referrerpolicy="no-referrer" alt="image-20250703175607297"></p><p><img src="imgs/image-20250703174818680.png" referrerpolicy="no-referrer" alt="image-20250703174818680"></p><p><img src="imgs/image-20250703175015304.png" referrerpolicy="no-referrer"></p><p>&nbsp;</p><p><span>خد بالك دا معناها ان كل workspace ليه ملف state لوحده مختلف عن ثاني كانك حطيط كل واحد فى فولدر مستقل وكل واحد ليه fstate خاص بيه</span></p><p><span>خلينا نعمل </span><code>create</code><span> لـ </span><code>workspace</code><span> جديد اسمه </span><code>example1</code><span> باستخدام أمر </span><code>terraform workspace new</code><span>:</span></p><div class="md-alert md-alert-warning warning"><p><span class='md-alert-text md-alert-text-warning'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Warning</span><br></p><p><span>انا هنا مش تبع تسمية key الـ standerd بس عادي مش </span></p></div><p>&nbsp;</p><p><span>جوه كل </span><code>workspace</code><span> من دول، </span><code>Terraform</code><span> بيستخدم الـ </span><code>key</code><span> اللي أنت حددته في الـ </span><code>backend configuration</code><span> بتاعتك. عشان كده المفروض تلاقي عندك</span>
<span> </span><code>example1/workspaces-example/terraform.tfstate</code><span> </span>
<span>و </span><code>example2/workspaces-example/terraform.tfstate</code><span>.</span>
<span> بمعنى تاني، إنك تعمل </span><code>switch</code><span> لـ </span><code>workspace</code><span> مختلف هو هو بالظبط كأنك غيرت الـ </span><code>path</code><span> اللي الـ </span><code>state file</code><span> بتاعك متخزن فيه.</span></p><p><span>دي حاجة مفيدة جداً لما يكون عندك </span><code>Terraform module</code><span> معموله </span><code>deploy</code><span> خلاص، وعايز تجرب فيه شوية حاجات (زي مثلاً إنك تحاول تعمل </span><code>refactor</code><span> للكود)، بس في نفس الوقت مش عايز التجارب بتاعتك دي تأثر على الـ </span><code>state</code><span> بتاع الـ </span><code>infrastructure</code><span> اللي معمولة </span><code>deploy</code><span> بالفعل. الـ </span><code>Terraform workspaces</code><span> بتسمحلك تعمل </span><code>run</code><span> لأمر </span><code>terraform workspace new</code><span> وتعمل </span><code>deploy</code><span> لنسخة جديدة طبق الأصل من نفس الـ </span><code>infrastructure</code><span>، بس بتخزن الـ </span><code>state</code><span> بتاعها في </span><code>file</code><span> منفصل لوحده.</span></p><p><span>في الحقيقة، أنت ممكن كمان تغير الطريقة اللي الـ </span><code>module</code><span> ده بيتصرف بيها على حسب الـ </span><code>workspace</code><span> اللي أنت فيه، عن طريق إنك تقرا اسم الـ </span><code>workspace</code><span> باستخدام الـ </span><code>expression</code><span> ده: </span><code>terraform.workspace</code><span>. كمثال، دي طريقة تخلي الـ </span><code>Instance type</code><span> يبقى </span><code>t2.medium</code><span> في الـ </span><code>default workspace</code><span> ويبقى </span><code>t2.micro</code><span> في أي </span><code>workspace</code><span> تاني (عشان توفر فلوس مثلاً وانت بتجرب):</span></p><div class="md-alert md-alert-note note"><p><span class='md-alert-text md-alert-text-note'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</span><br></p><p><span>refactor المقصود به اعادة هيكلة او بتستخدام مثلا storage مختلف تشوف اداءه يستحق ولا ء </span>
<span>فالفكرة انت عيز تجرب ومش عايز يكون فى بيئة producation فبتعمل كده فى بيئة testing وبتشوف نفع كان به وترجع لبيئة producation وطبق طب لو منفعش انت مش خسران حاجة مفيش حاجة اثرة معاك فى producation تقدر عن طريق control version ترجع وقضي الامر</span></p></div><p>&nbsp;</p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_instance"</span> <span class="cm-string">"example"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">ami</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"ami-0fb653ca2d3203ac1"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">instance_type</span> <span class="cm-operator">=</span> <span class="cm-variable">terraform</span><span class="cm-operator">.</span><span class="cm-property">workspace</span> <span class="cm-operator">==</span> <span class="cm-string">"default"</span> <span class="cm-string">? "t2.medium"</span> <span class="cm-operator">:</span> <span class="cm-string">"t2.micro"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><div class="md-alert md-alert-note note"><p><span class='md-alert-text md-alert-text-note'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</span><br></p><p><span>الكود اللي فات بيستخدم </span><code>ternary syntax</code><span> عشان يظبط </span><code>instance_type</code><span> بشكل شرطي (</span><code>conditionally</code><span>) يا إما لـ </span><code>t2.medium</code><span> أو </span><code>t2.micro</code><span>، على حسب قيمة </span><code>terraform.workspace</code><span>. </span>
<span>هتشوف التفاصيل الكاملة للـ </span><code>ternary syntax</code><span> والـ </span><code>conditional logic</code><span> في </span><code>Terraform</code><span> في الفصل الخامس.</span></p><p><span>فى طرق عشان تعمل الحاجة دي تغير سلوك resource بناءا على workspace هنشوف هنعمل دا ازاي وبطرق اكثر تنظيما وسلاسة   </span></p><p>&nbsp;</p></div><p><span>الكود اللي فات ده بيستخدم حاجة اسمها </span><code>ternary syntax</code><span> عشان يحدد قيمة الـ </span><code>instance_type</code><span> بشكل شرطي، يا إما </span><code>t2.medium</code><span> أو </span><code>t2.micro</code><span>، على حسب قيمة </span><code>terraform.workspace</code><span>. أنت هتشوف التفاصيل الكاملة للـ </span><code>ternary syntax</code><span> والـ </span><code>conditional logic</code><span> في </span><code>Terraform</code><span> في الفصل الخامس.</span></p><p><span>الـ </span><code>Terraform workspaces</code><span> ممكن تكون طريقة ممتازة عشان تعمل </span><code>spin up</code><span> و </span><code>tear down</code><span> لـ </span><code>versions</code><span> مختلفة من الكود بتاعك بسرعة، بس فيها شوية عيوب (drawbacks):</span></p><div class="md-alert md-alert-tip tip"><p><span class='md-alert-text md-alert-text-tip'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>Tip</span><br></p><p><strong><code>Spin up</code></strong><span>: دي معناها إنك </span><strong><span>بتِقوّم</span></strong><span> أو بتشغل الـ infrastructure. يعني بتعمل </span><code>create</code><span> للـ </span><code>resources</code><span> (زي السيرفرات مثلاً) وتخليها جاهزة وموجودة </span><code>online</code><span> عشان تبدأ تستخدمها.</span></p><p><strong><code>Tear down</code></strong><span>: ودي عكسها تماماً. معناها إنك </span><strong><span>بتهدّ</span></strong><span> أو بتمسح الـ infrastructure دي خالص. بتعمل </span><code>destroy</code><span> لكل الـ </span><code>resources</code><span> اللي كنت عملتلها </span><code>spin up</code><span> عشان متفضلش شغالة وتصرف فلوس على الفاضي.</span></p></div><p>&nbsp;</p><ul><li><p><span>الـ </span><code>state files</code><span> بتاعت كل الـ </span><code>workspaces</code><span> بتتخزن في نفس الـ </span><code>backend</code><span> (يعني مثلاً في نفس الـ </span><code>S3 bucket</code><span>). ده معناه إنك بتستخدم نفس الـ </span><code>authentication</code><span> والـ </span><code>access controls</code><span> لكل الـ </span><code>workspaces</code><span>، وده سبب من الأسباب الرئيسية اللي بتخلي الـ </span><code>workspaces</code><span> مش طريقة كويسة عشان تعمل </span><code>isolating</code><span> للـ </span><code>environments</code><span> عن بعضها (زي مثلاً تفصل الـ </span><code>staging</code><span> عن الـ </span><code>production</code><span>).</span></p></li></ul><p>&nbsp;</p><ul><li><p><span>الـ </span><code>Workspaces</code><span> مش بتبقى ظاهرة في الكود أو على الـ </span><code>terminal</code><span> إلا لو عملت </span><code>run</code><span> لأوامر </span><code>terraform workspace</code><span>. لما تبص على الكود، أي </span><code>module</code><span> معموله </span><code>deploy</code><span> في </span><code>workspace</code><span> واحد بيبان شكله هو هو بالظبط زي </span><code>module</code><span> تاني معموله </span><code>deploy</code><span> في 10 </span><code>workspaces</code><span>. ده بيخلي الـ </span><code>maintenance</code><span> أصعب، لإنك مش بيبقى عندك صورة واضحة للـ </span><code>infrastructure</code><span> بتاعتك, المشكلة دي اسمها Code blinds</span></p></li><li><p><span>لما نحط النقطتين اللي فاتوا دول على بعض، النتيجة هي إن الـ </span><code>workspaces</code><span> ممكن تكون </span><code>error prone</code><span> جداً (يعني سهل تغلط فيها). عدم الوضوح ده بيخلي سهل إنك تنسى أنت في أنهي </span><code>workspace</code><span> وتعمل </span><code>deploy</code><span> للتغييرات في مكان غلط بالغلط (زي مثلاً إنك بالصدفة تعمل </span><code>run</code><span> لأمر </span><code>terraform destroy</code><span> في الـ </span><code>workspace</code><span> بتاع الـ </span><code>production</code><span> بدل الـ </span><code>staging</code><span>). ولإنك لازم تستخدم نفس الـ </span><code>authentication</code><span> لكل الـ </span><code>workspaces</code><span>، فمفيش عندك أي </span><code>layers of defense</code><span> تانية تحميك من غلطات زي دي.</span></p></li></ul><p><span>بسبب العيوب دي، الـ </span><code>workspaces</code><span> مش وسيلة مناسبة عشان تعمل </span><code>isolating</code><span> لـ </span><code>environment</code><span> عن التانية، زي مثلاً إنك تفصل الـ </span><code>staging</code><span> عن الـ </span><code>production</code><span>. عشان تاخد </span><code>isolation</code><span> مظبوط بين الـ </span><code>environments</code><span>، بدل الـ </span><code>workspaces</code><span>، أنت غالباً هتحتاج تستخدم طريقة الـ </span><code>file layout</code><span>، وده موضوع الجزء اللي جاي.</span></p><p><span>قبل ما نكمل، اتأكد إنك تمسح الـ 3 </span><code>EC2 Instances</code><span> اللي لسه عاملين ليهم </span><code>deploy</code><span>، وده عن طريق إنك تعمل </span><code>run</code><span> لأمر </span><code>terraform workspace select &lt;name&gt;</code><span> وبعدها </span><code>terraform destroy</code><span> في كل </span><code>workspace</code><span> من التلاتة.</span></p><p>&nbsp;</p><p>&nbsp;</p><h3 id='الـ-isolation-عن-طريق-الـ-file-layout'><span>الـ Isolation عن طريق الـ File Layout</span></h3><p><span>عشان توصل لـ </span><code>isolation</code><span> كامل بين الـ </span><code>environments</code><span>، أنت محتاج تعمل الآتي:</span></p><ul><li><p><span>تحط الـ </span><code>Terraform configuration files</code><span> بتاعت كل </span><code>environment</code><span> في فولدر منفصل. كمثال، كل الـ </span><code>configurations</code><span> بتاعت الـ </span><code>staging environment</code><span> ممكن تبقى في فولدر اسمه </span><code>stage</code><span> وكل الـ </span><code>configurations</code><span> بتاعت الـ </span><code>production environment</code><span> تبقى في فولدر اسمه </span><code>prod</code><span>.</span></p></li><li><p><span>تعمل </span><code>configure</code><span> لـ </span><code>backend</code><span> مختلف لكل </span><code>environment</code><span>، وتستخدم </span><code>authentication mechanisms</code><span> و </span><code>access controls</code><span> مختلفة. يعني مثلاً، كل </span><code>environment</code><span> ممكن تبقى في </span><code>AWS account</code><span> منفصل لوحدها وليها </span><code>S3 bucket</code><span> منفصل كـ </span><code>backend</code><span>.</span></p></li></ul><p><span>بالطريقة دي، استخدام فولدرات منفصلة بيخلي الموضوع أوضح بكتير أنت بتعمل </span><code>deploy</code><span> في أنهي </span><code>environment</code><span>. واستخدام </span><code>state files</code><span> منفصلة، ومعاها </span><code>authentication mechanisms</code><span> منفصلة، بيخلي احتمالية إن أي لخبطة تحصل في </span><code>environment</code><span> معينة تأثر على التانية أقل بكتير.</span></p><p><span>في الحقيقة، أنت ممكن تاخد مفهوم الـ </span><code>isolation</code><span> ده لأبعد من مجرد الـ </span><code>environments</code><span> وتنزِل بيه لحد مستوى الـ &quot;component&quot;. الـ </span><code>component</code><span> هنا هو عبارة عن مجموعة  من الـ </span><code>resources</code><span> اللي أنت عادةً بتعملها </span><code>deploy</code><span> مع بعض.</span></p><div class="md-alert md-alert-note note"><p><span class='md-alert-text md-alert-text-note'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</span><br></p><p>&nbsp;</p><p><span>تخيل إنك بتبني سيستم كامل فيه </span><code>VPC</code><span> (الشبكة)، و </span><code>database</code><span>، و </span><code>web-app</code><span>. بدل ما تحط كل دول في ملف </span><code>Terraform</code><span> واحد، هتقسمهم بالشكل ده:</span></p><p><strong><span>الشكل العام للمشروع (الـ Tree Structure):</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0241px; left: 7.63019px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">infrastructure/</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">├── staging/</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; ├── vpc/</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; │ &nbsp; ├── main.tf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; │ &nbsp; └── terraform.tfstate  (State بتاع الـ VPC بس في الـ Staging)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; │</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; ├── database/</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; │ &nbsp; ├── main.tf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; │ &nbsp; └── terraform.tfstate  (State بتاع الـ Database بس في الـ Staging)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; │</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; └── web-app/</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; ├── main.tf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│ &nbsp; &nbsp; &nbsp; └── terraform.tfstate  (State بتاع الـ Web App بس في الـ Staging)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">└── production/</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> ├── vpc/</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> │ &nbsp; ├── main.tf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> │ &nbsp; └── terraform.tfstate  (State بتاع الـ VPC بس في الـ Production)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> │</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> ├── database/</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> │ &nbsp; ├── main.tf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> │ &nbsp; └── terraform.tfstate  (State بتاع الـ Database بس في الـ Production)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> │</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> └── web-app/</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; ├── main.tf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; └── terraform.tfstate  (State بتاع الـ Web App بس في الـ Production)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 582px;"></div><div class="CodeMirror-gutters" style="display: none; height: 582px;"></div></div></div></pre><p><strong><span>شرح الـ Tree دي:</span></strong></p><ol start='' ><li><p><strong><span>التقسيم على مستوى الـ </span><code>Environment</code><span>:</span></strong></p><ul><li><p><span>عندنا فولدرين أساسيين: </span><code>staging</code><span> و </span><code>production</code><span>. ده بيضمن إن أي تغييرات هتحصل في الـ </span><code>staging</code><span> مش هتأثر أبداً على الـ </span><code>production</code><span> عشان كل واحد فيهم ليه فولدراته الخاصة.</span></p></li></ul></li><li><p><strong><span>التقسيم على مستوى الـ </span><code>Component</code><span>:</span></strong></p><ul><li><p><span>جوه كل </span><code>environment</code><span> (زي </span><code>staging</code><span> مثلاً)، قسمنا الشغل لـ </span><code>components</code><span> منطقية:</span></p><ul><li><p><code>vpc/</code><span>: ده الـ </span><code>component</code><span> المسئول عن الشبكة بس (</span><code>VPC</code><span>, </span><code>Subnets</code><span>, </span><code>Route Tables</code><span>.. إلخ). ده نادرًا ما بيتغير.</span></p></li><li><p><code>database/</code><span>: ده الـ </span><code>component</code><span> المسئول عن قاعدة البيانات (</span><code>RDS instance</code><span>, </span><code>Security Groups</code><span>.. إلخ).</span></p></li><li><p><code>web-app/</code><span>: ده الـ </span><code>component</code><span> بتاع الأبلكيشن نفسه (</span><code>EC2 instances</code><span>, </span><code>Load Balancer</code><span>.. إلخ). ده أكتر حاجة بتتغير.</span></p></li></ul></li></ul></li></ol><p><strong><span>ليه التقسيمة دي كويسة؟</span></strong></p><ul><li><p><strong><code>Isolation</code><span> قوي:</span></strong><span> كل </span><code>component</code><span> في كل </span><code>environment</code><span> ليه الـ </span><code>state file</code><span> بتاعه. فلو أنت بتعدل في الـ </span><code>web-app</code><span> بتاع الـ </span><code>staging</code><span>، مستحيل بالغلط تبوظ الـ </span><code>VPC</code><span> أو الـ </span><code>database</code><span> حتى لو في نفس الـ </span><code>environment</code><span>.</span></p></li><li><p><strong><span>أمان:</span></strong><span> لو حصل </span><code>destroy</code><span> بالغلط، هيمسح </span><code>component</code><span> واحد بس (زي الـ </span><code>web-app</code><span>) مش السيستم كله.</span></p></li><li><p><strong><span>سرعة:</span></strong><span> لما تيجي تعمل </span><code>terraform plan</code><span> أو </span><code>apply</code><span>، </span><code>Terraform</code><span> هيبص على عدد قليل من الـ </span><code>resources</code><span> (بتاعة الـ </span><code>component</code><span> ده بس)، فبيبقى أسرع بكتير.</span></p></li></ul></div><p><span>كمثال، بعد ما بتظبط الـ </span><code>network topology</code><span> الأساسية للـ </span><code>infrastructure</code><span> بتاعتك — أو زي ما بنقولها</span>
<span> بالـ </span><code>AWS lingo</code><span>: الـ </span><code>Virtual Private Cloud (VPC)</code><span> وكل الـ </span><code>subnets</code><span> والـ </span><code>routing rules</code><span> والـ </span><code>VPNs</code><span> والـ </span><code>network ACLs</code><span> اللي تبعها — أنت غالبًا هتغيرها مرة كل كام شهر بالكتير. على الناحية التانية، أنت ممكن تعمل </span><code>deploy</code><span> لـ </span><code>version</code><span> جديدة من </span><code>web server</code><span> كذا مرة في اليوم الواحد. لو أنت بتعمل </span><code>manage</code><span> للـ </span><code>infrastructure</code><span> بتاعت الـ </span><code>VPC component</code><span> والـ </span><code>web server component</code><span> في نفس مجموعة الـ </span><code>Terraform configurations</code><span>، يبقى أنت كده بتعرّض الـ </span><code>network topology</code><span> بتاعتك كلها لخطر إنها تبوظ (مثلاً بسبب </span><code>typo</code><span> بسيط في الكود أو حد بالغلط عمل </span><code>run</code><span> لكوماند غلط) كذا مرة في اليوم بدون أي داعي.</span></p><div class="md-alert md-alert-tip tip"><p><span class='md-alert-text md-alert-text-tip'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>Tip</span><br></p><p>&nbsp;</p><p><span>الـ </span><strong><code>AWS Lingo</code></strong><span> هو مصطلح عامي بيتقال على مجموعة الأسماء والمصطلحات الخاصة اللي شركة </span><code>AWS</code><span> بتستخدمها عشان توصف الخدمات بتاعتها. كل خدمة سحابية ليها &quot;لغة&quot; أو </span><code>lingo</code><span> خاصة بيها، و </span><code>AWS</code><span> ليها أشهر </span><code>lingo</code><span> في السوق.</span></p><p><strong><span>مثال:</span></strong><span> بدل ما نقول &quot;سيرفر&quot;، في </span><code>AWS lingo</code><span> بنقول </span><code>EC2 Instance</code><span>. بدل ما نقول &quot;object storage&quot;، بنقول </span><code>S3 Bucket</code><span>. وبدل ما نقول &quot;virtual network&quot;، بنقول </span><code>VPC</code><span>.</span></p><p><span>فالمقصود بالجملة دي هو &quot;زي ما بنسميها بلغة AWS&quot; أو &quot;بالمصطلحات اللي AWS بتستخدمها&quot;. فهم الـ </span><code>lingo</code><span> ده ضروري لأي حد بيشتغل على </span><code>AWS cloud</code><span>.</span></p></div><p>&nbsp;</p><p><span>عشان كده، أنا بنصح إنك تستخدم </span><code>Terraform folders</code><span> منفصلة (وبالتالي </span><code>state files</code><span> منفصلة) لكل </span><code>environment</code><span> (زي </span><code>staging</code><span>, </span><code>production</code><span>, وغيرهم) ولكل </span><code>component</code><span> (زي </span><code>VPC</code><span>, </span><code>services</code><span>, </span><code>databases</code><span>) جوه الـ </span><code>environment</code><span> دي. وعشان نشوف ده شكله إيه على أرض الواقع، خلينا نمشي على الـ </span><code>file layout</code><span> اللي بنصح بيه للـ </span><code>Terraform projects</code><span>.</span></p><p><span>شكل 3-7 بيوضح الـ </span><code>file layout</code><span> اللي أنا بستخدمه في أي </span><code>Terraform project</code><span> عادةً.</span></p><p><img src="imgs/image-20250703190224536.png" referrerpolicy="no-referrer" alt="image-20250703190224536"></p><p><span>على أعلى مستوى، فيه فولدرات منفصلة لكل </span><code>environment</code><span>. الـ </span><code>environments</code><span> بالظبط بتختلف من مشروع للتاني، بس أشهرهم هما دول:</span></p><ul><li><p><strong><code>stage</code></strong>
<span>ده </span><code>environment</code><span> للحاجات اللي قبل الـ </span><code>production</code><span> (يعني للـ </span><code>testing</code><span>).</span></p></li><li><p><strong><code>prod</code></strong>
<span>ده </span><code>environment</code><span> للحاجات الـ </span><code>production</code><span> (يعني الأبلكيشنز اللي الـ </span><code>users</code><span> بيستخدموها).</span></p></li><li><p><strong><code>mgmt</code></strong>
<span>ده </span><code>environment</code><span> للـ </span><code>DevOps tooling</code><span> (زي الـ </span><code>bastion host</code><span> أو الـ </span><code>CI server</code><span>).</span></p></li><li><p><strong><code>global</code></strong>
<span>ده مكان تحط فيه الـ </span><code>resources</code><span> اللي كل الـ </span><code>environments</code><span> بتستخدمها (زي </span><code>S3</code><span> أو </span><code>IAM</code><span>).</span></p><div class="md-alert md-alert-note note"><p><span class='md-alert-text md-alert-text-note'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</span><br></p><p><span>s3 اللي مقصوده هنا هي الخاصة بي backend المفروض تكون مشتركة </span></p></div><p>&nbsp;</p></li></ul><p><span>جوه كل </span><code>environment</code><span>، فيه فولدرات منفصلة لكل </span><code>component</code><span>. الـ </span><code>components</code><span> برضه بتختلف من مشروع للتاني، بس أشهرهم هما دول:</span></p><ul><li><p><strong><code>vpc</code></strong>
<span>الـ </span><code>network topology</code><span> بتاعة الـ </span><code>environment</code><span> دي.</span></p></li><li><p><strong><code>services</code></strong>
<span>الأبلكيشنز أو الـ </span><code>microservices</code><span> اللي هتشتغل في الـ </span><code>environment</code><span> دي، زي مثلاً </span><code>frontend</code><span> معمول بـ </span><code>Ruby on Rails</code><span> أو </span><code>backend</code><span> معمول بـ </span><code>Scala</code><span>. وكل أبلكيشن ممكن كمان يبقى ليه الفولدر الخاص بيه عشان تفصله عن باقي الأبلكيشنز.</span></p></li></ul><p>&nbsp;</p><ul><li><p><strong><code>data-storage</code></strong>
<span>الـ </span><code>data stores</code><span> اللي هتشتغل في الـ </span><code>environment</code><span> دي، زي </span><code>MySQL</code><span> أو </span><code>Redis</code><span>. وكل </span><code>data store</code><span> ممكن يبقى ليه الفولدر الخاص بيه عشان تفصله عن باقي الـ </span><code>data stores</code><span>.</span></p></li></ul><div class="md-alert md-alert-note note"><p><span class='md-alert-text md-alert-text-note'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</span><br></p><p><span>هنا حط الحجات الخاصة بيـ</span><code>network topology</code><span> سواء subnet ولا  acl وغيرها الهدف ان لو باظ state file فى واحد ميأثرش على الباقي وبينظم الشغل وبيخلي كل واحد عارف دوره فى team</span></p></div><p><span>وجوه كل </span><code>component</code><span>، هنلاقي بقى الـ </span><code>Terraform configuration files</code><span> نفسها، ودي بتكون مترتبة حسب أسماء متفق عليها (naming conventions) زي كده:</span></p><ul><li><p><strong><code>variables.tf</code></strong>
<span>الـ </span><code>Input variables</code><span>.</span></p></li><li><p><strong><code>outputs.tf</code></strong>
<span>الـ </span><code>Output variables</code><span>.</span></p></li><li><p><code>backend.tf</code></p><p><span>اد بتحط فيه backend الخاص بterraform سواء كان local  او terraform</span></p></li><li><p><strong><code>main.tf</code></strong>
<span>الـ </span><code>Resources</code><span> والـ </span><code>data sources</code><span>.</span></p></li></ul><p><span>لما بتعمل </span><code>run</code><span> لـ </span><code>Terraform</code><span>، هو ببساطة بيدور على أي ملفات في الفولدر الحالي آخرها </span><code>.tf</code><span>، فمن ناحيته أنت ممكن تسمي الملفات أي اسم يعجبك. بس خد بالك، يمكن </span><code>Terraform</code><span> ميهتمش بأسماء الملفات، بس زمايلك في الفريق غالبًا هيهتموا. استخدام أسماء متوقعة وثابتة بيخلي الكود بتاعك سهل تصفحه: يعني مثلاً هتبقى عارف دايمًا تبص فين عشان تلاقي </span><code>variable</code><span> أو </span><code>output</code><span> أو </span><code>resource</code><span>.</span></p><p><span>لاحظ إن الـ </span><code>convention</code><span> اللي فاتت دي هي أقل </span><code>convention</code><span> المفروض تمشي عليها، لإن في كل استخدامات </span><code>Terraform</code><span> تقريبًا، بيبقى مفيد جدًا إنك تقدر توصل للـ </span><code>input variables</code><span> والـ </span><code>output variables</code><span> والـ </span><code>resources</code><span> بسرعة. بس أنت ممكن تزود على الـ </span><code>convention</code><span> دي. دي مجرد أمثلة:</span></p><ul><li><p><strong><code>dependencies.tf</code></strong>
<span>من الشائع إنك تحط كل الـ </span><code>data sources</code><span> بتاعتك في ملف اسمه </span><code>dependencies.tf</code><span> عشان يبقى سهل تشوف الكود ده معتمد على إيه من بره.</span></p></li><li><p><strong><code>providers.tf</code></strong>
<span>ممكن تحط الـ </span><code>provider blocks</code><span> بتاعتك في ملف </span><code>providers.tf</code><span> عشان تقدر تشوف بلمحة سريعة الكود ده بيكلم أنهي </span><code>providers</code><span> وإيه الـ </span><code>authentication</code><span> اللي هتحتاج توفره.</span></p></li><li><p><strong><code>main-xxx.tf</code></strong>
<span>لو ملف الـ </span><code>main.tf</code><span> بتاعك بقى طويل أوي لأنه فيه عدد كبير من الـ </span><code>resources</code><span>، ممكن تقسمه لملفات أصغر بتجمع الـ </span><code>resources</code><span> بطريقة منطقية. يعني مثلاً </span><code>main-iam.tf</code><span> ممكن يحتوي على كل الـ </span><code>IAM resources</code><span>، و </span><code>main-s3.tf</code><span> يحتوي على كل الـ </span><code>S3 resources</code><span>، وهكذا. استخدام الـ </span><code>prefix</code><span> اللي هو </span><code>main-</code><span> بيخلي تصفح قايمة الملفات في الفولدر أسهل لما بتترتب أبجديًا، لإن كل الـ </span><code>resources</code><span> هتتجمع تحت بعضها. ومن الجدير بالذكر برضه، لو لقيت نفسك بتعمل </span><code>manage</code><span> لعدد ضخم من الـ </span><code>resources</code><span> وبتعاني عشان تقسمهم على ملفات كتير، دي ممكن تكون علامة إنك المفروض تقسم الكود بتاعك لـ </span><code>modules</code><span> أصغر بدل كده، وده موضوع هنتكلم فيه بالتفصيل في الفصل الرابع.</span></p></li></ul><p><span>دلوقتي، خلينا ناخد كود الـ </span><code>web server cluster</code><span> اللي كتبته في الفصل التاني، ومعاه كود الـ </span><code>Amazon S3</code><span> والـ </span><code>DynamoDB</code><span> اللي كتبته في الفصل ده، ونعيد ترتيبهم باستخدام الـ </span><code>folder structure</code><span> اللي في شكل 3-8.</span></p><p><img src="imgs/image-20250703195418639.png" referrerpolicy="no-referrer" alt="image-20250703195418639"></p><p>&nbsp;</p><p><span>الـ </span><code>S3 bucket</code><span> اللي عملته في الفصل ده المفروض يتنقل للفولدر </span><code>global/s3</code><span>. انقل</span>
<span> الـ </span><code>output variables</code><span> (اللي هما </span><code>s3_bucket_arn</code><span> و </span><code>dynamodb_table_name</code><span>) لملف </span><code>outputs.tf</code><span>. وانت بتنقل الفولدر، خلي بالك كويس متنساش الفولدر المخفي (</span><code>.terraform</code><span>) وانت بتعمل </span><code>copy</code><span> للملفات في المكان الجديد عشان متضطرش تعمل </span><code>reinitialize</code><span> لكل حاجة من الأول.</span></p><p><span>الـ </span><code>web server cluster</code><span> اللي عملته في الفصل التاني المفروض يتنقل لـ </span><code>stage/services/webserver-cluster</code><span> (اعتبر دي نسخة الـ &quot;testing&quot; أو الـ &quot;staging&quot; من الـ </span><code>web server cluster</code><span> ده؛ أنت هتضيف نسخة &quot;production&quot; في الفصل اللي جاي). مرة تانية، اتأكد إنك تعمل </span><code>copy</code><span> لفولدر </span><code>.terraform</code><span>، وتنقل الـ </span><code>input variables</code><span> لملف </span><code>variables.tf</code><span>، والـ </span><code>output variables</code><span> لملف </span><code>outputs.tf</code><span>.</span></p><p><span>المفروض كمان تعمل </span><code>update</code><span> للـ </span><code>web server cluster</code><span> عشان يستخدم </span><code>S3</code><span> كـ </span><code>backend</code><span>. ممكن تاخد الـ </span><code>backend config</code><span> من </span><code>global/s3/main.tf</code><span> وتعملها </span><code>copy-paste</code><span> زي ما هي تقريبًا، </span><strong><span>بس اتأكد إنك تغير الـ </span><code>key</code></strong><span> عشان يبقى نفس الـ </span><code>path</code><span> بتاع فولدر كود الـ Terraform ده: </span><code>stage/services/webserver-cluster/terraform.tfstate</code><span>. ده بيديلك تطابق 1 لـ 1 بين شكل كود الـ </span><code>Terraform</code><span> بتاعك في الـ </span><code>version control</code><span> وبين الـ </span><code>Terraform state files</code><span> بتاعتك في </span><code>S3</code><span>، فبيبقى واضح جدًا إزاي الاتنين مرتبطين ببعض. الـ </span><code>s3 module</code><span> أصلًا بيظبط الـ </span><code>key</code><span> بالـ </span><code>convention</code><span> دي.</span></p><p><span>الـ </span><code>file layout</code><span> ده ليه مميزات كتير:</span></p><ul><li><p><strong><code>Clear code / environment layout</code><span> (شكل واضح للكود والـ environment):</span></strong>
<span>سهل إنك تتصفح الكود وتفهم بالظبط إيه الـ </span><code>components</code><span> اللي معمولة </span><code>deploy</code><span> في كل </span><code>environment</code><span>.</span></p></li><li><p><strong><code>Isolation</code><span> (العزل):</span></strong>
<span>الـ </span><code>layout</code><span> ده بيوفر قدر كويس من الـ </span><code>isolation</code><span> بين الـ </span><code>environments</code><span> وبين الـ </span><code>components</code><span> جوه نفس الـ </span><code>environment</code><span>، وده بيضمن إن لو حاجة باظت، الضرر يبقى محكوم على قد ما نقدر في جزء صغير بس من الـ </span><code>infrastructure</code><span> بتاعتك كلها.</span></p></li></ul><p><span>من ناحية تانية، المميزات دي ممكن تعتبر عيوب برضه:</span></p><ul><li><p><strong><code>Working with multiple folders</code><span> (الشغل مع فولدرات كتير):</span></strong>
<span>تقسيم الـ </span><code>components</code><span> في فولدرات منفصلة بيحميك من إنك تبوظ الـ </span><code>infrastructure</code><span> كلها بكوماند واحد بالغلط، بس في نفس الوقت بيمنعك من إنك تعمل </span><code>create</code><span> للـ </span><code>infrastructure</code><span> كلها بكوماند واحد. يعني لو كل الـ </span><code>components</code><span> بتاعت </span><code>environment</code><span> واحدة كانت في </span><code>Terraform configuration</code><span> واحد، كنت ممكن تعمل </span><code>spin up</code><span> لـ </span><code>environment</code><span> كاملة بـ </span><code>call</code><span> واحدة لـ </span><code>terraform apply</code><span>. لكن لو الـ </span><code>components</code><span> في فولدرات منفصلة، يبقى لازم تعمل </span><code>run</code><span> لـ </span><code>terraform apply</code><span> في كل فولدر لوحده.</span></p><p><strong><span>الحل:</span></strong><span> لو بتستخدم </span><code>Terragrunt</code><span>، ممكن تعمل </span><code>run</code><span> للكوماندات على كذا فولدر في نفس الوقت باستخدام كوماند </span><code>run-all</code><span>.</span></p></li><li><p><strong><code>Copy/paste</code><span> :</span></strong>
<span>الـ </span><code>file layout</code><span> المشروح في الجزء ده فيه تكرار كتير. يعني مثلاً، نفس الـ </span><code>frontend-app</code><span> والـ </span><code>backend-app</code><span> موجودين في فولدرات </span><code>stage</code><span> و </span><code>prod</code><span>.</span></p><p><strong><span>الحل:</span></strong><span> أنت في الحقيقة مش هتحتاج تعمل </span><code>copy-paste</code><span> لكل الكود ده! في الفصل الرابع، هتشوف إزاي تستخدم </span><code>Terraform modules</code><span> عشان تخلي الكود ده كله </span><code>DRY</code><span> (اختصار لـ </span><code>Don&#39;t Repeat Yourself</code><span>، يعني متكررش نفسك).</span></p></li><li><p><strong><code>Resource dependencies</code><span> (dependencies بين الـ Resources):</span></strong>
<span>تقسيم الكود على فولدرات كتير بيصعّب استخدام الـ </span><code>resource dependencies</code><span>. لو كود الأبلكيشن بتاعك موجود في نفس الـ </span><code>Terraform configuration files</code><span> مع كود الـ </span><code>database</code><span>، كود الأبلكيشن كان هيقدر يوصل للـ </span><code>attributes</code><span> بتاعت الـ </span><code>database</code><span> مباشرة باستخدام </span><code>attribute reference</code><span> (زي إنه ياخد عنوان الـ </span><code>database</code><span> عن طريق </span><code>aws_db_instance.foo.address</code><span>). لكن لو كود الأبلكيشن وكود الـ </span><code>database</code><span> في فولدرات مختلفة، زي ما أنا نصحت، مش هتقدر تعمل كده.</span></p><p><strong><span>الحل:</span></strong><span> فيه حل من اتنين. الأول إنك تستخدم </span><code>dependency blocks</code><span> في </span><code>Terragrunt</code><span> زي ما هتشوف في الفصل العاشر. الحل التاني إنك تستخدم الـ </span><code>data source</code><span> اللي اسمه </span><code>terraform_remote_state</code><span>، وده اللي هنشرحه في الجزء الجاي.</span></p></li></ul><p>&nbsp;</p><h2 id='الـ-data-source-اللي-اسمه-terraformremotestate'><strong><span>الـ </span><code>data source</code><span> اللي اسمه </span><code>terraform_remote_state</code></strong></h2><p><span>في الفصل التاني، أنت استخدمت الـ </span><code>data sources</code><span> عشان تجيب معلومات </span><code>read-only</code><span> من </span><code>AWS</code><span>، زي الـ </span><code>aws_subnets</code><span>  اللي كان بيرجعلك </span><code>list</code><span> بالـ </span><code>subnets</code><span> اللي في الـ </span><code>VPC</code><span> بتاعتك. فيه </span><code>data source</code><span> تاني مفيد أوي لما بتتعامل مع الـ </span><code>state</code><span>: اسمه </span><strong><code>terraform_remote_state</code></strong><span>. أنت ممكن تستخدم الـ </span><code>data source</code><span> ده عشان تجيب الـ </span><code>Terraform state file</code><span> اللي متخزن عن طريق مجموعة تانية من الـ </span><code>Terraform configurations</code><span>.</span></p><p><span>خلينا ناخد مثال. تخيل إن الـ </span><code>web server cluster</code><span> بتاعك محتاج يكلم </span><code>MySQL database</code><span>. إنك تشغل </span><code>database</code><span> تكون </span><code>scalable</code><span>، و</span><code>secure</code><span>، و</span><code>durable</code><span>، و</span><code>highly available</code><span> دي شغلانة كبيرة. مرة تانية، أنت ممكن تخلي </span><code>AWS</code><span> هي اللي تشيل الشغلانة دي عنك، المرة دي عن طريق إنك تستخدم خدمة </span><code>Amazon</code><span> اللي اسمها </span><code>Relational Database Service</code><span> (أو </span><code>RDS</code><span>)، زي ما هو واضح في شكل 3-9. خدمة </span><code>RDS</code><span> بتدعم أنواع </span><code>databases</code><span> كتير، زي </span><code>MySQL</code><span>، و</span><code>PostgreSQL</code><span>، و</span><code>SQL Server</code><span>، و</span><code>Oracle</code><span>.</span></p><p><span>أنت ممكن متكونش عايز تعمل </span><code>define</code><span> للـ </span><code>MySQL database</code><span> في نفس مجموعة الـ </span><code>configuration files</code><span> بتاعت الـ </span><code>web server cluster</code><span>، لإنك هتعمل </span><code>deploy</code><span> لـ </span><code>updates</code><span> على الـ </span><code>web server cluster</code><span> أكتر بكتير، ومش عايز تاخد الـ </span><code>risk</code><span> إنك تبوظ الـ </span><code>database</code><span> بالغلط كل مرة بتعمل فيها كده.</span></p><p><img src="imgs/image-20250703203051429.png" referrerpolicy="no-referrer" alt="image-20250703203051429"></p><p><img src="imgs/image-20250703203109873.png" referrerpolicy="no-referrer" alt="image-20250703203109873"></p><p><span>بعد كده، هنعمل الـ </span><code>resources</code><span> بتاعة الـ </span><code>database</code><span> في الملف</span>
<span> </span><code>stage/data-stores/mysql/main.tf</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">provider</span> <span class="cm-string">"aws"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">region</span> <span class="cm-operator">=</span> <span class="cm-string">"us-east-2"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_db_instance"</span> <span class="cm-string">"example"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">identifier_prefix</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"terraform-up-and-running"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">engine</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"mysql"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">allocated_storage</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-number">10</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">instance_class</span> &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"db.t2.micro"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">skip_final_snapshot</span> <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">db_name</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"example_database"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">username</span> <span class="cm-operator">=</span> <span class="cm-string">"???"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">password</span> <span class="cm-operator">=</span> <span class="cm-string">"???"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 358px;"></div><div class="CodeMirror-gutters" style="display: none; height: 358px;"></div></div></div></pre><p><span>في أول الملف، هتلاقي الـ </span><code>provider block</code><span> العادي، بس تحته على طول فيه </span><code>resource</code><span> جديد: </span><code>aws_db_instance</code><span>. الـ </span><code>resource</code><span> ده بيعمل </span><code>create</code><span> لـ </span><code>database</code><span> على </span><code>RDS</code><span> بالإعدادات دي:</span></p><ul><li><p><code>MySQL</code><span> كـ </span><code>database engine</code><span>.</span></p></li><li><p><code>10 GB</code><span> مساحة تخزين.</span></p></li><li><p><code>Instance</code><span> من نوع </span><code>db.t2.micro</code><span>، وده فيه </span><code>virtual CPU</code><span> واحد، و </span><code>1 GB</code><span> ميموري، وهو جزء من الـ </span><code>AWS Free Tier</code><span>.</span></p></li><li><p><span>الـ </span><code>final snapshot</code><span> مقفول، لإن الكود ده مجرد للتعلم والـ </span><code>testing</code><span> (لو معملتش </span><code>disable</code><span> للـ </span><code>snapshot</code><span>، أو مدخلتش اسم للـ </span><code>snapshot</code><span> عن طريق الـ </span><code>parameter</code><span> اللي اسمه </span><code>final_snapshot_identifier</code><span>، أمر </span><code>destroy</code><span> هيفشل).</span></p></li></ul><p><span>لاحظ إن فيه اتنين </span><code>parameters</code><span> لازم تبعتهم للـ </span><code>aws_db_instance resource</code><span> وهما الـ </span><code>master username</code><span> والـ </span><code>master password</code><span>. ولإن دول يعتبروا </span><code>secrets</code><span> (معلومات سرية)، المفروض متحطهمش في الكود بتاعك </span><code>plain text</code><span> كده على طول! في الفصل السادس، هنتكلم عن كذا طريقة عشان تتعامل مع الـ </span><code>secrets</code><span> بشكل آمن مع </span><code>Terraform</code><span>. دلوقتي، خلينا نستخدم طريقة سهلة وبتخلينا نتجنب تخزين أي </span><code>secrets</code><span> كـ </span><code>plain text</code><span>: إنك تخزن الـ </span><code>secrets</code><span> بتاعتك، زي باسووردات الـ </span><code>database</code><span>، بره </span><code>Terraform</code><span> خالص (مثلاً في </span><code>password manager</code><span> زي </span><code>1Password</code><span> أو </span><code>LastPass</code><span> أو </span><code>macOS Keychain</code><span>)، وتبعت الـ </span><code>secrets</code><span> دي لـ </span><code>Terraform</code><span> عن طريق الـ </span><code>environment variables</code><span>.</span></p><p><span>عشان نعمل كده، هنعمل </span><code>declare</code><span> لاتنين </span><code>variables</code><span> اسمهم </span><code>db_username</code><span> و </span><code>db_password</code><span> في الملف </span><code>stage/data-stores/mysql/variables.tf</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"db_username"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"The username for the database"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">string</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">sensitive</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">variable</span> <span class="cm-string">"db_password"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"The password for the database"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">string</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">sensitive</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 246px;"></div><div class="CodeMirror-gutters" style="display: none; height: 246px;"></div></div></div></pre><p><span>أولاً، لاحظ إن الـ </span><code>variables</code><span> دي متعلم عليها بـ </span><code>sensitive = true</code><span> عشان نقول إنها بتحتوي على </span><code>secrets</code><span>. ده بيضمن إن </span><code>Terraform</code><span> مش هيطبع القيم بتاعتها في الـ </span><code>log</code><span> لما تعمل </span><code>run</code><span> لـ </span><code>plan</code><span> أو </span><code>apply</code><span>. ثانياً، لاحظ إن الـ </span><code>variables</code><span> دي مالهاش </span><code>default</code><span>. وده مقصود. المفروض متخزنش بيانات الـ </span><code>database</code><span> بتاعتك أو أي معلومات حساسة </span><code>plain text</code><span>. بدل كده، إحنا هنحدد قيمة الـ </span><code>variables</code><span> دي باستخدام الـ </span><code>environment variables</code><span>.</span></p><p><span>قبل ما نعمل كده، خلينا نخلص الكود. أولاً، هنمرر الاتنين </span><code>input variables</code><span> الجداد دول للـ </span><code>aws_db_instance resource</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_db_instance"</span> <span class="cm-string">"example"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">identifier_prefix</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"terraform-up-and-running"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">engine</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"mysql"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">allocated_storage</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-number">10</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">instance_class</span> &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"db.t2.micro"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">skip_final_snapshot</span> <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">db_name</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"example_database"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">username</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">db_username</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">password</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">db_password</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 246px;"></div><div class="CodeMirror-gutters" style="display: none; height: 246px;"></div></div></div></pre><p><span>بعد كده، هنعمل </span><code>configure</code><span> للـ </span><code>component</code><span> ده عشان يخزن الـ </span><code>state</code><span> بتاعه في الـ </span><code>S3 bucket</code><span> اللي عملناه قبل كده على الـ </span><code>path</code><span> ده: </span><code>stage/data-stores/mysql/terraform.tfstate</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">terraform</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">backend</span> <span class="cm-string">"s3"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># غير ده لاسم الـ bucket بتاعك!</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">bucket</span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"terraform-up-and-running-state"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">key</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"stage/data-stores/mysql/terraform.tfstate"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">region</span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"us-east-2"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># غير ده لاسم الـ DynamoDB table بتاعك!</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">dynamodb_table</span> <span class="cm-operator">=</span> <span class="cm-string">"terraform-up-and-running-locks"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">encrypt</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 269px;"></div><div class="CodeMirror-gutters" style="display: none; height: 269px;"></div></div></div></pre><p><span>أخيراً، هنضيف اتنين </span><code>output variables</code><span> في الملف </span><code>stage/data-stores/mysql/outputs.tf</code><span> عشان نرجع الـ </span><code>address</code><span> والـ </span><code>port</code><span> بتوع الـ </span><code>database</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"address"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">aws_db_instance</span><span class="cm-operator">.</span><span class="cm-property">example</span><span class="cm-operator">.</span><span class="cm-property">address</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"Connect to the database at this endpoint"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"port"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">aws_db_instance</span><span class="cm-operator">.</span><span class="cm-property">example</span><span class="cm-operator">.</span><span class="cm-property">port</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">description</span> <span class="cm-operator">=</span> <span class="cm-string">"The port the database is listening on"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 202px;"></div><div class="CodeMirror-gutters" style="display: none; height: 202px;"></div></div></div></pre><p><span>دلوقتي أنت جاهز تدخل الـ </span><code>username</code><span> والـ </span><code>password</code><span> بتوع الـ </span><code>database</code><span> باستخدام الـ </span><code>environment variables</code><span>. كـتذكرة، لكل </span><code>input variable</code><span> اسمه </span><code>foo</code><span> متعرف في الـ </span><code>Terraform configurations</code><span> بتاعتك، أنت ممكن تدي </span><code>Terraform</code><span> القيمة بتاعته عن طريق </span><code>environment variable</code><span> اسمه </span><code>TF_VAR_foo</code><span>. بالنسبة للـ </span><code>input variables</code><span> اللي هما </span><code>db_username</code><span> و </span><code>db_password</code><span>، دي الطريقة اللي تحدد بيها الـ </span><code>environment variables</code><span> اللي هما </span><code>TF_VAR_db_username</code><span> و </span><code>TF_VAR_db_password</code><span> على أنظمة Linux/Unix/macOS:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$ export</span> <span class="cm-def">TF_VAR_db_username</span><span class="cm-operator">=</span><span class="cm-string">"(YOUR_DB_USERNAME)"</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$ export</span> <span class="cm-def">TF_VAR_db_password</span><span class="cm-operator">=</span><span class="cm-string">"(YOUR_DB_PASSWORD)"</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="display: none; height: 45px;"></div></div></div></pre><p><span>ودي الطريقة على أنظمة Windows:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$ set</span> <span class="cm-def">TF_VAR_db_username</span><span class="cm-operator">=</span><span class="cm-string">"(YOUR_DB_USERNAME)"</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$ set</span> <span class="cm-def">TF_VAR_db_password</span><span class="cm-operator">=</span><span class="cm-string">"(YOUR_DB_PASSWORD)"</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="display: none; height: 45px;"></div></div></div></pre><p><span>اعمل </span><code>run</code><span> لـ </span><code>terraform init</code><span> و </span><code>terraform apply</code><span> عشان تعمل </span><code>create</code><span> للـ </span><code>database</code><span>. خد بالك إن </span><code>Amazon RDS</code><span> ممكن ياخد حوالي 10 دقايق عشان يعمل </span><code>provision</code><span> حتى لو لـ </span><code>database</code><span> صغيرة، فخليك صبور. بعد ما الـ </span><code>apply</code><span> يخلص، المفروض تشوف الـ </span><code>outputs</code><span> دي في الـ </span><code>terminal</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">$ terraform apply</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(...)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Apply complete! Resources: 1 added, 0 changed, 0 destroyed.</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Outputs:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">address = "terraform-up-and-running.cowu6mts6srx.us-east-2.rds.amazonaws.com"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">port = 3306</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 202px;"></div><div class="CodeMirror-gutters" style="display: none; height: 202px;"></div></div></div></pre><p><span>الـ </span><code>outputs</code><span> دي دلوقتي متخزنة كمان في الـ </span><code>Terraform state</code><span> بتاع الـ </span><code>database</code><span>، اللي موجود في الـ </span><code>S3 bucket</code><span> بتاعك على الـ </span><code>path</code><span> ده: </span><code>stage/data-stores/mysql/terraform.tfstate</code><span>.</span></p><p><span>لو رجعت لكود الـ </span><code>web server cluster</code><span> بتاعك، ممكن تخلي الـ </span><code>web server</code><span> يقرأ الـ </span><code>outputs</code><span> دي من الـ </span><code>state file</code><span> بتاع الـ </span><code>database</code><span> عن طريق إنك تضيف الـ </span><code>terraform_remote_state</code><span> </span><code>data source</code><span> في الملف </span><code>stage/services/webserver-cluster/main.tf</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">data</span> <span class="cm-string">"terraform_remote_state"</span> <span class="cm-string">"db"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">backend</span> <span class="cm-operator">=</span> <span class="cm-string">"s3"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">config</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">bucket</span> <span class="cm-operator">=</span> <span class="cm-string">"(YOUR_BUCKET_NAME)"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">key</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"stage/data-stores/mysql/terraform.tfstate"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">region</span> <span class="cm-operator">=</span> <span class="cm-string">"us-east-2"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 202px;"></div><div class="CodeMirror-gutters" style="display: none; height: 202px;"></div></div></div></pre><p><span>الـ </span><code>terraform_remote_state</code><span> </span><code>data source</code><span> ده بيعمل </span><code>configure</code><span> لكود الـ </span><code>web server cluster</code><span> عشان يقرأ الـ </span><code>state file</code><span> من نفس الـ </span><code>S3 bucket</code><span> والفولدر اللي الـ </span><code>database</code><span> بتخزن الـ </span><code>state</code><span> بتاعها فيه، زي ما هو واضح في شكل 3-11.</span></p><div class="md-alert md-alert-important important"><p><span class='md-alert-text md-alert-text-important'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Important</span><br></p><p><span>على فكرة ممكن تكون local انا عامل كده </span></p><p><span>global موجود فى fstate file بروح اقراءه عشان اعرف bucket و region و key المفروض هو المكان fstate بتاع database</span>
<span>ملحوظة مش بتحط lock اللي هو هنا dynamodb_table ليه ؟ لان هنا فقط انا بعمل عملية قراءة انك تحط lock ملوش لازمة لان  race condition بيحصل فى write بس انما read لاء</span></p></div><p>&nbsp;</p><p>&nbsp;</p><p><img src="imgs/image-20250703213241833.png" referrerpolicy="no-referrer" alt="image-20250703213241833"></p><p>&nbsp;</p><p><span>مهم أوي إنك تفهم إن، زي كل الـ </span><code>data sources</code><span> في </span><code>Terraform</code><span>، الداتا اللي بترجع من </span><code>terraform_remote_state</code><span> بتبقى </span><strong><code>read-only</code><span> (للقراءة فقط)</span></strong><span>. يعني أي حاجة بتعملها في كود </span><code>Terraform</code><span> بتاع الـ </span><code>web server cluster</code><span> مستحيل تعدّل في الـ </span><code>state</code><span> ده، فتقدر تسحب الداتا بتاعة الـ </span><code>state</code><span> بتاع الـ </span><code>database</code><span> وانت متطمن ومش هتسبب أي مشاكل في الـ </span><code>database</code><span> نفسها.</span></p><p><span>كل الـ </span><code>output variables</code><span> بتاعت الـ </span><code>database</code><span> متخزنة في الـ </span><code>state file</code><span>، وأنت تقدر تقراها من الـ </span><code>terraform_remote_state</code><span> </span><code>data source</code><span> باستخدام </span><code>attribute reference</code><span> بالشكل ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">data.terraform_remote_state.&lt;NAME&gt;.outputs.&lt;ATTRIBUTE&gt;</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>كمثال، دي الطريقة اللي ممكن تعمل بيها </span><code>update</code><span> للـ </span><code>User Data</code><span> بتاع الـ </span><code>Instances</code><span> في الـ </span><code>web server cluster</code><span> عشان تسحب عنوان وبورت الـ </span><code>database</code><span> من الـ </span><code>terraform_remote_state</code><span> </span><code>data source</code><span> وتعرض المعلومات دي في الـ </span><code>HTTP response</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">user_data</span> <span class="cm-operator">=</span> <span class="cm-string">&lt;&lt;EOF</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">#!/bin/bash</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">echo "Hello, World" &gt;&gt; index.html</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">echo "${data.terraform_remote_state.db.outputs.address}" &gt;&gt; index.html</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">echo "${data.terraform_remote_state.db.outputs.port}" &gt;&gt; index.html</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">nohup busybox httpd -f -p ${var.server_port} &amp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">EOF</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 157px;"></div><div class="CodeMirror-gutters" style="display: none; height: 157px;"></div></div></div></pre><div class="md-alert md-alert-warning warning"><p><span class='md-alert-text md-alert-text-warning'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Warning</span><br></p><p><span>خد بالك الله يرضى عليك دا معناها ان global لازم تتنشاء الاول وبعدها Database و بعدها webserver</span>
<span>مينفعش تعمل بره الترتيب ده طب السؤال </span>
<span>مش كده انا معرض للخطاء البشري ؟ هقولك اه </span>
<span>اصبر على الفصل 10 تشوف Terragrunt بتحلها ازاي</span></p></div><p><span>بما إن الـ </span><code>User Data script</code><span> بقى بيطول، إنك تكتبه </span><code>inline</code><span> (جوه الكود مباشرة) بقى بيخلي شكل الكود وحش ومش منظم. بشكل عام، إنك تدمج لغة برمجة (</span><code>Bash</code><span>) جوه لغة تانية (</span><code>Terraform</code><span>) بيصعّب الـ </span><code>maintenance</code><span> بتاعت كل واحدة فيهم، فخلينا نقف هنا لحظة ونطلع الـ </span><code>Bash script</code><span> ده في ملف خارجي. عشان نعمل كده، ممكن نستخدم </span><code>built-in function</code><span> (دالة مدمجة) اسمها </span><strong><code>templatefile</code></strong><span>.</span></p><p><code>Terraform</code><span> فيه شوية </span><code>built-in functions</code><span> ممكن تشغلها باستخدام </span><code>expression</code><span> بالشكل ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">function_name(...)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>كمثال، شوف الـ </span><code>function</code><span> اللي اسمها </span><code>format</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">format(&lt;FMT&gt;, &lt;ARGS&gt;, ...)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>الـ </span><code>function</code><span> دي بتعمل </span><code>format</code><span> للـ </span><code>arguments</code><span> اللي في </span><code>ARGS</code><span> حسب الـ </span><code>syntax</code><span> بتاع </span><code>sprintf</code><span> اللي في الـ </span><code>string</code><span> اللي اسمه </span><code>FMT</code><span>. أحسن طريقة تجرب بيها الـ </span><code>built-in functions</code><span> هي إنك تشغل كوماند </span><code>terraform console</code><span> عشان يفتحلك </span><code>interactive console</code><span> (شاشة أوامر تفاعلية) تقدر تجرب فيها الـ </span><code>syntax</code><span> بتاع </span><code>Terraform</code><span>، وتسأل عن الـ </span><code>state</code><span> بتاعك، وتشوف النتيجة في ساعتها:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">$ terraform console</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&gt; format("%.3f", 3.14159265359)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">3.142</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 67px;"></div><div class="CodeMirror-gutters" style="display: none; height: 67px;"></div></div></div></pre><p><span>خد بالك إن الـ </span><code>Terraform console</code><span> بتبقى </span><code>read-only</code><span>، فمتخافش من إنك تغير الـ </span><code>infrastructure</code><span> أو الـ </span><code>state</code><span> بالغلط.</span></p><p><span>فيه </span><code>built-in functions</code><span> تانية كتير ممكن تستخدمها عشان تتعامل مع الـ </span><code>strings</code><span> والأرقام والـ </span><code>lists</code><span> والـ </span><code>maps</code><span>. واحدة منهم هي الـ </span><code>templatefile function</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">templatefile(&lt;PATH&gt;, &lt;VARS&gt;)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>الـ </span><code>function</code><span> دي بتقرا الملف اللي في المسار </span><code>PATH</code><span>، وبتعمله </span><code>render</code><span> كـ </span><code>template</code><span>، وبترجع النتيجة كـ </span><code>string</code><span>. ولما أقول &quot;بتعمله </span><code>render</code><span> كـ </span><code>template</code><span>&quot;، قصدي إن الملف اللي في </span><code>PATH</code><span> يقدر يستخدم الـ </span><code>syntax</code><span> بتاع </span><code>string interpolation</code><span> بتاع </span><code>Terraform</code><span> اللي هو (</span><code>${...}</code><span>)، و</span><code>Terraform</code><span> هيملى الفراغات دي بالقيم من الـ </span><code>VARS</code><span>.</span></p><p><span>عشان تشوف ده عملي، حط محتويات الـ </span><code>User Data script</code><span> في ملف اسمه </span><code>stage/services/webserver-cluster/user-data.sh</code><span> بالشكل ده:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#!/bin/bash</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cat</span> &gt; index.html &lt;&lt;EOF</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&lt;h1&gt;Hello, World&lt;/h1&gt;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&lt;p&gt;DB address: <span class="cm-def">${db_address}</span>&lt;/p&gt;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&lt;p&gt;DB port: <span class="cm-def">${db_port}</span>&lt;/p&gt;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">EOF</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">nohup busybox httpd <span class="cm-attribute">-f</span> <span class="cm-attribute">-p</span> <span class="cm-def">${server_port}</span> &amp;</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 157px;"></div><div class="CodeMirror-gutters" style="display: none; height: 157px;"></div></div></div></pre><p><span>لاحظ إن الـ </span><code>Bash script</code><span> ده فيه شوية تغييرات عن الأصلي:</span></p><ul><li><p><span>هو بيدور على الـ </span><code>variables</code><span> باستخدام الـ </span><code>syntax</code><span> العادي بتاع </span><code>Terraform</code><span>، بس الفرق إن الـ </span><code>variables</code><span> الوحيدة اللي بيقدر يوصلها هي اللي أنت بتبعتها في الـ </span><code>parameter</code><span> التاني بتاع </span><code>templatefile</code><span> (زي ما هتشوف كمان شوية)، عشان كده مش محتاج تكتب أي </span><code>prefix</code><span> قبلها: يعني مثلاً تستخدم </span><code>${server_port}</code><span> مش </span><code>${var.server_port}</code><span>.</span></p></li><li><p><span>الـ </span><code>script</code><span> دلوقتي فيه شوية </span><code>HTML syntax</code><span> (زي </span><code>&lt;h1&gt;</code><span>) عشان يخلي شكل الـ </span><code>output</code><span> أحسن في الـ </span><code>web browser</code><span>.</span></p></li></ul><p><span>آخر خطوة هي إننا نعمل </span><code>update</code><span> للـ </span><code>parameter</code><span> اللي اسمه </span><code>user_data</code><span> في الـ </span><code>aws_launch_configuration resource</code><span> عشان ينادي على الـ </span><code>templatefile function</code><span> ويبعتلها الـ </span><code>variables</code><span> اللي محتاجها في شكل </span><code>map</code><span>:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.6302px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_launch_configuration"</span> <span class="cm-string">"example"</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">image_id</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"ami-0fb653ca2d3203ac1"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">instance_type</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-string">"t2.micro"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">security_groups</span> <span class="cm-operator">=</span> [<span class="cm-variable">aws_security_group</span><span class="cm-operator">.</span><span class="cm-property">instance</span><span class="cm-operator">.</span><span class="cm-property">id</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># نعمل Render للـ User Data script كـ template</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">user_data</span> <span class="cm-operator">=</span> <span class="cm-variable">templatefile</span>(<span class="cm-string">"user-data.sh"</span>, {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">server_port</span> <span class="cm-operator">=</span> <span class="cm-variable">var</span><span class="cm-operator">.</span><span class="cm-property">server_port</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">db_address</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">data</span><span class="cm-operator">.</span><span class="cm-property">terraform_remote_state</span><span class="cm-operator">.</span><span class="cm-property">db</span><span class="cm-operator">.</span><span class="cm-property">outputs</span><span class="cm-operator">.</span><span class="cm-property">address</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">db_port</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">data</span><span class="cm-operator">.</span><span class="cm-property">terraform_remote_state</span><span class="cm-operator">.</span><span class="cm-property">db</span><span class="cm-operator">.</span><span class="cm-property">outputs</span><span class="cm-operator">.</span><span class="cm-property">port</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  })</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># مطلوب لما بنستخدم launch configuration مع auto scaling group.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">lifecycle</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">create_before_destroy</span> <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 381px;"></div><div class="CodeMirror-gutters" style="display: none; height: 381px;"></div></div></div></pre><p><span>آه، كده شكلها أنضف بكتير من كتابة الـ </span><code>Bash scripts</code><span> جوه الكود مباشرة!</span></p><p><span>لو عملت </span><code>deploy</code><span> للـ </span><code>cluster</code><span> ده باستخدام </span><code>terraform apply</code><span>، واستنيت الـ </span><code>Instances</code><span> تسجل نفسها في الـ </span><code>ALB</code><span>، وفتحت الـ </span><code>URL</code><span> بتاع الـ </span><code>ALB</code><span> في الـ </span><code>web browser</code><span>، هتشوف حاجة شبه شكل 3-12.</span></p><p><span>مبروك، الـ </span><code>web server cluster</code><span> بتاعك دلوقتي بيقدر يوصل لعنوان وبورت الـ </span><code>database</code><span> بشكل </span><code>programmatically</code><span> عن طريق </span><code>Terraform</code><span>. لو كنت بتستخدم </span><code>web framework</code><span> حقيقي (زي </span><code>Ruby on Rails</code><span>)، كنت ممكن تحط العنوان والبورت دول كـ </span><code>environment variables</code><span> أو تكتبهم في </span><code>config file</code><span> عشان الـ </span><code>database library</code><span> بتاعتك (زي </span><code>ActiveRecord</code><span>) تقدر تستخدمهم وتكلم الـ </span><code>database</code></p><div class="md-alert md-alert-tip tip"><p><span class='md-alert-text md-alert-text-tip'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>Tip</span><br><span>بص انا عمتله وجربتها تقدر تخش تجربها </span>
<span>انا مش بس استخدامت backend s3 دا انا استخدامت local </span></p><p><span>global انشاءت منه </span><code>&quot;../../global/terraform.tfstate</code><span> بعدها قومت database</span></p><p>&nbsp;</p><p><img src="imgs/image-20250704012314341.png" referrerpolicy="no-referrer" alt="image-20250704012314341"></p><p><span>كان لازم امرر الملف ده وانا بعمل </span><code>terraform init</code><span> عشان</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.63019px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">terraform init -backend-config=../../global/backend_config.hcl</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>وبهدها apply وبعدا اروح للـwebserver نفس النظام واشغل نفس امر init وبعدها apply </span>
<span>وبعدها انا استخدمة terraform_remote_state مع  local عشان اجيب اس s3 واجيب region مش ذكاء مني انا بس بشوف الدنيا شغالة ولا لاء</span></p><p><span>وبعدها استخدامة terraform_remote_state مع database وهكذا </span></p><p><span>فى اخطاء فى المثال ده من الكاتب اول حاجة كان المفروض ينشاء حاجة network topology فى فولدر وتكون اول حاجة دا لو افترضنا اننا عيزين الاثنين يتوصلو مع بعض بس مش مشكلة الهدف كان التعليم كده انت فهمت اهمية تقسم المشروع بتاع لـcomponent وشفت العيب ودي الطريقة الاكثر انتشار ولكن بدل ما انا اعد ألف عليهم واحد واحد كده هنا بيجي دور terragrunt عشان يرحمنا من ألف ودورن وتشغل باللك من الاول ومين الثاني </span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.63019px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">data</span> <span class="cm-string">"terraform_remote_state"</span> <span class="cm-string">"global"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">backend</span> <span class="cm-operator">=</span> <span class="cm-string">"local"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">config</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">path</span> <span class="cm-operator">=</span> <span class="cm-string">"../../global/terraform.tfstate"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">data</span> <span class="cm-string">"terraform_remote_state"</span> <span class="cm-string">"database"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">backend</span> <span class="cm-operator">=</span> <span class="cm-string">"s3"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">config</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">bucket</span> <span class="cm-operator">=</span> <span class="cm-variable">data</span><span class="cm-operator">.</span><span class="cm-property">terraform_remote_state</span><span class="cm-operator">.</span><span class="cm-property">global</span><span class="cm-operator">.</span><span class="cm-property">outputs</span><span class="cm-operator">.</span><span class="cm-property">bucket_name</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">key</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"ex3/stage/database/terraform.tfstate"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">region</span> <span class="cm-operator">=</span> <span class="cm-variable">data</span><span class="cm-operator">.</span><span class="cm-property">terraform_remote_state</span><span class="cm-operator">.</span><span class="cm-property">global</span><span class="cm-operator">.</span><span class="cm-property">outputs</span><span class="cm-operator">.</span><span class="cm-property">region</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_launch_template"</span> <span class="cm-string">"template_instance"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">name_prefix</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"my-launch-template-"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">image_id</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">data</span><span class="cm-operator">.</span><span class="cm-property">aws_ami</span><span class="cm-operator">.</span><span class="cm-property">linux_ami</span><span class="cm-operator">.</span><span class="cm-property">id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">instance_type</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"t2.micro"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">key_name</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">aws_key_pair</span><span class="cm-operator">.</span><span class="cm-property">ec2_key_pair</span><span class="cm-operator">.</span><span class="cm-property">key_name</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">vpc_security_group_ids</span> <span class="cm-operator">=</span> [<span class="cm-variable">aws_security_group</span><span class="cm-operator">.</span><span class="cm-property">allow_ssh_http_ec2</span><span class="cm-operator">.</span><span class="cm-property">id</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">user_data</span> <span class="cm-operator">=</span> <span class="cm-variable">base64encode</span>(<span class="cm-string">&lt;&lt;-EOF</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">#!/bin/bash</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">yum update -y</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">yum install -y httpd</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">systemctl enable httpd</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">systemctl start httpd</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"># We are using a 'Here Document' to write a full HTML file easily</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">cat &gt; /var/www/html/index.html &lt;&lt;EOT</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">&lt;!DOCTYPE html&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">&lt;html lang="en"&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">&lt;head&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &lt;meta charset="UTF-8"&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &lt;title&gt;Terraform Deployed Server&lt;/title&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &lt;style&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp; &nbsp; body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp; &nbsp; div { border: 1px solid #ccc; padding: 20px; display: inline-block; }</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &lt;/style&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">&lt;/head&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">&lt;body&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &lt;div&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp; &nbsp; &lt;h1&gt;Hello from a full Apache (httpd) Server!&lt;/h1&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp; &nbsp; &lt;hr&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp; &nbsp; &lt;h2&gt;Database Connection Info:&lt;/h2&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp; &nbsp; &lt;p&gt;&lt;b&gt;Address:&lt;/b&gt; ${data.terraform_remote_state.database.outputs.address}&lt;/p&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp; &nbsp; &lt;p&gt;&lt;b&gt;Port:&lt;/b&gt; ${data.terraform_remote_state.database.outputs.port}&lt;/p&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &lt;/div&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">&lt;/body&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">&lt;/html&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">EOT</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">EOF</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">lifecycle</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">create_before_destroy</span> <span class="cm-operator">=</span> <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1568px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1568px;"></div></div></div></pre><p><span>تقدر تجرب </span>
<a href='https://github.com/taha2samy/examples' target='_blank' class='url'>https://github.com/taha2samy/examples</a>
<span>هتلاقيه في ch3 في اخر مثال ex3 وعيش</span></p><p><span>انا عمتلها مجرد apache server  وبعرض عليها واشتغلت </span><img src="imgs/image-20250704011545029.png" referrerpolicy="no-referrer" alt="image-20250704011545029"></p></div><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><hr /><p><strong><span>2. &quot;مشكلة البيضة والفرخة&quot; ليها حلول تانية غير الشغل اليدوي (للمستقبل)</span></strong></p><div class="md-alert md-alert-tip tip"><p><span class='md-alert-text md-alert-text-tip'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>Tip</span><br></p><p><strong><span>إزاي نعمل </span><code>S3 Bucket</code><span> من غير ما نقع في دوامة ؟</span></strong></p><p><span>الفصل شرح طريقة يدوية من خطوتين عشان تعمل الـ </span><code>S3 Bucket</code><span> اللي هتخزن فيه الـ </span><code>state</code><span>. دي طريقة شغالة، بس في بيئة شغل حقيقية، أي حاجة يدوية معرضة للغلط.</span></p><p><strong><span>هل فيه طرق تانية؟ آه، بس متقدمة شوية:</span></strong></p><ol start='' ><li><p><strong><span>استخدام </span><code>AWS CLI</code><span> في </span><code>script</code><span>:</span></strong><span> ممكن تعمل </span><code>bootstrap script</code><span> صغير باستخدام الـ </span><code>AWS CLI</code><span> وظيفته الوحيدة إنه يعمل </span><code>create</code><span> للـ </span><code>S3 Bucket</code><span> والـ </span><code>DynamoDB table</code><span>. الـ </span><code>script</code><span> ده بتشغله مرة واحدة بس في حياة الـ </span><code>AWS Account</code><span> كله، وبعدها كل شغل </span><code>Terraform</code><span> بيستخدم الـ </span><code>bucket</code><span> ده. ده بيوحد الطريقة وبيقلل الغلط اليدوي.</span></p></li><li><p><strong><span>استخدام حساب </span><code>AWS</code><span> تاني (الـ </span><code>Chicken and Egg Account</code><span>):</span></strong><span> في الشركات الكبيرة، بيبقى فيه </span><code>AWS Account</code><span> مركزي ومخصص بس للـ </span><code>DevOps tools</code><span>. ممكن تستخدم </span><code>Terraform</code><span> من الحساب ده (اللي الـ </span><code>state</code><span> بتاعه </span><code>local</code><span>) عشان تعمل </span><code>create</code><span> للـ </span><code>S3 Buckets</code><span> في كل الحسابات التانية (</span><code>staging</code><span>, </span><code>production</code><span>). أنت كده بتستخدم </span><code>Terraform</code><span> عشان يجهز </span><code>Terraform</code><span>!</span></p></li><li><p><strong><code>Terraform Cloud</code><span> أو </span><code>Enterprise</code><span>:</span></strong><span> دي خدمات من </span><code>HashiCorp</code><span> نفسها بتحللك المشكلة دي من أساسها. هي بتتكفل بموضوع تخزين الـ </span><code>state</code><span> والـ </span><code>locking</code><span> من غير ما تحتاج تعمل </span><code>S3 Bucket</code><span> بنفسك.</span></p></li></ol><p><span>الفكرة هنا مش إنك تستخدم الطرق دي دلوقتي، بس مهم تعرف إن &quot;المشكلة&quot; اللي واجهناها دي ليها حلول </span><code>automated</code><span> واحترافية، وإن الشغل اليدوي ده مجرد خطوة أولى للتعلم.</span></p></div><p>&nbsp;</p><div class="md-alert md-alert-warning warning"><p><span class='md-alert-text md-alert-text-warning'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Warning</span><br></p><p>&nbsp;</p><p>&nbsp;</p><p><strong><span>مشكلة الـ </span><code>Tight Coupling</code><span> مع </span><code>terraform_remote_state</code></strong></p><p>&nbsp;</p><p><span>إحنا اتفقنا إن أفضل طريقة ننظم بيها شغلنا هي إننا نقسم الـ </span><code>infrastructure</code><span> بتاعتنا لـ </span><code>components</code><span> منفصلة. فبقى عندنا فولدرين:</span></p><ol start='' ><li><p><code>database/</code><span>: ده الفولدر اللي فيه كود </span><code>Terraform</code><span> اللي بيبني الـ </span><code>database</code><span> بتاعتنا.</span></p></li><li><p><code>web-app/</code><span>: ده الفولدر اللي فيه كود </span><code>Terraform</code><span> اللي بيبني الـ </span><code>servers</code><span> بتاعة الأبلكيشن.</span></p></li></ol><p><strong><span>المشكلة اللي قابلتنا:</span></strong><span> الـ </span><code>web-app</code><span> محتاج يعرف عنوان (الـ </span><code>address</code><span>) والـ </span><code>port</code><span> بتاع الـ </span><code>database</code><span> عشان يعرف يكلمها.</span></p><p><strong><span>الحل السريع اللي استخدمناه:</span></strong><span> استخدمنا </span><code>data source</code><span> اسمه </span><code>terraform_remote_state</code><span>.</span></p><hr /><p><strong><span>الكارثة بتحصل إمتى؟ (The Breakage Scenario)</span></strong></p><p><span>تخيل إنك شغال في فريق، والفريق ده متقسم لفريقين صغيرين:</span></p><ul><li><p><strong><span>فريق الداتا:</span></strong><span> مسئول عن فولدر </span><code>database/</code><span>.</span></p></li><li><p><strong><span>فريق الأبلكيشن:</span></strong><span> مسئول عن فولدر </span><code>web-app/</code><span>.</span></p></li></ul><p><span>في يوم من الأيام، &quot;فريق الداتا&quot; قرر يعمل </span><code>refactor</code><span> للكود بتاعه. بصوا على الـ </span><code>output</code><span> اللي اسمه </span><code>address</code><span> وقالوا: &quot;الاسم ده مش واضح كفاية، خلينا نغيره لاسم أدق&quot;.</span></p><p><span>فقاموا بالتعديل البسيط ده في الكود بتاعهم:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.63019px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string-2">//</span> <span class="cm-tag">Before</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"address"</span> { </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-variable">aws_db_instance</span><span class="cm-operator">.</span><span class="cm-property">example</span><span class="cm-operator">.</span><span class="cm-property">address</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string-2">//</span> <span class="cm-tag">After</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">output</span> <span class="cm-string">"db_endpoint"</span> { </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-variable">aws_db_instance</span><span class="cm-operator">.</span><span class="cm-property">example</span><span class="cm-operator">.</span><span class="cm-property">address</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 202px;"></div><div class="CodeMirror-gutters" style="display: none; height: 202px;"></div></div></div></pre><p><span>بعد ما غيروا الكود، عملوا </span><code>terraform apply</code><span>. بالنسبة لهم، كل حاجة اشتغلت تمام 100% لأنهم غيروا اسم الـ </span><code>output</code><span> بس، والكود بتاعهم مش بيستخدمه في أي حتة تانية.</span></p><p><strong><span>هنا بقى بتحصل المشكلة عندك أنت في &quot;فريق الأبلكيشن&quot;.</span></strong></p><p><span>أنت متعرفش أي حاجة عن التغيير اللي حصل ده. جيت تاني يوم عايز تعمل تعديل صغير في الـ </span><code>web-app</code><span> بتاعك. شغلت </span><code>terraform plan</code><span>.</span></p><p><strong><code>Terraform</code><span> بيلاقي إن الـ </span><code>output</code><span> اللي اسمه </span><code>address</code><span> اللي أنت بتحاول تقراه مبقاش موجود في الـ </span><code>remote state</code><span> بتاع الداتا بيز.</span></strong></p><p><strong><span>BOOM!</span></strong><span> </span><code>Terraform</code><span> بيوقف كل حاجة وبيطلعلك </span><code>Error</code><span> في وشك.</span></p><blockquote><hr /></blockquote><h3 id='تحليل-المشكلة-the-brittle-contract'><strong><span>تحليل المشكلة: The Brittle Contract</span></strong></h3><p><span>المشكلة هنا مش إن الـ </span><code>components</code><span> بتتكلم مع بعض. المشكلة هي </span><strong><span>طريقة الكلام</span></strong><span>.</span></p><p><span>باستخدام </span><code>terraform_remote_state</code><span>، أنت خليت الـ </span><code>web-app</code><span> </span><strong><span>يعتمد على تفصيلة داخلية جداً</span></strong><span> في كود الـ </span><code>database</code><span> (وهي اسم متغير الـ </span><code>output</code><span>). أنت بكده عملت بينهم </span><strong><code>Tight Coupling</code></strong><span>.</span></p><p><span>الـ </span><strong><code>API Contract</code></strong><span> (أو الـ </span><strong><code>Interface</code></strong><span>) اللي بينهم بقى ضعيف وهش جداً. الـ </span><code>Contract</code><span> ده كان بيقول بشكل ضمني (implicitly): &quot;أنا كـ </span><code>web-app</code><span> متوقع إنك كـ </span><code>database</code><span> لازم تديني </span><code>output</code><span> اسمه </span><code>address</code><span>&quot;. أي تغيير في الاسم ده بيكسر الـ </span><code>Contract</code><span>، وبالتالي بيكسر السيستم كله.</span></p><blockquote><hr /></blockquote><h3 id='الحل-الأفضل-إزاي-نعمل-decoupling-باستخدام-وسيط'><strong><span>الحل الأفضل: إزاي نعمل </span><code>Decoupling</code><span> باستخدام وسيط</span></strong></h3><p><span>الحل إننا نخليهم يتكلموا مع بعض عن طريق </span><strong><span>وسيط محايد ومستقر</span></strong><span>. الـ </span><code>Contract</code><span> ميبقاش على تفاصيل داخلية، الـ </span><code>Contract</code><span> يبقى على اسم مكان عام بيحطوا فيه المعلومة وبيقروا منه.</span></p><p><strong><span>الحل هو استخدام </span><code>AWS Systems Manager Parameter Store</code><span> كـ </span><code>Service Discovery</code><span> mechanism:</span></strong></p><p><strong><span>الخطوة 1: تعديل كود &quot;فريق الداتا&quot; (الـ </span><code>Producer</code><span>)</span></strong></p><p><span>فريق الداتا، بالإضافة إنه بيعمل </span><code>output</code><span> (وده شيء كويس كـ Best Practice)، هيضيف </span><code>resource</code><span> جديد وظيفته &quot;ينشر&quot; (Publish) العنوان ده في مكان مركزي ومعروف للكل.</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.63019px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># في ملف database/main.tf</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_db_instance"</span> <span class="cm-string">"example"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># الجزء الجديد: بننشر المعلومة في مكان عام</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"aws_ssm_parameter"</span> <span class="cm-string">"db_endpoint"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">name</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"/my-app/stage/db/endpoint"</span> <span class="cm-comment"># &lt;-- ده "العنوان" المتفق عليه، ده الـ Contract الجديد</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">type</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-string">"String"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-variable">aws_db_instance</span><span class="cm-operator">.</span><span class="cm-property">example</span><span class="cm-operator">.</span><span class="cm-property">address</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 291px;"></div><div class="CodeMirror-gutters" style="display: none; height: 291px;"></div></div></div></pre><p><strong><span>إيه اللي حصل؟</span></strong><span> دلوقتي الـ </span><code>database</code><span> component بعد ما بيخلص شغله، بيروح يكتب العنوان بتاعه في </span><code>Parameter Store</code><span> تحت اسم </span><code>/my-app/stage/db/endpoint</code><span>. </span><strong><span>ده بقى الـ </span><code>Contract</code><span> الجديد والرسمي</span></strong><span>. فريق الداتا يقدر يغير أسماء الـ </span><code>outputs</code><span> بتاعته 100 مرة براحته، طالما هو ملتزم إنه يحط القيمة الصح في الـ </span><code>parameter</code><span> ده.</span></p><p><strong><span>الخطوة 2: تعديل كود &quot;فريق الأبلكيشن&quot; (الـ </span><code>Consumer</code><span>)</span></strong></p><p><span>أنت بقى هتمسح الـ </span><code>data &quot;terraform_remote_state&quot;</code><span> خالص من عندك، وهتستبدله بـ </span><code>data source</code><span> جديد بيقرأ من الـ </span><code>Parameter Store</code><span>.</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="terraform"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="terraform"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.0221px; left: 7.63019px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># في ملف web-app/main.tf (بعد التعديل)</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># هنا بنقرأ من المكان المركزي (بنستهلك المعلومة)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">data</span> <span class="cm-string">"aws_ssm_parameter"</span> <span class="cm-string">"db_endpoint"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-string">"/my-app/stage/db/endpoint"</span> <span class="cm-comment"># &lt;-- بنستخدم نفس "العنوان" المتفق عليه</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># وبعدين بنستخدمه كده</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">resource</span> <span class="cm-string">"some_resource"</span> <span class="cm-string">"app_server"</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">db_connection_string</span> <span class="cm-operator">=</span> <span class="cm-variable">data</span><span class="cm-operator">.</span><span class="cm-property">aws_ssm_parameter</span><span class="cm-operator">.</span><span class="cm-property">db_endpoint</span><span class="cm-operator">.</span><span class="cm-property">value</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 269px;"></div><div class="CodeMirror-gutters" style="display: none; height: 269px;"></div></div></div></pre><p><strong><span>النتيجة النهائية:</span></strong>
<span>الكود بتاعك مبقاش يعرف أي حاجة عن الـ </span><code>state file</code><span> بتاع الداتابيز ولا أسماء الـ </span><code>outputs</code><span> اللي جواه. كل اللي هو يعرفه إنه يروح يقرأ قيمة من مكان عام ومتفق عليه. الـ </span><code>components</code><span> بقت </span><strong><code>decoupled</code></strong><span>.</span></p><p><span>كل واحد فيهم يقدر يتغير ويتطور داخليًا براحته، طالما هما ملتزمين بالـ </span><strong><span>API Contract</span></strong><span> الواضح والمستقر اللي بينهم (وهو اسم الـ </span><code>parameter</code><span> في </span><code>Parameter Store</code><span>). ده بيخلي النظام كله أقوى وأكثر قابلية للصيانة والتطوير (</span><code>maintainable</code><span> و </span><code>scalable</code><span>) على المدى الطويل.</span></p><p><span>شرحك ده يوضح إنك فاهم المشكلة بعمق. الطريقة دي في التفكير هي اللي بتفرق بين واحد بيكتب كود Terraform وواحد بيبني infrastructure قوية ومستقرة (</span><code>robust</code><span> and </span><code>maintainable</code><span>).</span></p><p>&nbsp;</p><p>&nbsp;</p></div><p>&nbsp;</p><p>&nbsp;</p><div class="md-alert md-alert-note note"><p><span class='md-alert-text md-alert-text-note'><svg viewBox="0 0 16 16" version="1.1" width="1em" height="1em" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</span><br></p><p><strong><code>Terraform</code><span> بيثق في الـ </span><code>State</code><span> بتاعه أكتر ما بيثق في </span><code>AWS</code><span>!</span></strong></p><p><span>دي نقطة فلسفية بس مهمة جدًا عشان تفهم </span><code>Terraform</code><span> بيفكر إزاي. تخيل السيناريو ده:</span></p><ol start='' ><li><p><span>أنت عملت </span><code>EC2 instance</code><span> بـ </span><code>Terraform</code><span>. الـ </span><code>state file</code><span> سجل إن الـ </span><code>instance</code><span> دي موجودة بالـ </span><code>ID</code><span> الفلاني.</span></p></li><li><p><span>زميلك دخل على الـ </span><code>AWS Console</code><span> بإيده ومسح الـ </span><code>instance</code><span> دي من غير ما يقولك.</span></p></li><li><p><span>أنت جيت تعمل </span><code>terraform plan</code><span>.</span></p></li></ol><p><strong><span>تفتكر إيه اللي هيحصل؟</span></strong></p><p><span>أول حاجة </span><code>Terraform</code><span> هيعملها هي عملية الـ </span><code>refresh</code><span>. هيبص في الـ </span><code>state file</code><span> بتاعه، هيلاقي </span><code>ID</code><span> بتاع </span><code>instance</code><span>. هيروح يكلم </span><code>AWS</code><span> ويسألها عن الـ </span><code>ID</code><span> ده. </span><code>AWS</code><span> هتقوله &quot;الـ </span><code>ID</code><span> ده مش موجود!&quot;.</span></p><p><span>هنا، </span><code>Terraform</code><span> بيفهم إن فيه حاجة غلط. بيفهم إن الواقع اتغير من وراه. ده اسمه </span><strong><code>State Drift</code></strong><span>.</span></p><p><span>الـ </span><code>plan</code><span> اللي هيطلعهولك هيبقى: &quot;أنا شايف في الكود إنك عايز </span><code>instance</code><span>، وببص في الواقع مش لاقيها (مع إنها كانت متسجلة عندي في الـ </span><code>State</code><span>)، يبقى أنا </span><strong><span>هعملها </span><code>create</code><span> من جديد</span></strong><span>&quot;.</span></p><p><span>الفكرة هنا إن </span><code>Terraform</code><span> بيعتبر إن </span><strong><span>الكود هو الـ </span><code>Single Source of Truth</code></strong><span>، ويعتبر </span><strong><span>الـ </span><code>State</code><span> هو آخر حالة معروفة</span></strong><span>، ومهمته إنه يخلي الواقع يتطابق مع الكود. لو الواقع انحرف، هو بيصلحه.</span></p><p><strong><span>لما تكتشف إن الـ </span><code>State</code><span> بتاعك &quot;انحرف&quot; او Drift، أنت قدام مفترق طرق.</span></strong></p><p><span>لا توافق على الـ </span><code>plan</code><span> وأنت مغمض. اقف وفكر. اسأل نفسك: &quot;هل التغيير اللي حصل في الواقع ده غلطة ولا مقصود؟&quot;. بناءً على إجابتك، هتختار أحد المسارين التاليين:</span></p><p><strong><span>المسار الأول (الأكتر شيوعًا):</span></strong><span>Applying the Desired State from Code</span></p><p><strong><span>الفكرة:</span></strong><span> الكود هو الـ </span><code>Single Source of Truth</code><span>. الواقع الحالي به خطأ، ويجب تصحيحه.</span></p><ul><li><p><strong><span>امتى تستخدمه؟</span></strong><span> لو كان التغيير اليدوي ده غلطة أو مش مقصود (زي حذف سيرفر بالصدفة، أو تعديل قاعدة في </span><code>Security Group</code><span> يدويًا، أو حتى نتيجة </span><code>bug</code><span> نادر في </span><code>AWS</code><span>).</span></p></li><li><p><strong><span>بتعمل إيه؟ (الأوامر):</span></strong></p><ol start='' ><li><p><strong><code>terraform plan</code></strong><span>: راجع الـ </span><code>plan</code><span> بعينك كويس عشان تتأكد إنه هيصلح الانحراف ويرجع السيستم للحالة المطلوبة.</span></p></li><li><p><strong><code>terraform apply</code></strong><span>: لو الـ </span><code>plan</code><span> تمام، نفذه. </span><code>Terraform</code><span> هيصلح الـ </span><code>drift</code><span>، وبعدها هيحدّث الـ </span><code>State</code><span> بتاعه أوتوماتيك.</span></p></li></ol></li></ul><p><strong><span>المسار التاني (للحالات الخطيرة): تحديث الـ </span><code>State</code><span> عشان يعكس الواقع الجديد</span></strong></p><p><strong><span>الفكرة:</span></strong><span> الواقع الحالي هو الصحيح دلوقتي. لازم نحدّث الكود والـ </span><code>State</code><span> عشان يبقوا زيه.</span></p><ul><li><p><strong><span>امتى تستخدمه؟</span></strong><span> لو كان التغيير اليدوي مقصود وضروري (زي عمل </span><code>scale up</code><span> لـ </span><code>database</code><span> بسرعة من الـ </span><code>Console</code><span> عشان تواجه ضغط طارئ). لو عملت </span><code>apply</code><span> على طول، </span><code>Terraform</code><span> هيروح </span><strong><span>يصغر الـ </span><code>database</code><span> تاني</span></strong><span>، ودي هتبقى كارثة.</span></p></li><li><p><strong><span>بتعمل إيه؟ (الأوامر):</span></strong></p><ol start='' ><li><p><strong><span>عدّل الكود الأول (الحل الأبسط)</span></strong><span>: روح بنفسك على ملفات </span><code>.tf</code><span> وعدّل الـ </span><code>resource</code><span> عشان يبقى زي اللي في الواقع (مثلاً، غيّر قيمة الـ </span><code>instance_type</code><span> في الكود). لما تعمل </span><code>plan</code><span> بعدها، </span><code>Terraform</code><span> مش هيلاقي أي اختلاف.</span></p></li><li><p><strong><span>استخدم </span><code>terraform import</code></strong><span>: لو حد عمل </span><code>resource</code><span> جديد خالص بإيده، استخدم الأمر ده عشان تخلي </span><code>Terraform</code><span>  يضيفه للـ </span><code>State</code><span> بتاعه من غير ما يمسحه.</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 16.6318px; left: 7.63022px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">terraform import aws_instance.my_new_instance i-1234567890abcdef0</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="display: none; height: 45px;"></div></div></div></pre></li><li><p><strong><span>استخدم </span><code>terraform state</code><span> (للحالات المتقدمة)</span></strong><span>: دي أدوات متقدمة عشان تعدل في الـ </span><code>State</code><span> مباشرة (زي إنك تغير اسم </span><code>resource</code><span> جوه الـ </span><code>State</code><span>).</span></p></li></ol></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 17.026px; left: 7.63019px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">terraform state <span class="cm-builtin">mv</span> <span class="cm-string">'aws_instance.old_name'</span> <span class="cm-string">'aws_instance.new_name'</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p>&nbsp;</p><p><span>القاعدة الذهبية في الشغل مع </span><code>Terraform</code><span> هي: </span><strong><span>محدش يغير أي </span><code>resource</code><span> معمول بـ </span><code>Terraform</code><span> بإيده من الـ </span><code>Console</code><span>!</span></strong><span> كل التغييرات لازم تتم عن طريق تعديل الكود وعمل </span><code>apply</code><span>. ده بيضمن إن الـ </span><code>State</code><span> يفضل دايمًا انعكاس دقيق للـ </span><code>infrastructure</code><span>، وإن الكود هو فعلًا الـ </span><code>Single Source of Truth</code><span>.</span></p></div></div></div>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn&display=swap" rel="stylesheet">

<style>
    /* تطبيق الخط على كل الصفحة */
    body {
        font-family: "Vazirmatn", sans-serif;
        font-optical-sizing: auto;
        font-weight: 400;
        font-style: normal;
    }
    h1 h2 h3 h4 h5 h6 {
        font-family: "Vazirmatn", sans-serif;
        font-optical-sizing: auto;
        font-weight: 400;
        font-style: normal;
    }
    </style>

</body>
</html>